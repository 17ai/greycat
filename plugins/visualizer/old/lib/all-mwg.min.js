function arrayInstanceOf(t,e){return t instanceof Array&&(0==t.length||t[0]instanceof e)}var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},java;!function(t){var e;!function(t){var e=function(){function t(){}return t.gc=function(){},t.arraycopy=function(t,e,n,r,i){if((n instanceof Float64Array||n instanceof Int32Array)&&(t instanceof Float64Array||t instanceof Int32Array))i==t.length?n.set(t,r):n.set(t.subarray(e,e+i),r);else for(var o=0;o<i;o++)n[r+o]=t[e+o]},t}();t.System=e,e=function(){function t(){this._buffer="",this.length=0}return t.prototype.append=function(t){return this._buffer+=t,this.length=this._buffer.length,this},t.prototype.insert=function(t,e){return this._buffer=this._buffer.slice(0,t)+e+this._buffer.slice(t),this},t.prototype.toString=function(){return this._buffer},t}(),t.StringBuilder=e,e=function(){function t(){}return t.valueOf=function(t,e,n){return"undefined"==typeof e&&"undefined"==typeof n?t+"":t.slice(e,e+n)},t.hashCode=function(t){var e=t._hashCode?t._hashCode:0;if(0===e&&0<t.length){for(var n=0;n<t.length;n++)e=31*e+t.charCodeAt(n);t._hashCode=e}return e},t.isEmpty=function(t){return 0===t.length},t.join=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return e.join(t)},t}(),t.String=e,e=function(){function t(){}return t.sleep=function(t){},t}(),t.Thread=e,e=function(){function t(){}return t.MAX_VALUE=Number.MAX_VALUE,t.POSITIVE_INFINITY=Number.POSITIVE_INFINITY,t.NEGATIVE_INFINITY=Number.NEGATIVE_INFINITY,t.NaN=NaN,t}(),t.Double=e,e=function(){function t(){}return t.parseLong=function(t){return parseInt(t)},t}(),t.Long=e,e=function(){function t(){}return t.parseInt=function(t){return parseInt(t)},t}(),t.Integer=e}(e=t.lang||(t.lang={})),function(n){!function(t){!function(t){var e=function(){function t(t){this._internal=new Int32Array(t)}return t.prototype.set=function(t,e){this._internal[t]=e},t.prototype.get=function(t){return this._internal[t]},t.prototype.getAndSet=function(t,e){var n=this._internal[t];return this._internal[t]=e,n},t.prototype.compareAndSet=function(t,e,n){return this._internal[t]==e&&(this._internal[t]=n,!0)},t}();t.AtomicIntegerArray=e,e=function(){function t(t){this._internal=new Float64Array(t)}return t.prototype.set=function(t,e){this._internal[t]=e},t.prototype.get=function(t){return this._internal[t]},t.prototype.getAndSet=function(t,e){var n=this._internal[t];return this._internal[t]=e,n},t.prototype.compareAndSet=function(t,e,n){return this._internal[t]==e&&(this._internal[t]=n,!0)},t.prototype.length=function(){return this._internal.length},t}(),t.AtomicLongArray=e,e=function(){function t(t){this._internal=[]}return t.prototype.set=function(t,e){this._internal[t]=e},t.prototype.get=function(t){return this._internal[t]},t.prototype.getAndSet=function(t,e){var n=this._internal[t];return this._internal[t]=e,n},t.prototype.compareAndSet=function(t,e,n){return this._internal[t]==e&&(this._internal[t]=n,!0)},t.prototype.length=function(){return this._internal.length},t}(),t.AtomicReferenceArray=e,e=function(){function t(){this._internal=null}return t.prototype.compareAndSet=function(t,e){return this._internal==t&&(this._internal=e,!0)},t.prototype.get=function(){return this._internal},t.prototype.set=function(t){this._internal=t},t.prototype.getAndSet=function(t){var e=this._internal;return this._internal=t,e},t}(),t.AtomicReference=e,e=function(){function t(t){this._internal=0,this._internal=t}return t.prototype.compareAndSet=function(t,e){return this._internal==t&&(this._internal=e,!0)},t.prototype.get=function(){return this._internal},t.prototype.incrementAndGet=function(){return this._internal++,this._internal},t.prototype.decrementAndGet=function(){return this._internal--,this._internal},t}(),t.AtomicLong=e,e=function(){function t(t){this._internal=!1,this._internal=t}return t.prototype.compareAndSet=function(t,e){return this._internal==t&&(this._internal=e,!0)},t.prototype.get=function(){return this._internal},t.prototype.set=function(t){this._internal=t},t}(),t.AtomicBoolean=e,e=function(){function t(t){this._internal=0,this._internal=t}return t.prototype.compareAndSet=function(t,e){return this._internal==t&&(this._internal=e,!0)},t.prototype.get=function(){return this._internal},t.prototype.set=function(t){this._internal=t},t.prototype.getAndSet=function(t){var e=this._internal;return this._internal=t,e},t.prototype.incrementAndGet=function(){return this._internal++,this._internal},t.prototype.decrementAndGet=function(){return this._internal--,this._internal},t.prototype.getAndIncrement=function(){var t=this._internal;return this._internal++,t},t.prototype.getAndDecrement=function(){var t=this._internal;return this._internal--,t},t}(),t.AtomicInteger=e}(t.atomic||(t.atomic={})),function(t){var e=function(){function t(){}return t.prototype.lock=function(){},t.prototype.unlock=function(){},t}();t.ReentrantLock=e}(t.locks||(t.locks={}))}(n.concurrent||(n.concurrent={}));var r=function(){function t(){this.seed=void 0}return t.prototype.nextInt=function(t){return"undefined"==typeof t&&(t=Math.pow(2,32)),void 0==this.seed?Math.floor(Math.random()*t):Math.floor(this.nextSeeded(0,t))},t.prototype.nextDouble=function(){return void 0==this.seed?Math.random():this.nextSeeded(Number.MIN_VALUE,Number.MAX_VALUE)},t.prototype.nextBoolean=function(){return void 0==this.seed?.5<=Math.random():.5<=this.nextSeeded()},t.prototype.setSeed=function(t){this.seed=t},t.prototype.nextSeeded=function(t,e){return t=t||0,this.seed=(9301*this.seed+49297)%233280,t+this.seed/233280*((e||1)-t)},t}();n.Random=r,r=function(){function t(){}return t.fill=function(t,e,n,r){for(n=e+n;e<n;e++)t[e]=r},t.copyOf=function(t,n,r){return r=Array(n),e.System.arraycopy(t,0,r,0,Math.min(t.length,n)),r},t}(),n.Arrays=r,r=function(){function t(){}return t.swap=function(t,e,n){t.set(e,t.set(n,t.get(e)))},t}(),n.Collections=r;var i=function(){function t(t){this.cursor=0,this.lastRet=-1,this.list=t}return t.prototype.hasNext=function(){return this.cursor!=this.list.size()},t.prototype.next=function(){try{var t=this.cursor,e=this.list.get(t);return this.lastRet=t,this.cursor=t+1,e}catch(n){if(n instanceof Error)throw Error("no such element exception");throw n}},t}();n.Itr=i;var o=function(){function e(){this.content={}}return e.prototype.add=function(t){this.content[t]=t},e.prototype.clear=function(){this.content={}},e.prototype.contains=function(t){return this.content.hasOwnProperty(t)},e.prototype.containsAll=function(t){return!1},e.prototype.addAll=function(t){t=t.toArray(null);for(var e=0;e<t.length;e++)this.content[t[e]]=t[e];return!0},e.prototype.remove=function(t){var e=!1;return this.content[t]&&(e=!0),delete this.content[t],e},e.prototype.removeAll=function(){return!1},e.prototype.size=function(){return Object.keys(this.content).length},e.prototype.isEmpty=function(){return 0==this.size()},e.prototype.toArray=function(t){var e=this;return Object.keys(this.content).map(function(t){return e.content[t]})},e.prototype.iterator=function(){return new t.util.Itr(this)},e.prototype.forEach=function(t){for(var e in this.content)t(this.content[e])},e.prototype.get=function(t){return this.content[t]},e}();n.HashSet=o,r=function(){function t(){this.content=[]}return t.prototype.addAll=function(t,e){for(var n=e.toArray(null),r=0;r<n.length;r++)this.content.push(n[r]);return!1},t.prototype.clear=function(){this.content=[]},t.prototype.poll=function(){return this.content.shift()},t.prototype.remove=function(t){return this.content.splice(t,1),!0},t.prototype.removeAll=function(){return this.content=[],!0},t.prototype.toArray=function(t){return this.content},t.prototype.size=function(){return this.content.length},t.prototype.add=function(t,e){"undefined"!=typeof e?this.content.splice(t,0,e):this.content.push(t)},t.prototype.get=function(t){return this.content[t]},t.prototype.contains=function(t){return-1!=this.content.indexOf(t)},t.prototype.containsAll=function(t){return!1},t.prototype.isEmpty=function(){return 0==this.content.length},t.prototype.set=function(t,e){return this.content[t]=e},t.prototype.indexOf=function(t){return this.content.indexOf(t)},t.prototype.lastIndexOf=function(t){return this.content.lastIndexOf(t)},t.prototype.iterator=function(){return new i(this)},t}(),n.AbstractList=r;var s=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r);n.LinkedList=s,r=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r),n.ArrayList=r,r=function(){function t(){this.content=[]}return t.prototype.pop=function(){return this.content.pop()},t.prototype.push=function(t){this.content.push(t)},t.prototype.isEmpty=function(){return 0==this.content.length},t.prototype.peek=function(){return this.content.slice(-1)[0]},t}(),n.Stack=r,r=function(){function t(){this.content={}}return t.prototype.get=function(t){return this.content[t]},t.prototype.put=function(t,e){var n=this.content[t];return this.content[t]=e,n},t.prototype.containsKey=function(t){return this.content.hasOwnProperty(t)},t.prototype.remove=function(t){var e=this.content[t];return delete this.content[t],e},t.prototype.keySet=function(){var t,e=new o;for(t in this.content)this.content.hasOwnProperty(t)&&e.add(t);return e},t.prototype.isEmpty=function(){return 0==Object.keys(this.content).length},t.prototype.values=function(){var t,e=new o;for(t in this.content)this.content.hasOwnProperty(t)&&e.add(this.content[t]);return e},t.prototype.clear=function(){this.content={}},t.prototype.size=function(){return Object.keys(this.content).length},t}(),n.HashMap=r,r=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e}(r),n.ConcurrentHashMap=r}(t.util||(t.util={}))}(java||(java={}));var Long=function(){function t(t,e,n){this.low=this.high=0,this.unsigned=!1,this.eq=this.equals,this.neq=this.notEquals,this.lt=this.lessThan,this.lte=this.lessThanOrEqual,this.gt=this.greaterThan,this.gte=this.greaterThanOrEqual,this.comp=this.compare,this.neg=this.negate,this.sub=this.subtract,this.mul=this.multiply,this.div=this.divide,this.mod=this.modulo,this.shl=this.shiftLeft,this.shr=this.shiftRight,this.shru=this.shiftRightUnsigned,void 0!=e&&(this.high=e),void 0!=t&&(this.low=t),void 0!=n&&(this.unsigned=n)}return t.isLong=function(t){return!0===(t&&t.__isLong__)},t.fromInt=function(e,n){var r,i;if(n){if(e>>>=0,(i=0<=e&&256>e)&&(r=t.UINT_CACHE[e]))return r;r=t.fromBits(e,0>(0|e)?-1:0,!0),i&&(t.UINT_CACHE[e]=r)}else{if(e|=0,(i=-128<=e&&128>e)&&(r=t.INT_CACHE[e]))return r;r=t.fromBits(e,0>e?-1:0,!1),i&&(t.INT_CACHE[e]=r)}return r},t.fromNumber=function(e,n){if(isNaN(e)||!isFinite(e))return n?t.UZERO:t.ZERO;if(n){if(0>e)return t.UZERO;if(e>=t.TWO_PWR_64_DBL)return t.MAX_UNSIGNED_VALUE}else{if(e<=-t.TWO_PWR_63_DBL)return t.MIN_VALUE;if(e+1>=t.TWO_PWR_63_DBL)return t.MAX_VALUE}return 0>e?t.fromNumber(-e,n).neg():t.fromBits(e%t.TWO_PWR_32_DBL|0,e/t.TWO_PWR_32_DBL|0,n)},t.fromBits=function(e,n,r){return new t(e,n,r)},t.fromString=function(e,n,r){if(void 0===n&&(n=10),void 0===r&&(r=!1),0===e.length)throw Error("empty string");if("NaN"===e||"Infinity"===e||"+Infinity"===e||"-Infinity"===e)return t.ZERO;if(n=n||10,2>n||36<n)throw RangeError("radix");var i;if(0<(i=e.indexOf("-")))throw Error("interior hyphen");if(0===i)return t.fromString(e.substring(1),n,r).neg();i=t.fromNumber(t.pow_dbl(n,8));for(var o=t.ZERO,s=0;s<e.length;s+=8){var a=Math.min(8,e.length-s),l=parseInt(e.substring(s,s+a),n);8>a?(a=t.fromNumber(t.pow_dbl(n,a)),o=o.mul(a).add(t.fromNumber(l))):(o=o.mul(i),o=o.add(t.fromNumber(l)))}return o.unsigned=r,o},t.fromValue=function(e){return e instanceof t?e:"number"==typeof e?t.fromNumber(e):"string"==typeof e?t.fromString(e):t.fromBits(e.low,e.high,e.unsigned)},t.prototype.toInt=function(){return this.unsigned?this.low>>>0:this.low},t.prototype.toNumber=function(){return this.unsigned?(this.high>>>0)*t.TWO_PWR_32_DBL+(this.low>>>0):this.high*t.TWO_PWR_32_DBL+(this.low>>>0)},t.prototype.toString=function(e){if(e=e||10,2>e||36<e)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(t.MIN_VALUE)){var n=t.fromNumber(e),r=this.div(n),n=r.mul(n).sub(this);return r.toString(e)+n.toInt().toString(e)}return"-"+this.neg().toString(e)}for(var r=t.fromNumber(t.pow_dbl(e,6),this.unsigned),n=this,i="";;){var o=n.div(r),s=(n.sub(o.mul(r)).toInt()>>>0).toString(e),n=o;if(n.isZero())return s+i;for(;6>s.length;)s="0"+s;i=""+s+i}},t.prototype.getHighBits=function(){return this.high},t.prototype.getHighBitsUnsigned=function(){return this.high>>>0},t.prototype.getLowBits=function(){return this.low},t.prototype.getLowBitsUnsigned=function(){return this.low>>>0},t.prototype.getNumBitsAbs=function(){if(this.isNegative())return this.eq(t.MIN_VALUE)?64:this.neg().getNumBitsAbs();for(var e=0!=this.high?this.high:this.low,n=31;0<n&&0==(e&1<<n);n--);return 0!=this.high?n+33:n+1},t.prototype.isZero=function(){return 0===this.high&&0===this.low},t.prototype.isNegative=function(){return!this.unsigned&&0>this.high},t.prototype.isPositive=function(){return this.unsigned||0<=this.high},t.prototype.isOdd=function(){return 1===(1&this.low)},t.prototype.isEven=function(){return 0===(1&this.low)},t.prototype.equals=function(e){return t.isLong(e)||(e=t.fromValue(e)),(this.unsigned===e.unsigned||1!==this.high>>>31||1!==e.high>>>31)&&(this.high===e.high&&this.low===e.low)},t.prototype.notEquals=function(t){return!this.eq(t)},t.prototype.lessThan=function(t){return 0>this.comp(t)},t.prototype.lessThanOrEqual=function(t){return 0>=this.comp(t)},t.prototype.greaterThan=function(t){return 0<this.comp(t)},t.prototype.greaterThanOrEqual=function(t){return 0<=this.comp(t)},t.prototype.compare=function(e){if(t.isLong(e)||(e=t.fromValue(e)),this.eq(e))return 0;var n=this.isNegative(),r=e.isNegative();return n&&!r?-1:!n&&r?1:this.unsigned?e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1:this.sub(e).isNegative()?-1:1},t.prototype.negate=function(){return!this.unsigned&&this.eq(t.MIN_VALUE)?t.MIN_VALUE:this.not().add(t.ONE)},t.prototype.add=function(e){t.isLong(e)||(e=t.fromValue(e));var n=this.high>>>16,r=65535&this.high,i=this.low>>>16,o=e.high>>>16,s=65535&e.high,a=e.low>>>16;return e=0+((65535&this.low)+(65535&e.low)),a=0+(e>>>16)+(i+a),i=0+(a>>>16),i+=r+s,n=0+(i>>>16)+(n+o)&65535,t.fromBits((65535&a)<<16|65535&e,n<<16|65535&i,this.unsigned)},t.prototype.subtract=function(e){return t.isLong(e)||(e=t.fromValue(e)),this.add(e.neg())},t.prototype.multiply=function(e){if(this.isZero())return t.ZERO;if(t.isLong(e)||(e=t.fromValue(e)),e.isZero())return t.ZERO;if(this.eq(t.MIN_VALUE))return e.isOdd()?t.MIN_VALUE:t.ZERO;if(e.eq(t.MIN_VALUE))return this.isOdd()?t.MIN_VALUE:t.ZERO;if(this.isNegative())return e.isNegative()?this.neg().mul(e.neg()):this.neg().mul(e).neg();if(e.isNegative())return this.mul(e.neg()).neg();if(this.lt(t.TWO_PWR_24)&&e.lt(t.TWO_PWR_24))return t.fromNumber(this.toNumber()*e.toNumber(),this.unsigned);var n=this.high>>>16,r=65535&this.high,i=this.low>>>16,o=65535&this.low,s=e.high>>>16,a=65535&e.high,l=e.low>>>16;e=65535&e.low;var h,u,c,p;return p=0+o*e,c=0+(p>>>16)+i*e,u=0+(c>>>16),c=(65535&c)+o*l,u+=c>>>16,u+=r*e,h=0+(u>>>16),u=(65535&u)+i*l,h+=u>>>16,u=(65535&u)+o*a,h=h+(u>>>16)+(n*e+r*l+i*a+o*s)&65535,t.fromBits((65535&c)<<16|65535&p,h<<16|65535&u,this.unsigned)},t.prototype.divide=function(e){if(t.isLong(e)||(e=t.fromValue(e)),e.isZero())throw Error("division by zero");if(this.isZero())return this.unsigned?t.UZERO:t.ZERO;var n,r,i;if(this.unsigned){if(e.unsigned||(e=e.toUnsigned()),e.gt(this))return t.UZERO;if(e.gt(this.shru(1)))return t.UONE;i=t.UZERO}else{if(this.eq(t.MIN_VALUE))return e.eq(t.ONE)||e.eq(t.NEG_ONE)?t.MIN_VALUE:e.eq(t.MIN_VALUE)?t.ONE:(n=this.shr(1).div(e).shl(1),n.eq(t.ZERO)?e.isNegative()?t.ONE:t.NEG_ONE:(r=this.sub(e.mul(n)),i=n.add(r.div(e))));if(e.eq(t.MIN_VALUE))return this.unsigned?t.UZERO:t.ZERO;if(this.isNegative())return e.isNegative()?this.neg().div(e.neg()):this.neg().div(e).neg();if(e.isNegative())return this.div(e.neg()).neg();i=t.ZERO}for(r=this;r.gte(e);){n=Math.max(1,Math.floor(r.toNumber()/e.toNumber()));for(var o=Math.ceil(Math.log(n)/Math.LN2),o=48>=o?1:t.pow_dbl(2,o-48),s=t.fromNumber(n),a=s.mul(e);a.isNegative()||a.gt(r);)n-=o,s=t.fromNumber(n,this.unsigned),a=s.mul(e);s.isZero()&&(s=t.ONE),i=i.add(s),r=r.sub(a)}return i},t.prototype.modulo=function(e){return t.isLong(e)||(e=t.fromValue(e)),this.sub(this.div(e).mul(e))},t.prototype.not=function(){return t.fromBits(~this.low,~this.high,this.unsigned)},t.prototype.and=function(e){return t.isLong(e)||(e=t.fromValue(e)),t.fromBits(this.low&e.low,this.high&e.high,this.unsigned)},t.prototype.or=function(e){return t.isLong(e)||(e=t.fromValue(e)),t.fromBits(this.low|e.low,this.high|e.high,this.unsigned)},t.prototype.xor=function(e){return t.isLong(e)||(e=t.fromValue(e)),t.fromBits(this.low^e.low,this.high^e.high,this.unsigned)},t.prototype.shiftLeft=function(e){return t.isLong(e)&&(e=e.toInt()),0===(e&=63)?this:32>e?t.fromBits(this.low<<e,this.high<<e|this.low>>>32-e,this.unsigned):t.fromBits(0,this.low<<e-32,this.unsigned)},t.prototype.shiftRight=function(e){return t.isLong(e)&&(e=e.toInt()),0===(e&=63)?this:32>e?t.fromBits(this.low>>>e|this.high<<32-e,this.high>>e,this.unsigned):t.fromBits(this.high>>e-32,0<=this.high?0:-1,this.unsigned)},t.prototype.shiftRightUnsigned=function(e){if(t.isLong(e)&&(e=e.toInt()),e&=63,0===e)return this;var n=this.high;return 32>e?t.fromBits(this.low>>>e|n<<32-e,n>>>e,this.unsigned):32===e?t.fromBits(n,0,this.unsigned):t.fromBits(n>>>e-32,0,this.unsigned)},t.prototype.toSigned=function(){return this.unsigned?t.fromBits(this.low,this.high,!1):this},t.prototype.toUnsigned=function(){return this.unsigned?this:t.fromBits(this.low,this.high,!0)},t.INT_CACHE={},t.UINT_CACHE={},t.pow_dbl=Math.pow,t.TWO_PWR_16_DBL=65536,t.TWO_PWR_24_DBL=16777216,t.TWO_PWR_32_DBL=t.TWO_PWR_16_DBL*t.TWO_PWR_16_DBL,t.TWO_PWR_64_DBL=t.TWO_PWR_32_DBL*t.TWO_PWR_32_DBL,t.TWO_PWR_63_DBL=t.TWO_PWR_64_DBL/2,t.TWO_PWR_24=t.fromInt(t.TWO_PWR_24_DBL),t.ZERO=t.fromInt(0),t.UZERO=t.fromInt(0,!0),t.ONE=t.fromInt(1),t.UONE=t.fromInt(1,!0),t.NEG_ONE=t.fromInt(-1),t.MAX_VALUE=t.fromBits(2147483647,4294967295,!1),t.MAX_UNSIGNED_VALUE=t.fromBits(4294967295,4294967295,!0),t.MIN_VALUE=t.fromBits(2147483648,0,!1),t}();Object.defineProperty(Long.prototype,"__isLong__",{value:!0,enumerable:!1,configurable:!1});var org;!function(t){!function(e){var n=function(){function t(){}return t.isDefined=function(t){return void 0!=t&&null!=t},t.equals=function(t,e){return t===e},t.longArrayEquals=function(t,e){if(t.length!=e.length)return!1;for(var n=0;n<t.length;n++)if(t[n]!=e[n])return!1;return!0},t.LONG_SIZE=53,t.PREFIX_SIZE=16,t.BEGINNING_OF_TIME=-9007199254740990,t.END_OF_TIME=9007199254740990,t.NULL_LONG=9007199254740991,t.KEY_PREFIX_MASK=137438953471,t.CACHE_MISS_ERROR="Cache miss error",t.QUERY_SEP=",",t.QUERY_KV_SEP="=",t.TASK_SEP=".",t.TASK_PARAM_OPEN="(",t.TASK_PARAM_CLOSE=")",t.CHUNK_SEP=124,t.CHUNK_SUB_SEP=44,t.CHUNK_SUB_SUB_SEP=58,t.CHUNK_SUB_SUB_SUB_SEP=37,t.BUFFER_SEP=35,t.KEY_SEP=59,t.MAP_INITIAL_CAPACITY=8,t.MAP_LOAD_FACTOR=.75,t.BOOL_TRUE=49,t.BOOL_FALSE=48,t}();e.Constants=n,n=function(){function e(){this._plugins=this._scheduler=this._storage=null,this._memorySize=-1,this._readOnly=!1}return e.prototype.withStorage=function(t){return this._storage=t,this},e.prototype.withReadOnlyStorage=function(t){return this._storage=t,this._readOnly=!0,this},e.prototype.withMemorySize=function(t){return this._memorySize=t,this},e.prototype.withScheduler=function(t){return this._scheduler=t,this},e.prototype.withPlugin=function(t){if(null==this._plugins)this._plugins=Array(1),this._plugins[0]=t;else{var e=Array(this._plugins.length+1);java.lang.System.arraycopy(this._plugins,0,e,0,this._plugins.length),e[this._plugins.length]=t,this._plugins=e}return this},e.prototype.build=function(){return null==t.mwg.GraphBuilder._internalBuilder&&(t.mwg.GraphBuilder._internalBuilder=new t.mwg.core.Builder),t.mwg.GraphBuilder._internalBuilder.newGraph(this._storage,this._readOnly,this._scheduler,this._plugins,this._memorySize)},e._internalBuilder=null,e}(),e.GraphBuilder=n,n=function(){function e(){}return e.typeName=function(e){switch(e){case t.mwg.Type.BOOL:return"boolean";case t.mwg.Type.STRING:return"string";case t.mwg.Type.LONG:return"long";case t.mwg.Type.INT:return"int";case t.mwg.Type.DOUBLE:return"double";case t.mwg.Type.DOUBLE_ARRAY:return"double[]";case t.mwg.Type.LONG_ARRAY:return"long[]";case t.mwg.Type.INT_ARRAY:return"int[]";case t.mwg.Type.LONG_TO_LONG_MAP:return"map(long->long)";case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:return"map(long->long[])";case t.mwg.Type.STRING_TO_LONG_MAP:return"map(string->long)";case t.mwg.Type.RELATION:return"relation";default:return"unknown"}},e.BOOL=1,e.STRING=2,e.LONG=3,e.INT=4,e.DOUBLE=5,e.DOUBLE_ARRAY=6,e.LONG_ARRAY=7,e.INT_ARRAY=8,e.LONG_TO_LONG_MAP=9,e.LONG_TO_LONG_ARRAY_MAP=10,e.STRING_TO_LONG_MAP=11,e.RELATION=12,e}(),e.Type=n,function(t){var e=function(){function t(){}return t.STATE_CHUNK=0,t.TIME_TREE_CHUNK=1,t.WORLD_ORDER_CHUNK=2,t.GEN_CHUNK=3,t}();t.ChunkType=e}(e.chunk||(e.chunk={})),function(e){var n=function(){function e(t,e,n,r){this._time_magic=this._super_time_magic=this._world_magic=this._index_stateChunk=this._index_timeTree=this._index_superTimeTree=this._index_worldOrder=-1,this._dead=!1,this._world=t,this._time=e,this._id=n,this._graph=r,this._resolver=r.resolver()}return e.prototype.cacheLock=function(){},e.prototype.cacheUnlock=function(){},e.prototype.init=function(){},e.prototype.nodeTypeName=function(){return this._resolver.typeName(this)},e.prototype.unphasedState=function(){return this._resolver.resolveState(this)},e.prototype.phasedState=function(){return this._resolver.alignState(this)},e.prototype.newState=function(t){return this._resolver.newState(this,this._world,t)},e.prototype.graph=function(){return this._graph},e.prototype.world=function(){return this._world},e.prototype.time=function(){return this._time},e.prototype.id=function(){return this._id},e.prototype.get=function(t){var e=this._resolver.resolveState(this);return null!=e?e.get(this._resolver.stringToHash(t,!1)):null},e.prototype.set=function(e,n){if("string"==typeof n||n instanceof String)this.setProperty(e,t.mwg.Type.STRING,n);else if("number"==typeof n||n instanceof Number)0!=n%1?this.setProperty(e,t.mwg.Type.DOUBLE,n):this.setProperty(e,t.mwg.Type.LONG,n);else if("boolean"==typeof n||n instanceof Boolean)this.setProperty(e,t.mwg.Type.BOOL,n);else if(n instanceof Int32Array)this.setProperty(e,t.mwg.Type.LONG_ARRAY,n);else{if(!(n instanceof Float64Array))throw Error("Invalid property type: "+n+", please use a Type listed in org.mwg.Type");this.setProperty(e,t.mwg.Type.DOUBLE_ARRAY,n)}},e.prototype.setProperty=function(e,n,r){var i=this._resolver.alignState(this);if(null==i)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);i.set(this._resolver.stringToHash(e,!0),n,r)},e.prototype.getOrCreate=function(e,n){var r=this._resolver.alignState(this);if(null!=r)return r.getOrCreate(this._resolver.stringToHash(e,!0),n);throw Error(t.mwg.Constants.CACHE_MISS_ERROR)},e.prototype.type=function(t){var e=this._resolver.resolveState(this);return null!=e?e.getType(this._resolver.stringToHash(t,!1)):-1},e.prototype.removeProperty=function(e){this.setProperty(e,t.mwg.Type.INT,null)},e.prototype.rel=function(t,e){if(null!=e){var n=this._resolver.resolveState(this);if(null!=n)if(n=n.get(this._resolver.stringToHash(t,!1)),null==n||0==n.size())e([]);else{for(var r=n.size(),i=Array(r),o=this._graph.newCounter(r),s=new Int32Array(1),a=0;a<r;a++)this._resolver.lookup(this._world,this._time,n.get(a),function(t){null!=t&&(i[s[0]]=t,s[0]++),o.count()});o.then(function(){if(s[0]==i.length)e(i);else{var t=Array(s[0]);java.lang.System.arraycopy(i,0,t,0,t.length),e(t)}})}else e([])}},e.prototype.add=function(e,n){if(null!=n){var r=this._resolver.alignState(this),i=this._resolver.stringToHash(e,!0);if(null==r)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);r.getOrCreate(i,t.mwg.Type.RELATION).add(n.id())}},e.prototype.remove=function(e,n){if(null!=n){var r=this._resolver.alignState(this),i=this._resolver.stringToHash(e,!1);if(null==r)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);r=r.get(i),null!=r&&r.remove(n.id())}},e.prototype.free=function(){this._resolver.freeNode(this)},e.prototype.timeDephasing=function(){var e=this._resolver.resolveState(this);if(null!=e)return this._time-e.time();throw Error(t.mwg.Constants.CACHE_MISS_ERROR)},e.prototype.lastModification=function(){var e=this._resolver.resolveState(this);if(null!=e)return e.time();throw Error(t.mwg.Constants.CACHE_MISS_ERROR)},e.prototype.rephase=function(){this._resolver.alignState(this)},e.prototype.timepoints=function(t,e,n){this._resolver.resolveTimepoints(this,t,e,n)},e.prototype.jump=function(t,e){this._resolver.lookup(this._world,t,this._id,e)},e.prototype.findByQuery=function(e,n){var r=this._resolver.resolveState(this);if(null==r)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);var i=e.indexName();if(null==i)throw Error("Please specify indexName in query before first use!");var o=e.world();o==t.mwg.Constants.NULL_LONG&&(o=this.world());var s=e.time();if(s==t.mwg.Constants.NULL_LONG&&(s=this.time()),r=r.get(this._resolver.stringToHash(i,!1)),null!=r){var a=this,r=r.get(e.hash());if(null==r)n([]);else{for(var l=Array(r.length),h=this._graph.newCounter(r.length),u=new java.util.concurrent.atomic.AtomicInteger(0),i=0;i<r.length;i++)a._resolver.lookup(o,s,r[i],function(t){null!=t&&(l[u.getAndIncrement()]=t),h.count()});h.then(function(){for(var r=Array(u.get()),i=0,o=0;o<r.length;o++){for(var s=l[o],h=a._resolver.resolveState(s),c=!0,p=0;p<e.attributes().length;p++){var m=h.get(e.attributes()[p]);if(null==e.values()[p]){if(null!=m){c=!1;break}}else{if(null==m){c=!1;break}if(m instanceof Float64Array){if(!(e.values()[p]instanceof Float64Array)){c=!1;break}if(!t.mwg.Constants.longArrayEquals(e.values()[p],m)){c=!1;break}}else if(!t.mwg.Constants.equals(e.values()[p].toString(),m.toString())){c=!1;break}}}c&&(r[i]=s,i++)}r.length==i?n(r):(o=Array(i),java.lang.System.arraycopy(r,0,o,0,i),n(o))})}}else n([])},e.prototype.find=function(t,e,n){var r=this._graph.newQuery();r.setWorld(this.world()),r.setTime(this.time()),r.setIndexName(t),r.parse(e),this.findByQuery(r,n)},e.prototype.findAll=function(e,n){var r=this,i=this._resolver.resolveState(this);if(null==i)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);if(i=i.get(this._resolver.stringToHash(e,!1)),null!=i){var o=this,s=i.size(),a=Array(s),l=this._graph.newCounter(s),h=new java.util.concurrent.atomic.AtomicInteger(0);i.each(function(t,e){o._resolver.lookup(r.world(),r.time(),e,function(t){a[h.getAndIncrement()]=t,l.count()})}),l.then(function(){if(h.get()==a.length)n(a);else{var t=Array(h.get());java.lang.System.arraycopy(a,0,t,0,t.length),n(t)}})}else n([])},e.prototype.index=function(e,n,r,i){r=r.split(t.mwg.Constants.QUERY_SEP+"");var o=this._resolver.alignState(this);if(null==o)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);e=o.getOrCreate(this._resolver.stringToHash(e,!0),t.mwg.Type.LONG_TO_LONG_ARRAY_MAP);for(var o=this._graph.newQuery(),s=this._resolver.resolveState(n),a=0;a<r.length;a++){var l=s.getFromKey(r[a]);null!=l?o.add(r[a],l.toString()):o.add(r[a],null)}e.put(o.hash(),n.id()),t.mwg.Constants.isDefined(i)&&i(!0)},e.prototype.unindex=function(e,n,r,i){r=r.split(t.mwg.Constants.QUERY_SEP+"");var o=this._resolver.alignState(this);if(null==o)throw Error(t.mwg.Constants.CACHE_MISS_ERROR);if(e=o.get(this._resolver.stringToHash(e,!1)),null!=e){for(var o=this._graph.newQuery(),s=this._resolver.resolveState(n),a=0;a<r.length;a++){var l=r[a],h=s.getFromKey(l);null!=h?o.add(l,h.toString()):o.add(l,null)}e.remove(o.hash(),n.id())}t.mwg.Constants.isDefined(i)&&i(!0)},e.prototype.isNaN=function(t){return isNaN(t)},e.prototype.toString=function(){var e=this,n=new java.lang.StringBuilder;n.append('{"world":'),n.append(this.world()),n.append(',"time":'),n.append(this.time()),n.append(',"id":'),n.append(this.id());var r=this._resolver.resolveState(this);return null!=r&&(r.each(function(r,i,o){if(null!=o)switch(i){case t.mwg.Type.BOOL:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),o?n.append("0"):n.append("1");break;case t.mwg.Type.STRING:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append('"'),n.append(o),n.append('"');break;case t.mwg.Type.LONG:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append(o);break;case t.mwg.Type.INT:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append(o);break;case t.mwg.Type.DOUBLE:e.isNaN(o)||(n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append(o));break;case t.mwg.Type.DOUBLE_ARRAY:for(n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("["),r=0;r<o.length;r++)0!=r&&n.append(","),n.append(o[r]);n.append("]");break;case t.mwg.Type.RELATION:for(n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("["),r=0;r<o.size();r++)0!=r&&n.append(","),n.append(o.get(r));n.append("]");break;case t.mwg.Type.LONG_ARRAY:for(n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("["),r=0;r<o.length;r++)0!=r&&n.append(","),n.append(o[r]);n.append("]");break;case t.mwg.Type.INT_ARRAY:for(n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("["),r=0;r<o.length;r++)0!=r&&n.append(","),n.append(o[r]);n.append("]");break;case t.mwg.Type.LONG_TO_LONG_MAP:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("{");var s=[!0];o.each(function(t,e){s[0]?s[0]=!1:n.append(","),n.append('"'),n.append(t),n.append('":'),n.append(e)}),n.append("}");break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("{");var s=[!0],a=new java.util.HashSet;o.each(function(t,e){a.add(t)}),i=a.toArray(Array(a.size()));for(var l=0;l<i.length;l++){var h=o.get(i[l]);for(s[0]?s[0]=!1:n.append(","),n.append('"'),n.append(i[l]),n.append('":['),r=0;r<h.length;r++)0!=r&&n.append(","),n.append(h[r]);n.append("]")}n.append("}");break;case t.mwg.Type.STRING_TO_LONG_MAP:n.append(',"'),n.append(e._resolver.hashToString(r)),n.append('":'),n.append("{"),s=[!0],o.each(function(t,e){s[0]?s[0]=!1:n.append(","),n.append('"'),n.append(t),n.append('":'),n.append(e)}),n.append("}")}}),n.append("}")),n.toString()},e.prototype.getOrCreateRel=function(e){return this.getOrCreate(e,t.mwg.Type.RELATION)},e.prototype.getByIndex=function(t){return this._resolver.resolveState(this).get(t)},e.prototype.setPropertyByIndex=function(t,e,n){this._resolver.alignState(this).set(t,e,n)},e}();e.AbstractNode=n,n=function(){function t(){this._nodeTypes=new java.util.HashMap,this._taskActions=new java.util.HashMap}return t.prototype.declareNodeType=function(t,e){return this._nodeTypes.put(t,e),this},t.prototype.declareTaskAction=function(t,e){return this._taskActions.put(t,e),this},t.prototype.declareMemoryFactory=function(t){return this._memoryFactory=t,this},t.prototype.declareResolverFactory=function(t){return this._resolverFactory=t,this},t.prototype.hookFactory=function(){return this._hookFactory},t.prototype.declareTaskHookFactory=function(t){return this._hookFactory=t,this},t.prototype.nodeTypes=function(){return this._nodeTypes.keySet().toArray(Array(this._nodeTypes.size()))},t.prototype.nodeType=function(t){return this._nodeTypes.get(t)},t.prototype.taskActionTypes=function(){return this._taskActions.keySet().toArray(Array(this._taskActions.size()))},t.prototype.taskActionType=function(t){return this._taskActions.get(t)},t.prototype.memoryFactory=function(){return this._memoryFactory},t.prototype.resolverFactory=function(){return this._resolverFactory},t}(),e.AbstractPlugin=n,n=function(){function t(){
this._next=null}return t.prototype.setNext=function(t){this._next=t},t.prototype.next=function(){return this._next},t}(),e.AbstractTaskAction=n,n=function(){function t(){}return t.SAME_THREAD=0,t.ANY_LOCAL_THREAD=1,t.OTHER_LOCAL_THREAD=2,t.ANY_REMOTE_THREAD=3,t}(),e.SchedulerAffinity=n}(e.plugin||(e.plugin={})),function(e){var n=function(){function e(){}return e.newTask=function(){return null==t.mwg.task.Actions._internalBuilder&&(t.mwg.task.Actions._internalBuilder=new t.mwg.core.Builder),t.mwg.task.Actions._internalBuilder.newTask()},e.setWorld=function(e){return t.mwg.task.Actions.newTask().setWorld(e)},e.setTime=function(e){return t.mwg.task.Actions.newTask().setTime(e)},e.then=function(e){return t.mwg.task.Actions.newTask().then(e)},e.inject=function(e){return t.mwg.task.Actions.newTask().inject(e)},e.fromVar=function(e){return t.mwg.task.Actions.newTask().fromVar(e)},e.fromVarAt=function(e,n){return t.mwg.task.Actions.newTask().fromVarAt(e,n)},e.fromIndexAll=function(e){return t.mwg.task.Actions.newTask().fromIndexAll(e)},e.fromIndex=function(e,n){return t.mwg.task.Actions.newTask().fromIndex(e,n)},e.parse=function(e){return t.mwg.task.Actions.newTask().parse(e)},e.asGlobalVar=function(e){return t.mwg.task.Actions.newTask().asGlobalVar(e)},e.addToGlobalVar=function(e){return t.mwg.task.Actions.newTask().addToGlobalVar(e)},e.asVar=function(e){return t.mwg.task.Actions.newTask().asGlobalVar(e)},e.addToVar=function(e){return t.mwg.task.Actions.newTask().addToVar(e)},e.map=function(e){return t.mwg.task.Actions.newTask().map(e)},e.selectWith=function(e,n){return t.mwg.task.Actions.newTask().selectWith(e,n)},e.selectWithout=function(e,n){return t.mwg.task.Actions.newTask().selectWithout(e,n)},e.select=function(e){return t.mwg.task.Actions.newTask().select(e)},e.selectObject=function(e){return t.mwg.task.Actions.newTask().selectObject(e)},e.traverse=function(e){return t.mwg.task.Actions.newTask().traverse(e)},e.get=function(e){return t.mwg.task.Actions.newTask().get(e)},e.traverseIndex=function(e,n){return t.mwg.task.Actions.newTask().traverseIndex(e,n)},e.traverseOrKeep=function(e){return t.mwg.task.Actions.newTask().traverseOrKeep(e)},e.traverseIndexAll=function(e){return t.mwg.task.Actions.newTask().traverseIndexAll(e)},e.loop=function(e,n,r){return t.mwg.task.Actions.newTask().loop(e,n,r)},e.loopPar=function(e,n,r){return t.mwg.task.Actions.newTask().loopPar(e,n,r)},e.print=function(e){return t.mwg.task.Actions.newTask().print(e)},e.setProperty=function(e,n,r){return t.mwg.task.Actions.newTask().setProperty(e,n,r)},e.selectWhere=function(e){return t.mwg.task.Actions.newTask().selectWhere(e)},e.foreach=function(e){return t.mwg.task.Actions.newTask().foreach(e)},e.foreachPar=function(e){return t.mwg.task.Actions.newTask().foreachPar(e)},e.math=function(e){return t.mwg.task.Actions.newTask().math(e)},e.action=function(e,n){return t.mwg.task.Actions.newTask().action(e,n)},e.remove=function(e,n){return t.mwg.task.Actions.newTask().remove(e,n)},e.add=function(e,n){return t.mwg.task.Actions.newTask().add(e,n)},e.jump=function(e){return t.mwg.task.Actions.newTask().jump(e)},e.removeProperty=function(e){return t.mwg.task.Actions.newTask().removeProperty(e)},e.newNode=function(){return t.mwg.task.Actions.newTask().newNode()},e.newTypedNode=function(e){return t.mwg.task.Actions.newTask().newTypedNode(e)},e.save=function(){return t.mwg.task.Actions.newTask().save()},e.ifThen=function(e,n){return t.mwg.task.Actions.newTask().ifThen(e,n)},e.ifThenElse=function(e,n,r){return t.mwg.task.Actions.newTask().ifThenElse(e,n,r)},e.whileDo=function(e,n){return t.mwg.task.Actions.newTask().whileDo(e,n)},e.doWhile=function(e,n){return t.mwg.task.Actions.newTask().doWhile(e,n)},e.split=function(e){return t.mwg.task.Actions.newTask().split(e)},e.lookup=function(e){return t.mwg.task.Actions.newTask().lookup(e)},e.clear=function(){return t.mwg.task.Actions.newTask().clear()},e.subTask=function(e){return t.mwg.task.Actions.newTask().subTask(e)},e.isolate=function(e){return t.mwg.task.Actions.newTask().isolate(e)},e.subTasks=function(e){return t.mwg.task.Actions.newTask().subTasks(e)},e.subTasksPar=function(e){return t.mwg.task.Actions.newTask().subTasksPar(e)},e.cond=function(e){return t.mwg.task.Actions.newTask().mathConditional(e)},e._internalBuilder=null,e}();e.Actions=n}(e.task||(e.task={})),function(e){var n=function(){function t(){}return t.encodeLongToBuffer=function(e,n){var r=!0,i=e;0>e&&(i=-i);for(var o=47;5<=o;o-=6)r&&0==(i/t.powTwo[o]&63)||(r=!1,n.write(t.dictionary[i/t.powTwo[o]&63]));n.write(t.dictionary[2*(31&i)+(0>e?1:0)])},t.encodeIntToBuffer=function(e,n){var r=!0,i=e;0>e&&(i=-i);for(var o=29;5<=o;o-=6)r&&0==(i/t.powTwo[o]&63)||(r=!1,n.write(t.dictionary[i/t.powTwo[o]&63]));n.write(t.dictionary[2*(31&i)+(0>e?1:0)])},t.decodeToLong=function(e){return t.decodeToLongWithBounds(e,0,e.length())},t.decodeToLongWithBounds=function(e,n,r){for(var i=Long.ZERO,i=i.add(t.longIndexes[255&t.dictionary.indexOf(e.read(r-1))].shiftRightUnsigned(1)),o=1;o<r-n;o++)i=i.add(t.longIndexes[255&t.dictionary.indexOf(e.read(r-1-o))].shiftLeft(6*o-1));return 0!=(1&t.dictionary.indexOf(e.read(r-1)))&&(i=i.mul(-1)),i.toNumber()},t.decodeToInt=function(e){return t.decodeToIntWithBounds(e,0,e.length())},t.decodeToIntWithBounds=function(e,n,r){var i;i=0+(255&t.dictionary.indexOf(e.read(r-1)))/2;for(var o=1;o<r-n;o++)i+=(255&t.dictionary.indexOf(e.read(r-1-o)))*t.powTwo[6*o-1];return 0!=(1&t.dictionary.indexOf(e.read(r-1)))&&(i=-i),i},t.encodeDoubleToBuffer=function(e,n){var r=[],i=new Float64Array(1),o=new Uint8Array(i.buffer);for(i[0]=e,i=2048*(o[7]/128&1)+((16*(127&o[7])|o[6]/16)-1023+1023),r.push(t.dictionary[i/64&63]),r.push(t.dictionary[63&i]),r.push(t.dictionary[15&o[6]]),r.push(t.dictionary[o[5]/4&63]),r.push(t.dictionary[16*(3&o[5])|o[4]/16]),r.push(t.dictionary[4*(15&o[4])|o[3]/64]),r.push(t.dictionary[63&o[3]]),r.push(t.dictionary[o[2]/4&63]),r.push(t.dictionary[16*(3&o[2])|o[1]/16]),r.push(t.dictionary[4*(15&o[1])|o[0]/64]),r.push(t.dictionary[63&o[0]]),o=r.length;3<=o&&65==r[s];)o--;for(var s=0;s<o;s++)n.write(r[s])},t.decodeToDouble=function(e){return t.decodeToDoubleWithBounds(e,0,e.length())},t.decodeToDoubleWithBounds=function(e,n,r){for(var i=64*(255&t.dictionary.indexOf(e.read(n)))+(255&t.dictionary.indexOf(e.read(n+1))),o=0!=(2048&i)?-1:1,i=2047&i,s=0,a=2;a<r-n;a++)s+=(255&t.dictionary.indexOf(e.read(n+a)))*t.powTwo[48-6*(a-2)];return 0!=i?o*Math.pow(2,i-1023)*(1+s/Math.pow(2,52)):o*Math.pow(2,-1022)*(0+s/Math.pow(2,52))},t.encodeBoolArrayToBuffer=function(e,n){for(var r=0,i=0;i<e.length;i++)r|=(e[i]?1:0)*t.powTwo[i%6],(5==i%6||i==e.length-1)&&(n.write(t.dictionary[r]),r=0)},t.decodeBoolArray=function(e,n){return t.decodeToBoolArrayWithBounds(e,0,e.length(),n)},t.decodeToBoolArrayWithBounds=function(e,n,r,i){for(var o=[],s=0;s<r-n;s++)for(var a=255&t.dictionary.indexOf(e.read(n+s)),l=0;6>l&&6*s+l<i;l++)o[6*s+l]=0!=(a&1*t.powTwo[l]);return o},t.encodeStringToBuffer=function(e,n){for(var r,i=e.length,o=0,s=6,a=0;a<i;a++)r=e.charCodeAt(a),6==s?(n.write(t.dictionary[r/4&63]),o=16*(3&r),s=4):4==s?(n.write(t.dictionary[63&(o|r/16&15)]),o=4*(15&r),s=2):2==s&&(n.write(t.dictionary[63&(o|r/64&3)]),n.write(t.dictionary[63&r]),s=6);6!=s&&n.write(t.dictionary[o])},t.decodeString=function(e){return t.decodeToStringWithBounds(e,0,e.length())},t.decodeToStringWithBounds=function(e,n,r){for(var i="",o=0,s=8,a=n;a<r;a++)n=t.dictionary.indexOf(e.read(a)),8==s?(o=4*n,s=2):2==s?(i+=String.fromCharCode(o|n/16),o=16*(15&n),s=4):4==s?(i+=String.fromCharCode(o|n/4),o=64*(3&n),s=6):6==s&&(i+=String.fromCharCode(o|n),s=8);return i},t.dictionary=[65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,48,49,50,51,52,53,54,55,56,57,43,47],t.powTwo={0:1,1:2,2:4,3:8,4:16,5:32,6:64,7:128,8:256,9:512,10:1024,11:2048,12:4096,13:8192,14:16384,15:32768,16:65536,17:131072,18:262144,19:524288,20:1048576,21:2097152,22:4194304,23:8388608,24:16777216,25:33554432,26:67108864,27:134217728,28:268435456,29:536870912,30:1073741824,31:2147483648,32:4294967296,33:8589934592,34:17179869184,35:34359738368,36:68719476736,37:137438953472,38:274877906944,39:549755813888,40:1099511627776,41:2199023255552,42:4398046511104,43:8796093022208,44:17592186044416,45:35184372088832,46:70368744177664,47:0x800000000000,48:281474976710656,49:562949953421312,50:0x4000000000000,51:0x8000000000000,52:4503599627370496,53:9007199254740992},t.longIndexes=[Long.fromNumber(0),Long.fromNumber(1),Long.fromNumber(2),Long.fromNumber(3),Long.fromNumber(4),Long.fromNumber(5),Long.fromNumber(6),Long.fromNumber(7),Long.fromNumber(8),Long.fromNumber(9),Long.fromNumber(10),Long.fromNumber(11),Long.fromNumber(12),Long.fromNumber(13),Long.fromNumber(14),Long.fromNumber(15),Long.fromNumber(16),Long.fromNumber(17),Long.fromNumber(18),Long.fromNumber(19),Long.fromNumber(20),Long.fromNumber(21),Long.fromNumber(22),Long.fromNumber(23),Long.fromNumber(24),Long.fromNumber(25),Long.fromNumber(26),Long.fromNumber(27),Long.fromNumber(28),Long.fromNumber(29),Long.fromNumber(30),Long.fromNumber(31),Long.fromNumber(32),Long.fromNumber(33),Long.fromNumber(34),Long.fromNumber(35),Long.fromNumber(36),Long.fromNumber(37),Long.fromNumber(38),Long.fromNumber(39),Long.fromNumber(40),Long.fromNumber(41),Long.fromNumber(42),Long.fromNumber(43),Long.fromNumber(44),Long.fromNumber(45),Long.fromNumber(46),Long.fromNumber(47),Long.fromNumber(48),Long.fromNumber(49),Long.fromNumber(50),Long.fromNumber(51),Long.fromNumber(52),Long.fromNumber(53),Long.fromNumber(54),Long.fromNumber(55),Long.fromNumber(56),Long.fromNumber(57),Long.fromNumber(58),Long.fromNumber(59),Long.fromNumber(60),Long.fromNumber(61),Long.fromNumber(62),Long.fromNumber(63)],t}();e.Base64=n,n=function(){function t(t,e,n){this._origin=t,this._initPos=e,this._endPos=n}return t.prototype.write=function(t){throw Error("Write operation forbidden during iteration")},t.prototype.writeAll=function(t){throw Error("Write operation forbidden during iteration")},t.prototype.read=function(t){if(this._initPos+t>this._endPos)throw Error(""+t);return this._origin.read(this._initPos+t)},t.prototype.data=function(){return this._origin.slice(this._initPos,this._endPos)},t.prototype.length=function(){return this._endPos-this._initPos+1},t.prototype.free=function(){throw Error("Free operation forbidden during iteration")},t.prototype.iterator=function(){throw Error("iterator creation forbidden forbidden during iteration")},t.prototype.removeLast=function(){throw Error("Write operation forbidden during iteration")},t.prototype.slice=function(t,e){throw Error("Write operation forbidden during iteration")},t}(),e.BufferView=n,n=function(){function e(t){this._cursor=-1,this._origin=t,this._originSize=t.length()}return e.prototype.hasNext=function(){return 0<this._originSize&&this._cursor+1<this._originSize},e.prototype.next=function(){for(var e=this._cursor;this._cursor+1<this._originSize;)if(this._cursor++,this._origin.read(this._cursor)==t.mwg.Constants.BUFFER_SEP)return new t.mwg.utility.BufferView(this._origin,e+1,this._cursor-1);return e<this._originSize?new t.mwg.utility.BufferView(this._origin,e+1,this._cursor):null},e}(),e.DefaultBufferIterator=n,n=function(){function e(){this.checkers=new java.util.HashMap}return e.prototype.asBool=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.BOOL)throw Error("Property "+e+" should be Boolean value, currently "+r)}})},e.prototype.asString=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.STRING)throw Error("Property "+e+" should be String value, currently "+r)}})},e.prototype.asLong=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.LONG&&n!=t.mwg.Type.INT)throw Error("Property "+e+" should be long value, currently "+r)}})},e.prototype.asLongWithin=function(e,n,r){return this.declare(e,{check:function(i,o){if(null!=o&&(i!=t.mwg.Type.LONG&&i!=t.mwg.Type.INT||o<n||o>r))throw Error("Property "+e+" should be long value ["+n+","+r+"], currently "+o)}})},e.prototype.asDouble=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.DOUBLE&&n!=t.mwg.Type.INT&&n!=t.mwg.Type.LONG)throw Error("Property "+e+" should be double value, currently "+r)}})},e.prototype.asDoubleWithin=function(e,n,r){return this.declare(e,{check:function(i,o){if(null!=o&&(i!=t.mwg.Type.DOUBLE&&i!=t.mwg.Type.INT&&i!=t.mwg.Type.LONG||o<n||o>r))throw Error("Property "+e+" should be double value ["+n+","+r+"], currently "+o)}})},e.prototype.asInt=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.INT&&n!=t.mwg.Type.LONG)throw Error("Property "+e+" should be integer value, currently "+r)}})},e.prototype.asIntWithin=function(e,n,r){return this.declare(e,{check:function(i,o){if(null!=o&&(i!=t.mwg.Type.INT&&i!=t.mwg.Type.LONG||o<n||o>r))throw Error("Property "+e+" should be integer value ["+n+","+r+"], currently "+o)}})},e.prototype.asIntGreaterOrEquals=function(e,n){return this.declare(e,{check:function(r,i){if(null!=i&&(r!=t.mwg.Type.INT&&r!=t.mwg.Type.LONG||i<n))throw Error("Property "+e+" should be integer value >="+n+", currently "+i)}})},e.prototype.asDoubleArray=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.DOUBLE_ARRAY)throw Error("Property "+e+" should be doubleArray value, currently "+r)}})},e.prototype.asPositiveInt=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&n!=t.mwg.Type.INT||0>=r)throw Error("Property "+e+" should be a positive integer, currently "+r)}})},e.prototype.asNonNegativeDouble=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&(n!=t.mwg.Type.DOUBLE&&n!=t.mwg.Type.INT&&n!=t.mwg.Type.LONG||!(0<=r)))throw Error("Property "+e+" should be a non-negative double, currently "+r)}})},e.prototype.asPositiveDouble=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&(n!=t.mwg.Type.DOUBLE&&n!=t.mwg.Type.INT&&n!=t.mwg.Type.LONG||!(0<r)))throw Error("Property "+e+" should be a positive double, currently "+r)}})},e.prototype.asNonNegativeOrNanDouble=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&(n!=t.mwg.Type.DOUBLE&&n!=t.mwg.Type.INT&&n!=t.mwg.Type.LONG||0>r))throw Error("Property "+e+" should be a positive double, currently "+r)}})},e.prototype.asPositiveLong=function(e){return this.declare(e,{check:function(n,r){if(null!=r&&(n!=t.mwg.Type.LONG&&n!=t.mwg.Type.INT||0>=r))throw Error("Property "+e+" should be a positive long, currently "+r)}})},e.prototype.declare=function(t,e){return this.checkers.put(t,e),this},e.prototype.check=function(t,e,n){t=this.checkers.get(t),null!=t&&t.check(e,n)},e}(),e.Enforcer=n,n=function(){function e(){}return e.longHash=function(e,n){if(0>=n)throw Error("Max must be > 0");var r=t.mwg.utility.HashHelper.PRIME5,r=r.add(e),r=r.add(r.shiftLeft(17)),r=r.mul(t.mwg.utility.HashHelper.PRIME4),r=r.mul(t.mwg.utility.HashHelper.PRIME1),r=r.add(e),r=r.add(r.shiftLeft(17)),r=r.mul(t.mwg.utility.HashHelper.PRIME4),r=r.mul(t.mwg.utility.HashHelper.PRIME1),r=r.add(t.mwg.utility.HashHelper.len),r=r.xor(r.shiftRightUnsigned(15)),r=r.mul(t.mwg.utility.HashHelper.PRIME2),r=r.add(e),r=r.xor(r.shiftRightUnsigned(13)),r=r.mul(t.mwg.utility.HashHelper.PRIME3),r=r.xor(r.shiftRightUnsigned(16)),r=r.isNegative()?r.mul(-1):r,r=r.mod(n);return r.toNumber()},e.tripleHash=function(e,n,r,i,o){if(0>=o)throw Error("Max must be > 0");var s=t.mwg.utility.HashHelper.PRIME5,a=s.mul(t.mwg.utility.HashHelper.PRIME2).add(t.mwg.utility.HashHelper.len),l=a.mul(t.mwg.utility.HashHelper.PRIME3),h=l.mul(t.mwg.utility.HashHelper.PRIME4),s=s.shiftLeft(13).or(s.shiftRightUnsigned(51)).add(Long.fromNumber(n,!1)),a=a.shiftLeft(11).or(a.shiftRightUnsigned(53)).add(Long.fromNumber(r,!1)),l=l.shiftLeft(17).or(l.shiftRightUnsigned(47)).add(Long.fromNumber(i,!1)),h=h.shiftLeft(19).or(h.shiftRightUnsigned(45)).add(Long.fromNumber(e,!1)),s=s.add(s.shiftLeft(17).or(s.shiftRightUnsigned(47))),a=a.add(a.shiftLeft(19).or(a.shiftRightUnsigned(45))),l=l.add(l.shiftLeft(13).or(l.shiftRightUnsigned(51))),h=h.add(h.shiftLeft(11).or(h.shiftRightUnsigned(53))),s=s.mul(t.mwg.utility.HashHelper.PRIME1).add(Long.fromNumber(n,!1)),a=a.mul(t.mwg.utility.HashHelper.PRIME1).add(Long.fromNumber(r,!1)),l=l.mul(t.mwg.utility.HashHelper.PRIME1).add(Long.fromNumber(i,!1)),h=h.mul(t.mwg.utility.HashHelper.PRIME1).add(t.mwg.utility.HashHelper.PRIME5),s=s.mul(t.mwg.utility.HashHelper.PRIME2),a=a.mul(t.mwg.utility.HashHelper.PRIME2),l=l.mul(t.mwg.utility.HashHelper.PRIME2),h=h.mul(t.mwg.utility.HashHelper.PRIME2),s=s.add(s.shiftLeft(11).or(s.shiftRightUnsigned(53))),a=a.add(a.shiftLeft(17).or(a.shiftRightUnsigned(47))),l=l.add(l.shiftLeft(19).or(l.shiftRightUnsigned(45))),h=h.add(h.shiftLeft(13).or(h.shiftRightUnsigned(51))),s=s.mul(t.mwg.utility.HashHelper.PRIME3),a=a.mul(t.mwg.utility.HashHelper.PRIME3),l=l.mul(t.mwg.utility.HashHelper.PRIME3),h=h.mul(t.mwg.utility.HashHelper.PRIME3);return e=s.add(a.shiftLeft(3).or(a.shiftRightUnsigned(61))),e=e.add(l.shiftLeft(6).or(l.shiftRightUnsigned(58))),e=e.add(h.shiftLeft(9).or(h.shiftRightUnsigned(55))),e=e.xor(e.shiftRightUnsigned(11)),e=e.add(t.mwg.utility.HashHelper.PRIME4.add(t.mwg.utility.HashHelper.len).mul(t.mwg.utility.HashHelper.PRIME1)),e=e.xor(e.shiftRightUnsigned(15)),e=e.mul(t.mwg.utility.HashHelper.PRIME2),e=e.xor(e.shiftRightUnsigned(13)),e=e.isNegative()?e.mul(-1):e,e=e.mod(o),e.toNumber()},e.rand=function(){return 1e6*Math.random()},e.equals=function(t,e){return t===e},e.DOUBLE_MIN_VALUE=function(){return Number.MIN_VALUE},e.DOUBLE_MAX_VALUE=function(){return Number.MAX_VALUE},e.isDefined=function(t){return void 0!=t&&null!=t},e.hash=function(e){for(var n=t.mwg.utility.HashHelper.HSTART,r=e.length,i=0;i<r;i++)n=n.mul(t.mwg.utility.HashHelper.HMULT).xor(t.mwg.utility.HashHelper.byteTable[255&e.charCodeAt(i)]);return n.mod(t.mwg.core.CoreConstants.END_OF_TIME).toNumber()},e.hashBytes=function(e){for(var n=t.mwg.utility.HashHelper.HSTART,r=e.length,i=0;i<r;i++)n=n.mul(t.mwg.utility.HashHelper.HMULT).xor(t.mwg.utility.HashHelper.byteTable[255&e[i]]);return n.mod(t.mwg.core.CoreConstants.END_OF_TIME).toNumber()},e.PRIME1=Long.fromNumber(2654435761,!1),e.PRIME2=Long.fromNumber(2246822519,!1),e.PRIME3=Long.fromNumber(3266489917,!1),e.PRIME4=Long.fromNumber(668265263,!1),e.PRIME5=Long.fromNumber(374761393,!1),e.len=24,e.byteTable=function(){for(var t=[],e=Long.fromBits(3400472196,1414213562),n=0;256>n;n++){for(var r=0;31>r;r++)e=e.shiftRightUnsigned(7).xor(e),e=e.shiftLeft(11).xor(e),e=e.shiftRightUnsigned(10).xor(e);t[n]=e.toSigned()}return t}(),e.HSTART=Long.fromBits(2718281828,3141592653),e.HMULT=Long.fromBits(3776338029,1784494570),e}(),e.HashHelper=n,n=function(){function e(){}return e.keyToBuffer=function(e,n,r,i,o){e.write(n),e.write(t.mwg.Constants.KEY_SEP),t.mwg.utility.Base64.encodeLongToBuffer(r,e),e.write(t.mwg.Constants.KEY_SEP),t.mwg.utility.Base64.encodeLongToBuffer(i,e),e.write(t.mwg.Constants.KEY_SEP),t.mwg.utility.Base64.encodeLongToBuffer(o,e)},e}(),e.KeyHelper=n,n=function(){function t(){this.ctxIdents=new java.util.HashMap}return t.prototype.start=function(t){this.ctxIdents.put(t,0),console.log("StartTask:"+t)},t.prototype.beforeAction=function(t,e){for(var n=this.ctxIdents.get(e),r=0;r<n;r++)console.log("\t");console.log(e.template(t.toString()))},t.prototype.afterAction=function(t,e){},t.prototype.beforeTask=function(t,e){var n=this.ctxIdents.get(t);this.ctxIdents.put(e,n+1)},t.prototype.afterTask=function(t){this.ctxIdents.remove(t)},t.prototype.end=function(t){console.log("EndTask:"+t.toString())},t}(),e.VerboseHook=n,n=function(){function e(){}return e.prototype.newHook=function(){return new t.mwg.utility.VerboseHook},e}(),e.VerboseHookFactory=n,n=function(e){function n(){e.call(this),this.declareTaskHookFactory(new t.mwg.utility.VerboseHookFactory)}return __extends(n,e),n}(t.mwg.plugin.AbstractPlugin),e.VerbosePlugin=n}(e.utility||(e.utility={}))}(t.mwg||(t.mwg={}))}(org||(org={})),function(t){!function(e){!function(e){var n=function(){function e(){this.prefix=0}return e.prototype.get=function(e,n){for(var r=this._graph.newBuffer(),i=e.iterator(),o=!0;i.hasNext();)i.next(),o?o=!1:r.write(t.mwg.core.CoreConstants.BUFFER_SEP);n(r)},e.prototype.put=function(t,e){null!=e&&e(!0)},e.prototype.remove=function(t,e){e(!0)},e.prototype.connect=function(t,e){this._graph=t,e(!0)},e.prototype.lock=function(e){var n=this._graph.newBuffer();t.mwg.utility.Base64.encodeIntToBuffer(this.prefix,n),this.prefix++,e(n)},e.prototype.unlock=function(t,e){e(!0)},e.prototype.disconnect=function(t){this._graph=null,t(!0)},e}();e.BlackHoleStorage=n,n=function(){function e(){}return e.prototype.newGraph=function(e,n,r,i,o){return null==e&&(e=new t.mwg.core.BlackHoleStorage),n&&(e=new t.mwg.core.utility.ReadOnlyStorage(e)),n=r,null==n&&(n=new t.mwg.core.scheduler.TrampolineScheduler),-1==o&&(o=1e5),new t.mwg.core.CoreGraph(e,o,n,i)},e.prototype.newTask=function(){return new t.mwg.core.task.CoreTask},e}(),e.Builder=n,n=function(e){function n(){e.apply(this,arguments)}return __extends(n,e),n.PREFIX_TO_SAVE_SIZE=2,n.NULL_KEY=new Float64Array([t.mwg.Constants.END_OF_TIME,t.mwg.Constants.END_OF_TIME,t.mwg.Constants.END_OF_TIME]),n.GLOBAL_UNIVERSE_KEY=new Float64Array([t.mwg.Constants.NULL_LONG,t.mwg.Constants.NULL_LONG,t.mwg.Constants.NULL_LONG]),n.GLOBAL_DICTIONARY_KEY=new Float64Array([t.mwg.Constants.NULL_LONG,0,0]),n.GLOBAL_INDEX_KEY=new Float64Array([t.mwg.Constants.NULL_LONG,1,0]),n.INDEX_ATTRIBUTE="index",n.DISCONNECTED_ERROR="Please connect your graph, prior to any usage of it",n.SCALE_1=1e3,n.SCALE_2=1e4,n.SCALE_3=1e5,n.SCALE_4=1e6,n.DEAD_NODE_ERROR="This Node has been tagged destroyed, please don't use it anymore!",n}(t.mwg.Constants),e.CoreConstants=n,n=function(){function e(e,n,r,i){this._worldKeyCalculator=this._nodeKeyCalculator=this._prefix=null;var o=this,s=null,a=null,l=null;if(null!=i)for(var h=0;h<i.length;h++){var u=i[h],c=u.memoryFactory(),p=u.hookFactory();null!=c&&(s=c),u=u.resolverFactory(),null!=u&&(a=u),null!=p&&(l=p)}if(null==s&&(s=new t.mwg.core.memory.HeapMemoryFactory),null==a&&(a={newResolver:function(e,n){return new t.mwg.core.MWGResolver(e,n,o)}}),this._hookFactory=l,this._storage=e,this._memoryFactory=s,this._space=s.newSpace(n,o),this._resolver=a.newResolver(this._storage,this._space),this._scheduler=r,this._taskActions=new java.util.HashMap,t.mwg.core.task.CoreTask.fillDefault(this._taskActions),null!=i)for(this._nodeTypes=new java.util.HashMap,h=0;h<i.length;h++){for(u=i[h],n=u.nodeTypes(),e=0;e<n.length;e++)r=n[e],this._nodeTypes.put(this._resolver.stringToHash(r,!1),u.nodeType(r));for(n=u.taskActionTypes(),e=0;e<n.length;e++)r=n[e],this._taskActions.put(r,u.taskActionType(r))}else this._nodeTypes=null;this._isConnected=new java.util.concurrent.atomic.AtomicBoolean((!1)),this._lock=new java.util.concurrent.atomic.AtomicBoolean((!1)),this._plugins=i}return e.prototype.fork=function(t){var e=this._worldKeyCalculator.newKey();return this._resolver.initWorld(t,e),e},e.prototype.newNode=function(e,n){if(!this._isConnected.get())throw Error(t.mwg.core.CoreConstants.DISCONNECTED_ERROR);var r=new t.mwg.core.CoreNode(e,n,this._nodeKeyCalculator.newKey(),this);return this._resolver.initNode(r,t.mwg.Constants.NULL_LONG),r},e.prototype.newTypedNode=function(e,n,r){if(null==r)throw Error("nodeType should not be null");if(!this._isConnected.get())throw Error(t.mwg.core.CoreConstants.DISCONNECTED_ERROR);var i=this._resolver.stringToHash(r,!1),o=this.factoryByCode(i);return null==o?(console.log("WARNING: UnKnow NodeType "+r+", missing plugin configuration in the builder ? Using generic node as a fallback"),e=new t.mwg.core.CoreNode(e,n,this._nodeKeyCalculator.newKey(),this)):e=o(e,n,this._nodeKeyCalculator.newKey(),this),this._resolver.initNode(e,i),e},e.prototype.cloneNode=function(e){if(null==e)throw Error("origin node should not be null");if(!this._isConnected.get())throw Error(t.mwg.core.CoreConstants.DISCONNECTED_ERROR);if(e.cacheLock(),e._dead)throw e.cacheUnlock(),Error(t.mwg.core.CoreConstants.DEAD_NODE_ERROR+" node id: "+e.id());this._space.mark(e._index_stateChunk),this._space.mark(e._index_superTimeTree),this._space.mark(e._index_timeTree),this._space.mark(e._index_worldOrder);var n=this._space.get(e._index_worldOrder),n=this.factoryByCode(n.extra()),n=null==n?new t.mwg.core.CoreNode(e.world(),e.time(),e.id(),this):n(e.world(),e.time(),e.id(),this);return n._index_stateChunk=e._index_stateChunk,n._index_timeTree=e._index_timeTree,n._index_superTimeTree=e._index_superTimeTree,n._index_worldOrder=e._index_worldOrder,n._world_magic=e._world_magic,n._super_time_magic=e._super_time_magic,n._time_magic=e._time_magic,e.cacheUnlock(),n},e.prototype.factoryByCode=function(e){return null!=this._nodeTypes&&e!=t.mwg.Constants.NULL_LONG?this._nodeTypes.get(e):null},e.prototype.taskAction=function(t){return null!=this._taskActions&&null!=t?this._taskActions.get(t):null},e.prototype.taskHookFactory=function(){return this._hookFactory},e.prototype.lookup=function(e,n,r,i){if(!this._isConnected.get())throw Error(t.mwg.core.CoreConstants.DISCONNECTED_ERROR);this._resolver.lookup(e,n,r,i)},e.prototype.save=function(t){this._space.save(t)},e.prototype.connect=function(e){for(var n=this,r=this;r._lock.compareAndSet(!1,!0););this._isConnected.compareAndSet(!1,!0)?(r._scheduler.start(),r._storage.connect(r,function(i){r._storage.lock(function(i){n._prefix=t.mwg.utility.Base64.decodeToIntWithBounds(i,0,i.length()),i.free();var o=r.newBuffer();t.mwg.utility.KeyHelper.keyToBuffer(o,t.mwg.chunk.ChunkType.GEN_CHUNK,t.mwg.Constants.BEGINNING_OF_TIME,t.mwg.Constants.NULL_LONG,n._prefix),o.write(t.mwg.core.CoreConstants.BUFFER_SEP),t.mwg.utility.KeyHelper.keyToBuffer(o,t.mwg.chunk.ChunkType.GEN_CHUNK,t.mwg.Constants.END_OF_TIME,t.mwg.Constants.NULL_LONG,n._prefix),o.write(t.mwg.core.CoreConstants.BUFFER_SEP),t.mwg.utility.KeyHelper.keyToBuffer(o,t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,t.mwg.Constants.NULL_LONG),o.write(t.mwg.core.CoreConstants.BUFFER_SEP),t.mwg.utility.KeyHelper.keyToBuffer(o,t.mwg.chunk.ChunkType.STATE_CHUNK,t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[0],t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[1],t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[2]),o.write(t.mwg.core.CoreConstants.BUFFER_SEP),r._storage.get(o,function(i){if(o.free(),null!=i){var s=i.iterator(),a=s.next(),l=s.next(),h=s.next(),u=s.next(),s=!0;try{var c=r._space.createAndMark(t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,t.mwg.Constants.NULL_LONG);0<h.length()&&c.load(h);var p=r._space.createAndMark(t.mwg.chunk.ChunkType.STATE_CHUNK,t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[0],t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[1],t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[2]);if(0<u.length()&&p.load(u),r._worldKeyCalculator=r._space.createAndMark(t.mwg.chunk.ChunkType.GEN_CHUNK,t.mwg.Constants.END_OF_TIME,t.mwg.Constants.NULL_LONG,n._prefix),0<l.length()&&r._worldKeyCalculator.load(l),r._nodeKeyCalculator=r._space.createAndMark(t.mwg.chunk.ChunkType.GEN_CHUNK,t.mwg.Constants.BEGINNING_OF_TIME,t.mwg.Constants.NULL_LONG,n._prefix),0<a.length()&&r._nodeKeyCalculator.load(a),r._resolver.init(),null!=n._plugins)for(a=0;a<n._plugins.length;a++){var m=n._plugins[a].nodeTypes();if(null!=m)for(l=0;l<m.length;l++)r._resolver.stringToHash(m[l],!0)}}catch(g){if(!(g instanceof Error))throw g;console.error(g),s=!1}i.free(),r._lock.set(!0),t.mwg.utility.HashHelper.isDefined(e)&&e(s)}else r._lock.set(!0),t.mwg.utility.HashHelper.isDefined(e)&&e(!1)})})})):(r._lock.set(!0),t.mwg.utility.HashHelper.isDefined(e)&&e(null))},e.prototype.disconnect=function(e){for(;this._lock.compareAndSet(!1,!0););if(this._isConnected.compareAndSet(!0,!1)){var n=this;n._scheduler.stop(),this.save(function(r){if(n._space.freeAll(),null!=n._storage){var i=n.newBuffer();t.mwg.utility.Base64.encodeIntToBuffer(n._prefix,i),n._storage.unlock(i,function(r){i.free(),n._storage.disconnect(function(r){n._lock.set(!0),t.mwg.utility.HashHelper.isDefined(e)&&e(r)})})}else n._lock.set(!0),t.mwg.utility.HashHelper.isDefined(e)&&e(r)})}else this._lock.set(!0),t.mwg.utility.HashHelper.isDefined(e)&&e(null)},e.prototype.newBuffer=function(){return this._memoryFactory.newBuffer()},e.prototype.newQuery=function(){return new t.mwg.core.CoreQuery(this,this._resolver)},e.prototype.index=function(e,n,r,i){if(null==e)throw Error("indexName should not be null");if(null==n)throw Error("toIndexNode should not be null");if(null==r)throw Error("flatKeyAttributes should not be null");this.getIndexOrCreate(n.world(),n.time(),e,!0,function(e){if(null==e)throw Error("Index creation failed, cache is probably full !!!");e.index(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE,n,r,function(n){e.free(),t.mwg.utility.HashHelper.isDefined(i)&&i(n)})})},e.prototype.unindex=function(e,n,r,i){if(null==e)throw Error("indexName should not be null");if(null==n)throw Error("toIndexNode should not be null");if(null==r)throw Error("flatKeyAttributes should not be null");this.getIndexOrCreate(n.world(),n.time(),e,!1,function(e){null!=e?e.unindex(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE,n,r,function(n){e.free(),t.mwg.utility.HashHelper.isDefined(i)&&i(n)}):t.mwg.utility.HashHelper.isDefined(i)&&i(!1)})},e.prototype.indexes=function(e,n,r){var i=this;this._resolver.lookup(e,n,t.mwg.core.CoreConstants.END_OF_TIME,function(e){if(null==e)r([]);else{var n=e.get(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE);if(null==n)e.free(),r([]);else{var o=Array(n.size()),s=new Int32Array([0]);n.each(function(t,e){o[s[0]]=i._resolver.hashToString(t),s[0]++}),e.free(),r(o)}}})},e.prototype.find=function(e,n,r,i,o){if(null==r)throw Error("indexName should not be null");if(null==i)throw Error("query should not be null");this.getIndexOrCreate(e,n,r,!1,function(e){null==e?t.mwg.utility.HashHelper.isDefined(o)&&o([]):e.find(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE,i,function(n){e.free(),t.mwg.utility.HashHelper.isDefined(o)&&o(n)})})},e.prototype.findByQuery=function(e,n){if(null==e)throw Error("query should not be null");if(e.world()==t.mwg.Constants.NULL_LONG)throw Error("Please fill world parameter in query before first usage!");if(e.time()==t.mwg.Constants.NULL_LONG)throw Error("Please fill time parameter in query before first usage!");if(null==e.indexName())throw Error("Please fill indexName parameter in query before first usage!");this.getIndexOrCreate(e.world(),e.time(),e.indexName(),!1,function(r){null==r?t.mwg.utility.HashHelper.isDefined(n)&&n([]):(e.setIndexName(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE),r.findByQuery(e,function(e){r.free(),t.mwg.utility.HashHelper.isDefined(n)&&n(e)}))})},e.prototype.findAll=function(e,n,r,i){if(null==r)throw Error("indexName should not be null");this.getIndexOrCreate(e,n,r,!1,function(e){null==e?t.mwg.utility.HashHelper.isDefined(i)&&i([]):e.findAll(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE,function(n){e.free(),t.mwg.utility.HashHelper.isDefined(i)&&i(n)})})},e.prototype.getIndexNode=function(t,e,n,r){if(null==n)throw Error("indexName should not be null");this.getIndexOrCreate(t,e,n,!1,r)},e.prototype.getIndexOrCreate=function(e,n,r,i,o){var s=this,a=this._resolver.stringToHash(r,i);this._resolver.lookup(e,n,t.mwg.core.CoreConstants.END_OF_TIME,function(r){if(null!=r||i){var l;null==r?(r=new t.mwg.core.CoreNode(e,n,t.mwg.core.CoreConstants.END_OF_TIME,s),s._resolver.initNode(r,t.mwg.core.CoreConstants.NULL_LONG),l=r.getOrCreate(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE,t.mwg.Type.LONG_TO_LONG_MAP)):l=r.get(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE);var h=l.get(a);r.free(),h==t.mwg.core.CoreConstants.NULL_LONG?i?(r=s.newNode(e,n),r.getOrCreate(t.mwg.core.CoreConstants.INDEX_ATTRIBUTE,t.mwg.Type.LONG_TO_LONG_ARRAY_MAP),h=r.id(),l.put(a,h),o(r)):o(null):s._resolver.lookup(e,n,h,o)}else o(null)})},e.prototype.newCounter=function(e){return new t.mwg.core.utility.CoreDeferCounter(e);
},e.prototype.newSyncCounter=function(e){return new t.mwg.core.utility.CoreDeferCounterSync(e)},e.prototype.resolver=function(){return this._resolver},e.prototype.scheduler=function(){return this._scheduler},e.prototype.space=function(){return this._space},e.prototype.storage=function(){return this._storage},e.prototype.freeNodes=function(t){if(null!=t)for(var e=0;e<t.length;e++)null!=t[e]&&t[e].free()},e}(),e.CoreGraph=n,n=function(t){function e(e,n,r,i){t.call(this,e,n,r,i)}return __extends(e,t),e}(t.mwg.plugin.AbstractNode),e.CoreNode=n,n=function(){function e(e,n){this.capacity=1,this._attributes=new Float64Array(this.capacity),this._values=Array(this.capacity),this.size=0,this._time=this._world=t.mwg.Constants.NULL_LONG,this._indexName=null,this._graph=e,this._resolver=n,this._hash=null}return e.prototype.parse=function(e){for(var n=0,r=t.mwg.Constants.NULL_LONG,i=0;n<e.length;)e.charAt(n)==t.mwg.Constants.QUERY_KV_SEP?(-1!=i&&(r=this._resolver.stringToHash(e.substring(i,n).trim(),!1)),i=n+1):e.charAt(n)==t.mwg.Constants.QUERY_SEP&&(r!=t.mwg.Constants.NULL_LONG&&this.internal_add(r,e.substring(i,n).trim()),r=t.mwg.Constants.NULL_LONG,i=n+1),n++;return r!=t.mwg.Constants.NULL_LONG&&this.internal_add(r,e.substring(i,n).trim()),this},e.prototype.add=function(t,e){return this.internal_add(this._resolver.stringToHash(t.trim(),!1),e),this},e.prototype.setWorld=function(t){return this._world=t,this},e.prototype.world=function(){return this._world},e.prototype.setTime=function(t){return this._time=t,this},e.prototype.time=function(){return this._time},e.prototype.setIndexName=function(t){return this._indexName=t,this},e.prototype.indexName=function(){return this._indexName},e.prototype.hash=function(){return null==this._hash&&this.compute(),this._hash},e.prototype.attributes=function(){return this._attributes},e.prototype.values=function(){return this._values},e.prototype.internal_add=function(t,e){if(this.size==this.capacity){var n=2*this.capacity,r=new Float64Array(n),i=Array(n);java.lang.System.arraycopy(this._attributes,0,r,0,this.capacity),java.lang.System.arraycopy(this._values,0,i,0,this.capacity),this._attributes=r,this._values=i,this.capacity=n}this._attributes[this.size]=t,this._values[this.size]=e,this.size++},e.prototype.compute=function(){for(var e=this.size-1;0<=e;e--)for(var n=1;n<=e;n++)if(this._attributes[n-1]>this._attributes[n]){var r=this._attributes[n-1],i=this._values[n-1];this._attributes[n-1]=this._attributes[n],this._values[n-1]=this._values[n],this._attributes[n]=r,this._values[n]=i}for(n=this._graph.newBuffer(),e=0;e<this.size;e++)t.mwg.utility.Base64.encodeLongToBuffer(this._attributes[e],n),null!=this._values[e]&&t.mwg.utility.Base64.encodeStringToBuffer(this._values[e],n);this._hash=t.mwg.utility.HashHelper.hashBytes(n.data()),n.free()},e}(),e.CoreQuery=n,n=function(){function e(t,e,n){this._space=e,this._storage=t,this._graph=n}return e.prototype.init=function(){this.dictionary=this._space.getAndMark(t.mwg.chunk.ChunkType.STATE_CHUNK,t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[0],t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[1],t.mwg.core.CoreConstants.GLOBAL_DICTIONARY_KEY[2]),this.globalWorldOrderChunk=this._space.getAndMark(t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,t.mwg.Constants.NULL_LONG)},e.prototype.typeName=function(t){return this.hashToString(this.typeCode(t))},e.prototype.typeCode=function(e){return e=this._space.get(e._index_worldOrder),null==e?t.mwg.Constants.NULL_LONG:e.extra()},e.prototype.initNode=function(e,n){var r=this._space.createAndMark(t.mwg.chunk.ChunkType.STATE_CHUNK,e.world(),e.time(),e.id());this._space.notifyUpdate(r.index());var i=this._space.createAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,e.world(),t.mwg.Constants.NULL_LONG,e.id());i.insert(e.time());var o=this._space.createAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,e.world(),e.time(),e.id());o.insert(e.time());var s=this._space.createAndMark(t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,e.id());s.put(e.world(),e.time()),n!=t.mwg.Constants.NULL_LONG&&s.setExtra(n),e._index_stateChunk=r.index(),e._index_timeTree=o.index(),e._index_superTimeTree=i.index(),e._index_worldOrder=s.index(),e._world_magic=-1,e._super_time_magic=-1,e._time_magic=-1,e.init()},e.prototype.initWorld=function(t,e){this.globalWorldOrderChunk.put(e,t)},e.prototype.freeNode=function(t){t.cacheLock(),t._dead||(this._space.unmark(t._index_stateChunk),this._space.unmark(t._index_timeTree),this._space.unmark(t._index_superTimeTree),this._space.unmark(t._index_worldOrder),t._dead=!0),t.cacheUnlock()},e.prototype.lookup=function(e,n,r,i){var o=this,s=this;try{s._space.getOrLoadAndMark(t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,r,function(a){if(null==a)i(null);else{var l=s.resolve_world(o.globalWorldOrderChunk,a,n,e);s._space.getOrLoadAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,l,t.mwg.Constants.NULL_LONG,r,function(o){if(null==o)s._space.unmark(a.index()),i(null);else{var h=o.previousOrEqual(n);h==t.mwg.Constants.NULL_LONG?(s._space.unmark(o.index()),s._space.unmark(a.index()),i(null)):s._space.getOrLoadAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,l,h,r,function(h){if(null==h)s._space.unmark(o.index()),s._space.unmark(a.index()),i(null);else{var u=h.previousOrEqual(n);u==t.mwg.Constants.NULL_LONG?(s._space.unmark(h.index()),s._space.unmark(o.index()),s._space.unmark(a.index()),i(null)):s._space.getOrLoadAndMark(t.mwg.chunk.ChunkType.STATE_CHUNK,l,u,r,function(c){if(null==c)s._space.unmark(h.index()),s._space.unmark(o.index()),s._space.unmark(a.index()),i(null);else{var p=a.extra(),m=null;p!=t.mwg.Constants.NULL_LONG&&(m=s._graph.factoryByCode(p)),p=null==m?new t.mwg.core.CoreNode(e,n,r,s._graph):m(e,n,r,s._graph),p._dead=!1,p._index_stateChunk=c.index(),p._index_superTimeTree=o.index(),p._index_timeTree=h.index(),p._index_worldOrder=a.index(),l==e&&u==n?(p._world_magic=-1,p._super_time_magic=-1,p._time_magic=-1):(p._world_magic=a.magic(),p._super_time_magic=o.magic(),p._time_magic=h.magic()),null!=i&&i(p)}})}})}})}})}catch(a){if(!(a instanceof Error))throw a;console.error(a)}},e.prototype.resolve_world=function(e,n,r,i){if(null==e||null==n)return i;for(var o=i,s=t.mwg.Constants.NULL_LONG,a=n.get(o);o!=s;){if(a!=t.mwg.Constants.NULL_LONG&&a<=r)return o;s=o,o=e.get(o),a=n.get(o)}return i},e.prototype.getOrLoadAndMarkAll=function(n,r,i){for(var o=r.length/e.KEY_SIZE,s=[],a=0,l=Array(o),h=0;h<o;h++)r[h*e.KEY_SIZE]==t.mwg.core.CoreConstants.NULL_KEY[0]&&r[h*e.KEY_SIZE+1]==t.mwg.core.CoreConstants.NULL_KEY[1]&&r[h*e.KEY_SIZE+2]==t.mwg.core.CoreConstants.NULL_KEY[2]?(s[h]=!1,l[h]=null):(l[h]=this._space.getAndMark(n[h],r[h*e.KEY_SIZE],r[h*e.KEY_SIZE+1],r[h*e.KEY_SIZE+2]),null==l[h]?(s[h]=!0,a++):s[h]=!1);if(0==a)i(l);else{for(var u=this._graph.newBuffer(),c=new Int32Array(a),h=a=0;h<o;h++)s[h]&&(c[a]=h,0!=a&&u.write(t.mwg.core.CoreConstants.BUFFER_SEP),t.mwg.utility.KeyHelper.keyToBuffer(u,n[h],r[h*e.KEY_SIZE],r[h*e.KEY_SIZE+1],r[h*e.KEY_SIZE+2]),a+=1);var p=this;this._storage.get(u,function(e){u.free();for(var o=e.iterator(),s=0;o.hasNext();){var a=c[s],h=o.next();0<h.length()?(l[a]=p._space.createAndMark(n[a],r[a*t.mwg.core.MWGResolver.KEY_SIZE],r[a*t.mwg.core.MWGResolver.KEY_SIZE+1],r[a*t.mwg.core.MWGResolver.KEY_SIZE+2]),l[a].load(h)):l[a]=null,s++}e.free(),i(l)})}},e.prototype.resolveState=function(t){return this.internal_resolveState(t,!0)},e.prototype.internal_resolveState=function(e,n){var r=null;if(n&&e.cacheLock(),e._dead)throw n&&e.cacheUnlock(),Error(t.mwg.core.CoreConstants.DEAD_NODE_ERROR+" node id: "+e.id());if(-1==e._world_magic&&-1==e._time_magic&&-1==e._super_time_magic)r=this._space.get(e._index_stateChunk);else{var i=this._space.get(e._index_worldOrder),o=this._space.get(e._index_superTimeTree),s=this._space.get(e._index_timeTree);if(null!=i&&null!=o&&null!=s)if(e._world_magic==i.magic()&&e._super_time_magic==o.magic()&&e._time_magic==s.magic())r=this._space.get(e._index_stateChunk);else{n&&i.lock();var r=e.time(),a=e.id(),l=e.world(),l=this.resolve_world(this.globalWorldOrderChunk,i,r,l);if(l!=o.world()){var h=this._space.getAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,l,t.mwg.core.CoreConstants.NULL_LONG,a);null!=h&&(this._space.unmark(o.index()),o=h)}h=o.previousOrEqual(r),h!=s.time()&&(h=this._space.getAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,l,h,a),null!=h&&(this._space.unmark(s.index()),s=h)),h=s.previousOrEqual(r),e._time_magic=s.magic(),e._super_time_magic=o.magic(),r=this._space.get(e._index_stateChunk),l==r.world()&&h==r.time()||(o=this._space.getAndMark(t.mwg.chunk.ChunkType.STATE_CHUNK,l,h,a),null!=o&&(this._space.unmark(r.index()),r=o,e._index_stateChunk=r.index())),n&&i.unlock()}}return n&&e.cacheUnlock(),r},e.prototype.alignState=function(e){if(e.cacheLock(),e._dead)throw e.cacheUnlock(),Error(t.mwg.core.CoreConstants.DEAD_NODE_ERROR+" node id: "+e.id());if(-1==e._world_magic&&-1==e._time_magic&&-1==e._super_time_magic){var n=this._space.get(e._index_stateChunk);if(null!=n)return e.cacheUnlock(),n}if(n=this._space.get(e._index_worldOrder),null==n)return e.cacheUnlock(),null;n.lock();var r=e.world(),i=e.time(),o=e.id(),s=this.internal_resolveState(e,!1);if(-1==e._world_magic&&-1==e._time_magic&&-1==e._super_time_magic)return n.unlock(),e.cacheUnlock(),s;var a=this._space.createAndMark(t.mwg.chunk.ChunkType.STATE_CHUNK,r,i,o);if(a.loadFrom(s),e._world_magic=-1,e._super_time_magic=-1,e._time_magic=-1,e._index_stateChunk=a.index(),this._space.unmark(s.index()),s.world()==r||n.get(r)!=t.mwg.core.CoreConstants.NULL_LONG){var s=this._space.get(e._index_superTimeTree),l=this._space.get(e._index_timeTree),h=s.size(),u=2*t.mwg.core.CoreConstants.SCALE_1;if(h>u&&(u=2*t.mwg.core.CoreConstants.SCALE_2),h>u&&(u=2*t.mwg.core.CoreConstants.SCALE_3),h>u&&(u=2*t.mwg.core.CoreConstants.SCALE_4),l.insert(i),l.size()==u){var c=new Float64Array([-1]);l.range(t.mwg.core.CoreConstants.BEGINNING_OF_TIME,t.mwg.core.CoreConstants.END_OF_TIME,l.size()/2,function(t){c[0]=t});var p=this._space.createAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,r,c[0],o);l.range(t.mwg.core.CoreConstants.BEGINNING_OF_TIME,t.mwg.core.CoreConstants.END_OF_TIME,l.size()/2,function(t){p.unsafe_insert(t)}),this._space.notifyUpdate(p.index()),s.insert(c[0]),l.clearAt(c[0]),i<c[0]?this._space.unmark(p.index()):(e._index_timeTree=p.index(),this._space.unmark(l.index()))}}else s=this._space.createAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,r,t.mwg.core.CoreConstants.NULL_LONG,o),s.insert(i),o=this._space.createAndMark(t.mwg.chunk.ChunkType.TIME_TREE_CHUNK,r,i,o),o.insert(i),n.put(r,i),this._space.unmark(e._index_timeTree),this._space.unmark(e._index_superTimeTree),e._index_timeTree=o.index(),e._index_superTimeTree=s.index();return n.unlock(),e.cacheUnlock(),a},e.prototype.newState=function(e,n,r){return e.cacheLock(),r=new t.mwg.core.CoreNode(n,r,e.id(),e.graph()),r._index_worldOrder=e._index_worldOrder,r._index_superTimeTree=e._index_superTimeTree,r._index_timeTree=e._index_timeTree,r._index_stateChunk=e._index_stateChunk,r._time_magic=e._time_magic,r._super_time_magic=e._super_time_magic,r._world_magic=e._world_magic,n=this.alignState(r),e._index_worldOrder=r._index_worldOrder,e._index_superTimeTree=r._index_superTimeTree,e._index_timeTree=r._index_timeTree,e._index_stateChunk=r._index_stateChunk,e._time_magic=r._time_magic,e._super_time_magic=r._super_time_magic,e._world_magic=r._world_magic,e.cacheUnlock(),n},e.prototype.resolveTimepoints=function(e,n,r,i){var o=this;this._space.getOrLoadAndMark(t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK,0,0,e.id(),function(s){if(null==s)i(new Float64Array(0));else{for(var a=new Int32Array([t.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY]),l=[new Float64Array(a[0])],h=0,u=e.world();u!=t.mwg.core.CoreConstants.NULL_LONG;){var c=s.get(u);if(c!=t.mwg.core.CoreConstants.NULL_LONG){if(c<=n){l[0][h]=u,h++;break}c>r||(l[0][h]=u,h++,h==a[0]&&(c=new Float64Array(2*a[0]),java.lang.System.arraycopy(l[0],0,c,0,a[0]),l[0]=c,a[0]*=2)),u=o.globalWorldOrderChunk.get(u)}else u=o.globalWorldOrderChunk.get(u)}o.resolveTimepointsFromWorlds(o.globalWorldOrderChunk,s,e,n,r,l[0],h,i)}})},e.prototype.resolveTimepointsFromWorlds=function(e,n,r,i,o,s,a,l){var h=this;e=new Float64Array(3*a);for(var u=new Int8Array(a),c=0;c<a;c++)e[3*c]=s[c],e[3*c+1]=t.mwg.core.CoreConstants.NULL_LONG,e[3*c+2]=r.id(),u[c]=t.mwg.chunk.ChunkType.TIME_TREE_CHUNK;this.getOrLoadAndMarkAll(u,e,function(e){if(null==e)h._space.unmark(n.index()),l(new Float64Array(0));else{for(var u=new Int32Array([t.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY]),c=[new Float64Array(u[0])],p=[new Float64Array(u[0])],m=new Int32Array([0]),g=o,f=0;f<a;f++){var _=e[f];if(null!=_){var y=n.get(s[f]),d=g;_.range(y,g,t.mwg.core.CoreConstants.END_OF_TIME,function(t){if(t!=d&&(c[0][m[0]]=t,p[0][m[0]]=_.world(),m[0]++,u[0]==m[0])){t=new Float64Array(2*u[0]);var e=new Float64Array(2*u[0]);java.lang.System.arraycopy(c[0],0,t,0,u[0]),java.lang.System.arraycopy(p[0],0,e,0,u[0]),c[0]=t,p[0]=e,u[0]*=2}}),g=y}h._space.unmark(_.index())}h.resolveTimepointsFromSuperTimes(n,r,i,o,p[0],c[0],m[0],l)}})},e.prototype.resolveTimepointsFromSuperTimes=function(e,n,r,i,o,s,a,l){for(var h=this,u=new Float64Array(3*a),c=new Int8Array(a),p=0;p<a;p++)u[3*p]=o[p],u[3*p+1]=s[p],u[3*p+2]=n.id(),c[p]=t.mwg.chunk.ChunkType.TIME_TREE_CHUNK;this.getOrLoadAndMarkAll(c,u,function(n){if(null==n)h._space.unmark(e.index()),l(new Float64Array(0));else{for(var s=new Int32Array([t.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY]),u=[new Float64Array(s[0])],c=new Int32Array([0]),p=i,m=0;m<a;m++){var g=n[m];if(null!=g){var f=e.get(o[m]);f<r&&(f=r);var _=p;g.range(f,p,t.mwg.core.CoreConstants.END_OF_TIME,function(t){t!=_&&(u[0][c[0]]=t,c[0]++,s[0]==c[0]&&(t=new Float64Array(2*s[0]),java.lang.System.arraycopy(u[0],0,t,0,s[0]),u[0]=t,s[0]*=2))}),m<a-1&&o[m+1]!=o[m]&&(p=f)}h._space.unmark(g.index())}c[0]!=s[0]&&(n=new Float64Array(c[0]),java.lang.System.arraycopy(u[0],0,n,0,c[0]),u[0]=n),h._space.unmark(e.index()),l(u[0])}})},e.prototype.stringToHash=function(e,n){var r=t.mwg.utility.HashHelper.hash(e);if(n){var i=this.dictionary.get(0);null==i&&(i=this.dictionary.getOrCreate(0,t.mwg.Type.STRING_TO_LONG_MAP)),i.containsHash(r)||i.put(e,r)}return r},e.prototype.hashToString=function(t){var e=this.dictionary.get(0);return null!=e?e.getByHash(t):null},e.KEY_SIZE=3,e}(),e.MWGResolver=n,function(e){!function(e){var n=function(){function t(t){this._back=new Int8Array(t)}return t.prototype.get=function(t){return this._back[t]},t.prototype.set=function(t,e){this._back[t]=e},t}();e.HeapAtomicByteArray=n,n=function(){function e(n,r){this._graph=r,this._maxEntries=n,this._hashEntries=n*e.HASH_LOAD_FACTOR,this._lru=new t.mwg.core.chunk.heap.HeapFixedStack(n,(!0)),this._dirtiesStack=new t.mwg.core.chunk.heap.HeapFixedStack(n,(!1)),this._hashNext=new java.util.concurrent.atomic.AtomicIntegerArray(n),this._hash=new java.util.concurrent.atomic.AtomicIntegerArray(this._hashEntries);for(var i=0;i<n;i++)this._hashNext.set(i,-1);for(i=0;i<this._hashEntries;i++)this._hash.set(i,-1);for(this._chunkValues=new java.util.concurrent.atomic.AtomicReferenceArray(n),this._chunkWorlds=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries),this._chunkTimes=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries),this._chunkIds=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries),this._chunkTypes=new t.mwg.core.chunk.heap.HeapAtomicByteArray(this._maxEntries),this._chunkMarks=new java.util.concurrent.atomic.AtomicLongArray(this._maxEntries),i=0;i<this._maxEntries;i++)this._chunkMarks.set(i,0)}return e.prototype.graph=function(){return this._graph},e.prototype.worldByIndex=function(t){return this._chunkWorlds.get(t)},e.prototype.timeByIndex=function(t){return this._chunkTimes.get(t)},e.prototype.idByIndex=function(t){return this._chunkIds.get(t)},e.prototype.getAndMark=function(e,n,r,i){for(var o=t.mwg.utility.HashHelper.tripleHash(e,n,r,i,this._hashEntries),o=this._hash.get(o),s=-1;-1!=o;){if(this._chunkTypes.get(o)==e&&this._chunkWorlds.get(o)==n&&this._chunkTimes.get(o)==r&&this._chunkIds.get(o)==i){0<this.mark(o)&&(s=o);break}o=this._hashNext.get(o)}return-1!=s?this._chunkValues.get(s):null},e.prototype.get=function(t){return this._chunkValues.get(t)},e.prototype.getOrLoadAndMark=function(e,n,r,i,o){var s=this,a=this.getAndMark(e,n,r,i);if(null!=a)o(a);else{var l=this.graph().newBuffer();t.mwg.utility.KeyHelper.keyToBuffer(l,e,n,r,i),this.graph().storage().get(l,function(t){if(null!=t&&0<t.length()){var a=s.createAndMark(e,n,r,i);a.load(t),t.free(),o(a)}else l.free(),o(null)})}},e.prototype.mark=function(t){var e,n;do e=this._chunkMarks.get(t),n=-1!=e?e+1:e;while(!this._chunkMarks.compareAndSet(t,e,n));return 0==e&&1==n&&this._lru.dequeue(t),n},e.prototype.unmark=function(t){var e,n;do e=this._chunkMarks.get(t),0<e?n=e-1:(console.error("WARNING: DOUBLE UNMARK"),n=e);while(!this._chunkMarks.compareAndSet(t,e,n));1==e&&0==n&&this._lru.enqueue(t)},e.prototype.free=function(t){},e.prototype.createAndMark=function(e,n,r,i){for(var o=-1,s=t.mwg.utility.HashHelper.tripleHash(e,n,r,i,this._hashEntries),a=this._hash.get(s);0<=a;){if(e==this._chunkTypes.get(a)&&n==this._chunkWorlds.get(a)&&r==this._chunkTimes.get(a)&&i==this._chunkIds.get(a)){o=a;break}a=this._hashNext.get(a)}if(-1!=o){var l;do a=this._chunkMarks.get(o),l=-1!=a?a+1:a;while(!this._chunkMarks.compareAndSet(o,a,l));if(l==a+1)return this._chunkValues.get(o)}for(o=-1;-1==o&&(a=this._lru.dequeueTail(),-1!=a);)this._chunkMarks.compareAndSet(a,0,-1)&&(o=a);if(-1==o)throw Error("mwDB crashed, cache is full, please avoid to much retention of nodes or augment cache capacity! available:"+this.available());switch(l=null,e){case t.mwg.chunk.ChunkType.STATE_CHUNK:l=new t.mwg.core.chunk.heap.HeapStateChunk(this,o);break;case t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK:l=new t.mwg.core.chunk.heap.HeapWorldOrderChunk(this,o);break;case t.mwg.chunk.ChunkType.TIME_TREE_CHUNK:l=new t.mwg.core.chunk.heap.HeapTimeTreeChunk(this,o);break;case t.mwg.chunk.ChunkType.GEN_CHUNK:l=new t.mwg.core.chunk.heap.HeapGenChunk(this,i,o)}if(null!=this._chunkValues.get(o)){for(var h=this._chunkWorlds.get(o),u=this._chunkTimes.get(o),c=this._chunkIds.get(o),p=this._chunkTypes.get(o),m=t.mwg.utility.HashHelper.tripleHash(p,h,u,c,this._hashEntries),a=this._hash.get(m),g=-1;0<=a&&(p!=this._chunkTypes.get(a)||h!=this._chunkWorlds.get(a)||u!=this._chunkTimes.get(a)||c!=this._chunkIds.get(a));)g=a,a=this._hashNext.get(a);-1==g?(h=this._hashNext.get(a),this._hash.set(m,h)):-1==a?this._hashNext.set(g,-1):this._hashNext.set(g,this._hashNext.get(a)),this._hashNext.set(a,-1)}return this._chunkValues.set(o,l),this._chunkMarks.set(o,1),this._chunkTypes.set(o,e),this._chunkWorlds.set(o,n),this._chunkTimes.set(o,r),this._chunkIds.set(o,i),this._hashNext.set(o,this._hash.get(s)),this._hash.set(s,o),l},e.prototype.notifyUpdate=function(t){this._dirtiesStack.enqueue(t)&&this.mark(t)},e.prototype.save=function(e){for(var n=this._graph.newBuffer(),r=!0;0!=this._dirtiesStack.size();){var i=this._dirtiesStack.dequeueTail(),o=this._chunkValues.get(i);r?r=!1:n.write(t.mwg.core.CoreConstants.BUFFER_SEP),t.mwg.utility.KeyHelper.keyToBuffer(n,this._chunkTypes.get(i),this._chunkWorlds.get(i),this._chunkTimes.get(i),this._chunkIds.get(i)),n.write(t.mwg.core.CoreConstants.BUFFER_SEP);try{o.save(n),this.unmark(i)}catch(s){if(!(s instanceof Error))throw s;console.error(s)}}this.graph().storage().put(n,function(t){n.free(),null!=e&&e(t)})},e.prototype.clear=function(){},e.prototype.freeAll=function(){},e.prototype.available=function(){return this._lru.size()},e.prototype.printMarked=function(){for(var e=0;e<this._chunkValues.length();e++)if(null!=this._chunkValues.get(e)&&0!=this._chunkMarks.get(e))switch(this._chunkTypes.get(e)){case t.mwg.chunk.ChunkType.STATE_CHUNK:console.log("STATE("+this._chunkWorlds.get(e)+","+this._chunkTimes.get(e)+","+this._chunkIds.get(e)+")->marks->"+this._chunkMarks.get(e));break;case t.mwg.chunk.ChunkType.TIME_TREE_CHUNK:console.log("TIME_TREE("+this._chunkWorlds.get(e)+","+this._chunkTimes.get(e)+","+this._chunkIds.get(e)+")->marks->"+this._chunkMarks.get(e));break;case t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK:console.log("WORLD_ORDER("+this._chunkWorlds.get(e)+","+this._chunkTimes.get(e)+","+this._chunkIds.get(e)+")->marks->"+this._chunkMarks.get(e));break;case t.mwg.chunk.ChunkType.GEN_CHUNK:console.log("GENERATOR("+this._chunkWorlds.get(e)+","+this._chunkTimes.get(e)+","+this._chunkIds.get(e)+")->marks->"+this._chunkMarks.get(e))}},e.HASH_LOAD_FACTOR=4,e}(),e.HeapChunkSpace=n,n=function(){function t(t,e){if(this._capacity=t,this._next=new Int32Array(t),this._prev=new Int32Array(t),this._last=this._first=-1,java.util.Arrays.fill(this._next,0,t,-1),java.util.Arrays.fill(this._prev,0,t,-1),e){for(var n=0;n<t;n++){var r=this._last;this._prev[n]=r,this._last=n,-1==this._first?this._first=n:this._next[r]=n}this._count=t}else this._count=0}return t.prototype.enqueue=function(t){if(this._count>=this._capacity||this._first==t||this._last==t||-1!=this._prev[t]||-1!=this._next[t])return!1;var e=this._last;return this._prev[t]=e,this._last=t,-1==this._first?this._first=t:this._next[e]=t,this._count++,!0},t.prototype.dequeueTail=function(){var t=this._first;if(-1==t)return-1;var e=this._next[t];return this._next[t]=-1,this._prev[t]=-1,this._first=e,-1==e?this._last=-1:this._prev[e]=-1,this._count--,t},t.prototype.dequeue=function(t){var e=this._prev[t],n=this._next[t];if(-1==e&&-1==n)return!1;if(-1==e){if(t=this._first,-1==t)return!1;e=this._next[t],this._next[t]=-1,this._prev[t]=-1,this._first=e,-1==e?this._last=-1:this._prev[e]=-1,--this._count}else if(-1==n){if(t=this._last,-1==t)return!1;e=this._prev[t],this._prev[t]=-1,this._next[t]=-1,this._last=e,-1==e?this._first=-1:this._next[e]=-1,--this._count}else this._next[e]=n,this._prev[n]=e,this._prev[t]=-1,this._next[t]=-1,this._count--;return!0},t.prototype.free=function(){},t.prototype.size=function(){return this._count},t}(),e.HeapFixedStack=n,n=function(){function e(e,n,r){this._index=r,this._space=e,this._prefix=Long.fromNumber(n).shiftLeft(t.mwg.Constants.LONG_SIZE-t.mwg.Constants.PREFIX_SIZE),this._seed=-1}return e.prototype.save=function(e){t.mwg.utility.Base64.encodeLongToBuffer(this._seed,e),this._dirty=!1},e.prototype.load=function(e){if(null!=e&&0!=e.length()){e=t.mwg.utility.Base64.decodeToLongWithBounds(e,0,e.length());var n=this._seed;this._seed=e,-1==n||n==this._seed||null==this._space||this._dirty||(this._dirty=!0,this._space.notifyUpdate(this._index))}},e.prototype.newKey=function(){if(this._seed==t.mwg.Constants.KEY_PREFIX_MASK)throw Error("Object Index could not be created because it exceeded the capacity of the current prefix. Ask for a new prefix.");-1==this._seed&&(this._seed=0),this._seed++,this._space&&this._space.notifyUpdate(this._index);var e=this._prefix.add(this._seed).toNumber();if(e>=t.mwg.Constants.NULL_LONG)throw Error("Object Index exceeds the maximum JavaScript number capacity. (2^"+t.mwg.Constants.LONG_SIZE+")");return e},e.prototype.index=function(){return this._index},e.prototype.world=function(){return this._space.worldByIndex(this._index)},e.prototype.time=function(){return this._space.timeByIndex(this._index)},e.prototype.id=function(){return this._space.idByIndex(this._index)},e.prototype.chunkType=function(){return t.mwg.chunk.ChunkType.GEN_CHUNK},e}(),e.HeapGenChunk=n,n=function(){function e(t){this.capacity=this.mapSize=0,this.hashs=this.nexts=this.values=this.keys=null,this.parent=t}return e.prototype.key=function(t){return this.keys[t]},e.prototype.setKey=function(t,e){this.keys[t]=e},e.prototype.value=function(t){return this.values[t]},e.prototype.setValue=function(t,e){this.values[t]=e},e.prototype.next=function(t){return this.nexts[t]},e.prototype.setNext=function(t,e){this.nexts[t]=e},e.prototype.hash=function(t){return this.hashs[t]},e.prototype.setHash=function(t,e){this.hashs[t]=e},e.prototype.reallocate=function(e){if(e>this.capacity){var n=new Float64Array(e);null!=this.keys&&java.lang.System.arraycopy(this.keys,0,n,0,this.capacity),this.keys=n,n=new Float64Array(e),null!=this.values&&java.lang.System.arraycopy(this.values,0,n,0,this.capacity),this.values=n;var n=new Int32Array(e),r=new Int32Array(2*e);for(java.util.Arrays.fill(n,0,e,-1),java.util.Arrays.fill(r,0,2*e,-1),this.hashs=r,this.nexts=n,n=0;n<this.mapSize;n++)r=t.mwg.utility.HashHelper.longHash(this.key(n),2*e),this.setNext(n,this.hash(r)),this.setHash(r,n);this.capacity=e}},e.prototype.cloneFor=function(e){if(e=new t.mwg.core.chunk.heap.HeapLongLongArrayMap(e),e.mapSize=this.mapSize,e.capacity=this.capacity,null!=this.keys){var n=new Float64Array(this.capacity);java.lang.System.arraycopy(this.keys,0,n,0,this.capacity),e.keys=n}return null!=this.values&&(n=new Float64Array(this.capacity),java.lang.System.arraycopy(this.values,0,n,0,this.capacity),e.values=n),null!=this.nexts&&(n=new Int32Array(this.capacity),java.lang.System.arraycopy(this.nexts,0,n,0,this.capacity),e.nexts=n),null!=this.hashs&&(n=new Int32Array(2*this.capacity),java.lang.System.arraycopy(this.hashs,0,n,0,2*this.capacity),e.hashs=n),e},e.prototype.get=function(e){var n=new Float64Array(0);if(null!=this.keys){for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),i=0,o=0,r=this.hash(r);0<=r;){if(e==this.key(r)){if(o==i){var i=0==i?1:2*i,s=new Float64Array(i);java.lang.System.arraycopy(n,0,s,0,n.length),n=s}n[o]=this.value(r),o++}r=this.next(r)}o!=i&&(e=new Float64Array(o),java.lang.System.arraycopy(n,0,e,0,o),n=e)}return n},e.prototype.each=function(t){this.unsafe_each(t)},e.prototype.unsafe_each=function(t){for(var e=0;e<this.mapSize;e++)t(this.key(e),this.value(e))},e.prototype.size=function(){return this.mapSize},e.prototype.remove=function(e,n){if(null!=this.keys&&0!=this.mapSize){for(var r=2*this.capacity,i=t.mwg.utility.HashHelper.longHash(e,r),o=this.hash(i),i=-1;0<=o;){if(e==this.key(o)&&n==this.value(o)){i=o;break}o=this.next(o)}if(-1!=i){var s=t.mwg.utility.HashHelper.longHash(e,r),o=this.hash(s);if(o==i)this.setHash(s,this.next(o));else for(;-1!=o;){var a=this.next(o);if(a==i){this.setNext(o,this.next(a));break}o=a}if(s=this.mapSize-1,s!=i)if(o=this.key(s),this.setKey(i,o),this.setValue(i,this.value(s)),this.setNext(i,this.next(s)),r=t.mwg.utility.HashHelper.longHash(o,r),o=this.hash(r),o==s)this.setHash(r,i);else for(;-1!=o;){if(a=this.next(o),a==s){this.setNext(o,i);break}o=a}this.mapSize--,this.parent.declareDirty()}}},e.prototype.put=function(e,n){if(null==this.keys)this.reallocate(t.mwg.Constants.MAP_INITIAL_CAPACITY),this.setKey(0,e),this.setValue(0,n),this.setHash(t.mwg.utility.HashHelper.longHash(e,2*this.capacity),0),this.setNext(0,-1),this.mapSize++,this.parent.declareDirty();else{for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),i=r=this.hash(r),o=-1;0<=i;){if(e==this.key(i)&&n==this.value(i)){o=i;break}i=this.next(i)}-1==o&&(i=this.mapSize,i==this.capacity&&this.reallocate(2*this.capacity),this.setKey(i,e),this.setValue(i,n),this.setHash(t.mwg.utility.HashHelper.longHash(e,2*this.capacity),i),this.setNext(i,r),this.mapSize++,this.parent.declareDirty())}},e}(),e.HeapLongLongArrayMap=n,n=function(){function e(t){this.capacity=this.mapSize=0,this.hashs=this.nexts=this.values=this.keys=null,this.parent=t}return e.prototype.key=function(t){return this.keys[t]},e.prototype.setKey=function(t,e){this.keys[t]=e},e.prototype.value=function(t){return this.values[t]},e.prototype.setValue=function(t,e){this.values[t]=e},e.prototype.next=function(t){return this.nexts[t]},e.prototype.setNext=function(t,e){this.nexts[t]=e},e.prototype.hash=function(t){return this.hashs[t]},e.prototype.setHash=function(t,e){this.hashs[t]=e},e.prototype.reallocate=function(e){if(e>this.capacity){var n=new Float64Array(e);null!=this.keys&&java.lang.System.arraycopy(this.keys,0,n,0,this.capacity),this.keys=n,n=new Float64Array(e),null!=this.values&&java.lang.System.arraycopy(this.values,0,n,0,this.capacity),this.values=n;var n=new Int32Array(e),r=new Int32Array(2*e);for(java.util.Arrays.fill(n,0,e,-1),java.util.Arrays.fill(r,0,2*e,-1),this.hashs=r,this.nexts=n,n=0;n<this.mapSize;n++)r=t.mwg.utility.HashHelper.longHash(this.key(n),2*e),this.setNext(n,this.hash(r)),this.setHash(r,n);this.capacity=e}},e.prototype.cloneFor=function(e){if(e=new t.mwg.core.chunk.heap.HeapLongLongMap(e),e.mapSize=this.mapSize,e.capacity=this.capacity,null!=this.keys){var n=new Float64Array(this.capacity);java.lang.System.arraycopy(this.keys,0,n,0,this.capacity),e.keys=n}return null!=this.values&&(n=new Float64Array(this.capacity),java.lang.System.arraycopy(this.values,0,n,0,this.capacity),e.values=n),null!=this.nexts&&(n=new Int32Array(this.capacity),java.lang.System.arraycopy(this.nexts,0,n,0,this.capacity),e.nexts=n),null!=this.hashs&&(n=new Int32Array(2*this.capacity),java.lang.System.arraycopy(this.hashs,0,n,0,2*this.capacity),e.hashs=n),e},e.prototype.get=function(e){var n=t.mwg.Constants.NULL_LONG;if(null!=this.keys)for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),r=this.hash(r);0<=r;){if(e==this.key(r)){n=this.value(r);break}r=this.next(r)}return n},e.prototype.each=function(t){this.unsafe_each(t)},e.prototype.unsafe_each=function(t){for(var e=0;e<this.mapSize;e++)t(this.key(e),this.value(e))},e.prototype.size=function(){return this.mapSize},e.prototype.remove=function(e){if(null!=this.keys&&0!=this.mapSize){for(var n=2*this.capacity,r=t.mwg.utility.HashHelper.longHash(e,n),i=this.hash(r),r=-1;0<=i;){if(e==this.key(i)){r=i;break}i=this.next(i)}if(-1!=r){if(e=t.mwg.utility.HashHelper.longHash(e,n),i=this.hash(e),i==r)this.setHash(e,this.next(i));else for(;-1!=i;){var o=this.next(i);if(o==r){this.setNext(i,this.next(o));break}i=o}if(e=this.mapSize-1,e!=r)if(i=this.key(e),this.setKey(r,i),this.setValue(r,this.value(e)),this.setNext(r,this.next(e)),n=t.mwg.utility.HashHelper.longHash(i,n),i=this.hash(n),i==e)this.setHash(n,r);else for(;-1!=i;){if(o=this.next(i),o==e){this.setNext(i,r);break}i=o}this.mapSize--,this.parent.declareDirty()}}},e.prototype.put=function(e,n){if(null==this.keys)this.reallocate(t.mwg.Constants.MAP_INITIAL_CAPACITY),this.setKey(0,e),this.setValue(0,n),this.setHash(t.mwg.utility.HashHelper.longHash(e,2*this.capacity),0),this.setNext(0,-1),this.mapSize++;else{for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),i=r=this.hash(r),o=-1;0<=i;){if(e==this.key(i)){o=i;break}i=this.next(i)}-1==o?(i=this.mapSize,i==this.capacity&&this.reallocate(2*this.capacity),this.setKey(i,e),this.setValue(i,n),this.setHash(t.mwg.utility.HashHelper.longHash(e,2*this.capacity),i),this.setNext(i,r),this.mapSize++,this.parent.declareDirty()):this.value(o)!=n&&(this.setValue(o,n),this.parent.declareDirty())}},e}(),e.HeapLongLongMap=n,n=function(){function e(t,e){this.aligned=!0,this.parent=t,null!=e?(this.aligned=!1,this._back=e._back,this._size=e._size):(this._back=null,this._size=0)}return e.prototype.allocate=function(t){t=new Float64Array(t),null!=this._back&&java.lang.System.arraycopy(this._back,0,t,0,this._back.length),this._back=t},e.prototype.size=function(){return this._size},e.prototype.get=function(t){return this._back[t]},e.prototype.unsafe_get=function(t){return this._back[t]},e.prototype.add=function(e){if(!this.aligned){var n=new Float64Array(this._back.length);java.lang.System.arraycopy(this._back,0,n,0,this._back.length),this._back=n,this.aligned=!0}return null==this._back?(this._back=new Float64Array(t.mwg.Constants.MAP_INITIAL_CAPACITY),this._back[0]=e,this._size=1):(this._size==this._back.length&&(n=new Float64Array(2*this._back.length),java.lang.System.arraycopy(this._back,0,n,0,this._size),this._back=n),this._back[this._size]=e,this._size++),this.parent.declareDirty(),this},e.prototype.remove=function(t){if(!this.aligned){var e=new Float64Array(this._back.length);java.lang.System.arraycopy(this._back,0,e,0,this._back.length),this._back=e,this.aligned=!0}for(var e=-1,n=0;n<this._size;n++)if(this._back[n]==t){e=n;break}return-1!=e&&(0==this._size-1?(this._back=null,
this._size=0):(t=new Float64Array(this._size-1),java.lang.System.arraycopy(this._back,0,t,0,e),java.lang.System.arraycopy(this._back,e+1,t,e,this._size-e-1),this._back=t,this._size--)),this},e.prototype.clear=function(){return this._size=0,this.aligned?null!=this._back&&java.util.Arrays.fill(this._back,0,this._back.length,-1):(this._back=null,this.aligned=!0),this},e.prototype.toString=function(){var t=new java.lang.StringBuilder;t.append("[");for(var e=0;e<this._size;e++)0!=e&&t.append(","),t.append(this._back[e]);return t.append("]"),t.toString()},e}(),e.HeapRelationship=n,n=function(){function e(t,e){this._space=t,this._index=e,this._type=this._hash=this._next=null,this._capacity=this._size=0,this._dirty=!1}return e.prototype.world=function(){return this._space.worldByIndex(this._index)},e.prototype.time=function(){return this._space.timeByIndex(this._index)},e.prototype.id=function(){return this._space.idByIndex(this._index)},e.prototype.chunkType=function(){return t.mwg.chunk.ChunkType.STATE_CHUNK},e.prototype.index=function(){return this._index},e.prototype.get=function(t){return this.internal_get(t)},e.prototype.internal_find=function(e){if(0!=this._size)if(null==this._hash){for(var n=0;n<this._size;n++)if(this._k[n]==e)return n}else for(n=t.mwg.utility.HashHelper.longHash(e,2*this._capacity),n=this._hash[n];0<=n;){if(e==this._k[n])return n;n=this._next[n]}return-1},e.prototype.internal_get=function(e){if(0==this._size)return null;var n=this.internal_find(e);if(-1!=n&&(e=this._v[n],null!=e))switch(this._type[n]){case t.mwg.Type.DOUBLE_ARRAY:return n=new Float64Array(e.length),java.lang.System.arraycopy(e,0,n,0,e.length),n;case t.mwg.Type.LONG_ARRAY:return n=new Float64Array(e.length),java.lang.System.arraycopy(e,0,n,0,e.length),n;case t.mwg.Type.INT_ARRAY:return n=new Int32Array(e.length),java.lang.System.arraycopy(e,0,n,0,e.length),n;default:return e}return null},e.prototype.set=function(e,n,r){if(null!=r){if(n==t.mwg.Type.STRING&&"string"!=typeof r)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.BOOL&&"boolean"!=typeof r)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if((n==t.mwg.Type.DOUBLE||n==t.mwg.Type.LONG||n==t.mwg.Type.INT)&&"number"!=typeof r)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.DOUBLE_ARRAY&&!(r instanceof Float64Array))throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.LONG_ARRAY&&!(r instanceof Float64Array))throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.INT_ARRAY&&!(r instanceof Int32Array))throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.STRING_TO_LONG_MAP&&"object"!=typeof r)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.LONG_TO_LONG_MAP&&"boolean"!=typeof r)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);if(n==t.mwg.Type.LONG_TO_LONG_ARRAY_MAP&&"boolean"!=typeof r)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r)}this.internal_set(e,n,r,!0,!1)},e.prototype.setFromKey=function(t,e,n){this.internal_set(this._space.graph().resolver().stringToHash(t,!0),e,n,!0,!1)},e.prototype.getFromKey=function(t){return this.internal_get(this._space.graph().resolver().stringToHash(t,!1))},e.prototype.getFromKeyWithDefault=function(t,e){var n=this.getFromKey(t);return null==n?e:n},e.prototype.getType=function(e){if(0==this._size)return-1;if(null==this._hash){for(var n=0;n<this._capacity;n++)if(this._k[n]==e)return this._type[n]}else for(n=t.mwg.utility.HashHelper.longHash(e,2*this._capacity),n=this._hash[n];0<=n;){if(e==this._k[n])return this._type[n];n=this._next[n]}return-1},e.prototype.getTypeFromKey=function(t){return this.getType(this._space.graph().resolver().stringToHash(t,!1))},e.prototype.getOrCreate=function(e,n){var r=this.internal_find(e);if(-1!=r&&this._type[r]==n)return this._v[r];switch(r=null,n){case t.mwg.Type.RELATION:r=new t.mwg.core.chunk.heap.HeapRelationship(this,null);break;case t.mwg.Type.STRING_TO_LONG_MAP:r=new t.mwg.core.chunk.heap.HeapStringLongMap(this);break;case t.mwg.Type.LONG_TO_LONG_MAP:r=new t.mwg.core.chunk.heap.HeapLongLongMap(this);break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:r=new t.mwg.core.chunk.heap.HeapLongLongArrayMap(this)}return this.internal_set(e,n,r,!0,!1),r},e.prototype.getOrCreateFromKey=function(t,e){return this.getOrCreate(this._space.graph().resolver().stringToHash(t,!0),e)},e.prototype.declareDirty=function(){null==this._space||this._dirty||(this._dirty=!0,this._space.notifyUpdate(this._index))},e.prototype.save=function(e){t.mwg.utility.Base64.encodeIntToBuffer(this._size,e);for(var n=0;n<this._size;n++)if(null!=this._v[n]){var r=this._v[n];if(null!=r)switch(e.write(t.mwg.core.CoreConstants.CHUNK_SEP),t.mwg.utility.Base64.encodeLongToBuffer(this._k[n],e),e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SEP),t.mwg.utility.Base64.encodeIntToBuffer(this._type[n],e),e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SEP),this._type[n]){case t.mwg.Type.STRING:t.mwg.utility.Base64.encodeStringToBuffer(r,e);break;case t.mwg.Type.BOOL:this._v[n]?e.write(t.mwg.core.CoreConstants.BOOL_TRUE):e.write(t.mwg.core.CoreConstants.BOOL_FALSE);break;case t.mwg.Type.LONG:t.mwg.utility.Base64.encodeLongToBuffer(r,e);break;case t.mwg.Type.DOUBLE:t.mwg.utility.Base64.encodeDoubleToBuffer(r,e);break;case t.mwg.Type.INT:t.mwg.utility.Base64.encodeIntToBuffer(r,e);break;case t.mwg.Type.DOUBLE_ARRAY:var i=r;for(t.mwg.utility.Base64.encodeIntToBuffer(i.length,e),r=0;r<i.length;r++)e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeDoubleToBuffer(i[r],e);break;case t.mwg.Type.RELATION:for(i=r,t.mwg.utility.Base64.encodeIntToBuffer(i.size(),e),r=0;r<i.size();r++)e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(i.unsafe_get(r),e);break;case t.mwg.Type.LONG_ARRAY:for(i=r,t.mwg.utility.Base64.encodeIntToBuffer(i.length,e),r=0;r<i.length;r++)e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(i[r],e);break;case t.mwg.Type.INT_ARRAY:for(i=r,t.mwg.utility.Base64.encodeIntToBuffer(i.length,e),r=0;r<i.length;r++)e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeIntToBuffer(i[r],e);break;case t.mwg.Type.STRING_TO_LONG_MAP:t.mwg.utility.Base64.encodeLongToBuffer(r.size(),e),r.unsafe_each(function(n,r){e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeStringToBuffer(n,e),e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(r,e)});break;case t.mwg.Type.LONG_TO_LONG_MAP:t.mwg.utility.Base64.encodeLongToBuffer(r.size(),e),r.unsafe_each(function(n,r){e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(n,e),e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(r,e)});break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:t.mwg.utility.Base64.encodeLongToBuffer(r.size(),e),r.unsafe_each(function(n,r){e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(n,e),e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(r,e)})}}},e.prototype.each=function(t){for(var e=0;e<this._size;e++)null!=this._v[e]&&t(this._k[e],this._type[e],this._v[e])},e.prototype.loadFrom=function(e){if(null!=e){if(this._capacity=e._capacity,this._size=e._size,null!=e._k){var n=new Float64Array(this._capacity);java.lang.System.arraycopy(e._k,0,n,0,this._capacity),this._k=n}if(null!=e._type&&(n=new Int8Array(this._capacity),java.lang.System.arraycopy(e._type,0,n,0,this._capacity),this._type=n),null!=e._next&&(n=new Int32Array(this._capacity),java.lang.System.arraycopy(e._next,0,n,0,this._capacity),this._next=n),null!=e._hash&&(n=new Int32Array(2*this._capacity),java.lang.System.arraycopy(e._hash,0,n,0,2*this._capacity),this._hash=n),null!=e._v)for(this._v=Array(this._capacity),n=0;n<this._size;n++)switch(e._type[n]){case t.mwg.Type.LONG_TO_LONG_MAP:null!=e._v[n]&&(this._v[n]=e._v[n].cloneFor(this));break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:null!=e._v[n]&&(this._v[n]=e._v[n].cloneFor(this));break;case t.mwg.Type.STRING_TO_LONG_MAP:null!=e._v[n]&&(this._v[n]=e._v[n].cloneFor(this));break;case t.mwg.Type.RELATION:null!=e._v[n]&&(this._v[n]=new t.mwg.core.chunk.heap.HeapRelationship(this,e._v[n]));break;default:this._v[n]=e._v[n]}}},e.prototype.internal_set=function(e,n,r,i,o){var s=null;if(null!=r)try{switch(n){case t.mwg.Type.BOOL:s=r;break;case t.mwg.Type.DOUBLE:s=r;break;case t.mwg.Type.LONG:s=r;break;case t.mwg.Type.INT:s=r;break;case t.mwg.Type.STRING:s=r;break;case t.mwg.Type.RELATION:s=r;break;case t.mwg.Type.DOUBLE_ARRAY:var a=new Float64Array(r.length);java.lang.System.arraycopy(r,0,a,0,r.length),s=a;break;case t.mwg.Type.LONG_ARRAY:var l=new Float64Array(r.length);java.lang.System.arraycopy(r,0,l,0,r.length),s=l;break;case t.mwg.Type.INT_ARRAY:var h=new Int32Array(r.length);java.lang.System.arraycopy(r,0,h,0,r.length),s=h;break;case t.mwg.Type.STRING_TO_LONG_MAP:s=r;break;case t.mwg.Type.LONG_TO_LONG_MAP:s=r;break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:s=r;break;default:throw Error("Internal Exception, unknown type")}}catch(u){if(u instanceof Error)throw Error("mwDB usage error, set method called with type "+t.mwg.Type.typeName(n)+" while param object is "+r);throw u}if(null==this._k)null!=s&&(this._capacity=t.mwg.Constants.MAP_INITIAL_CAPACITY,this._k=new Float64Array(this._capacity),this._v=Array(this._capacity),this._type=new Int8Array(this._capacity),this._k[0]=e,this._v[0]=s,this._type[0]=n,this._size=1);else{if(h=l=r=-1,null==this._hash){for(a=0;a<this._size;a++)if(this._k[a]==e){r=a;break}}else for(h=t.mwg.utility.HashHelper.longHash(e,2*this._capacity),a=this._hash[h];-1!=a;){if(this._k[a]==e){r=a;break}l=a,a=this._next[a]}if(-1!=r){if(i||n!=this._type[r])if(null==s){if(null!=this._hash&&(-1!=l?this._next[l]=this._next[r]:this._hash[h]=-1),e=this._size-1,r==e)this._k[r]=-1,this._v[r]=null,this._type[r]=-1;else if(this._k[r]=this._k[e],this._v[r]=this._v[e],this._type[r]=this._type[e],null!=this._hash)if(this._next[r]=this._next[e],n=t.mwg.utility.HashHelper.longHash(this._k[r],2*this._capacity),a=this._hash[n],a==e)this._hash[n]=r;else for(;-1!=a;){if(this._next[a]==e){this._next[a]=r;break}a=this._next[a]}this._size--}else this._v[r]=s,this._type[r]!=n&&(this._type[r]=n);o||this.declareDirty()}else if(this._size<this._capacity)this._k[this._size]=e,this._v[this._size]=s,this._type[this._size]=n,null!=this._hash&&(this._next[this._size]=this._hash[h],this._hash[h]=this._size),this._size++,this.declareDirty();else{for(i=2*this._capacity,r=new Float64Array(i),java.lang.System.arraycopy(this._k,0,r,0,this._capacity),this._k=r,r=Array(i),java.lang.System.arraycopy(this._v,0,r,0,this._capacity),this._v=r,r=new Int8Array(i),java.lang.System.arraycopy(this._type,0,r,0,this._capacity),this._type=r,this._capacity=i,this._k[this._size]=e,this._v[this._size]=s,this._type[this._size]=n,this._size++,this._hash=new Int32Array(2*this._capacity),java.util.Arrays.fill(this._hash,0,2*this._capacity,-1),this._next=new Int32Array(this._capacity),java.util.Arrays.fill(this._next,0,this._capacity,-1),a=0;a<this._size;a++)e=t.mwg.utility.HashHelper.longHash(this._k[a],2*this._capacity),this._next[a]=this._hash[e],this._hash[e]=a;o||this.declareDirty()}}},e.prototype.allocate=function(e){if(!(e<=this._capacity)){var n=new Float64Array(e);for(null!=this._k&&java.lang.System.arraycopy(this._k,0,n,0,this._capacity),this._k=n,n=Array(e),null!=this._v&&java.lang.System.arraycopy(this._v,0,n,0,this._capacity),this._v=n,n=new Int8Array(e),null!=this._type&&java.lang.System.arraycopy(this._type,0,n,0,this._capacity),this._type=n,this._capacity=e,this._hash=new Int32Array(2*this._capacity),java.util.Arrays.fill(this._hash,0,2*this._capacity,-1),this._next=new Int32Array(this._capacity),java.util.Arrays.fill(this._next,0,this._capacity,-1),e=0;e<this._size;e++)n=t.mwg.utility.HashHelper.longHash(this._k[e],2*this._capacity),this._next[e]=this._hash[n],this._hash[n]=e}},e.prototype.load=function(e){if(null!=e&&0!=e.length()){for(var n=null==this._k,r=0,i=e.length(),o=-1,s=t.mwg.core.CoreConstants.NULL_LONG,a=-1,l=!0,h=null,u=null,c=null,p=null,m=null,g=null,f=null,_=-1,y=0,d=t.mwg.core.CoreConstants.NULL_LONG,w=null;r<i;){var A=e.read(r);if(A==t.mwg.core.CoreConstants.CHUNK_SEP)if(l)l=!1,o=t.mwg.utility.Base64.decodeToIntWithBounds(e,0,r),this.allocate(Math.pow(2,Math.ceil(Math.log(o)/Math.log(2)))),o=r+1;else{if(-1!=a){switch(_=null,a){case t.mwg.Type.BOOL:e.read(o)==t.mwg.core.CoreConstants.BOOL_FALSE?_=!1:e.read(o)==t.mwg.core.CoreConstants.BOOL_TRUE&&(_=!0);break;case t.mwg.Type.STRING:_=t.mwg.utility.Base64.decodeToStringWithBounds(e,o,r);break;case t.mwg.Type.DOUBLE:_=t.mwg.utility.Base64.decodeToDoubleWithBounds(e,o,r);break;case t.mwg.Type.LONG:_=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r);break;case t.mwg.Type.INT:_=t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r);break;case t.mwg.Type.DOUBLE_ARRAY:null==h?h=new Float64Array(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)):h[y]=t.mwg.utility.Base64.decodeToDoubleWithBounds(e,o,r),_=h;break;case t.mwg.Type.LONG_ARRAY:null==u?u=new Float64Array(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)):u[y]=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r),_=u;break;case t.mwg.Type.INT_ARRAY:null==c?c=new Int32Array(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)):c[y]=t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r),_=c;break;case t.mwg.Type.RELATION:null==p?(p=new t.mwg.core.chunk.heap.HeapRelationship(this,null),p.allocate(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r))):p.add(t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=p;break;case t.mwg.Type.STRING_TO_LONG_MAP:null!=w&&m.put(w,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=m;break;case t.mwg.Type.LONG_TO_LONG_MAP:d!=t.mwg.core.CoreConstants.NULL_LONG&&g.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=g;break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:d!=t.mwg.core.CoreConstants.NULL_LONG&&f.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=f}null!=_&&this.internal_set(s,a,_,!0,n)}o=r+1,s=t.mwg.core.CoreConstants.NULL_LONG,_=a=-1,y=0,d=t.mwg.core.CoreConstants.NULL_LONG,w=null}else if(A==t.mwg.core.CoreConstants.CHUNK_SUB_SEP)s==t.mwg.core.CoreConstants.NULL_LONG?(s=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r),o=r+1):-1==a&&(a=t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r),o=r+1);else if(A==t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP){if(-1==_)switch(_=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r),a){case t.mwg.Type.DOUBLE_ARRAY:h=new Float64Array(_);break;case t.mwg.Type.LONG_ARRAY:u=new Float64Array(_);break;case t.mwg.Type.INT_ARRAY:c=new Int32Array(_);break;case t.mwg.Type.RELATION:p=new t.mwg.core.chunk.heap.HeapRelationship(this,null),p.allocate(_);break;case t.mwg.Type.STRING_TO_LONG_MAP:m=new t.mwg.core.chunk.heap.HeapStringLongMap(this),m.reallocate(_);break;case t.mwg.Type.LONG_TO_LONG_MAP:g=new t.mwg.core.chunk.heap.HeapLongLongMap(this),g.reallocate(_);break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:f=new t.mwg.core.chunk.heap.HeapLongLongArrayMap(this),f.reallocate(_)}else switch(a){case t.mwg.Type.DOUBLE_ARRAY:h[y]=t.mwg.utility.Base64.decodeToDoubleWithBounds(e,o,r),y++;break;case t.mwg.Type.RELATION:p.add(t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r));break;case t.mwg.Type.LONG_ARRAY:u[y]=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r),y++;break;case t.mwg.Type.INT_ARRAY:c[y]=t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r),y++;break;case t.mwg.Type.STRING_TO_LONG_MAP:null!=w&&(m.put(w,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),w=null);break;case t.mwg.Type.LONG_TO_LONG_MAP:d!=t.mwg.core.CoreConstants.NULL_LONG&&(g.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),d=t.mwg.core.CoreConstants.NULL_LONG);break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:d!=t.mwg.core.CoreConstants.NULL_LONG&&(f.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),d=t.mwg.core.CoreConstants.NULL_LONG)}o=r+1}else if(A==t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SUB_SEP){switch(a){case t.mwg.Type.STRING_TO_LONG_MAP:null==w?w=t.mwg.utility.Base64.decodeToStringWithBounds(e,o,r):(m.put(w,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),w=null);break;case t.mwg.Type.LONG_TO_LONG_MAP:d==t.mwg.core.CoreConstants.NULL_LONG?d=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r):(g.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),d=t.mwg.core.CoreConstants.NULL_LONG);break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:d==t.mwg.core.CoreConstants.NULL_LONG?d=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r):(f.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),d=t.mwg.core.CoreConstants.NULL_LONG)}o=r+1}r++}if(-1!=a){switch(_=null,a){case t.mwg.Type.BOOL:e.read(o)==t.mwg.core.CoreConstants.BOOL_FALSE?_=!1:e.read(o)==t.mwg.core.CoreConstants.BOOL_TRUE&&(_=!0);break;case t.mwg.Type.STRING:_=t.mwg.utility.Base64.decodeToStringWithBounds(e,o,r);break;case t.mwg.Type.DOUBLE:_=t.mwg.utility.Base64.decodeToDoubleWithBounds(e,o,r);break;case t.mwg.Type.LONG:_=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r);break;case t.mwg.Type.INT:_=t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r);break;case t.mwg.Type.DOUBLE_ARRAY:null==h?h=new Float64Array(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)):h[y]=t.mwg.utility.Base64.decodeToDoubleWithBounds(e,o,r),_=h;break;case t.mwg.Type.LONG_ARRAY:null==u?u=new Float64Array(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)):u[y]=t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r),_=u;break;case t.mwg.Type.INT_ARRAY:null==c?c=new Int32Array(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)):c[y]=t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r),_=c;break;case t.mwg.Type.RELATION:null!=p&&p.add(t.mwg.utility.Base64.decodeToIntWithBounds(e,o,r)),_=p;break;case t.mwg.Type.STRING_TO_LONG_MAP:null!=w&&m.put(w,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=m;break;case t.mwg.Type.LONG_TO_LONG_MAP:d!=t.mwg.core.CoreConstants.NULL_LONG&&g.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=g;break;case t.mwg.Type.LONG_TO_LONG_ARRAY_MAP:d!=t.mwg.core.CoreConstants.NULL_LONG&&f.put(d,t.mwg.utility.Base64.decodeToLongWithBounds(e,o,r)),_=f}null!=_&&this.internal_set(s,a,_,!0,n)}}},e}(),e.HeapStateChunk=n,n=function(){function e(t){this.capacity=this.mapSize=0,this.hashs=this.nexts=this.values=this.keysH=this.keys=null,this.parent=t}return e.prototype.key=function(t){return this.keys[t]},e.prototype.setKey=function(t,e){this.keys[t]=e},e.prototype.keyH=function(t){return this.keysH[t]},e.prototype.setKeyH=function(t,e){this.keysH[t]=e},e.prototype.value=function(t){return this.values[t]},e.prototype.setValue=function(t,e){this.values[t]=e},e.prototype.next=function(t){return this.nexts[t]},e.prototype.setNext=function(t,e){this.nexts[t]=e},e.prototype.hash=function(t){return this.hashs[t]},e.prototype.setHash=function(t,e){this.hashs[t]=e},e.prototype.reallocate=function(e){if(e>this.capacity){var n=Array(e);null!=this.keys&&java.lang.System.arraycopy(this.keys,0,n,0,this.capacity),this.keys=n,n=new Float64Array(e),null!=this.keysH&&java.lang.System.arraycopy(this.keysH,0,n,0,this.capacity),this.keysH=n,n=new Float64Array(e),null!=this.values&&java.lang.System.arraycopy(this.values,0,n,0,this.capacity),this.values=n;var n=new Int32Array(e),r=new Int32Array(2*e);for(java.util.Arrays.fill(n,0,e,-1),java.util.Arrays.fill(r,0,2*e,-1),this.hashs=r,this.nexts=n,n=0;n<this.mapSize;n++)r=t.mwg.utility.HashHelper.longHash(this.keyH(n),2*e),this.setNext(n,this.hash(r)),this.setHash(r,n);this.capacity=e}},e.prototype.cloneFor=function(e){if(e=new t.mwg.core.chunk.heap.HeapStringLongMap(e),e.mapSize=this.mapSize,e.capacity=this.capacity,null!=this.keys){var n=Array(this.capacity);java.lang.System.arraycopy(this.keys,0,n,0,this.capacity),e.keys=n}return null!=this.keysH&&(n=new Float64Array(this.capacity),java.lang.System.arraycopy(this.keysH,0,n,0,this.capacity),e.keysH=n),null!=this.values&&(n=new Float64Array(this.capacity),java.lang.System.arraycopy(this.values,0,n,0,this.capacity),e.values=n),null!=this.nexts&&(n=new Int32Array(this.capacity),java.lang.System.arraycopy(this.nexts,0,n,0,this.capacity),e.nexts=n),null!=this.hashs&&(n=new Int32Array(2*this.capacity),java.lang.System.arraycopy(this.hashs,0,n,0,2*this.capacity),e.hashs=n),e},e.prototype.getValue=function(e){var n=t.mwg.Constants.NULL_LONG;if(null!=this.keys){e=t.mwg.utility.HashHelper.hash(e);for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),r=this.hash(r);0<=r;){if(e==this.keyH(r)){n=this.value(r);break}r=this.next(r)}}return n},e.prototype.getByHash=function(e){var n=null;if(null!=this.keys)for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),r=this.hash(r);0<=r;){if(e==this.keyH(r)){n=this.key(r);break}r=this.next(r)}return n},e.prototype.containsHash=function(e){var n=!1;if(null!=this.keys)for(var r=t.mwg.utility.HashHelper.longHash(e,2*this.capacity),r=this.hash(r);0<=r;){if(e==this.keyH(r)){n=!0;break}r=this.next(r)}return n},e.prototype.each=function(t){this.unsafe_each(t)},e.prototype.unsafe_each=function(t){for(var e=0;e<this.mapSize;e++)t(this.key(e),this.value(e))},e.prototype.size=function(){return this.mapSize},e.prototype.remove=function(e){if(null!=this.keys&&0!=this.mapSize){for(var n=t.mwg.utility.HashHelper.hash(e),r=2*this.capacity,i=t.mwg.utility.HashHelper.longHash(n,r),o=this.hash(i),i=-1;0<=o;){if(e==this.key(o)){i=o;break}o=this.next(o)}if(-1!=i){if(e=t.mwg.utility.HashHelper.longHash(n,r),o=this.hash(e),o==i)this.setHash(e,this.next(o));else for(;-1!=o;){if(n=this.next(o),n==i){this.setNext(o,this.next(n));break}o=n}if(e=this.mapSize-1,e!=i)if(o=this.key(e),n=this.keyH(e),this.setKey(i,o),this.setKeyH(i,n),this.setValue(i,this.value(e)),this.setNext(i,this.next(e)),r=t.mwg.utility.HashHelper.longHash(n,r),o=this.hash(r),o==e)this.setHash(r,i);else for(;-1!=o;){if(n=this.next(o),n==e){this.setNext(o,i);break}o=n}this.mapSize--,this.parent.declareDirty()}}},e.prototype.put=function(e,n){var r=t.mwg.utility.HashHelper.hash(e);if(null==this.keys)this.reallocate(t.mwg.Constants.MAP_INITIAL_CAPACITY),this.setKey(0,e),this.setKeyH(0,r),this.setValue(0,n),this.setHash(t.mwg.utility.HashHelper.longHash(r,2*this.capacity),0),this.setNext(0,-1),this.mapSize++;else{for(var i=t.mwg.utility.HashHelper.longHash(r,2*this.capacity),o=i=this.hash(i),s=-1;0<=o;){if(e==this.key(o)){s=o;break}o=this.next(o)}-1==s?(o=this.mapSize,o==this.capacity&&this.reallocate(2*this.capacity),this.setKey(o,e),this.setKeyH(o,r),this.setValue(o,n),this.setHash(t.mwg.utility.HashHelper.longHash(r,2*this.capacity),o),this.setNext(o,i),this.mapSize++,this.parent.declareDirty()):this.value(s)!=n&&(this.setValue(s,n),this.parent.declareDirty())}},e}(),e.HeapStringLongMap=n,n=function(){function e(t,e){this._root=-1,this._size=0,this._space=t,this._index=e,this._magic=0,this._dirty=!1}return e.prototype.world=function(){return this._space.worldByIndex(this._index)},e.prototype.time=function(){return this._space.timeByIndex(this._index)},e.prototype.id=function(){return this._space.idByIndex(this._index)},e.prototype.size=function(){return this._size},e.prototype.range=function(t,e,n,r){var i=0;for(e=this.internal_previousOrEqual_index(e);-1!=e&&this.key(e)>=t&&i<n;)r(this.key(e)),i++,e=this.previous(e)},e.prototype.save=function(e){t.mwg.utility.Base64.encodeLongToBuffer(this._size,e),e.write(t.mwg.core.CoreConstants.CHUNK_SEP);for(var n=!0,r=0;r<this._size;r++)n?n=!1:e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(this._k[r],e);this._dirty=!1},e.prototype.load=function(e){if(null!=e&&0!=e.length()){for(var n=null==this._k,r=!1,i=0,o=0,s=e.length();i<s;){var a=e.read(i);a==t.mwg.core.CoreConstants.CHUNK_SUB_SEP?(r=r||this.internal_insert(t.mwg.utility.Base64.decodeToLongWithBounds(e,o,i)),o=i+1):a==t.mwg.core.CoreConstants.CHUNK_SEP&&(this.reallocate(t.mwg.utility.Base64.decodeToLongWithBounds(e,o,i)),o=i+1),i++}!(r=r||this.internal_insert(t.mwg.utility.Base64.decodeToLongWithBounds(e,o,i)))||n||this._dirty||(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index))}},e.prototype.index=function(){return this._index},e.prototype.previousOrEqual=function(e){return e=this.internal_previousOrEqual_index(e),-1!=e?this.key(e):t.mwg.core.CoreConstants.NULL_LONG},e.prototype.magic=function(){return this._magic},e.prototype.insert=function(t){this.internal_insert(t)&&this.internal_set_dirty()},e.prototype.unsafe_insert=function(t){this.internal_insert(t)},e.prototype.chunkType=function(){return t.mwg.chunk.ChunkType.TIME_TREE_CHUNK},e.prototype.clearAt=function(n){var r=this._k;this._k=new Float64Array(this._k.length),this._back_meta=new Int32Array(this._k.length*e.META_SIZE),this._colors=[],this._root=-1;for(var i=this._size,o=this._size=0;o<i;o++)r[o]!=t.mwg.core.CoreConstants.NULL_LONG&&r[o]<n&&this.internal_insert(r[o]);this.internal_set_dirty()},e.prototype.reallocate=function(t){var n=new Float64Array(t);null!=this._k&&java.lang.System.arraycopy(this._k,0,n,0,this._size);var r=[];if(null!=this._colors){java.lang.System.arraycopy(this._colors,0,r,0,this._size);for(var i=this._size;i<t;i++)r[i]=!1}var o=new Int32Array(t*e.META_SIZE);if(null!=this._back_meta)for(java.lang.System.arraycopy(this._back_meta,0,o,0,this._size*e.META_SIZE),i=this._size*e.META_SIZE;i<t*e.META_SIZE;i++)o[i]=-1;this._back_meta=o,this._k=n,this._colors=r},e.prototype.key=function(t){return-1==t?-1:this._k[t]},e.prototype.setKey=function(t,e){this._k[t]=e},e.prototype.left=function(t){return-1==t?-1:this._back_meta[t*e.META_SIZE]},e.prototype.setLeft=function(t,n){this._back_meta[t*e.META_SIZE]=n},e.prototype.right=function(t){return-1==t?-1:this._back_meta[t*e.META_SIZE+1]},e.prototype.setRight=function(t,n){this._back_meta[t*e.META_SIZE+1]=n},e.prototype.parent=function(t){return-1==t?-1:this._back_meta[t*e.META_SIZE+2]},e.prototype.setParent=function(t,n){this._back_meta[t*e.META_SIZE+2]=n},e.prototype.color=function(t){return-1==t||this._colors[t]},e.prototype.setColor=function(t,e){this._colors[t]=e},e.prototype.grandParent=function(t){return-1==t?-1:-1!=this.parent(t)?this.parent(this.parent(t)):-1},e.prototype.sibling=function(t){return-1==this.parent(t)?-1:t==this.left(this.parent(t))?this.right(this.parent(t)):this.left(this.parent(t))},e.prototype.uncle=function(t){return-1!=this.parent(t)?this.sibling(this.parent(t)):-1},e.prototype.previous=function(t){if(-1!=this.left(t)){for(t=this.left(t);-1!=this.right(t);)t=this.right(t);return t}if(-1!=this.parent(t)){if(t!=this.right(this.parent(t)))for(;-1!=this.parent(t)&&t==this.left(this.parent(t));)t=this.parent(t);return this.parent(t)}return-1},e.prototype.internal_previousOrEqual_index=function(t){var e=this._root;if(-1==e)return e;for(;-1!=e;){if(t==this.key(e))return e;if(t>this.key(e)){if(-1==this.right(e))return e;e=this.right(e)}else{if(-1==this.left(e)){for(t=this.parent(e);-1!=t&&e==this.left(t);)e=t,t=this.parent(t);return t}e=this.left(e)}}return-1},e.prototype.rotateLeft=function(t){var e=this.right(t);this.replaceNode(t,e),this.setRight(t,this.left(e)),-1!=this.left(e)&&this.setParent(this.left(e),t),this.setLeft(e,t),this.setParent(t,e)},e.prototype.rotateRight=function(t){var e=this.left(t);this.replaceNode(t,e),this.setLeft(t,this.right(e)),-1!=this.right(e)&&this.setParent(this.right(e),t),this.setRight(e,t),this.setParent(t,e)},e.prototype.replaceNode=function(t,e){-1==this.parent(t)?this._root=e:t==this.left(this.parent(t))?this.setLeft(this.parent(t),e):this.setRight(this.parent(t),e),-1!=e&&this.setParent(e,this.parent(t))},e.prototype.insertCase1=function(t){-1==this.parent(t)?this.setColor(t,!0):this.insertCase2(t)},e.prototype.insertCase2=function(t){this.color(this.parent(t))||this.insertCase3(t)},e.prototype.insertCase3=function(t){this.color(this.uncle(t))?this.insertCase4(t):(this.setColor(this.parent(t),!0),this.setColor(this.uncle(t),!0),this.setColor(this.grandParent(t),!1),this.insertCase1(this.grandParent(t)))},e.prototype.insertCase4=function(t){t==this.right(this.parent(t))&&this.parent(t)==this.left(this.grandParent(t))?(this.rotateLeft(this.parent(t)),t=this.left(t)):t==this.left(this.parent(t))&&this.parent(t)==this.right(this.grandParent(t))&&(this.rotateRight(this.parent(t)),t=this.right(t)),this.insertCase5(t)},e.prototype.insertCase5=function(t){this.setColor(this.parent(t),!0),this.setColor(this.grandParent(t),!1),t==this.left(this.parent(t))&&this.parent(t)==this.left(this.grandParent(t))?this.rotateRight(this.grandParent(t)):this.rotateLeft(this.grandParent(t))},e.prototype.internal_insert=function(e){if(null==this._k||this._k.length==this._size){var n=this._size,n=0==n?t.mwg.Constants.MAP_INITIAL_CAPACITY:2*n;this.reallocate(n)}if(n=this._size,0==n)this.setKey(n,e),this.setColor(n,!1),this.setLeft(n,-1),this.setRight(n,-1),this.setParent(n,-1),this._root=n,this._size=1;else{for(var r=this._root;;){if(e==this.key(r))return!1;if(e<this.key(r)){if(-1==this.left(r)){this.setKey(n,e),this.setColor(n,!1),this.setLeft(n,-1),this.setRight(n,-1),this.setParent(n,-1),this.setLeft(r,n),this._size++;break}r=this.left(r)}else{if(-1==this.right(r)){this.setKey(n,e),this.setColor(n,!1),this.setLeft(n,-1),this.setRight(n,-1),this.setParent(n,-1),this.setRight(r,n),this._size++;break}r=this.right(r)}}this.setParent(n,r)}return this.insertCase1(n),!0},e.prototype.internal_set_dirty=function(){this._magic+=1,null==this._space||this._dirty||(this._dirty=!0,this._space.notifyUpdate(this._index))},e.META_SIZE=3,e}(),e.HeapTimeTreeChunk=n,n=function(){function e(e,n){this._index=n,this._space=e,this._magic=this._lock=0,this._extra=t.mwg.core.CoreConstants.NULL_LONG,this._capacity=this._size=0,this._hash=this._next=this._kv=null,this._dirty=!1}return e.prototype.world=function(){return this._space.worldByIndex(this._index)},e.prototype.time=function(){return this._space.timeByIndex(this._index)},e.prototype.id=function(){return this._space.idByIndex(this._index)},e.prototype.extra=function(){return this._extra},e.prototype.setExtra=function(t){this._extra=t},e.prototype.lock=function(){},e.prototype.unlock=function(){},e.prototype.magic=function(){return this._magic},e.prototype.each=function(t){for(var e=0;e<this._size;e++)t(this._kv[2*e],this._kv[2*e+1])},e.prototype.get=function(e){if(0<this._size)for(var n=t.mwg.utility.HashHelper.longHash(e,2*this._capacity),n=this._hash[n];0<=n;){if(e==this._kv[2*n])return this._kv[2*n+1];n=this._next[n]}return t.mwg.core.CoreConstants.NULL_LONG},e.prototype.put=function(t,e){this.internal_put(t,e,!0)},e.prototype.internal_put=function(e,n,r){if(0<this._capacity){for(var i=t.mwg.utility.HashHelper.longHash(e,2*this._capacity),o=this._hash[i],s=-1;0<=o;){if(e==this._kv[2*o]){s=o;break}o=this._next[o]}-1==s?(this._capacity==this._size&&(this.resize(2*this._capacity),i=t.mwg.utility.HashHelper.longHash(e,2*this._capacity)),this._kv[2*this._size]=e,this._kv[2*this._size+1]=n,this._next[this._size]=this._hash[i],this._hash[i]=this._size,this._size++,this._magic+=1,r&&!this._dirty&&(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index))):this._kv[2*s+1]!=n&&(this._kv[2*s+1]=n,this._magic+=1,r&&!this._dirty&&(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index)))}else this._capacity=t.mwg.Constants.MAP_INITIAL_CAPACITY,this._next=new Int32Array(this._capacity),
java.util.Arrays.fill(this._next,0,this._capacity,-1),this._hash=new Int32Array(2*this._capacity),java.util.Arrays.fill(this._hash,0,2*this._capacity,-1),this._kv=new Float64Array(2*this._capacity),this._size=1,this._kv[0]=e,this._kv[1]=n,this._hash[t.mwg.utility.HashHelper.longHash(e,2*this._capacity)]=0,r&&!this._dirty&&(this._dirty=!0,null!=this._space&&this._space.notifyUpdate(this._index))},e.prototype.resize=function(e){if(e>this._capacity){if(null==this._kv)this._kv=new Float64Array(2*e),this._hash=new Int32Array(2*e),this._next=new Int32Array(e),this._capacity=e,java.util.Arrays.fill(this._next,0,e,-1),java.util.Arrays.fill(this._hash,0,2*e,-1);else{var n=new Float64Array(2*e);java.lang.System.arraycopy(this._kv,0,n,0,2*this._size);var r=new Int32Array(e),i=new Int32Array(2*e);java.util.Arrays.fill(r,0,e,-1),java.util.Arrays.fill(i,0,2*e,-1);for(var o=0;o<this._size;o++){var s=t.mwg.utility.HashHelper.longHash(n[2*o],2*e);r[o]=i[s],i[s]=o}this._capacity=e,this._hash=i,this._next=r,this._kv=n}return!0}return!1},e.prototype.load=function(e){if(null!=e&&0!=e.length()){for(var n=null==this._kv,r=0,i=e.length(),o=!1,s=0,a=t.mwg.core.CoreConstants.NULL_LONG;r<i;)e.read(r)==t.mwg.core.CoreConstants.CHUNK_SEP?(o?this._extra=t.mwg.utility.Base64.decodeToLongWithBounds(e,s,r):(this.resize(t.mwg.utility.Base64.decodeToLongWithBounds(e,0,r)),o=!0),s=r+1):e.read(r)==t.mwg.core.CoreConstants.CHUNK_SUB_SEP?(a!=t.mwg.core.CoreConstants.NULL_LONG&&(s=t.mwg.utility.Base64.decodeToLongWithBounds(e,s,r),this.internal_put(a,s,!n),a=t.mwg.core.CoreConstants.NULL_LONG),s=r+1):e.read(r)==t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP&&(a=t.mwg.utility.Base64.decodeToLongWithBounds(e,s,r),s=r+1),r++;a!=t.mwg.core.CoreConstants.NULL_LONG&&(s=t.mwg.utility.Base64.decodeToLongWithBounds(e,s,r),this.internal_put(a,s,!n))}},e.prototype.index=function(){return this._index},e.prototype.remove=function(t){throw Error("Not implemented yet!!!")},e.prototype.size=function(){return this._size},e.prototype.chunkType=function(){return t.mwg.chunk.ChunkType.WORLD_ORDER_CHUNK},e.prototype.save=function(e){t.mwg.utility.Base64.encodeLongToBuffer(this._size,e),e.write(t.mwg.core.CoreConstants.CHUNK_SEP),this._extra!=t.mwg.core.CoreConstants.NULL_LONG&&(t.mwg.utility.Base64.encodeLongToBuffer(this._extra,e),e.write(t.mwg.core.CoreConstants.CHUNK_SEP));for(var n=!0,r=0;r<this._size;r++)n||e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SEP),n=!1,t.mwg.utility.Base64.encodeLongToBuffer(this._kv[2*r],e),e.write(t.mwg.core.CoreConstants.CHUNK_SUB_SUB_SEP),t.mwg.utility.Base64.encodeLongToBuffer(this._kv[2*r+1],e);this._dirty=!1},e}(),e.HeapWorldOrderChunk=n}(e.heap||(e.heap={}))}(e.chunk||(e.chunk={})),function(e){var n=function(){function e(){}return e.prototype.slice=function(t,e){var n=e-t+1,r=new Int8Array(n);return java.lang.System.arraycopy(this.buffer,t,r,0,n),r},e.prototype.write=function(e){if(null==this.buffer)this.buffer=new Int8Array(t.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY),this.buffer[0]=e,this.writeCursor=1;else if(this.writeCursor==this.buffer.length){var n=new Int8Array(2*this.buffer.length);java.lang.System.arraycopy(this.buffer,0,n,0,this.buffer.length),n[this.writeCursor]=e,this.writeCursor++,this.buffer=n}else this.buffer[this.writeCursor]=e,this.writeCursor++},e.prototype.getNewSize=function(t,e){for(;t<e;)t*=2;return t},e.prototype.writeAll=function(e){if(null==this.buffer){var n=this.getNewSize(t.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY,e.length);this.buffer=new Int8Array(n),java.lang.System.arraycopy(e,0,this.buffer,0,e.length),this.writeCursor=e.length}else this.writeCursor+e.length>this.buffer.length?(n=this.getNewSize(this.buffer.length,this.buffer.length+e.length),n=new Int8Array(n),java.lang.System.arraycopy(this.buffer,0,n,0,this.buffer.length),java.lang.System.arraycopy(e,0,n,this.writeCursor,e.length),this.buffer=n):java.lang.System.arraycopy(e,0,this.buffer,this.writeCursor,e.length),this.writeCursor+=e.length},e.prototype.read=function(t){return this.buffer[t]},e.prototype.data=function(){var t=new Int8Array(this.writeCursor);return null!=this.buffer&&java.lang.System.arraycopy(this.buffer,0,t,0,this.writeCursor),t},e.prototype.length=function(){return this.writeCursor},e.prototype.free=function(){this.buffer=null},e.prototype.iterator=function(){return new t.mwg.utility.DefaultBufferIterator(this)},e.prototype.removeLast=function(){this.writeCursor--},e.prototype.toString=function(){return String.fromCharCode.apply(null,this.data())},e}();e.HeapBuffer=n,n=function(){function e(){}return e.prototype.newSpace=function(e,n){return new t.mwg.core.chunk.heap.HeapChunkSpace(e,n)},e.prototype.newBuffer=function(){return new t.mwg.core.memory.HeapBuffer},e}(),e.HeapMemoryFactory=n}(e.memory||(e.memory={})),function(e){var n=function(){function e(){this.last=this.first=null}return e.prototype.add=function(e){e=new t.mwg.core.scheduler.JobQueue.JobQueueElem(e,null),null==this.first?this.first=e:this.last._next=e,this.last=e},e.prototype.poll=function(){var t=this.first;return this.first=this.first._next,t._ptr},e}();e.JobQueue=n,function(t){var e=function(){return function(t,e){this._ptr=t,this._next=e}}();t.JobQueueElem=e}(n=e.JobQueue||(e.JobQueue={})),n=function(){function t(){}return t.prototype.dispatch=function(t,e){e()},t.prototype.start=function(){},t.prototype.stop=function(){},t}(),e.NoopScheduler=n,n=function(){function e(){this.queue=new t.mwg.core.scheduler.JobQueue,this.wip=new java.util.concurrent.atomic.AtomicInteger(0)}return e.prototype.dispatch=function(t,e){if(this.queue.add(e),0==this.wip.getAndIncrement())do{var n=this.queue.poll();null!=n&&n()}while(0<this.wip.decrementAndGet())},e.prototype.start=function(){},e.prototype.stop=function(){},e}(),e.TrampolineScheduler=n}(e.scheduler||(e.scheduler={})),function(e){var n=function(e){function n(t,n){e.call(this),this._relationName=t,this._variableNameToAdd=n}return __extends(n,e),n.prototype.eval=function(e){var n=e.result(),r=e.variable(e.template(this._variableNameToAdd));if(null!=n&&null!=r)for(var i=e.template(this._relationName),n=n.iterator(),o=n.next();null!=o;){if(o instanceof t.mwg.plugin.AbstractNode)for(var s=r.iterator(),a=s.next();null!=a;)a instanceof t.mwg.plugin.AbstractNode&&o.add(i,a),a=s.next();o=n.next()}e.continueTask()},n.prototype.toString=function(){return"add('"+this._relationName+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._variableNameToAdd+"')"},n}(t.mwg.plugin.AbstractTaskAction);e.ActionAdd=n,n=function(e){function n(t,n){e.call(this),this._relationName=t,this._variableNameTarget=n}return __extends(n,e),n.prototype.eval=function(e){var n=e.result(),r=e.variable(e.template(this._variableNameTarget));if(null!=n&&null!=r)for(var i=e.template(this._relationName),n=n.iterator(),o=n.next();null!=o;){if(o instanceof t.mwg.plugin.AbstractNode)for(var s=r.iterator(),a=s.next();null!=a;)a instanceof t.mwg.plugin.AbstractNode&&a.add(i,o),a=s.next();o=n.next()}e.continueTask()},n.prototype.toString=function(){return"addTo('"+this._relationName+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._variableNameTarget+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionAddTo=n,n=function(t){function e(e,n){t.call(this),this._name=e,this._global=n}return __extends(e,t),e.prototype.eval=function(t){var e=t.result();this._global?t.addToGlobalVariable(t.template(this._name),e):t.addToVariable(t.template(this._name),e),t.continueTask()},e.prototype.toString=function(){return this._global?"addToGlobalVar('"+this._name+"')":"addToVar('"+this._name+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionAddToVar=n,n=function(t){function e(e,n){t.call(this),this._name=e,this._global=n}return __extends(e,t),e.prototype.eval=function(t){var e=t.result();this._global?t.setGlobalVariable(t.template(this._name),e):t.setVariable(t.template(this._name),e),t.continueTask()},e.prototype.toString=function(){return this._global?"asGlobalVar('"+this._name+"')":"asVar('"+this._name+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionAsVar=n,n=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.eval=function(t){t.continueWith(t.newResult())},e.prototype.toString=function(){return"clear()"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionClear=n,n=function(t){function e(e){t.call(this),this._name=e}return __extends(e,t),e.prototype.eval=function(t){var e=t.result();t.setVariable(t.template(this._name),e),t.continueTask()},e.prototype.toString=function(){return"defineVar('"+this._name+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionDefineVar=n,n=function(e){function n(t,n){e.call(this),this._cond=n,this._then=t}return __extends(n,e),n.prototype.eval=function(e){var n=this,r=this,i=Array(1);i[0]=function(o){var s=e._result;e._result=o,n._cond(e)?(null!=s&&s.free(),r._then.executeFrom(e,e._result,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,i[0])):(null!=s&&s.free(),e.continueWith(o))},this._then.executeFrom(e,e._result,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,i[0])},n.prototype.toString=function(){return"doWhile()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionDoWhile=n,n=function(e){function n(t){e.call(this),this._subTask=t}return __extends(n,e),n.prototype.eval=function(e){var n=this,r=this,i=e.result();if(null==i)e.continueTask();else{var o=i.iterator(),s=e.newResult();s.allocate(i.size());var a=Array(1),l=Array(1);a[0]=function(n){if(null!=n)for(var i=0;i<n.size();i++)s.add(n.get(i));l[0].free(),n=o.next(),l[0]=null!=n?e.wrap(n):null,null==n?e.continueWith(s):r._subTask.executeFrom(e,l[0],t.mwg.plugin.SchedulerAffinity.SAME_THREAD,a[0])},i=o.next(),l[0]=e.wrap(i),null!=i?e.graph().scheduler().dispatch(t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(){n._subTask.executeFrom(e,e.wrap(l[0]),t.mwg.plugin.SchedulerAffinity.SAME_THREAD,a[0])}):e.continueWith(s)}},n.prototype.toString=function(){return"foreach()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionForeach=n,n=function(e){function n(t){e.call(this),this._subTask=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.result(),r=e.wrap(null),i=n.iterator(),n=n.size();if(-1==n)throw Error("Foreach on non array structure are not supported yet!");r.allocate(n);for(var o=e.graph().newCounter(n),n=i.next(),s=0;null!=n;){var a=s,l=e.wrap(n);this._subTask.executeFrom(e,l,t.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(t){l.free(),null!=t&&1==t.size()?r.set(a,t.get(0)):r.set(a,t),o.count()}),s++,n=i.next()}o.then(function(){e.continueWith(r)})},n.prototype.toString=function(){return"foreachPar()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionForeachPar=n,n=function(e){function n(t,n){e.call(this),this._indexName=t,this._query=n}return __extends(n,e),n.prototype.eval=function(t){var e=t.template(this._indexName),n=t.template(this._query);t.graph().find(t.world(),t.time(),e,n,function(e){t.continueWith(t.wrap(e))})},n.prototype.toString=function(){return"fromIndex('"+this._indexName+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._query+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionFromIndex=n,n=function(t){function e(e){t.call(this),this._indexName=e}return __extends(e,t),e.prototype.eval=function(t){t.graph().findAll(t.world(),t.time(),this._indexName,function(e){t.continueWith(t.wrap(e))})},e.prototype.toString=function(){return"fromIndexAll('"+this._indexName+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionFromIndexAll=n,n=function(t){function e(e,n){t.call(this),this._name=e,this._index=n}return __extends(e,t),e.prototype.eval=function(t){var e=t.template(this._name),e=-1!=this._index?t.wrap(t.variable(e).get(this._index)):t.variable(e);null!=e&&(e=e.clone()),t.continueWith(e)},e.prototype.toString=function(){return"fromVar('"+this._name+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionFromVar=n,n=function(e){function n(t){e.call(this),this._name=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.newResult(),r=e.template(this._name),i=e.result();if(null!=i){for(var o=i.size(),s=e.graph().newCounter(o),a=0;a<o;a++){var l=i.get(a);if(l instanceof t.mwg.plugin.AbstractNode){var h=l;h.type(r)==t.mwg.Type.RELATION?h.rel(r,function(t){if(null!=t)for(var e=0;e<t.length;e++)n.add(t[e]);h.free(),s.count()}):(l=h.get(r),null!=l&&n.add(l),h.free(),s.count())}else n.add(l),s.count()}s.then(function(){i.clear(),e.continueWith(n)})}else e.continueTask()},n.prototype.toString=function(){return"get('"+this._name+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionGet=n,n=function(e){function n(t,n){e.call(this),this._condition=t,this._action=n}return __extends(n,e),n.prototype.eval=function(e){this._condition(e)?this._action.executeFrom(e,e.result(),t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){e.continueWith(t)}):e.continueTask()},n.prototype.toString=function(){return"ifThen()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionIfThen=n,n=function(e){function n(t,n,r){e.call(this),this._condition=t,this._thenSub=n,this._elseSub=r}return __extends(n,e),n.prototype.eval=function(e){this._condition(e)?this._thenSub.executeFrom(e,e.result(),t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){e.continueWith(t)}):this._elseSub.executeFrom(e,e.result(),t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){e.continueWith(t)})},n.prototype.toString=function(){return"ifThen()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionIfThenElse=n,n=function(e){function n(t,n,r){e.call(this),this._indexName=t,this._flatKeyAttributes=n,this._isIndexation=r}return __extends(n,e),n.prototype.eval=function(e){for(var n=e.result(),r=e.template(this._indexName),i=e.template(this._flatKeyAttributes),o=new t.mwg.core.utility.CoreDeferCounter(n.size()),s=function(t){if(!t)throw Error("Error during indexation of node with id "+n.get(0).id());o.count()},a=0;a<n.size();a++){var l=n.get(a);l instanceof t.mwg.plugin.AbstractNode?this._isIndexation?e.graph().index(r,l,i,s):e.graph().unindex(r,l,i,s):o.count()}o.then(function(){e.continueTask()})},n.prototype.toString=function(){return this._isIndexation?"indexNode('"+this._indexName+"','"+this._flatKeyAttributes+"')":"unindexNode('"+this._indexName+"','"+this._flatKeyAttributes+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionIndexOrUnindexNode=n,n=function(t){function e(e){t.call(this),this._value=e}return __extends(e,t),e.prototype.eval=function(t){t.continueWith(t.wrap(this._value).clone())},e.prototype.toString=function(){return"inject()"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionInject=n,n=function(e){function n(t){e.call(this),this._subTask=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.result();this._subTask.executeFrom(e,n,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){null!=t&&t.free(),e.continueWith(n)})},n.prototype.toString=function(){return"subTask()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionIsolate=n,n=function(e){function n(t){e.call(this),this._time=t}return __extends(n,e),n.prototype.eval=function(e){for(var n=e.template(this._time),n=java.lang.Long.parseLong(n),r=e.result(),i=new t.mwg.core.utility.CoreDeferCounter(r.size()),o=r.size(),s=0;s<o;s++){var a=r.get(s);if(a instanceof t.mwg.plugin.AbstractNode){var l=a,h=s;l.jump(n,function(t){l.free(),r.set(h,t),i.count()})}else i.count()}i.then(function(){e.continueTask()})},n.prototype.toString=function(){return"jump('"+this._time+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionJump=n,n=function(t){function e(e){t.call(this),this._id=e}return __extends(e,t),e.prototype.eval=function(t){var e=java.lang.Long.parseLong(t.template(this._id));t.graph().lookup(t.world(),t.time(),e,function(e){t.continueWith(t.wrap(e))})},e.prototype.toString=function(){return"lookup('"+this._id+'")'},e}(t.mwg.plugin.AbstractTaskAction),e.ActionLookup=n,n=function(e){function n(t,n,r){e.call(this),this._subTask=r,this._lower=t,this._upper=n}return __extends(n,e),n.prototype.eval=function(e){var n=t.mwg.core.task.TaskHelper.parseInt(e.template(this._lower)),r=t.mwg.core.task.TaskHelper.parseInt(e.template(this._upper)),i=e.result(),o=this,s=new java.util.concurrent.atomic.AtomicInteger(n);if(0<r-n){var a=Array(1);a[0]=function(n){var l=s.getAndIncrement();null!=n&&n.free(),l>r?e.continueTask():o._subTask.executeFromUsing(e,i,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){t.defineVariable("i",l)},a[0])},this._subTask.executeFromUsing(e,i,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){t.defineVariable("i",s.getAndIncrement())},a[0])}else e.continueTask()},n.prototype.toString=function(){return"loop('"+this._lower+"','"+this._upper+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionLoop=n,n=function(e){function n(t,n,r){e.call(this),this._subTask=r,this._lower=t,this._upper=n}return __extends(n,e),n.prototype.eval=function(e){var n=t.mwg.core.task.TaskHelper.parseInt(e.template(this._lower)),r=t.mwg.core.task.TaskHelper.parseInt(e.template(this._upper)),i=e.result(),o=e.newResult();if(0<r-n){for(var s=e.graph().newCounter(r-n+1);n<=r;n++){var a=n;this._subTask.executeFromUsing(e,i,t.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(t){t.defineVariable("i",a)},function(t){if(null!=t&&0<t.size())for(var e=0;e<t.size();e++)o.add(t.get(e));s.count()})}s.then(function(){e.continueWith(o)})}else e.continueWith(o)},n.prototype.toString=function(){return"loopPar('"+this._lower+"','"+this._upper+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionLoopPar=n,n=function(e){function n(t){e.call(this),this._map=t}return __extends(n,e),n.prototype.eval=function(e){for(var n=e.result(),r=e.wrap(null),i=n.size(),o=0;o<i;o++){var s=n.get(o);s instanceof t.mwg.plugin.AbstractNode?r.add(this._map(s)):r.add(s)}e.continueWith(r)},n.prototype.toString=function(){return"map()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionMap=n,n=function(e){function n(n){e.call(this),this._expression=n,this._engine=t.mwg.core.task.math.CoreMathExpressionEngine.parse(n)}return __extends(n,e),n.prototype.eval=function(e){for(var n=e.result(),r=e.newResult(),i=n.size(),o=0;o<i;o++){var s=n.get(o),a=new java.util.HashMap;a.put("PI",Math.PI),a.put("TRUE",1),a.put("FALSE",0),s instanceof t.mwg.plugin.AbstractNode?(r.add(this._engine.eval(s,e,a)),s.free()):r.add(this._engine.eval(null,e,a))}n.clear(),e.continueWith(r)},n.prototype.toString=function(){return"math('"+this._expression+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionMath=n,n=function(t){function e(e){t.call(this),this._typeNode=e}return __extends(e,t),e.prototype.eval=function(t){var e;null==this._typeNode?e=t.graph().newNode(t.world(),t.time()):(e=t.template(this._typeNode),e=t.graph().newTypedNode(t.world(),t.time(),e)),t.continueWith(t.wrap(e))},e.prototype.toString=function(){return null!=this._typeNode?"newTypedNode('"+this._typeNode+"')":"newNode()"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionNewNode=n,n=function(e){function n(t,n){e.call(this),this.subAction=null,this._actionName=t,this._flatParams=n}return __extends(n,e),n.prototype.eval=function(e){var n=e.template(this._actionName),r=e.template(this._flatParams),i=e.graph().taskAction(n);if(null==i)throw Error("Unknown task action: "+n);for(var o=t.mwg.core.CoreConstants.MAP_INITIAL_CAPACITY,n=Array(o),s=0,a=0,l=r.length,h=0;a<l;){if(r.charAt(a)==t.mwg.Constants.QUERY_SEP){if(h=r.substring(h,a),0<h.length){if(s>=o){var u=2*o,c=Array(u);java.lang.System.arraycopy(n,0,c,0,o),n=c,o=u}n[s]=h,s++}h=a+1}a++}h=r.substring(h,a),0<h.length&&(s>=o&&(c=Array(2*o),java.lang.System.arraycopy(n,0,c,0,o),n=c),n[s]=h,s++),s<n.length&&(r=Array(s),java.lang.System.arraycopy(n,0,r,0,s),n=r),this.subAction=i(n),null!=this.subAction?this.subAction.eval(e):e.continueTask()},n.prototype.toString=function(){return this._actionName+"("+this._flatParams+")"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionPlugin=n,n=function(t){function e(e){t.call(this),this._name=e}return __extends(e,t),e.prototype.eval=function(t){console.log(t.template(this._name)),t.continueTask()},e.prototype.toString=function(){return"print('"+this._name+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionPrint=n,n=function(e){function n(t,n){e.call(this),this._relationName=t,this._variableNameToRemove=n}return __extends(n,e),n.prototype.eval=function(e){var n=e.result(),r=e.variable(e.template(this._variableNameToRemove));if(null!=n&&null!=r)for(var i=e.template(this._relationName),n=n.iterator(),o=n.next();null!=o;){if(o instanceof t.mwg.plugin.AbstractNode)for(var s=r.iterator(),a=s.next();null!=a;)a instanceof t.mwg.plugin.AbstractNode&&o.remove(i,a),a=s.next();o=n.next()}e.continueTask()},n.prototype.toString=function(){return"remove('"+this._relationName+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._variableNameToRemove+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionRemove=n,n=function(e){function n(t){e.call(this),this._propertyName=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.result();if(null!=n)for(var r=e.template(this._propertyName),i=0;i<n.size();i++){var o=n.get(i);o instanceof t.mwg.plugin.AbstractNode&&o.removeProperty(r)}e.continueTask()},n.prototype.toString=function(){return"removeProperty('"+this._propertyName+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionRemoveProperty=n,n=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.prototype.eval=function(t){t.graph().save(function(e){t.continueTask()})},e.prototype.toString=function(){return"save()"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionSave=n,n=function(e){function n(t){e.call(this),this._filter=t}return __extends(n,e),n.prototype.eval=function(e){for(var n=e.result(),r=e.newResult(),i=n.size(),o=0;o<i;o++){var s=n.get(o);s instanceof t.mwg.plugin.AbstractNode?this._filter(s)?r.add(s):s.free():r.add(s)}n.clear(),e.continueWith(r)},n.prototype.toString=function(){return"select()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionSelect=n,n=function(e){function n(t){e.call(this),this._filter=t}return __extends(n,e),n.prototype.eval=function(e){for(var n=e.result(),r=e.wrap(null),n=n.iterator(),i=n.next();null!=i;)this._filter(i,e)&&(i instanceof t.mwg.plugin.AbstractNode?r.add(i.graph().cloneNode(i)):r.add(i)),i=n.next();e.continueWith(r)},n.prototype.toString=function(){return"selectObject()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionSelectObject=n,n=function(e){function n(t,n,r){e.call(this),this._relationName=t,this._variableNameToSet=r,this._propertyType=n}return __extends(n,e),n.prototype.eval=function(e){var n=e.result(),r=e.template(this._relationName);if(null!=n){var i;switch(i=e.template(this._variableNameToSet),this._propertyType){case t.mwg.Type.BOOL:i=this.parseBoolean(i.toString());break;case t.mwg.Type.INT:i=t.mwg.core.task.TaskHelper.parseInt(i.toString());break;case t.mwg.Type.DOUBLE:i=parseFloat(i.toString());break;case t.mwg.Type.LONG:i=java.lang.Long.parseLong(i.toString())}for(var o=0;o<n.size();o++){var s=n.get(o);s instanceof t.mwg.plugin.AbstractNode&&s.setProperty(r,this._propertyType,i)}}e.continueTask()},n.prototype.toString=function(){return"setProperty('"+this._relationName+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._propertyType+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._variableNameToSet+"')"},n.prototype.parseBoolean=function(t){return t=t.toLowerCase(),"true"===t||"1"===t},n}(t.mwg.plugin.AbstractTaskAction),e.ActionSetProperty=n,n=function(t){function e(e){t.call(this),this._splitPattern=e}return __extends(e,t),e.prototype.eval=function(t){for(var e=t.template(this._splitPattern),n=t.result(),r=t.wrap(null),i=0;i<n.size();i++){var o=n.get(0);if(o instanceof String)if(o=o.split(e),1==n.size())for(var s=0;s<o.length;s++)r.add(o[s]);else r.add(o)}t.continueWith(r)},e.prototype.toString=function(){return"split('"+this._splitPattern+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionSplit=n,n=function(e){function n(t){e.call(this),this._subTask=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.result();this._subTask.executeFrom(e,n,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(t){e.continueWith(t)})},n.prototype.toString=function(){return"subTask()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionSubTask=n,n=function(e){function n(t){e.call(this),this._subTasks=t}return __extends(n,e),n.prototype.eval=function(e){var n=this,r=e.result(),i=new java.util.concurrent.atomic.AtomicInteger(0),o=this._subTasks.length,s=e.newResult(),a=Array(1);a[0]=function(l){var h=i.getAndIncrement();if(null!=l)for(var u=0;u<l.size();u++){var c=l.get(u);null!=c&&s.add(c)}h<o?n._subTasks[h].executeFrom(e,r,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,a[0]):e.continueWith(s)};var l=i.getAndIncrement();l<o?this._subTasks[l].executeFrom(e,r,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,a[0]):e.continueWith(s)},n.prototype.toString=function(){return"subTasks()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionSubTasks=n,n=function(e){function n(t){e.call(this),this._subTasks=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.result(),r=e.newResult(),i=this._subTasks.length;r.allocate(i);for(var o=e.graph().newCounter(i),s=0;s<i;s++){var a=s;this._subTasks[s].executeFrom(e,n,t.mwg.plugin.SchedulerAffinity.ANY_LOCAL_THREAD,function(t){r.set(a,t),o.count()})}o.then(function(){e.continueWith(r)})},n.prototype.toString=function(){return"subTasksPar()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionSubTasksPar=n,n=function(t){function e(e){t.call(this),this._varName=e}return __extends(e,t),e.prototype.eval=function(t){var e=t.template(this._varName);t.setTime(java.lang.Long.parseLong(e)),t.continueTask()},e.prototype.toString=function(){return"setTime('"+this._varName+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionTime=n,n=function(e){function n(t){e.call(this),this._name=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.wrap(null),r=e.template(this._name),i=e.result();if(null!=i){for(var o=i.size(),s=e.graph().newCounter(o),a=0;a<o;a++){var l=i.get(a);if(l instanceof t.mwg.plugin.AbstractNode){var h=l;h.rel(r,function(t){if(null!=t)for(var e=0;e<t.length;e++)n.add(t[e]);h.free(),s.count()})}else n.add(l),s.count()}s.then(function(){i.clear(),e.continueWith(n)})}else e.continueTask()},n.prototype.toString=function(){return"traverse('"+this._name+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionTraverse=n,n=function(e){function n(t,n){e.call(this),this._query=n,this._indexName=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.wrap(null),r=e.template(this._indexName),i=e.result();if(null!=i){for(var o=i.size(),s=e.graph().newCounter(o),a=0;a<o;a++){var l=i.get(a);if(l instanceof t.mwg.plugin.AbstractNode){var h=l;h.find(r,this._query,function(t){if(null!=t)for(var e=0;e<t.length;e++)null!=t[e]&&n.add(t[e]);h.free(),s.count()})}else n.add(l),s.count()}s.then(function(){i.clear(),e.continueWith(n)})}else e.continueTask()},n.prototype.toString=function(){return"traverseIndex('"+this._indexName+t.mwg.core.CoreConstants.QUERY_SEP+this._query+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionTraverseIndex=n,n=function(e){function n(t){e.call(this),this._indexName=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.wrap(null),r=e.template(this._indexName),i=e.result();if(null!=i){for(var o=i.size(),s=e.graph().newCounter(o),a=0;a<o;a++){var l=i.get(a);if(l instanceof t.mwg.plugin.AbstractNode){var h=l;h.findAll(r,function(t){if(null!=t)for(var e=0;e<t.length;e++)null!=t[e]&&n.add(t[e]);h.free(),s.count()})}else n.add(l),s.count()}s.then(function(){i.clear(),e.continueWith(n)})}else e.continueTask()},n.prototype.toString=function(){return"traverseIndexAll('"+this._indexName+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionTraverseIndexAll=n,n=function(e){function n(t){e.call(this),this._name=t}return __extends(n,e),n.prototype.eval=function(e){var n=e.template(this._name),r=e.result();if(null!=r){for(var i=e.newResult(),o=r.size(),s=e.graph().newCounter(o),a=0;a<o;a++){var l=r.get(a);l instanceof t.mwg.plugin.AbstractNode?l.type(n)==t.mwg.Type.RELATION?l.rel(n,function(t){if(null!=t)for(var e=0;e<t.length;e++)i.add(t[e]);s.count()}):(i.add(l.graph().cloneNode(l)),s.count()):(i.add(l),s.count())}s.then(function(){e.continueWith(i)})}else e.continueTask()},n.prototype.toString=function(){return"traverseOrKeep('"+this._name+"')"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionTraverseOrKeep=n,n=function(e){function n(t,n){e.call(this),this._cond=t,this._then=n}return __extends(n,e),n.prototype.eval=function(e){var n=this,r=this,i=Array(1);i[0]=function(o){var s=e._result;e._result=o,n._cond(e)?(null!=s&&s.free(),r._then.executeFrom(e,e._result,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,i[0])):(null!=s&&s.free(),e.continueWith(o))},this._cond(e)?this._then.executeFrom(e,e._result,t.mwg.plugin.SchedulerAffinity.SAME_THREAD,i[0]):e.continueTask()},n.prototype.toString=function(){return"whileDo()"},n}(t.mwg.plugin.AbstractTaskAction),e.ActionWhileDo=n,n=function(e){function n(t,n){e.call(this),this._patternTemplate=n,this._name=t}return __extends(n,e),n.prototype.toString=function(){return"with('"+this._name+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._patternTemplate+"')"},n.prototype.eval=function(e){for(var n=new RegExp(e.template(this._patternTemplate)),r=e.result(),i=e.newResult(),o=r.size(),s=0;s<o;s++){var a=r.get(s);if(a instanceof t.mwg.plugin.AbstractNode){var l=a.get(this._name);null!=l&&n.test(l.toString())&&i.add(a.graph().cloneNode(a))}else i.add(a)}e.continueWith(i)},n}(t.mwg.plugin.AbstractTaskAction),e.ActionWith=n,n=function(e){function n(t,n){e.call(this),this._patternTemplate=n,this._name=t}return __extends(n,e),n.prototype.toString=function(){return"without('"+this._name+"'"+t.mwg.Constants.QUERY_SEP+"'"+this._patternTemplate+"')"},n.prototype.eval=function(e){for(var n=new RegExp(e.template(this._patternTemplate)),r=e.result(),i=e.newResult(),o=r.size(),s=0;s<o;s++){var a=r.get(s);if(a instanceof t.mwg.plugin.AbstractNode){var l=a.get(this._name);null!=l&&n.test(l.toString())||i.add(a.graph().cloneNode(a))}else i.add(a)}e.continueWith(i)},n}(t.mwg.plugin.AbstractTaskAction),e.ActionWithout=n,n=function(t){function e(e){t.call(this),this._varName=e}return __extends(e,t),e.prototype.eval=function(t){var e=t.template(this._varName);t.setWorld(java.lang.Long.parseLong(e)),t.continueTask()},e.prototype.toString=function(){return"setWorld('"+this._varName+"')"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionWorld=n,n=function(t){function e(e){t.call(this),this._wrapped=e}return __extends(e,t),e.prototype.eval=function(t){this._wrapped(t)},e.prototype.toString=function(){return"then()"},e}(t.mwg.plugin.AbstractTaskAction),e.ActionWrapper=n,n=function(){function e(){this._hookFactory=this._last=this._first=null}return e.prototype.addAction=function(t){null==this._first?this._last=this._first=t:(this._last.setNext(t),this._last=t)},e.prototype.setWorld=function(e){return this.addAction(new t.mwg.core.task.ActionWorld(e)),this},e.prototype.setTime=function(e){return this.addAction(new t.mwg.core.task.ActionTime(e)),this},e.prototype.fromIndex=function(e,n){if(null==e)throw Error("indexName should not be null");if(null==n)throw Error("query should not be null");return this.addAction(new t.mwg.core.task.ActionFromIndex(e,n)),this},e.prototype.fromIndexAll=function(e){if(null==e)throw Error("indexName should not be null");return this.addAction(new t.mwg.core.task.ActionFromIndexAll(e)),this},e.prototype.indexNode=function(e,n){return this.addAction(new t.mwg.core.task.ActionIndexOrUnindexNode(e,n,(!0))),this},e.prototype.unindexNode=function(e,n){return this.addAction(new t.mwg.core.task.ActionIndexOrUnindexNode(e,n,(!1))),this},e.prototype.selectWith=function(e,n){if(null==n)throw Error("pattern should not be null");return this.addAction(new t.mwg.core.task.ActionWith(e,n)),this},e.prototype.selectWithout=function(e,n){if(null==n)throw Error("pattern should not be null");return this.addAction(new t.mwg.core.task.ActionWithout(e,n)),this},e.prototype.asGlobalVar=function(e){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionAsVar(e,(!0))),this},e.prototype.asVar=function(e){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionAsVar(e,(!0))),
this},e.prototype.defineVar=function(e){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionDefineVar(e)),this},e.prototype.addToGlobalVar=function(e){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionAddToVar(e,(!0))),this},e.prototype.addToVar=function(e){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionAddToVar(e,(!1))),this},e.prototype.fromVar=function(e){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionFromVar(e,(-1))),this},e.prototype.fromVarAt=function(e,n){if(null==e)throw Error("variableName should not be null");return this.addAction(new t.mwg.core.task.ActionFromVar(e,n)),this},e.prototype.select=function(e){if(null==e)throw Error("filter should not be null");return this.addAction(new t.mwg.core.task.ActionSelect(e)),this},e.prototype.selectObject=function(e){if(null==e)throw Error("filterFunction should not be null");return this.addAction(new t.mwg.core.task.ActionSelectObject(e)),this},e.prototype.selectWhere=function(t){throw Error("Not implemented yet")},e.prototype.get=function(e){return this.addAction(new t.mwg.core.task.ActionGet(e)),this},e.prototype.traverse=function(e){return this.addAction(new t.mwg.core.task.ActionTraverse(e)),this},e.prototype.traverseOrKeep=function(e){return this.addAction(new t.mwg.core.task.ActionTraverseOrKeep(e)),this},e.prototype.traverseIndex=function(e,n){if(null==e)throw Error("indexName should not be null");return this.addAction(new t.mwg.core.task.ActionTraverseIndex(e,n)),this},e.prototype.traverseIndexAll=function(e){if(null==e)throw Error("indexName should not be null");return this.addAction(new t.mwg.core.task.ActionTraverseIndexAll(e)),this},e.prototype.map=function(e){if(null==e)throw Error("mapFunction should not be null");return this.addAction(new t.mwg.core.task.ActionMap(e)),this},e.prototype.flatMap=function(t){throw Error("Not implemented yet")},e.prototype.group=function(t){throw Error("Not implemented yet")},e.prototype.groupWhere=function(t){throw Error("Not implemented yet")},e.prototype.inject=function(e){if(null==e)throw Error("inputValue should not be null");return this.addAction(new t.mwg.core.task.ActionInject(e)),this},e.prototype.subTask=function(e){if(null==e)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionSubTask(e)),this},e.prototype.isolate=function(e){if(null==e)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionIsolate(e)),this},e.prototype.subTasks=function(e){if(null==e)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionSubTasks(e)),this},e.prototype.subTasksPar=function(e){if(null==e)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionSubTasksPar(e)),this},e.prototype.ifThen=function(e,n){if(null==e)throw Error("condition should not be null");if(null==n)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionIfThen(e,n)),this},e.prototype.ifThenElse=function(e,n,r){if(null==e)throw Error("condition should not be null");if(null==n)throw Error("thenSub should not be null");if(null==r)throw Error("elseSub should not be null");return this.addAction(new t.mwg.core.task.ActionIfThenElse(e,n,r)),this},e.prototype.whileDo=function(e,n){return this.addAction(new t.mwg.core.task.ActionWhileDo(e,n)),this},e.prototype.doWhile=function(e,n){return this.addAction(new t.mwg.core.task.ActionDoWhile(e,n)),this},e.prototype.then=function(e){if(null==e)throw Error("action should not be null");return this.addAction(new t.mwg.core.task.ActionWrapper(e)),this},e.prototype.foreach=function(e){if(null==e)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionForeach(e)),this},e.prototype.foreachPar=function(e){if(null==e)throw Error("subTask should not be null");return this.addAction(new t.mwg.core.task.ActionForeachPar(e)),this},e.prototype.save=function(){return this.addAction(new t.mwg.core.task.ActionSave),this},e.prototype.clear=function(){return this.addAction(new t.mwg.core.task.ActionClear),this},e.prototype.lookup=function(e){return this.addAction(new t.mwg.core.task.ActionLookup(e)),this},e.prototype.execute=function(t,e){this.executeWith(t,null,e)},e.prototype.executeSync=function(t){var e=t.newSyncCounter(1);return this.executeWith(t,null,e.wrap()),e.waitResult()},e.prototype.executeWith=function(e,n,r){var i=this;if(null!=this._first){n=n instanceof t.mwg.core.task.CoreTaskResult?n.clone():new t.mwg.core.task.CoreTaskResult(n,(!0));var o=null;null!=this._hookFactory?o=this._hookFactory.newHook():null!=e.taskHookFactory()&&(o=e.taskHookFactory().newHook());var s=new t.mwg.core.task.CoreTaskContext(null,n,e,o,r);e.scheduler().dispatch(t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(){s.execute(i._first)})}else null!=r&&r(this.emptyResult())},e.prototype.prepareWith=function(e,n,r){n=n instanceof t.mwg.core.task.CoreTaskResult?n.clone():new t.mwg.core.task.CoreTaskResult(n,(!0));var i=null;return null!=this._hookFactory?i=this._hookFactory.newHook():null!=e.taskHookFactory()&&(i=e.taskHookFactory().newHook()),new t.mwg.core.task.CoreTaskContext(null,n,e,i,r)},e.prototype.executeUsing=function(e){var n=this;null!=this._first?e.graph().scheduler().dispatch(t.mwg.plugin.SchedulerAffinity.SAME_THREAD,function(){e.execute(n._first)}):null!=e._callback&&e._callback(this.emptyResult())},e.prototype.executeFrom=function(e,n,r,i){var o=this;if(null!=this._first){var s=new t.mwg.core.task.CoreTaskContext(e,n.clone(),e.graph(),e.hook(),i);e.graph().scheduler().dispatch(r,function(){s.execute(o._first)})}else null!=i&&i(this.emptyResult())},e.prototype.executeFromUsing=function(e,n,r,i,o){var s=this;if(null!=this._first){var a=new t.mwg.core.task.CoreTaskContext(e,n.clone(),e.graph(),e.hook(),o);null!=i&&i(a),e.graph().scheduler().dispatch(r,function(){a.execute(s._first)})}else null!=o&&o(this.emptyResult())},e.prototype.action=function(e,n){if(null==e)throw Error("name should not be null");if(null==n)throw Error("flatParams should not be null");return this.addAction(new t.mwg.core.task.ActionPlugin(e,n)),this},e.prototype.parse=function(e){if(null==e)throw Error("flat should not be null");for(var n=0,r=e.length,i=0,o=null,s=!1,a=!1;n<r;){switch(e.charAt(n)){case"'":for(a=!0;n<r&&"'"!=e.charAt(n);)n++;break;case t.mwg.Constants.TASK_SEP:s||(o=e.substring(i,n),this.action("get",o)),o=null,a=!1,i=n+1;break;case t.mwg.Constants.TASK_PARAM_OPEN:o=e.substring(i,n),i=n+1;break;case t.mwg.Constants.TASK_PARAM_CLOSE:s=a?e.substring(i+1,n-1):e.substring(i,n),this.action(o,s),o=null,i=n+1,s=!0}n++}return s||(o=e.substring(i,n),0<o.length&&this.action("get",o)),this},e.prototype.newNode=function(){return this.addAction(new t.mwg.core.task.ActionNewNode(null)),this},e.prototype.newTypedNode=function(e){return this.addAction(new t.mwg.core.task.ActionNewNode(e)),this},e.prototype.setProperty=function(e,n,r){if(null==e)throw Error("propertyName should not be null");if(null==r)throw Error("variableNameToSet should not be null");return this.addAction(new t.mwg.core.task.ActionSetProperty(e,n,r)),this},e.prototype.removeProperty=function(e){if(null==e)throw Error("propertyName should not be null");return this.addAction(new t.mwg.core.task.ActionRemoveProperty(e)),this},e.prototype.add=function(e,n){if(null==e)throw Error("relationName should not be null");if(null==n)throw Error("variableNameToAdd should not be null");return this.addAction(new t.mwg.core.task.ActionAdd(e,n)),this},e.prototype.addTo=function(e,n){if(null==e)throw Error("relationName should not be null");if(null==n)throw Error("variableNameTarget should not be null");return this.addAction(new t.mwg.core.task.ActionAddTo(e,n)),this},e.prototype.remove=function(e,n){if(null==e)throw Error("relationName should not be null");if(null==n)throw Error("variableNameToRemove should not be null");return this.addAction(new t.mwg.core.task.ActionRemove(e,n)),this},e.prototype.jump=function(e){if(null==e)throw Error("time should not be null");return this.addAction(new t.mwg.core.task.ActionJump(e)),this},e.prototype.math=function(e){return this.addAction(new t.mwg.core.task.ActionMath(e)),this},e.prototype.split=function(e){return this.addAction(new t.mwg.core.task.ActionSplit(e)),this},e.prototype.loop=function(e,n,r){return this.addAction(new t.mwg.core.task.ActionLoop(e,n,r)),this},e.prototype.loopPar=function(e,n,r){return this.addAction(new t.mwg.core.task.ActionLoopPar(e,n,r)),this},e.prototype.print=function(e){return this.addAction(new t.mwg.core.task.ActionPrint(e)),this},e.prototype.hook=function(t){return this._hookFactory=t,this},e.prototype.emptyResult=function(){return new t.mwg.core.task.CoreTaskResult(null,(!1))},e.prototype.mathConditional=function(e){return new t.mwg.core.task.math.MathConditional(e).conditional()},e.fillDefault=function(e){e.put("get",function(e){if(1!=e.length)throw Error("get action need one parameter");return new t.mwg.core.task.ActionGet(e[0])}),e.put("math",function(e){if(1!=e.length)throw Error("math action need one parameter");return new t.mwg.core.task.ActionMath(e[0])}),e.put("traverse",function(e){if(1!=e.length)throw Error("traverse action need one parameter");return new t.mwg.core.task.ActionTraverse(e[0])}),e.put("traverseOrKeep",function(e){if(1!=e.length)throw Error("traverseOrKeep action need one parameter");return new t.mwg.core.task.ActionTraverseOrKeep(e[0])}),e.put("fromIndexAll",function(e){if(1!=e.length)throw Error("fromIndexAll action need one parameter");return new t.mwg.core.task.ActionFromIndexAll(e[0])}),e.put("fromIndex",function(e){if(2!=e.length)throw Error("fromIndex action need two parameter");return new t.mwg.core.task.ActionFromIndex(e[0],e[1])}),e.put("with",function(e){if(2!=e.length)throw Error("with action need two parameter");return new t.mwg.core.task.ActionWith(e[0],e[1])}),e.put("without",function(e){if(2!=e.length)throw Error("without action need two parameter");return new t.mwg.core.task.ActionWithout(e[0],e[1])})},e}(),e.CoreTask=n,n=function(){function e(t,e,n,r,i){this._nextVariables=this._localVariables=null,this._hook=r,this._time=this._world=0,this._graph=n,this._parent=t,this._globalVariables=null==t?new java.util.ConcurrentHashMap:t.globalVariables(),this._result=e,this._callback=i}return e.prototype.graph=function(){return this._graph},e.prototype.world=function(){return this._world},e.prototype.setWorld=function(t){this._world=t},e.prototype.time=function(){return this._time},e.prototype.setTime=function(t){this._time=t},e.prototype.variable=function(t){var e=this._globalVariables.get(t);return null==e&&(e=this.internal_deep_resolve(t)),e},e.prototype.internal_deep_resolve=function(t){var e=null;if(null!=this._localVariables&&(e=this._localVariables.get(t)),null==e&&null!=this._parent){var n=this._parent;return null!=n._nextVariables&&(e=n._nextVariables.get(t),null!=e)?e:n.internal_deep_resolve(t)}return e},e.prototype.wrap=function(e){return new t.mwg.core.task.CoreTaskResult(e,(!1))},e.prototype.wrapClone=function(e){return new t.mwg.core.task.CoreTaskResult(e,(!0))},e.prototype.newResult=function(){return new t.mwg.core.task.CoreTaskResult(null,(!1))},e.prototype.declareVariable=function(e){null==this._localVariables&&(this._localVariables=new java.util.HashMap),this._localVariables.put(e,new t.mwg.core.task.CoreTaskResult(null,(!1)))},e.prototype.lazyWrap=function(e){return e instanceof t.mwg.core.task.CoreTaskResult?e:this.wrap(e)},e.prototype.defineVariable=function(t,e){null==this._localVariables&&(this._localVariables=new java.util.HashMap),this._localVariables.put(t,this.lazyWrap(e).clone())},e.prototype.defineVariableForSubTask=function(t,e){null==this._nextVariables&&(this._nextVariables=new java.util.HashMap),this._nextVariables.put(t,this.lazyWrap(e).clone())},e.prototype.setGlobalVariable=function(t,e){var n=this._globalVariables.put(t,this.lazyWrap(e).clone());null!=n&&n.free()},e.prototype.setVariable=function(t,e){var n=this.internal_deep_resolve_map(t);null==n&&(null==this._localVariables&&(this._localVariables=new java.util.HashMap),n=this._localVariables),n=n.put(t,this.lazyWrap(e).clone()),null!=n&&n.free()},e.prototype.internal_deep_resolve_map=function(t){if(null!=this._localVariables){var e=this._localVariables.get(t);if(null!=e)return this._localVariables}return null!=this._parent?(e=this._parent,null!=e._nextVariables&&(e=e._nextVariables.get(t),null!=e)?this._localVariables:this._parent.internal_deep_resolve_map(t)):null},e.prototype.addToGlobalVariable=function(e,n){var r=this._globalVariables.get(e);if(null==r&&(r=new t.mwg.core.task.CoreTaskResult(null,(!1)),this._globalVariables.put(e,r)),null!=n)if(n instanceof t.mwg.core.task.CoreTaskResult)for(var i=0;i<n.size();i++){var o=n.get(i);o instanceof t.mwg.plugin.AbstractNode?r.add(o.graph().cloneNode(o)):r.add(o)}else n instanceof t.mwg.plugin.AbstractNode?(o=n,r.add(o.graph().cloneNode(o))):r.add(n)},e.prototype.addToVariable=function(e,n){var r=this.internal_deep_resolve_map(e);null==r&&(null==this._localVariables&&(this._localVariables=new java.util.HashMap),r=this._localVariables);var i=r.get(e);if(null==i&&(i=new t.mwg.core.task.CoreTaskResult(null,(!1)),r.put(e,i)),null!=n)if(n instanceof t.mwg.core.task.CoreTaskResult)for(r=0;r<n.size();r++){var o=n.get(r);o instanceof t.mwg.plugin.AbstractNode?i.add(o.graph().cloneNode(o)):i.add(o)}else n instanceof t.mwg.plugin.AbstractNode?(o=n,i.add(o.graph().cloneNode(o))):i.add(n)},e.prototype.globalVariables=function(){return this._globalVariables},e.prototype.nextVariables=function(){return this._globalVariables},e.prototype.variables=function(){return this._localVariables},e.prototype.result=function(){return this._result},e.prototype.resultAsNodes=function(){return this._result},e.prototype.resultAsStrings=function(){return this._result},e.prototype.continueWith=function(t){var e=this._result;null!=e&&e!=t&&e.free(),this._result=t,this.continueTask()},e.prototype.continueTask=function(){null!=this._hook&&this._hook.afterAction(this._current,this);var t=this._current.next();if(this._current=t,null==t){if(null!=this._localVariables)for(var t=this._localVariables.keySet(),e=t.toArray(Array(t.size())),t=0;t<e.length;t++)this._localVariables.get(e[t]).free();if(null!=this._nextVariables)for(t=this._nextVariables.keySet(),e=t.toArray(Array(t.size())),t=0;t<e.length;t++)this._nextVariables.get(e[t]).free();if(null==this._parent)for(t=this._globalVariables.keySet(),e=t.toArray(Array(t.size())),t=0;t<e.length;t++)this._globalVariables.get(e[t]).free();null!=this._hook&&(null==this._parent?this._hook.end(this):this._hook.afterTask(this)),null!=this._callback?this._callback(this._result):null!=this._result&&this._result.free()}else null!=this._hook&&this._hook.beforeAction(t,this),t.eval(this)},e.prototype.execute=function(t){this._current=t,null!=this._hook&&(null==this._parent?this._hook.start(this):this._hook.beforeTask(this._parent,this),this._hook.beforeAction(this._current,this)),this._current.eval(this)},e.prototype.template=function(e){if(null==e)return null;for(var n=0,r=null,i=-1;n<e.length;){var o=e.charAt(n),s="0",a="0";if(0<n&&(s=e.charAt(n-1)),n+1<e.length&&(a=e.charAt(n+1)),"{"==o&&"{"==s)i=n+1;else if(-1!=i&&"}"==o&&"}"==s){if(null==r&&(r=new java.lang.StringBuilder,r.append(e.substring(0,i-2))),i=e.substring(i,n-1).trim(),0<i.length&&"="==i.charAt(0)){for(i=t.mwg.core.task.math.CoreMathExpressionEngine.parse(i.substring(1)).eval(null,this,new java.util.HashMap)+"",o=i.length-1;0<=o;o--){if("."==i.charAt(o)){i=i.substring(0,o);break}if("0"!=i.charAt(o))break}r.append(i)}else{if(s=-1,"]"==i.charAt(i.length-1)){for(a=-1,o=i.length-3;0<=o;o--)if("["==i.charAt(o)){a=o+1;break}if(-1!=a&&(s=t.mwg.core.task.TaskHelper.parseInt(i.substring(a,i.length-1)),i=i.substring(0,a-1),0>s))throw Error("Array index out of range: "+s)}if(o=this.variable(i),null==o&&"result"===i&&(o=this.result()),null!=o)if(1==o.size()||-1!=s)i=-1==s?o.get(0):o.get(s),r.append(i);else{for(i=o.iterator(),r.append("["),o=!0,s=i.next();null!=s;)o?o=!1:r.append(","),r.append(s),s=i.next();r.append("]")}}i=-1}else-1!=i||null==r||"{"==o&&"{"==a||r.append(e.charAt(n));n++}return null==r?e:r.toString()},e.prototype.hook=function(){return this._hook},e.prototype.toString=function(){return"{result:"+this._result.toString()+"}"},e}(),e.CoreTaskContext=n,n=function(){function e(e,n){if(this._size=this._capacity=0,Array.isArray(e))if(this._capacity=this._size=e.length,this._backend=Array(this._size),n)for(var r=0;r<this._size;r++){var i=e[r];this._backend[r]=i instanceof t.mwg.plugin.AbstractNode?i.graph().cloneNode(i):i}else java.lang.System.arraycopy(e,0,this._backend,0,this._size);else if(e instanceof Float64Array){for(i=e,this._backend=Array(i.length),r=0;r<i.length;r++)this._backend[r]=i[r];this._size=this._capacity=this._backend.length}else if(e instanceof Int32Array){for(i=e,this._backend=Array(i.length),r=0;r<i.length;r++)this._backend[r]=i[r];this._size=this._capacity=this._backend.length}else if(e instanceof Float64Array){for(i=e,this._backend=Array(i.length),r=0;r<i.length;r++)this._backend[r]=i[r];this._size=this._capacity=this._backend.length}else if(e instanceof java.util.ArrayList){for(this._backend=Array(e.size()),r=0;r<e.size();r++)this._backend[r]=e.get(r);this._size=this._capacity=this._backend.length}else if(e instanceof t.mwg.core.task.CoreTaskResult){if(this._size=e._size,this._capacity=e._capacity,null!=e._backend)if(this._backend=Array(e._backend.length),n)for(r=0;r<this._size;r++)i=e._backend[r],this._backend[r]=i instanceof t.mwg.plugin.AbstractNode?i.graph().cloneNode(i):i;else java.lang.System.arraycopy(e._backend,0,this._backend,0,this._size)}else null!=e&&(this._backend=Array(1),this._size=this._capacity=1,this._backend[0]=e instanceof t.mwg.plugin.AbstractNode&&n?e.graph().cloneNode(e):e)}return e.prototype.asArray=function(){var t=Array(this._size);return null!=this._backend&&java.lang.System.arraycopy(this._backend,0,t,0,this._size),t},e.prototype.iterator=function(){return new t.mwg.core.task.CoreTaskResultIterator(this._backend)},e.prototype.get=function(t){return t<this._size?this._backend[t]:null},e.prototype.set=function(t,e){t>=this._capacity&&this.extendTil(t),this._backend[t]=e,t>=this._size&&this._size++},e.prototype.allocate=function(t){if(t>=this._capacity){if(null!=this._backend)throw Error("Not implemented yet!!!");this._backend=Array(t),this._capacity=t}},e.prototype.add=function(t){this._size>=this._capacity&&this.extendTil(this._size),this.set(this._size,t)},e.prototype.clear=function(){this._backend=null,this._size=this._capacity=0},e.prototype.clone=function(){return new t.mwg.core.task.CoreTaskResult(this,(!0))},e.prototype.free=function(){for(var e=0;e<this._capacity;e++)this._backend[e]instanceof t.mwg.plugin.AbstractNode&&this._backend[e].free()},e.prototype.size=function(){return this._size},e.prototype.extendTil=function(t){if(this._capacity<=t){var e=2*this._capacity;e<=t&&(e=t+1),t=Array(e),null!=this._backend&&java.lang.System.arraycopy(this._backend,0,t,0,this._size),this._backend=t,this._capacity=e}},e.prototype.toString=function(){return this.toJson(!0)},e.prototype.toJson=function(t){t=new java.lang.StringBuilder,t.append("[");for(var e=0;e<this._size;e++){0!=e&&t.append(",");var n=this._backend[e];null!=n&&t.append(n.toString())}return t.append("]"),t.toString()},e}(),e.CoreTaskResult=n,n=function(){function t(t){this._current=0,this._backend=null!=t?t:[],this._size=this._backend.length}return t.prototype.next=function(){if(this._current<this._size){var t=this._backend[this._current];return this._current++,t}return null},t}(),e.CoreTaskResultIterator=n,n=function(){function e(){}return e.flatNodes=function(e,n){if(e instanceof t.mwg.plugin.AbstractNode)return[e];if(Array.isArray(e)){for(var r=[],i=0;i<e.length;i++)if(e[i]instanceof t.mwg.plugin.AbstractNode){var o=Array(r.length+1);java.lang.System.arraycopy(r,0,o,0,r.length),o[r.length]=e[i],r=o}else if(Array.isArray(e[i])){var s=t.mwg.core.task.TaskHelper.flatNodes(e[i],n),o=Array(r.length+s.length);java.lang.System.arraycopy(r,0,o,0,r.length),java.lang.System.arraycopy(s,0,o,r.length,s.length),r=o}else if(n)throw Error("[ActionIndexOrUnindexNode] The array in result contains an element with wrong type. Expected type: AbstractNode. Actual type: "+e[i]);return r}if(n)throw Error("[ActionIndexOrUnindexNode] Wrong type of result. Expected type is AbstractNode or an array of AbstractNode.Actual type is "+e);return[]},e.parseInt=function(t){return parseInt(t)},e}(),e.TaskHelper=n,function(e){var n=function(){function e(t){this._cacheAST=this.buildAST(this.shuntingYard(t))}return e.parse=function(e){return new t.mwg.core.task.math.CoreMathExpressionEngine(e)},e.isNumber=function(t){return!isNaN(+t)},e.isDigit=function(t){return t=t.charCodeAt(0),48<=t&&57>=t},e.isLetter=function(t){return t=t.charCodeAt(0),65<=t&&90>=t||97<=t&&122>=t},e.isWhitespace=function(t){return t=t.charCodeAt(0),9<=t&&13>=t||32==t||133==t||160==t},e.prototype.shuntingYard=function(e){var n=new java.util.ArrayList,r=new java.util.Stack;e=new t.mwg.core.task.math.MathExpressionTokenizer(e);for(var i=null,o=null;e.hasNext();){var s=e.next();if(t.mwg.core.task.math.MathEntities.getINSTANCE().functions.keySet().contains(s.toUpperCase()))r.push(s),i=s;else if(","===s){for(;!r.isEmpty()&&"("!==r.peek();)n.add(r.pop());if(r.isEmpty())throw Error("Parse error for function '"+i+"'")}else if(t.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(s)){for(var o=t.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(s),a=r.isEmpty()?null:r.peek();t.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(a)&&(o.isLeftAssoc()&&o.getPrecedence()<=t.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(a).getPrecedence()||o.getPrecedence()<t.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(a).getPrecedence());)n.add(r.pop()),a=r.isEmpty()?null:r.peek();r.push(s)}else if("("===s){if(null!=o&&t.mwg.core.task.math.CoreMathExpressionEngine.isNumber(o))throw Error("Missing operator at character position "+e.getPos());r.push(s)}else if(")"===s){for(;!r.isEmpty()&&"("!==r.peek();)n.add(r.pop());if(r.isEmpty())throw Error("Mismatched parentheses");r.pop(),!r.isEmpty()&&t.mwg.core.task.math.MathEntities.getINSTANCE().functions.keySet().contains(r.peek().toUpperCase())&&n.add(r.pop())}else n.add(s);o=s}for(;!r.isEmpty();){if(e=r.pop(),"("===e||")"===e)throw Error("Mismatched parentheses");n.add(e)}return n},e.prototype.eval=function(t,e,n){if(null==this._cacheAST)throw Error("Call parse before");for(var r=new java.util.Stack,i=0;i<this._cacheAST.length;i++){var o=this._cacheAST[i];switch(o.type()){case 0:var s=r.pop(),a=r.pop();r.push(o.eval(a,s));break;case 1:for(s=o,a=new Float64Array(s.getNumParams()),o=s.getNumParams()-1;0<=o;o--)a[o]=r.pop();r.push(s.eval(a));break;case 2:r.push(o.content());break;case 3:if(s=o,o=null,null!=n&&(o=n.get(s.content())),null!=o)r.push(o);else if("TIME"===s.content())r.push(t.time());else{var l=s.content().trim(),h=a=null;if(null!=t&&(0<l.length&&"{"==l.charAt(0)&&"}"==l.charAt(l.length-1)?(a=t.get(s.content().substring(1,l.length-1)),h=s.content().substring(1,l.length-1)):(a=t.get(s.content()),h=s.content()),0<h.length&&"$"==h.charAt(0)&&(h=h.substring(1))),null!=e&&null==a)if("]"==l.charAt(l.length-1)){for(var u=-1,c=-1,o=l.length-3;0<=o;o--)if("["==l.charAt(o)){u=o+1;break}-1!=u&&(c=this.parseInt(l.substring(u,l.length-1)),l=l.substring(0,u-1)),o=e.variable(l),null==o&&"result"===l&&(o=e.result()),null!=o&&o.size()>c&&(a=o.get(c))}else o=e.variable(l),null==o&&"result"===l&&(o=e.result()),null!=o&&(a=o.get(0));if(null==a)throw Error("Unknow variable for name "+s.content());if(o=this.parseDouble(a.toString()),n.put(h,o),s=a.toString(),"true"===s)r.push(1);else if("false"===s)r.push(0);else try{r.push(o)}catch(p){if(!(p instanceof Error))throw p}}}}return t=r.pop(),null==t?0:t},e.prototype.buildAST=function(e){for(var n=Array(e.size()),r=0;r<e.size();r++){var i=e.get(r);if(t.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(i))n[r]=t.mwg.core.task.math.MathEntities.getINSTANCE().operators.get(i);else if(t.mwg.core.task.math.MathEntities.getINSTANCE().functions.keySet().contains(i.toUpperCase()))n[r]=t.mwg.core.task.math.MathEntities.getINSTANCE().functions.get(i.toUpperCase());else if(0<i.length&&t.mwg.core.task.math.CoreMathExpressionEngine.isLetter(i.charAt(0)))n[r]=new t.mwg.core.task.math.MathFreeToken(i);else try{var o=this.parseDouble(i);n[r]=new t.mwg.core.task.math.MathDoubleToken(o)}catch(s){if(!(s instanceof Error))throw s;n[r]=new t.mwg.core.task.math.MathFreeToken(i)}}return n},e.prototype.parseDouble=function(t){return parseFloat(t)},e.prototype.parseInt=function(t){return parseInt(t)},e.decimalSeparator=".",e.minusSign="-",e}();e.CoreMathExpressionEngine=n,n=function(){function e(e){this._expression=e,this._engine=t.mwg.core.task.math.CoreMathExpressionEngine.parse(e)}return e.prototype.conditional=function(){var t=this;return function(e){var n=new java.util.HashMap;return n.put("PI",Math.PI),n.put("TRUE",1),n.put("FALSE",0),.5<=t._engine.eval(null,e,n)}},e.prototype.toString=function(){return"cond('"+this._expression+"')"},e}(),e.MathConditional=n,n=function(){function t(t){this._content=t}return t.prototype.type=function(){return 2},t.prototype.content=function(){return this._content},t}(),e.MathDoubleToken=n,n=function(){function e(){this.operators=new java.util.HashMap,this.operators.put("+",new t.mwg.core.task.math.MathOperation("+",20,(!0))),this.operators.put("-",new t.mwg.core.task.math.MathOperation("-",20,(!0))),this.operators.put("*",new t.mwg.core.task.math.MathOperation("*",30,(!0))),this.operators.put("/",new t.mwg.core.task.math.MathOperation("/",30,(!0))),this.operators.put("%",new t.mwg.core.task.math.MathOperation("%",30,(!0))),this.operators.put("^",new t.mwg.core.task.math.MathOperation("^",40,(!1))),this.operators.put("&&",new t.mwg.core.task.math.MathOperation("&&",4,(!1))),this.operators.put("||",new t.mwg.core.task.math.MathOperation("||",2,(!1))),this.operators.put(">",new t.mwg.core.task.math.MathOperation(">",10,(!1))),this.operators.put(">=",new t.mwg.core.task.math.MathOperation(">=",10,(!1))),this.operators.put("<",new t.mwg.core.task.math.MathOperation("<",10,(!1))),this.operators.put("<=",new t.mwg.core.task.math.MathOperation("<=",10,(!1))),this.operators.put("==",new t.mwg.core.task.math.MathOperation("==",7,(!1))),this.operators.put("!=",new t.mwg.core.task.math.MathOperation("!=",7,(!1))),this.functions=new java.util.HashMap,this.functions.put("NOT",new t.mwg.core.task.math.MathFunction("NOT",1)),this.functions.put("IF",new t.mwg.core.task.math.MathFunction("IF",3)),this.functions.put("RAND",new t.mwg.core.task.math.MathFunction("RAND",0)),this.functions.put("SIN",new t.mwg.core.task.math.MathFunction("SIN",1)),this.functions.put("COS",new t.mwg.core.task.math.MathFunction("COS",1)),this.functions.put("TAN",new t.mwg.core.task.math.MathFunction("TAN",1)),this.functions.put("ASIN",new t.mwg.core.task.math.MathFunction("ASIN",1)),this.functions.put("ACOS",new t.mwg.core.task.math.MathFunction("ACOS",1)),this.functions.put("ATAN",new t.mwg.core.task.math.MathFunction("ATAN",1)),this.functions.put("MAX",new t.mwg.core.task.math.MathFunction("MAX",2)),this.functions.put("MIN",new t.mwg.core.task.math.MathFunction("MIN",2)),this.functions.put("ABS",new t.mwg.core.task.math.MathFunction("ABS",1)),this.functions.put("LOG",new t.mwg.core.task.math.MathFunction("LOG",1)),this.functions.put("ROUND",new t.mwg.core.task.math.MathFunction("ROUND",2)),this.functions.put("FLOOR",new t.mwg.core.task.math.MathFunction("FLOOR",1)),this.functions.put("CEILING",new t.mwg.core.task.math.MathFunction("CEILING",1)),this.functions.put("SQRT",new t.mwg.core.task.math.MathFunction("SQRT",1)),this.functions.put("SECONDS",new t.mwg.core.task.math.MathFunction("SECONDS",1)),this.functions.put("MINUTES",new t.mwg.core.task.math.MathFunction("MINUTES",1)),this.functions.put("HOURS",new t.mwg.core.task.math.MathFunction("HOURS",1)),this.functions.put("DAY",new t.mwg.core.task.math.MathFunction("DAY",1)),this.functions.put("MONTH",new t.mwg.core.task.math.MathFunction("MONTH",1)),this.functions.put("YEAR",new t.mwg.core.task.math.MathFunction("YEAR",1)),this.functions.put("DAYOFWEEK",new t.mwg.core.task.math.MathFunction("DAYOFWEEK",1))}return e.getINSTANCE=function(){return null==e.INSTANCE&&(e.INSTANCE=new t.mwg.core.task.math.MathEntities),e.INSTANCE},e.INSTANCE=null,e}(),e.MathEntities=n,n=function(){function e(t){this.pos=0,this.input=t.trim()}return e.prototype.hasNext=function(){return this.pos<this.input.length},e.prototype.peekNextChar=function(){return this.pos<this.input.length-1?this.input.charAt(this.pos+1):"\0"},e.prototype.next=function(){var e=new java.lang.StringBuilder;if(this.pos>=this.input.length)return this.previousToken=null;for(var n=this.input.charAt(this.pos);t.mwg.core.task.math.CoreMathExpressionEngine.isWhitespace(n)&&this.pos<this.input.length;)n=this.input.charAt(++this.pos);if(t.mwg.core.task.math.CoreMathExpressionEngine.isDigit(n))for(;(t.mwg.core.task.math.CoreMathExpressionEngine.isDigit(n)||n==t.mwg.core.task.math.CoreMathExpressionEngine.decimalSeparator)&&this.pos<this.input.length;)e.append(this.input.charAt(this.pos++)),n=this.pos==this.input.length?"\0":this.input.charAt(this.pos);else if(n==t.mwg.core.task.math.CoreMathExpressionEngine.minusSign&&t.mwg.core.task.math.CoreMathExpressionEngine.isDigit(this.peekNextChar())&&("("===this.previousToken||","===this.previousToken||null==this.previousToken||t.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(this.previousToken)))e.append(t.mwg.core.task.math.CoreMathExpressionEngine.minusSign),this.pos++,e.append(this.next());else if(t.mwg.core.task.math.CoreMathExpressionEngine.isLetter(n)||"_"==n||"{"==n||"}"==n||"$"==n){for(;(t.mwg.core.task.math.CoreMathExpressionEngine.isLetter(n)||t.mwg.core.task.math.CoreMathExpressionEngine.isDigit(n)||"_"==n||"{"==n||"}"==n||"$"==n)&&this.pos<this.input.length;)e.append(this.input.charAt(this.pos++)),n=this.pos==this.input.length?"\0":this.input.charAt(this.pos);if(this.pos<this.input.length&&"["==this.input.charAt(this.pos)){for(e.append(this.input.charAt(this.pos++)),n=this.pos==this.input.length?"\0":this.input.charAt(this.pos);t.mwg.core.task.math.CoreMathExpressionEngine.isDigit(n)&&this.pos<this.input.length;)e.append(this.input.charAt(this.pos++)),n=this.pos==this.input.length?"\0":this.input.charAt(this.pos);if("]"!=this.input.charAt(this.pos))throw Error("Error in array definition '"+e+"' at position "+(this.pos-e.length+1));e.append(this.input.charAt(this.pos++))}}else if("("==n||")"==n||","==n)e.append(n),this.pos++;else{for(;!t.mwg.core.task.math.CoreMathExpressionEngine.isLetter(n)&&!t.mwg.core.task.math.CoreMathExpressionEngine.isDigit(n)&&"_"!=n&&!t.mwg.core.task.math.CoreMathExpressionEngine.isWhitespace(n)&&"("!=n&&")"!=n&&","!=n&&"{"!=n&&"}"!=n&&"$"!=n&&this.pos<this.input.length&&(e.append(this.input.charAt(this.pos)),this.pos++,n=this.pos==this.input.length?"\0":this.input.charAt(this.pos),n!=t.mwg.core.task.math.CoreMathExpressionEngine.minusSign););if(!t.mwg.core.task.math.MathEntities.getINSTANCE().operators.keySet().contains(e.toString()))throw Error("Unknown operator '"+e+"' at position "+(this.pos-e.length+1))}return this.previousToken=e.toString()},e.prototype.getPos=function(){return this.pos},e}(),e.MathExpressionTokenizer=n,n=function(){function t(t){this._content=t}return t.prototype.content=function(){return this._content},t.prototype.type=function(){return 3},t}(),e.MathFreeToken=n,n=function(){
function t(t,e){this.name=t.toUpperCase(),this.numParams=e}return t.prototype.getName=function(){return this.name},t.prototype.getNumParams=function(){return this.numParams},t.prototype.eval=function(t){if("NOT"===this.name)return 0==t[0]?1:0;if("IF"===this.name)return 0!=t[0]?t[1]:t[2];if("RAND"===this.name)return Math.random();if("SIN"===this.name)return Math.sin(t[0]);if("COS"===this.name)return Math.cos(t[0]);if("TAN"===this.name)return Math.tan(t[0]);if("ASIN"===this.name)return Math.asin(t[0]);if("ACOS"===this.name)return Math.acos(t[0]);if("ATAN"===this.name)return Math.atan(t[0]);if("MAX"===this.name)return t[0]>t[1]?t[0]:t[1];if("MIN"===this.name)return t[0]<t[1]?t[0]:t[1];if("ABS"===this.name)return Math.abs(t[0]);if("LOG"===this.name)return Math.log(t[0]);if("ROUND"===this.name){var e=Math.pow(10,t[1]);return Math.round(t[0]*e)/e}return"FLOOR"===this.name?Math.floor(t[0]):"CEILING"===this.name?Math.ceil(t[0]):"SQRT"===this.name?Math.sqrt(t[0]):"SECONDS"===this.name?this.date_to_seconds(t[0]):"MINUTES"===this.name?this.date_to_minutes(t[0]):"HOURS"===this.name?this.date_to_hours(t[0]):"DAY"===this.name?this.date_to_days(t[0]):"MONTH"===this.name?this.date_to_months(t[0]):"YEAR"===this.name?this.date_to_year(t[0]):"DAYOFWEEK"===this.name?this.date_to_dayofweek(t[0]):0},t.prototype.date_to_seconds=function(t){return new Date(t).getSeconds()},t.prototype.date_to_minutes=function(t){return new Date(t).getMinutes()},t.prototype.date_to_hours=function(t){return new Date(t).getHours()},t.prototype.date_to_days=function(t){return new Date(t).getDate()},t.prototype.date_to_months=function(t){return new Date(t).getMonth()},t.prototype.date_to_year=function(t){return new Date(t).getFullYear()},t.prototype.date_to_dayofweek=function(t){return new Date(t).getDay()},t.prototype.type=function(){return 1},t}(),e.MathFunction=n,n=function(){function t(t,e,n){this.oper=t,this.precedence=e,this.leftAssoc=n}return t.prototype.getOper=function(){return this.oper},t.prototype.getPrecedence=function(){return this.precedence},t.prototype.isLeftAssoc=function(){return this.leftAssoc},t.prototype.eval=function(t,e){return"+"===this.oper?t+e:"-"===this.oper?t-e:"*"===this.oper?t*e:"/"===this.oper?t/e:"%"===this.oper?t%e:"^"===this.oper?Math.pow(t,e):"&&"===this.oper?0!=t&&0!=e?1:0:"||"===this.oper?0!=t||0!=e?1:0:">"===this.oper?t>e?1:0:">="===this.oper?t>=e?1:0:"<"===this.oper?t<e?1:0:"<="===this.oper?t<=e?1:0:"=="===this.oper?t==e?1:0:"!="===this.oper&&t!=e?1:0},t.prototype.type=function(){return 0},t}(),e.MathOperation=n}(e.math||(e.math={}))}(e.task||(e.task={})),function(t){var e=function(){function t(t){this._counter=t,this._nb_down=new java.util.concurrent.atomic.AtomicInteger(0)}return t.prototype.count=function(){var t,e;do t=this._nb_down.get(),e=t+1;while(!this._nb_down.compareAndSet(t,e));e==this._counter&&null!=this._end&&this._end()},t.prototype.getCount=function(){return this._nb_down.get()},t.prototype.then=function(t){this._end=t,this._nb_down.get()==this._counter&&null!=t&&t()},t.prototype.wrap=function(){var t=this;return function(e){t.count()}},t}();t.CoreDeferCounter=e,e=function(){function t(t){this._result=null,this._counter=t,this._nb_down=new java.util.concurrent.atomic.AtomicInteger(0)}return t.prototype.count=function(){this._nb_down.set(this._nb_down.get()+1),this._nb_down.get()==this._counter&&null!=this._end&&this._end()},t.prototype.getCount=function(){return this._nb_down.get()},t.prototype.then=function(t){this._end=t,this._nb_down.get()==this._counter&&null!=t&&t()},t.prototype.wrap=function(){var t=this;return function(e){t._result=e,t.count()}},t.prototype.waitResult=function(){for(;this._nb_down.get()!=this._counter;);return this._result},t}(),t.CoreDeferCounterSync=e,e=function(){function t(t){this.wrapped=t}return t.prototype.get=function(t,e){this.wrapped.get(t,e)},t.prototype.put=function(t,e){console.error("WARNING: PUT TO A READ ONLY STORAGE")},t.prototype.remove=function(t,e){console.error("WARNING: REMOVE TO A READ ONLY STORAGE")},t.prototype.connect=function(t,e){this.wrapped.connect(t,e)},t.prototype.disconnect=function(t){this.wrapped.disconnect(t)},t.prototype.lock=function(t){this.wrapped.lock(t)},t.prototype.unlock=function(t,e){this.wrapped.unlock(t,e)},t}(),t.ReadOnlyStorage=e}(e.utility||(e.utility={}))}(e.core||(e.core={}))}(t.mwg||(t.mwg={}))}(org||(org={}));var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)},org;!function(t){!function(e){!function(e){!function(e){!function(e){!function(e){!function(e){var n=function(){function e(){this.netlib=Module,this.c_dgemm=this.netlib.cwrap("f2c_dgemm",null,"number number number number number number number number number number number number number number number number".split(" ")),this.c_dgetrs=this.netlib.cwrap("dgetrs_",null,"number number number number number number number number number".split(" ")),this.c_dgetri=this.netlib.cwrap("dgetri_",null,"number number number number number number number".split(" ")),this.c_dorgqr=this.netlib.cwrap("dorgqr_",null,"number number number number number number number number number".split(" ")),this.c_dgesdd=this.netlib.cwrap("dgesdd_",null,"number number number number number number number number number number number number number number".split(" ")),this.c_dgeqrf=this.netlib.cwrap("dgeqrf_",null,"number number number number number number number number".split(" ")),this.c_dgetrf=this.netlib.cwrap("dgetrf_",null,"number number number number number number".split(" "))}return e.prototype.dgemm=function(e,n,r,i,o,s,a,l,h,u,c,p,m,g,f,_){l=this.netlib._malloc(1),c=this.netlib._malloc(1),f=this.netlib._malloc(4);var y=this.netlib._malloc(4),d=this.netlib._malloc(4),w=this.netlib._malloc(8),A=this.netlib._malloc(8*a.length),T=this.netlib._malloc(4),E=this.netlib._malloc(8*u.length),v=this.netlib._malloc(4),N=this.netlib._malloc(8),b=this.netlib._malloc(8*g.length),k=this.netlib._malloc(4);this.netlib.setValue(l,t.mwg.ml.common.matrix.blassolver.blas.BlasHelper.transTypeToChar(e).charCodeAt(0),"i8"),this.netlib.setValue(c,t.mwg.ml.common.matrix.blassolver.blas.BlasHelper.transTypeToChar(n).charCodeAt(0),"i8"),this.netlib.setValue(f,r,"i32"),this.netlib.setValue(y,i,"i32"),this.netlib.setValue(d,o,"i32"),this.netlib.setValue(w,s,"double"),new Float64Array(this.netlib.HEAPF64.buffer,A,a.length).set(a),this.netlib.setValue(T,h,"i32"),new Float64Array(this.netlib.HEAPF64.buffer,E,u.length).set(u),this.netlib.setValue(v,p,"i32"),this.netlib.setValue(N,m,"double"),e=new Float64Array(this.netlib.HEAPF64.buffer,b,g.length),e.set(g),this.netlib.setValue(k,_,"i32"),this.c_dgemm(l,c,f,y,d,w,A,T,E,v,N,b,k),g.set(e),this.netlib._free(l),this.netlib._free(c),this.netlib._free(f),this.netlib._free(y),this.netlib._free(d),this.netlib._free(w),this.netlib._free(A),this.netlib._free(T),this.netlib._free(E),this.netlib._free(v),this.netlib._free(N),this.netlib._free(b),this.netlib._free(k)},e.prototype.dgetrs=function(e,n,r,i,o,s,a,l,h,u,c,p){o=this.netlib._malloc(1),l=this.netlib._malloc(4),u=this.netlib._malloc(4);var m=this.netlib._malloc(8*i.length),g=this.netlib._malloc(4),f=this.netlib._malloc(4*a.length),_=this.netlib._malloc(8*h.length),y=this.netlib._malloc(4),d=this.netlib._malloc(4*p.length);this.netlib.setValue(o,t.mwg.ml.common.matrix.blassolver.blas.BlasHelper.transTypeToChar(e).charCodeAt(0),"i8"),this.netlib.setValue(l,n,"i32"),this.netlib.setValue(u,r,"i32"),new Float64Array(this.netlib.HEAPF64.buffer,m,i.length).set(i),this.netlib.setValue(g,s,"i32"),new Int32Array(this.netlib.HEAP32.buffer,f,a.length).set(a),e=new Float64Array(this.netlib.HEAPF64.buffer,_,h.length),e.set(h),this.netlib.setValue(y,c,"i32"),c=new Int32Array(this.netlib.HEAP32.buffer,d,p.length),c.set(p),this.c_dgetrs(o,l,u,m,g,f,_,y,d),h.set(e),p.set(c),this.netlib._free(o),this.netlib._free(l),this.netlib._free(u),this.netlib._free(m),this.netlib._free(g),this.netlib._free(f),this.netlib._free(_),this.netlib._free(y),this.netlib._free(d)},e.prototype.dgetri=function(t,e,n,r,i,o,s,a,l,h){n=this.netlib._malloc(4),o=this.netlib._malloc(8*e.length),a=this.netlib._malloc(4);var u=this.netlib._malloc(4*i.length),c=this.netlib._malloc(8*s.length),p=this.netlib._malloc(4),m=this.netlib._malloc(4*h.length);this.netlib.setValue(n,t,"i32"),t=new Float64Array(this.netlib.HEAPF64.buffer,o,e.length),t.set(e),this.netlib.setValue(a,r,"i32"),new Int32Array(this.netlib.HEAP32.buffer,u,i.length).set(i),r=new Float64Array(this.netlib.HEAPF64.buffer,c,s.length),r.set(s),this.netlib.setValue(p,l,"i32"),l=new Int32Array(this.netlib.HEAP32.buffer,m,h.length),l.set(h),this.c_dgetri(n,o,a,u,c,p,m),e.set(t),s.set(r),h.set(l),this.netlib._free(n),this.netlib._free(o),this.netlib._free(a),this.netlib._free(u),this.netlib._free(c),this.netlib._free(p),this.netlib._free(m)},e.prototype.dgetrf=function(t,e,n,r,i,o,s,a){r=this.netlib._malloc(4),s=this.netlib._malloc(4);var l=this.netlib._malloc(8*n.length),h=this.netlib._malloc(4),u=this.netlib._malloc(4*o.length),c=this.netlib._malloc(4*a.length);this.netlib.setValue(r,t,"i32"),this.netlib.setValue(s,e,"i32"),t=new Float64Array(this.netlib.HEAPF64.buffer,l,n.length),t.set(n),this.netlib.setValue(h,i,"i32"),i=new Int32Array(this.netlib.HEAP32.buffer,u,o.length),i.set(o),e=new Int32Array(this.netlib.HEAP32.buffer,c,a.length),e.set(a),this.c_dgetrf(r,s,l,h,u,c),n.set(t),o.set(i),a.set(e),this.netlib._free(r),this.netlib._free(s),this.netlib._free(l),this.netlib._free(h),this.netlib._free(u),this.netlib._free(c)},e.prototype.dorgqr=function(t,e,n,r,i,o,s,a,l,h,u,c){i=this.netlib._malloc(4),a=this.netlib._malloc(4),h=this.netlib._malloc(4);var p=this.netlib._malloc(8*r.length),m=this.netlib._malloc(4),g=this.netlib._malloc(8*s.length),f=this.netlib._malloc(8*l.length),_=this.netlib._malloc(4),y=this.netlib._malloc(4*c.length);this.netlib.setValue(i,t,"i32"),this.netlib.setValue(a,e,"i32"),this.netlib.setValue(h,n,"i32"),t=new Float64Array(this.netlib.HEAPF64.buffer,p,r.length),t.set(r),this.netlib.setValue(m,o,"i32"),new Float64Array(this.netlib.HEAPF64.buffer,g,s.length).set(s),o=new Float64Array(this.netlib.HEAPF64.buffer,f,l.length),o.set(l),this.netlib.setValue(_,u,"i32"),u=new Int32Array(this.netlib.HEAP32.buffer,y,c.length),u.set(c),this.c_dorgqr(i,a,h,p,m,g,f,_,y),r.set(t),l.set(o),c.set(u),this.netlib._free(i),this.netlib._free(a),this.netlib._free(h),this.netlib._free(p),this.netlib._free(m),this.netlib._free(g),this.netlib._free(f),this.netlib._free(_),this.netlib._free(y)},e.prototype.dgeqrf=function(t,e,n,r,i,o,s,a,l,h,u){r=this.netlib._malloc(4),s=this.netlib._malloc(4),l=this.netlib._malloc(8*n.length);var c=this.netlib._malloc(4),p=this.netlib._malloc(8*o.length),m=this.netlib._malloc(8*a.length),g=this.netlib._malloc(4),f=this.netlib._malloc(4*u.length);this.netlib.setValue(r,t,"i32"),this.netlib.setValue(s,e,"i32"),t=new Float64Array(this.netlib.HEAPF64.buffer,l,n.length),t.set(n),this.netlib.setValue(c,i,"i32"),i=new Float64Array(this.netlib.HEAPF64.buffer,p,o.length),i.set(o),e=new Float64Array(this.netlib.HEAPF64.buffer,m,a.length),e.set(a),this.netlib.setValue(g,h,"i32"),h=new Int32Array(this.netlib.HEAP32.buffer,f,u.length),h.set(u),this.c_dgeqrf(r,s,l,c,p,m,g,f),n.set(t),o.set(i),a.set(e),u.set(h),this.netlib._free(r),this.netlib._free(s),this.netlib._free(l),this.netlib._free(c),this.netlib._free(p),this.netlib._free(m),this.netlib._free(g),this.netlib._free(f)},e.prototype.dgesdd=function(t,e,n,r,i,o,s,a,l,h,u,c,p,m){var g=this.netlib._malloc(1),f=this.netlib._malloc(4),_=this.netlib._malloc(4),y=this.netlib._malloc(8*r.length),d=this.netlib._malloc(4),w=this.netlib._malloc(8*o.length),A=this.netlib._malloc(8*s.length),T=this.netlib._malloc(4),E=this.netlib._malloc(8*l.length),v=this.netlib._malloc(4),N=this.netlib._malloc(8*u.length),b=this.netlib._malloc(4),k=this.netlib._malloc(4*p.length),S=this.netlib._malloc(4*m.length);this.netlib.setValue(g,t.charCodeAt(0),"i8"),this.netlib.setValue(f,e,"i32"),this.netlib.setValue(_,n,"i32"),t=new Float64Array(this.netlib.HEAPF64.buffer,y,r.length),t.set(r),this.netlib.setValue(d,i,"i32"),i=new Float64Array(this.netlib.HEAPF64.buffer,w,o.length),i.set(o),e=new Float64Array(this.netlib.HEAPF64.buffer,A,s.length),e.set(s),this.netlib.setValue(T,a,"i32"),a=new Float64Array(this.netlib.HEAPF64.buffer,E,l.length),a.set(l),this.netlib.setValue(v,h,"i32"),h=new Float64Array(this.netlib.HEAPF64.buffer,N,u.length),h.set(u),this.netlib.setValue(b,c,"i32"),c=new Int32Array(this.netlib.HEAP32.buffer,k,p.length),c.set(p),n=new Int32Array(this.netlib.HEAP32.buffer,S,m.length),n.set(m),this.c_dgesdd(g,f,_,y,d,w,A,T,E,v,N,b,k,S),r.set(t),o.set(i),s.set(e),l.set(a),u.set(h),p.set(c),m.set(n),this.netlib._free(g),this.netlib._free(f),this.netlib._free(_),this.netlib._free(y),this.netlib._free(d),this.netlib._free(w),this.netlib._free(A),this.netlib._free(T),this.netlib._free(E),this.netlib._free(v),this.netlib._free(N),this.netlib._free(b),this.netlib._free(k),this.netlib._free(S)},e.prototype.connect=function(){},e.prototype.disconnect=function(){},e}();e.JSBlas=n}(e.blas||(e.blas={}))}(e.blassolver||(e.blassolver={}))}(e.matrix||(e.matrix={}))}(e.common||(e.common={}))}(e.ml||(e.ml={}))}(t.mwg||(t.mwg={}))}(org||(org={})),function(t){!function(e){!function(e){var n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.requireNotNull=function(t,e){if(null==t)throw Error(e)},n.prototype.illegalArgumentIfFalse=function(t,e){if(!t)throw Error(e)},n.prototype.extractFeatures=function(r){var i=e.prototype.get.call(this,n.FROM);if(null!=i){for(var i=i.split(n.FROM_SEPARATOR),o=Array(i.length),s=0;s<i.length;s++){var a=t.mwg.task.Actions.setWorld(""+this.world());a.setTime(this.time()+""),a.parse(i[s].trim()),o[s]=a}for(var l=new Float64Array(o.length),h=this.graph().newCounter(o.length),s=0;s<i.length;s++){var u=s,a=t.mwg.task.Actions.newTask().emptyResult();a.add(this),o[s].executeWith(this.graph(),a,function(e){null==e?l[u]=t.mwg.Constants.NULL_LONG:(l[u]=parseFloat(e.get(0).toString()),e.free()),h.count()})}h.then(function(){r(l)})}else r(null)},n.FROM_SEPARATOR=";",n.FROM="from",n}(t.mwg.plugin.AbstractNode);e.AbstractMLNode=n,n=function(e){function n(){e.call(this),this.declareNodeType(t.mwg.ml.algorithm.regression.PolynomialNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.regression.PolynomialNode(e,n,r,i)}),this.declareNodeType(t.mwg.ml.algorithm.profiling.GaussianSlotNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.profiling.GaussianSlotNode(e,n,r,i)}),this.declareNodeType(t.mwg.ml.algorithm.profiling.GaussianMixtureNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.profiling.GaussianMixtureNode(e,n,r,i)}),this.declareNodeType(t.mwg.ml.algorithm.regression.LiveLinearRegressionNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.regression.LiveLinearRegressionNode(e,n,r,i)}),this.declareNodeType(t.mwg.ml.algorithm.anomalydetector.InterquartileRangeOutlierDetectorNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.anomalydetector.InterquartileRangeOutlierDetectorNode(e,n,r,i)}),this.declareNodeType(t.mwg.ml.common.structure.KDTree.NAME,function(e,n,r,i){return new t.mwg.ml.common.structure.KDTree(e,n,r,i)}),this.declareNodeType(t.mwg.ml.algorithm.profiling.GaussianTreeNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.profiling.GaussianTreeNode(e,n,r,i)}),this.declareNodeType(t.mwg.ml.algorithm.profiling.GaussianNode.NAME,function(e,n,r,i){return new t.mwg.ml.algorithm.profiling.GaussianNode(e,n,r,i)})}return __extends(n,e),n}(t.mwg.plugin.AbstractPlugin),e.MLPlugin=n,function(e){!function(e){var n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.addValue=function(e){this.illegalArgumentIfFalse(null!=e,"Value must be not null");var r=this.unphasedState(),i=r.getFromKeyWithDefault(n.INPUT_DIM_KEY,n.INPUT_DIM_DEF);0>i&&(i=e.length,r.setFromKey(n.INPUT_DIM_KEY,t.mwg.Type.INT,e.length));var o=r.getFromKeyWithDefault(n.INTERNAL_VALUE_BUFFER_KEY,new Float64Array(0)),s=o.length/i,a=r.getFromKeyWithDefault(n.BUFFER_SIZE_KEY,n.BUFFER_SIZE_DEF),l=Math.max(0,s+1-a),s=s+1-l,a=new Float64Array(s*i);java.lang.System.arraycopy(o,l*i,a,0,a.length-i),java.lang.System.arraycopy(e,0,a,a.length-i,i);for(var o=new Float64Array(i),l=new Float64Array(i),h=0;h<i;h++){for(var u=new Float64Array(s),c=h,p=0;p<s;p++)u[p]=a[c],c+=i;u.sort(),c=u[Math.min(Math.round(s*n.UPPER_PERCENTILE),s-1)],u=u[Math.max(Math.round(s*n.LOWER_PERCENTILE),0)],p=c-u,o[h]=c+n.RANGE_COEF*p,l[h]=u-n.RANGE_COEF*p,r.setFromKey(n.UPPER_BOUND_KEY_PREFIX+h,t.mwg.Type.DOUBLE,o[h]),r.setFromKey(n.LOWER_BOUND_KEY_PREFIX+h,t.mwg.Type.DOUBLE,l[h])}return r.setFromKey(n.INTERNAL_VALUE_BUFFER_KEY,t.mwg.Type.DOUBLE_ARRAY,a),this.checkValue(e,o,l)},n.prototype.checkValue=function(t,e,n){for(var r=0;r<t.length;r++)if(!(t[r]<=n[r]&&t[r]>=e[r]))return!0;return!1},n.prototype.learn=function(t){var e=this;this.extractFeatures(function(n){n=e.addValue(n),t(n)})},n.prototype.classify=function(e){var n=this;this.extractFeatures(function(r){for(var i=new Float64Array(r.length),o=new Float64Array(r.length),s=n.unphasedState(),a=0;a<r.length;a++)i[a]=s.getFromKey(t.mwg.ml.algorithm.anomalydetector.InterquartileRangeOutlierDetectorNode.LOWER_BOUND_KEY_PREFIX+a),o[a]=s.getFromKey(t.mwg.ml.algorithm.anomalydetector.InterquartileRangeOutlierDetectorNode.UPPER_BOUND_KEY_PREFIX+a);r=n.checkValue(r,i,o),e(r)})},n.prototype.setProperty=function(t,r,i){n.INTERNAL_VALUE_BUFFER_KEY!==t&&n.INPUT_DIM_KEY!==t&&(n.enforcer.check(t,r,i),e.prototype.setProperty.call(this,t,r,i))},n.MAX_BUFFER_LIMIT=1e5,n.NAME="InterquartileRangeAnomalyDetection",n.INTERNAL_VALUE_BUFFER_KEY="_valueBuffer",n.BUFFER_SIZE_KEY="BufferSize",n.BUFFER_SIZE_DEF=50,n.INPUT_DIM_KEY="InputDimensions",n.INPUT_DIM_DEF=-1,n.UPPER_PERCENTILE=.75,n.LOWER_PERCENTILE=.25,n.RANGE_COEF=1.5,n.UPPER_BOUND_KEY_PREFIX="UpperBoundDimension",n.LOWER_BOUND_KEY_PREFIX="LowerBoundDimension",n.enforcer=(new t.mwg.utility.Enforcer).asIntWithin(n.BUFFER_SIZE_KEY,1,n.MAX_BUFFER_LIMIT),n}(t.mwg.ml.AbstractMLNode);e.InterquartileRangeOutlierDetectorNode=n}(e.anomalydetector||(e.anomalydetector={})),function(e){var n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.setProperty=function(t,r,i){n.enforcer.check(t,r,i),e.prototype.setProperty.call(this,t,r,i)},n.prototype.type=function(r){return r===n.AVG?t.mwg.Type.DOUBLE_ARRAY:r===n.MIN?t.mwg.Type.DOUBLE_ARRAY:r===n.MAX?t.mwg.Type.DOUBLE_ARRAY:r===n.COV?t.mwg.Type.DOUBLE_ARRAY:r===n.PRECISION?t.mwg.Type.DOUBLE_ARRAY:e.prototype.type.call(this,r)},n.prototype.get=function(t){if(t===n.AVG)return this.getAvg();if(t===n.MIN)return this.getMin();if(t===n.MAX||t===n.MAX)return this.getMax();if(t===n.COV){t=this._resolver.resolveState(this).getFromKey(n.PRECISION);var r=this.getNumberOfFeatures();if(null==t){t=new Float64Array(r);for(var i=0;i<r;i++)t[i]=1}return this.getCovariance(this.getAvg(),t)}return e.prototype.get.call(this,t)},n.prototype.learn=function(t){var e=this;this.extractFeatures(function(n){e.learnVector(n,t)})},n.prototype.learnVector=function(e,r){var i=this,o=this._resolver.alignState(this),s=o.getFromKeyWithDefault(n.WIDTH,n.WIDTH_DEF),a=o.getFromKeyWithDefault(n.COMPRESSION_FACTOR,n.COMPRESSION_FACTOR_DEF),l=o.getFromKeyWithDefault(n.COMPRESSION_ITER,n.COMPRESSION_ITER_DEF),h=o.getFromKey(n.PRECISION);if(null==h)for(var h=new Float64Array(e.length),u=0;u<e.length;u++)h[u]=1;var c=h,p=o.getFromKeyWithDefault(n.THRESHOLD,n.THRESHOLD_DEF),o=t.mwg.task.Actions.newTask();o.asGlobalVar("parent").traverse(n.INTERNAL_SUBGAUSSIAN).then(function(t){var n=t.resultAsNodes(),r=t.variable("parent").get(0),n=i.filter(n,e,c,p,r.getLevel()-1);null!=n?(r.internallearn(e,s,a,l,c,p,!1),t.continueWith(t.wrapClone(n))):(r.internallearn(e,s,a,l,c,p,!0),t.continueWith(null))}).ifThen(function(t){return null!=t.result()},o),t.mwg.task.Actions.setTime(this.time()+"").setWorld(this.world()+"").inject(this).subTask(o).execute(this.graph(),function(t){null!=t&&t.free(),null!=r&&r(!0)})},n.prototype.checkInside=function(t,e,n,r,i){r+=.707*i,i=this.getAvg();for(var o=!0,s=this.getCovarianceArray(i,n),a=0;a<t.length;a++)if(s[a]=Math.sqrt(s[a]),i[a]+s[a]<t[a]-r*n[a]||i[a]-s[a]>e[a]+r*n[a]){o=!1;break}return o},n.prototype.filter=function(e,n,r,i,o){if(i+=.707*o,null==e||0==e.size())return null;o=new Float64Array(e.size());for(var s=java.lang.Double.MAX_VALUE,a=0,l=0;l<e.size();l++){var h=e.get(l),u=h.getAvg();o[l]=t.mwg.ml.algorithm.profiling.GaussianMixtureNode.distance(n,u,h.getCovarianceArray(u,r)),o[l]<s&&(s=o[l],a=l)}return s<i?e.get(a):null},n.prototype.predict=function(t){},n.prototype.getLevel=function(){return this._resolver.resolveState(this).getFromKeyWithDefault(n.LEVEL,n.LEVEL_DEF)},n.prototype.getWidth=function(){return this._resolver.resolveState(this).getFromKeyWithDefault(n.WIDTH,n.WIDTH_DEF)},n.prototype.getCompressionFactor=function(){return this._resolver.resolveState(this).getFromKeyWithDefault(n.COMPRESSION_FACTOR,n.COMPRESSION_FACTOR_DEF)},n.prototype.getCompressionIter=function(){return this._resolver.resolveState(this).getFromKeyWithDefault(n.COMPRESSION_ITER,n.COMPRESSION_ITER_DEF)},n.prototype.updateLevel=function(t){e.prototype.set.call(this,n.LEVEL,t),0==t?e.prototype.set.call(this,n.INTERNAL_SUBGAUSSIAN,new Float64Array(0)):e.prototype.rel.call(this,n.INTERNAL_SUBGAUSSIAN,function(e){for(var n=0;n<e.length;n++)e[n].updateLevel(t-1),e[n].free()})},n.prototype.createLevel=function(t,r,i,o,s,a,l){var h=this.graph().newTypedNode(this.world(),this.time(),n.NAME);return h.set(n.LEVEL,r),h.internallearn(t,i,o,s,a,l,!1),e.prototype.add.call(this,n.INTERNAL_SUBGAUSSIAN,h),h},n.prototype.checkAndCompress=function(r,i,o,s,a){var l=this,h=e.prototype.get.call(this,n.INTERNAL_SUBGAUSSIAN);null!=h&&0!=h.size()&&h.size()>=i*r&&e.prototype.rel.call(this,n.INTERNAL_SUBGAUSSIAN,function(e){for(var n=Array(e.length),h=Array(e.length),u=0;u<e.length;u++)n[u]=e[u],h[u]=n[u].getAvg();for(var h=(new t.mwg.ml.algorithm.profiling.KMeans).getClusterIds(h,r,o,s),c=Array(r),u=0;u<r;u++)if(null!=h[u]&&0<h[u].length){for(var p=0,m=0,g=0;g<h[u].length;g++){var f=n[h[u][g]].getTotal();f>p&&(p=f,m=h[u][g])}c[u]=n[m]}for(u=0;u<r;u++)if(1<h[u].length&&1==c[u].getTotal()&&0<c[u].getLevel()&&c[u].createLevel(c[u].getAvg(),c[u].getLevel()-1,r,i,o,s,a).free(),null!=h[u]&&0<h[u].length){for(g=0;g<h[u].length;g++)p=n[h[u][g]],p!=c[u]&&(c[u].move(p),l.remove(t.mwg.ml.algorithm.profiling.GaussianMixtureNode.INTERNAL_SUBGAUSSIAN,p),p.free());c[u].checkAndCompress(r,i,o,s,a)}for(u=0;u<e.length;u++)e[u].free()})},n.prototype.move=function(t){for(var r=this.getTotal(),i=this.getLevel(),o=this.getSum(),s=this.getMin(),a=this.getMax(),l=this.getSumSquares(),r=r+t.getTotal(),h=t.getSum(),u=t.getMin(),c=t.getMax(),p=t.getSumSquares(),m=0;m<o.length;m++)o[m]+=h[m],u[m]<s[m]&&(s[m]=u[m]),c[m]>a[m]&&(a[m]=c[m]);for(m=0;m<l.length;m++)l[m]+=p[m];if(this.set(n.INTERNAL_TOTAL_KEY,r),this.set(n.INTERNAL_SUM_KEY,o),this.set(n.INTERNAL_MIN_KEY,s),this.set(n.INTERNAL_MAX_KEY,a),this.set(n.INTERNAL_SUMSQUARE_KEY,l),0<i)if(r=t.get(n.INTERNAL_SUBGAUSSIAN),null==r||0==r.size())t.updateLevel(i-1),e.prototype.add.call(this,n.INTERNAL_SUBGAUSSIAN,t);else for(t=this.getOrCreateRel(n.INTERNAL_SUBGAUSSIAN),m=0;m<r.size();m++)t.add(r.get(m))},n.prototype.query=function(e,r,i,o){var s=this.getNumberOfFeatures();if(0==s)o(null);else{var a=this._resolver.resolveState(this),l=a.getFromKey(n.PRECISION);if(null==l)for(var l=new Float64Array(s),h=0;h<s;h++)l[h]=1;for(null==r&&(r=this.getMin()),null==i&&(i=this.getMax()),h=0;h<s;h++)i[h]-r[h]<l[h]&&(r[h]-=l[h],i[h]=r[h]+2*l[h]);var u=r,c=i,p=l,m=a.getFromKeyWithDefault(n.THRESHOLD,n.THRESHOLD_DEF);r=t.mwg.task.Actions.setTime(this.time()+"").setWorld(this.world()+"");var g=this.getLevel();for(r.inject([this]),h=0;h<this.getLevel()-e;h++){r.traverseOrKeep(n.INTERNAL_SUBGAUSSIAN);var f=h;r.select(function(t){return t.checkInside(u,c,p,m,g-f)})}r.execute(this.graph(),function(e){for(var n=new t.mwg.ml.common.matrix.Matrix(null,s,s),r=0;r<s;r++)n.set(r,r,p[r]);for(var n=new t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution(null,n,(!1)),i=new Int32Array(e.size()),a=0,l=Array(e.size()),r=0;r<e.size();r++){var h=e.get(r);i[r]=h.getTotal();var a=a+i[r],u=h.getAvg();2<i[r]?(l[r]=new t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution(u,h.getCovariance(u,p),(!1)),l[r].setMin(h.getMin()),l[r].setMax(h.getMax())):l[r]=n.clone(u)}e.free(),o(new t.mwg.ml.algorithm.profiling.ProbaDistribution(i,l,a))})}},n.prototype.generateDistributions=function(e,r){var i=this.getNumberOfFeatures();if(0==i)r(null);else{var o=this._resolver.resolveState(this).getFromKey(n.PRECISION);if(null==o)for(var o=new Float64Array(i),s=0;s<i;s++)o[s]=1;var a=o,o=t.mwg.task.Actions.setTime(this.time()+"").setWorld(this.world()+"");for(o.inject([this]),s=0;s<this.getLevel()-e;s++)o.traverseOrKeep(n.INTERNAL_SUBGAUSSIAN);o.then(function(e){for(var n=e.resultAsNodes(),o=new t.mwg.ml.common.matrix.Matrix(null,i,i),s=0;s<i;s++)o.set(s,s,a[s]);for(var o=new t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution(null,o,(!1)),l=new Int32Array(n.size()),h=0,u=Array(n.size()),s=0;s<n.size();s++){var c=n.get(s);l[s]=c.getTotal();var h=h+l[s],p=c.getAvg();2<l[s]?(u[s]=new t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution(p,c.getCovariance(p,a),(!1)),u[s].setMin(c.getMin()),u[s].setMax(c.getMax())):u[s]=o.clone(p)}e.continueTask(),r(new t.mwg.ml.algorithm.profiling.ProbaDistribution(l,u,h))}),o.execute(this.graph(),null)}},n.prototype.toString=function(){return n.NAME},n.prototype.internallearn=function(r,i,o,s,a,l,h){var u=r.length,c=!1,p=this.getTotal(),m=this.getLevel();if(0==p){var g=new Float64Array(u);java.lang.System.arraycopy(r,0,g,0,u),this.set(n.INTERNAL_TOTAL_KEY,1),this.set(n.INTERNAL_SUM_KEY,g)}else{var f,_,y;if(1==p){g=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),f=new Float64Array(u),_=new Float64Array(u),java.lang.System.arraycopy(g,0,f,0,u),java.lang.System.arraycopy(g,0,_,0,u),y=new Float64Array(u*(u+1)/2);for(var d=0,w=0;w<u;w++)for(var A=w;A<u;A++)y[d]=g[w]*g[A],d++;h&&0<m&&(d=this.createLevel(g,m-1,i,o,s,a,l),t.mwg.ml.algorithm.profiling.GaussianMixtureNode.distance(r,g,a)<l&&(c=!0,d.internallearn(r,i,o,s,a,l,h)),d.free())}else g=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),f=e.prototype.get.call(this,n.INTERNAL_MIN_KEY),_=e.prototype.get.call(this,n.INTERNAL_MAX_KEY),y=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);for(w=0;w<u;w++)r[w]<f[w]&&(f[w]=r[w]),r[w]>_[w]&&(_[w]=r[w]),g[w]+=r[w];for(w=d=0;w<u;w++)for(A=w;A<u;A++)y[d]+=r[w]*r[A],d++;p++,h&&0<m&&!c&&(d=this.createLevel(r,m-1,i,o,s,a,l),d.free(),this.checkAndCompress(i,o,s,a,l)),this.set(n.INTERNAL_TOTAL_KEY,p),this.set(n.INTERNAL_SUM_KEY,g),this.set(n.INTERNAL_MIN_KEY,f),this.set(n.INTERNAL_MAX_KEY,_),this.set(n.INTERNAL_SUMSQUARE_KEY,y)}},n.prototype.getNumberOfFeatures=function(){return 0==this.getTotal()?0:e.prototype.get.call(this,n.INTERNAL_SUM_KEY).length},n.prototype.getSum=function(){return 0==this.getTotal()?null:e.prototype.get.call(this,n.INTERNAL_SUM_KEY)},n.prototype.getSumSquares=function(){var t=this.getTotal();if(0==t)return null;if(1==t){for(var t=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),r=t.length,i=new Float64Array(r*(r+1)/2),o=0,s=0;s<r;s++)for(var a=s;a<r;a++)i[o]=t[s]*t[a],o++;return i}return e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY)},n.prototype.getProbability=function(r,i,o){i=e.prototype.get.call(this,n.INTERNAL_SUM_KEY);var s=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);return i=t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution.getDistribution(i,s,this.getTotal(),!1),null==i?0:i.density(r,o)},n.prototype.getProbabilityArray=function(r,i,o){i=new Float64Array(r.length);var s=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),a=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY),s=t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution.getDistribution(s,a,this.getTotal(),!1);if(null!=s)for(a=0;a<i.length;a++)i[a]=s.density(r[a],o);return i},n.prototype.getTotal=function(){var t=e.prototype.get.call(this,n.INTERNAL_TOTAL_KEY);return null==t?0:t},n.prototype.getAvg=function(){var t=this.getTotal();if(0==t)return null;if(1==t)return e.prototype.get.call(this,n.INTERNAL_SUM_KEY);for(var r=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),i=0;i<r.length;i++)r[i]/=t;return r},n.prototype.getCovarianceArray=function(t,r){if(null==t){var i=new Float64Array(r.length);return java.lang.System.arraycopy(r,0,i,0,r.length),i}null==r&&(r=new Float64Array(t.length));var i=t.length,o=this.getTotal();if(0==o)return null;if(1<o){var s,a=new Float64Array(i),l=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);s=o/(o-1);for(var h=0,u=0;u<i;u++)a[u]=(l[h]/o-t[u]*t[u])*s,a[u]<r[u]&&(a[u]=r[u]),h+=i-u;return a}return i=new Float64Array(r.length),java.lang.System.arraycopy(r,0,i,0,r.length),i},n.prototype.getCovariance=function(r,i){var o=r.length,s=this.getTotal();if(0==s)return null;if(null==i&&(i=new Float64Array(r.length)),1<s){var a,l=new Float64Array(o*o),h=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);a=s/(s-1);for(var u=0,c=0;c<o;c++)for(var p=c;p<o;p++)l[c*o+p]=(h[u]/s-r[c]*r[p])*a,l[p*o+c]=l[c*o+p],u++,l[c*o+c]<i[c]&&(l[c*o+c]=i[c]);return new t.mwg.ml.common.matrix.Matrix(l,o,o)}return null},n.prototype.getMin=function(){var t=this.getTotal();return 0==t?null:1==t?e.prototype.get.call(this,n.INTERNAL_SUM_KEY):e.prototype.get.call(this,n.INTERNAL_MIN_KEY)},n.prototype.getMax=function(){var t=this.getTotal();return 0==t?null:1==t?e.prototype.get.call(this,n.INTERNAL_SUM_KEY):e.prototype.get.call(this,n.INTERNAL_MAX_KEY)},n.prototype.getSubGraph=function(){var t=e.prototype.get.call(this,n.INTERNAL_SUBGAUSSIAN);if(null==t)return null;for(var r=new Float64Array(t.size()),i=0;i<t.size();i++)r[i]=t.get(i);return r},n.distance=function(t,e,n){for(var r,i=0,o=0;o<t.length;o++)r=(t[o]-e[o])*(t[o]-e[o])/n[o],r>i&&(i=r);return Math.sqrt(i)},n.NAME="GaussianMixtureNode",n.MIN="min",n.MAX="max",n.AVG="avg",n.COV="cov",n.LEVEL="_level",n.LEVEL_DEF=0,n.WIDTH="_width",n.WIDTH_DEF=10,n.COMPRESSION_FACTOR="_compression",n.COMPRESSION_FACTOR_DEF=2,n.COMPRESSION_ITER="_compressioniter",n.COMPRESSION_ITER_DEF=10,n.THRESHOLD="_threshold",n.THRESHOLD_DEF=3,n.PRECISION="_precision",n.INTERNAL_SUBGAUSSIAN="_subGaussian",n.INTERNAL_SUM_KEY="_sum",n.INTERNAL_SUMSQUARE_KEY="_sumSquare",n.INTERNAL_TOTAL_KEY="_total",n.INTERNAL_MIN_KEY="_min",n.INTERNAL_MAX_KEY="_max",n.enforcer=(new t.mwg.utility.Enforcer).asIntWithin(n.LEVEL,0,1e3).asIntWithin(n.WIDTH,1,1e3).asPositiveDouble(n.COMPRESSION_FACTOR).asPositiveDouble(n.THRESHOLD).asDoubleArray(n.PRECISION),n}(t.mwg.ml.AbstractMLNode);e.GaussianMixtureNode=n,n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.setProperty=function(t,n,r){e.prototype.setProperty.call(this,t,n,r)},n.prototype.type=function(r){return r===n.AVG?t.mwg.Type.DOUBLE_ARRAY:r===n.MIN?t.mwg.Type.DOUBLE_ARRAY:r===n.MAX?t.mwg.Type.DOUBLE_ARRAY:r===n.COV?t.mwg.Type.DOUBLE_ARRAY:e.prototype.type.call(this,r)},n.prototype.get=function(t){if(t===n.AVG)return this.getAvg();if(t===n.MIN)return this.getMin();if(t===n.MAX||t===n.MAX)return this.getMax();if(t===n.COV){t=this._resolver.resolveState(this).getFromKey(n.PRECISION);var r=this.getNumberOfFeatures();if(null==t){t=new Float64Array(r);for(var i=0;i<r;i++)t[i]=1}return this.getCovariance(this.getAvg(),t)}return e.prototype.get.call(this,t)},n.prototype.learn=function(t){var e=this;this.extractFeatures(function(n){e.learnVector(n,t)})},n.prototype.learnVector=function(t,r){this._resolver.alignState(this);var i=t.length,o=this.getTotal();if(0==o){var s=new Float64Array(i);java.lang.System.arraycopy(t,0,s,0,i),this.set(n.INTERNAL_TOTAL_KEY,1),this.set(n.INTERNAL_SUM_KEY,s)}else{
var a,l,h;if(1==o){s=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),a=new Float64Array(i),l=new Float64Array(i),java.lang.System.arraycopy(s,0,a,0,i),java.lang.System.arraycopy(s,0,l,0,i),h=new Float64Array(i*(i+1)/2);for(var u=0,c=0;c<i;c++)for(var p=c;p<i;p++)h[u]=s[c]*s[p],u++}else s=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),a=e.prototype.get.call(this,n.INTERNAL_MIN_KEY),l=e.prototype.get.call(this,n.INTERNAL_MAX_KEY),h=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);for(c=0;c<i;c++)t[c]<a[c]&&(a[c]=t[c]),t[c]>l[c]&&(l[c]=t[c]),s[c]+=t[c];for(c=u=0;c<i;c++)for(p=c;p<i;p++)h[u]+=t[c]*t[p],u++;o++,this.set(n.INTERNAL_TOTAL_KEY,o),this.set(n.INTERNAL_SUM_KEY,s),this.set(n.INTERNAL_MIN_KEY,a),this.set(n.INTERNAL_MAX_KEY,l),this.set(n.INTERNAL_SUMSQUARE_KEY,h)}null!=r&&r(!0)},n.prototype.predict=function(t){},n.prototype.toString=function(){return n.NAME},n.prototype.getNumberOfFeatures=function(){return 0==this.getTotal()?0:e.prototype.get.call(this,n.INTERNAL_SUM_KEY).length},n.prototype.getSum=function(){return 0==this.getTotal()?null:e.prototype.get.call(this,n.INTERNAL_SUM_KEY)},n.prototype.getSumSquares=function(){var t=this.getTotal();if(0==t)return null;if(1==t){for(var t=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),r=t.length,i=new Float64Array(r*(r+1)/2),o=0,s=0;s<r;s++)for(var a=s;a<r;a++)i[o]=t[s]*t[a],o++;return i}return e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY)},n.prototype.getProbability=function(r,i,o){i=e.prototype.get.call(this,n.INTERNAL_SUM_KEY);var s=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);return i=t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution.getDistribution(i,s,this.getTotal(),!1),null==i?0:i.density(r,o)},n.prototype.getProbabilityArray=function(r,i,o){i=new Float64Array(r.length);var s=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),a=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY),s=t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution.getDistribution(s,a,this.getTotal(),!1);if(null!=s)for(a=0;a<i.length;a++)i[a]=s.density(r[a],o);return i},n.prototype.getTotal=function(){var t=e.prototype.get.call(this,n.INTERNAL_TOTAL_KEY);return null==t?0:t},n.prototype.getAvg=function(){var t=this.getTotal();if(0==t)return null;if(1==t)return e.prototype.get.call(this,n.INTERNAL_SUM_KEY);for(var r=e.prototype.get.call(this,n.INTERNAL_SUM_KEY),i=0;i<r.length;i++)r[i]/=t;return r},n.prototype.getCovarianceArray=function(t,r){if(null==t){var i=new Float64Array(r.length);return java.lang.System.arraycopy(r,0,i,0,r.length),i}null==r&&(r=new Float64Array(t.length));var i=t.length,o=this.getTotal();if(0==o)return null;if(1<o){var s,a=new Float64Array(i),l=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);s=o/(o-1);for(var h=0,u=0;u<i;u++)a[u]=(l[h]/o-t[u]*t[u])*s,a[u]<r[u]&&(a[u]=r[u]),h+=i-u;return a}return i=new Float64Array(r.length),java.lang.System.arraycopy(r,0,i,0,r.length),i},n.prototype.getCovariance=function(r,i){var o=r.length,s=this.getTotal();if(0==s)return null;if(null==i&&(i=new Float64Array(r.length)),1<s){var a,l=new Float64Array(o*o),h=e.prototype.get.call(this,n.INTERNAL_SUMSQUARE_KEY);a=s/(s-1);for(var u=0,c=0;c<o;c++)for(var p=c;p<o;p++)l[c*o+p]=(h[u]/s-r[c]*r[p])*a,l[p*o+c]=l[c*o+p],u++,l[c*o+c]<i[c]&&(l[c*o+c]=i[c]);return new t.mwg.ml.common.matrix.Matrix(l,o,o)}return null},n.prototype.getMin=function(){var t=this.getTotal();return 0==t?null:1==t?e.prototype.get.call(this,n.INTERNAL_SUM_KEY):e.prototype.get.call(this,n.INTERNAL_MIN_KEY)},n.prototype.getMax=function(){var t=this.getTotal();return 0==t?null:1==t?e.prototype.get.call(this,n.INTERNAL_SUM_KEY):e.prototype.get.call(this,n.INTERNAL_MAX_KEY)},n.distance=function(t,e,n){for(var r,i=0,o=0;o<t.length;o++)r=(t[o]-e[o])*(t[o]-e[o])/n[o],r>i&&(i=r);return Math.sqrt(i)},n.NAME="GaussianNode",n.MIN="min",n.MAX="max",n.AVG="avg",n.COV="cov",n.PRECISION="_precision",n.INTERNAL_SUM_KEY="_sum",n.INTERNAL_SUMSQUARE_KEY="_sumSquare",n.INTERNAL_TOTAL_KEY="_total",n.INTERNAL_MIN_KEY="_min",n.INTERNAL_MAX_KEY="_max",n}(t.mwg.ml.AbstractMLNode),e.GaussianNode=n,n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.learn=function(t){var e=this;this.extractFeatures(function(n){e.learnArray(n),t(!0)})},n.prototype.learnArray=function(e){var r,i,o,s,a,l=this._resolver.alignState(this),h=l.getFromKeyWithDefault(n.SLOTS_NUMBER,n.SLOTS_NUMBER_DEF),u=e.length;if(r=l.getFromKey(n.INTERNAL_TOTAL_KEY),1==h||0==h)null==r?(l.setFromKey(n.INTERNAL_FEATURES_NUMBER,t.mwg.Type.INT,u),r=new Int32Array(1),i=new Float64Array(u),o=new Float64Array(u),s=new Float64Array(u),a=new Float64Array(u*(u+1)/2)):(i=l.getFromKey(n.INTERNAL_MIN_KEY),o=l.getFromKey(n.INTERNAL_MAX_KEY),s=l.getFromKey(n.INTERNAL_SUM_KEY),a=l.getFromKey(n.INTERNAL_SUMSQUARE_KEY)),this.update(r,i,o,s,a,e,0,u,0,0);else{null==r?(l.setFromKey(n.INTERNAL_FEATURES_NUMBER,t.mwg.Type.INT,u),r=new Int32Array(h+1),i=new Float64Array((h+1)*u),o=new Float64Array((h+1)*u),s=new Float64Array((h+1)*u),a=new Float64Array((h+1)*u*(u+1)/2)):(i=l.getFromKey(n.INTERNAL_MIN_KEY),o=l.getFromKey(n.INTERNAL_MAX_KEY),s=l.getFromKey(n.INTERNAL_SUM_KEY),a=l.getFromKey(n.INTERNAL_SUMSQUARE_KEY));var c=l.getFromKeyWithDefault(n.PERIOD_SIZE,n.PERIOD_SIZE_DEF),c=t.mwg.ml.algorithm.profiling.GaussianSlotNode.getIntTime(this.time(),h,c),p=h*u,m=h*u*(u+1)/2;this.update(r,i,o,s,a,e,c,u,c*u,c*u*(u+1)/2),this.update(r,i,o,s,a,e,h,u,p,m),l.setFromKey(n.INTERNAL_FEATURES_NUMBER,t.mwg.Type.INT,u),l.setFromKey(n.INTERNAL_TOTAL_KEY,t.mwg.Type.INT_ARRAY,r),l.setFromKey(n.INTERNAL_MIN_KEY,t.mwg.Type.DOUBLE_ARRAY,i),l.setFromKey(n.INTERNAL_MAX_KEY,t.mwg.Type.DOUBLE_ARRAY,o),l.setFromKey(n.INTERNAL_SUM_KEY,t.mwg.Type.DOUBLE_ARRAY,s),l.setFromKey(n.INTERNAL_SUMSQUARE_KEY,t.mwg.Type.DOUBLE_ARRAY,a)}},n.prototype.predict=function(e){var r=this.unphasedState(),i=r.getFromKeyWithDefault(n.INTERNAL_FEATURES_NUMBER,0);if(0==i)e(null);else{var o=r.getFromKeyWithDefault(n.SLOTS_NUMBER,n.SLOTS_NUMBER_DEF),s=r.getFromKeyWithDefault(n.PERIOD_SIZE,n.PERIOD_SIZE_DEF),o=t.mwg.ml.algorithm.profiling.GaussianSlotNode.getIntTime(this.time(),o,s),s=o*i,a=r.getFromKey(n.INTERNAL_TOTAL_KEY),r=r.getFromKey(n.INTERNAL_SUM_KEY),l=new Float64Array(i);if(null!=a&&0!=a[o])for(var h=0;h<i;h++)l[h]=r[h+s]/a[o];e(l)}},n.prototype.setProperty=function(t,r,i){n.enforcer.check(t,r,i),e.prototype.setProperty.call(this,t,r,i)},n.prototype.get=function(t){var r=this._resolver.resolveState(this);return t===n.SLOTS_NUMBER?r.getFromKeyWithDefault(n.SLOTS_NUMBER,n.SLOTS_NUMBER_DEF):t===n.PERIOD_SIZE?r.getFromKeyWithDefault(n.PERIOD_SIZE,n.PERIOD_SIZE_DEF):e.prototype.get.call(this,t)},n.getIntTime=function(t,e,n){return 1>=e?0:t%n/(n/e)},n.prototype.update=function(t,e,n,r,i,o,s,a,l,h){if(1==t[s])for(var u=0,c=0;c<a;c++){e[l+c]=o[c],n[l+c]=o[c],r[l+c]=o[c];for(var p=c;p<a;p++)i[h+u]+=o[c]*o[p],u++}else for(c=u=0;c<a;c++)for(o[c]<e[l+c]&&(e[l+c]=o[c]),o[c]>n[l+c]&&(n[l+c]=o[c]),r[l+c]+=o[c],p=c;p<a;p++)i[h+u]+=o[c]*o[p],u++;t[s]+=1},n.prototype.getMin=function(){return this.unphasedState().getFromKey(n.INTERNAL_MIN_KEY)},n.prototype.getMax=function(){return this.unphasedState().getFromKey(n.INTERNAL_MAX_KEY)},n.prototype.getSum=function(){return this.unphasedState().getFromKey(n.INTERNAL_SUM_KEY)},n.prototype.getSumSquare=function(){return this.unphasedState().getFromKey(n.INTERNAL_SUMSQUARE_KEY)},n.prototype.getTotal=function(){return this.unphasedState().getFromKey(n.INTERNAL_TOTAL_KEY)},n.prototype.getAvg=function(){var t=this.unphasedState(),e=t.getFromKeyWithDefault(n.SLOTS_NUMBER,n.SLOTS_NUMBER_DEF),r=t.getFromKeyWithDefault(n.INTERNAL_FEATURES_NUMBER,0);if(0==r)return null;var i=t.getFromKey(n.INTERNAL_TOTAL_KEY),t=t.getFromKey(n.INTERNAL_SUM_KEY),o=new Float64Array(t.length);if(null!=i)if(1<e)for(var s=0,a=0;a<e+1;a++)if(0!=i[a])for(var l=0;l<r;l++)o[s]=t[s]/i[a],s++;else s+=r;else if(0!=i[0])for(l=0;l<r;l++)o[l]=t[l]/i[0];return o},n.NAME="GaussianSlotProfiling",n.SLOTS_NUMBER="SLOTS_NUMBER",n.SLOTS_NUMBER_DEF=1,n.PERIOD_SIZE="PERIOD_SIZE",n.PERIOD_SIZE_DEF=864e5,n.INTERNAL_FEATURES_NUMBER="_featuresNb",n.INTERNAL_TOTAL_KEY="_total",n.INTERNAL_MIN_KEY="_min",n.INTERNAL_MAX_KEY="_max",n.INTERNAL_SUM_KEY="_sum",n.INTERNAL_SUMSQUARE_KEY="_sumSquare",n.enforcer=(new t.mwg.utility.Enforcer).asPositiveInt(n.SLOTS_NUMBER).asPositiveLong(n.PERIOD_SIZE),n}(t.mwg.ml.AbstractMLNode),e.GaussianSlotNode=n,n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.learn=function(t){var e=this;this.extractFeatures(function(n){var r=new Float64Array(n.length-1);java.lang.System.arraycopy(n,0,r,0,n.length-1),e.internalLearn(n,r,t)})},n.prototype.internalLearn=function(n,r,i){var o=this,s=this._resolver.alignState(this);e.prototype.learnVector.call(this,n,function(e){e=s.getFromKeyWithDefault(t.mwg.ml.algorithm.profiling.GaussianTreeNode.THRESHOLD,t.mwg.ml.algorithm.profiling.GaussianTreeNode.THRESHOLD_DEF);var a=s.getFromKey(t.mwg.ml.algorithm.profiling.GaussianNode.PRECISION);if(null==s.getFromKey(t.mwg.ml.algorithm.profiling.GaussianTreeNode.INTERNAL_KDROOT)){var l=o.graph().newTypedNode(o.world(),o.time(),t.mwg.ml.common.structure.KDTree.NAME);l.setProperty(t.mwg.ml.common.structure.KDTree.DISTANCE_TYPE,t.mwg.Type.INT,t.mwg.ml.common.distance.DistanceEnum.GAUSSIAN),l.setProperty(t.mwg.ml.common.structure.KDTree.DISTANCE_THRESHOLD,t.mwg.Type.DOUBLE,e),l.setProperty(t.mwg.ml.common.structure.KDTree.GAUSSIAN_PRECISION,t.mwg.Type.DOUBLE_ARRAY,a),o.add(t.mwg.ml.algorithm.profiling.GaussianTreeNode.INTERNAL_KDROOT,l);var h=o.graph().newTypedNode(o.world(),o.time(),t.mwg.ml.algorithm.profiling.GaussianNode.NAME);h.learnVector(n,function(t){l.insert(r,h,function(t){l.free(),h.free(),null!=i&&i(!0)})})}else o.rel(t.mwg.ml.algorithm.profiling.GaussianTreeNode.INTERNAL_KDROOT,function(e){var s=e[0];s.nearestWithinDistance(r,function(e){if(null!=e){var a=e;a.learnVector(n,function(t){s.free(),a.free(),null!=i&&i(!0)})}else a=o.graph().newTypedNode(o.world(),o.time(),t.mwg.ml.algorithm.profiling.GaussianNode.NAME),a.learnVector(n,function(t){s.insert(r,a,function(t){s.free(),a.free(),null!=i&&i(!0)})})})})})},n.prototype.getNumNodes=function(){var e=new Int32Array(1);return this.rel(n.INTERNAL_KDROOT,function(n){e[0]=null==n||0==n.length?0:n[0].get(t.mwg.ml.common.structure.KDTree.NUM_NODES)}),e[0]},n.prototype.predict=function(t){},n.prototype.predictValue=function(t,e){var r=this;if(null!=e){var i=new Float64Array(t.length-1);java.lang.System.arraycopy(t,0,i,0,t.length-1),null==this._resolver.resolveState(this).getFromKey(n.INTERNAL_KDROOT)&&e(null),this.rel(n.INTERNAL_KDROOT,function(t){var n=t[0];n.nearestWithinDistance(i,function(t){if(null!=t){var i=t.getAvg(),i=i[i.length-1];t.free()}else i=r.getAvg(),i=i[i.length-1];n.free(),e(i)})})}},n.NAME="GaussianTreeNode",n.THRESHOLD="_threshold",n.THRESHOLD_DEF=1.01,n.INTERNAL_KDROOT="kdroot",n}(t.mwg.ml.algorithm.profiling.GaussianNode),e.GaussianTreeNode=n,n=function(){function e(){}return e.prototype.getClusterIds=function(t,e,n,r){for(var i=Array(e),o=t[0].length,s=new Int32Array(e),a=Array(e),l=0;l<e;l++)a[l]=new Float64Array(o);for(var h=new Int32Array(t.length),l=0;l<e;l++)java.lang.System.arraycopy(t[l],0,a[l],0,o);for(var u=0;u<n;u++){for(l=0;l<s.length;l++)s[l]=0;for(l=0;l<t.length;l++)h[l]=this.calculateCategory(t[l],a,r),s[h[l]]++;for(l=0;l<a.length;l++)for(var c=0;c<o;c++)a[l][c]=0;for(l=0;l<t.length;l++)for(c=0;c<o;c++)a[h[l]][c]+=t[l][c];for(l=0;l<a.length;l++)if(0!=s[l])for(c=0;c<o;c++)a[l][c]/=s[l];else c=new java.util.Random,c=t[c.nextInt(t.length)],java.lang.System.arraycopy(c,0,a[l],0,o)}for(l=0;l<e;l++)for(i[l]=new Int32Array(s[l]),c=n=0;c<t.length;c++)h[c]==l&&(i[l][n]=c,n++);return i},e.prototype.calculateCategory=function(e,n,r){for(var i=java.lang.Double.MAX_VALUE,o=0,s=0;s<n.length;s++){var a=t.mwg.ml.algorithm.profiling.KMeans.distance(e,n[s],r);a<i&&(i=a,o=s)}return o},e.distance=function(t,e,n){for(var r,i=0,o=0;o<t.length;o++)r=(t[o]-e[o])*(t[o]-e[o])/n[o],r>i&&(i=r);return Math.sqrt(i)},e}(),e.KMeans=n,n=function(){function e(t,e,n){this.total=t,this.distributions=e,this.global=n}return e.prototype.calculate=function(e){var n=0;if(null!=this.total)for(var r=0;r<this.distributions.length;r++)5>t.mwg.ml.algorithm.profiling.KMeans.distance(e,this.distributions[r].getAvg(),this.distributions[r].getCovDiag())&&(n+=this.distributions[r].density(e,!1)*this.total[r]/this.global);else for(r=0;r<this.distributions.length;r++)5>t.mwg.ml.algorithm.profiling.KMeans.distance(e,this.distributions[r].getAvg(),this.distributions[r].getCovDiag())&&(n+=this.distributions[r].density(e,!1)/this.global);return 1<n&&(n=1),n},e.prototype.calculateArray=function(t,e){null!=e&&e.updateInformation("Number of distributions: "+this.distributions.length+" , values: "+this.global);for(var n=new Float64Array(t.length),r=0,i=0;i<t.length;i++)if(n[i]=this.calculate(t[i]),r+=n[i],null!=e){var o=1/t.length*i,o=50*o+50;if(e.updateProgress(o),e.isCancelled())return null}if(0!=r)for(i=0;i<t.length;i++)n[i]/=r;return n},e.prototype.addUpProbabilities=function(t){for(var e=0,n=0;n<t.length;n++)e+=this.calculate(t[n]);return e},e.prototype.compareProbaDistribution=function(t,e){for(var n,r=new Float64Array(2),i=this.calculateArray(e,null),o=t.calculateArray(e,null),s=0;s<i.length;s++)n=Math.abs(i[s]-o[s]),r[0]+=n,n>r[1]&&(r[1]=n);return r[0]/=i.length,r},e}(),e.ProbaDistribution=n}(e.profiling||(e.profiling={})),function(e){var n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.learn=function(t,e){var n=this;this.extractFeatures(function(r){n.internalLearn(r,t,e)})},n.prototype.internalLearn=function(e,r,i){var o=this._resolver.alignState(this),s=o.getFromKeyWithDefault(n.ITERATION_KEY,n.ITERATION_DEF),a=o.getFromKeyWithDefault(n.ALPHA_KEY,n.ALPHA_DEF),l=o.getFromKeyWithDefault(n.LAMBDA_KEY,n.LAMBDA_DEF),h=o.getFromKey(n.WEIGHT_KEY);if(null==h)for(var h=new Float64Array(e.length+1),u=new java.util.Random,c=0;c<h.length;c++)h[c]=.001*u.nextDouble();if(o.getFromKeyWithDefault(n.LAST_ERR_KEY,0),c=this.calculate(h,e)-r,o.setFromKey(n.LAST_ERR_KEY,t.mwg.Type.DOUBLE,c),null==e||h.length!=e.length+1)throw Error(n.MISMATCH_MSG);for(var u=e.length,p=0;p<s;p++){for(var m=this.calculate(h,e)-r,c=0;c<u;c++)h[c]-=a*(m*e[c]+l*h[c]);h[u]-=a*m}if(r=o.getFromKey(n.INTERNAL_WEIGHT_BACKUP_KEY),null==r)o.setFromKey(n.WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,h),o.setFromKey(n.INTERNAL_WEIGHT_BACKUP_KEY,t.mwg.Type.DOUBLE_ARRAY,h),o.setFromKey(n.INTERNAL_TOTAL_KEY,t.mwg.Type.INT,1);else{for(c=e=0;c<h.length;c++)e=Math.max(e,Math.abs(h[c]-r[c]));c=o.getFromKeyWithDefault(n.THRESHOLD_KEY,n.THRESHOLD_DEF),e>c?(o=this.phasedState(),o.setFromKey(n.WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,h),o.setFromKey(n.INTERNAL_WEIGHT_BACKUP_KEY,t.mwg.Type.DOUBLE_ARRAY,h),o.setFromKey(n.INTERNAL_TOTAL_KEY,t.mwg.Type.INT,1)):(o.setFromKey(n.WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,h),o.setFromKey(n.INTERNAL_TOTAL_KEY,t.mwg.Type.INT,o.getFromKey(n.INTERNAL_TOTAL_KEY)+1))}null!=i&&i(!0)},n.prototype.setProperty=function(t,r,i){n.enforcer.check(t,r,i),e.prototype.setProperty.call(this,t,r,i)},n.prototype.calculate=function(t,e){for(var n=0,r=0;r<e.length;r++)n+=t[r]*e[r];return n+=t[e.length]},n.prototype.extrapolate=function(e){var r=this,i=this._resolver.resolveState(this).getFromKey(n.WEIGHT_KEY);null==i?null!=e&&e(0):this.extractFeatures(function(n){if(n.length!=i.length-1)throw Error(t.mwg.ml.algorithm.regression.LiveLinearRegressionNode.MISMATCH_MSG);null!=e&&e(r.calculate(i,n))})},n.ALPHA_KEY="ALPHA",n.ALPHA_DEF=1e-4,n.LAMBDA_KEY="LAMBDA",n.LAMBDA_DEF=1e-5,n.ITERATION_KEY="ITERATION",n.ITERATION_DEF=5,n.THRESHOLD_KEY="THRESHOLD",n.THRESHOLD_DEF=.01,n.LAST_ERR_KEY="_ERR",n.WEIGHT_KEY="_WEIGHT",n.INTERNAL_TOTAL_KEY="_TOTAL_KEY",n.INTERNAL_WEIGHT_BACKUP_KEY="_WEIGHTBACKUP",n.MISMATCH_MSG="Different Imput lengths are not supported",n.NAME="LiveLinearRegression",n.enforcer=(new t.mwg.utility.Enforcer).asDouble(n.ALPHA_KEY).asDouble(n.LAMBDA_KEY).asInt(n.ITERATION_KEY),n}(t.mwg.ml.AbstractMLNode);e.LiveLinearRegressionNode=n,n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.prototype.setProperty=function(t,r,i){if(t===n.VALUE)this.learn(parseFloat(i.toString()),null);else{if(t!==n.PRECISION)throw Error(n.NOT_MANAGED_ATT_ERROR);n.enforcer.check(t,r,i),e.prototype.setProperty.call(this,t,r,i)}},n.prototype.get=function(t){if(t===n.VALUE){var r=[null];return this.extrapolate(function(t){r[0]=t}),r[0]}return e.prototype.get.call(this,t)},n.prototype.learn=function(e,r){var i=this.unphasedState(),o=i.time(),s=this.time(),a=i.getFromKeyWithDefault(n.PRECISION,n.PRECISION_DEF),l=i.getFromKey(n.INTERNAL_WEIGHT_KEY);if(null==l)l=new Float64Array(1),l[0]=e,i.setFromKey(n.INTERNAL_WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,l),i.setFromKey(n.INTERNAL_NB_PAST_KEY,t.mwg.Type.INT,1),i.setFromKey(n.INTERNAL_STEP_KEY,t.mwg.Type.LONG,0),i.setFromKey(n.INTERNAL_LAST_TIME_KEY,t.mwg.Type.LONG,0),i.setFromKey(n.INTERNAL_TIME_BUFFER,t.mwg.Type.DOUBLE_ARRAY,new Float64Array([0])),i.setFromKey(n.INTERNAL_VALUES_BUFFER,t.mwg.Type.DOUBLE_ARRAY,new Float64Array([e])),null!=r&&r(!0);else{var h=o+i.getFromKey(n.INTERNAL_LAST_TIME_KEY);if(s>h){var u=i.getFromKey(n.INTERNAL_STEP_KEY),c=s-o;if(null==u||0==u){if(0==c)return l=new Float64Array(1),l[0]=e,i.setFromKey(n.INTERNAL_WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,l),i.setFromKey(n.INTERNAL_TIME_BUFFER,t.mwg.Type.DOUBLE_ARRAY,new Float64Array([0])),i.setFromKey(n.INTERNAL_VALUES_BUFFER,t.mwg.Type.DOUBLE_ARRAY,new Float64Array([e])),void(null!=r&&r(!0));u=c,i.setFromKey(n.INTERNAL_STEP_KEY,t.mwg.Type.LONG,u)}var p,m=l.length-1,g=i.getFromKey(n.INTERNAL_NB_PAST_KEY);p=(s-o)/u;var o=this.maxErr(a,m),f=t.mwg.ml.algorithm.regression.PolynomialNode.updateBuffer(i,p,n.INTERNAL_TIME_BUFFER),u=t.mwg.ml.algorithm.regression.PolynomialNode.updateBuffer(i,e,n.INTERNAL_VALUES_BUFFER);if(Math.abs(t.mwg.ml.common.matrix.operation.PolynomialFit.extrapolate(p,l)-e)<=o)i.setFromKey(n.INTERNAL_NB_PAST_KEY,t.mwg.Type.INT,g+1),i.setFromKey(n.INTERNAL_LAST_TIME_KEY,t.mwg.Type.LONG,c);else{for(l=Math.min(f.length,n.MAX_DEGREE);m<l&&f.length<4*n.MAX_DEGREE;){if(o=this.maxErr(a,m),p=new t.mwg.ml.common.matrix.operation.PolynomialFit(m),p.fit(f,u),this.tempError(p.getCoef(),f,u)<=o)return l=p.getCoef(),i.setFromKey(n.INTERNAL_NB_PAST_KEY,t.mwg.Type.INT,g+1),i.setFromKey(n.INTERNAL_WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,l),i.setFromKey(n.INTERNAL_LAST_TIME_KEY,t.mwg.Type.LONG,c),void(null!=r&&r(!0));m++}s-=h,h=this.newState(h),c=new Float64Array(2),m=new Float64Array(2),m[0]=0,m[1]=1,c[0]=u[u.length-2],c[1]=e,o=this.maxErr(a,0),Math.abs(c[1]-c[0])<=o?(l=new Float64Array(1),l[0]=c[0]):(l=new Float64Array(2),l[0]=c[0],l[1]=c[1]-c[0]),i.setFromKey(n.INTERNAL_TIME_BUFFER,t.mwg.Type.DOUBLE_ARRAY,null),i.setFromKey(n.INTERNAL_VALUES_BUFFER,t.mwg.Type.DOUBLE_ARRAY,null),h.setFromKey(n.INTERNAL_TIME_BUFFER,t.mwg.Type.DOUBLE_ARRAY,m),h.setFromKey(n.INTERNAL_VALUES_BUFFER,t.mwg.Type.DOUBLE_ARRAY,c),h.setFromKey(n.PRECISION,t.mwg.Type.DOUBLE,a),h.setFromKey(n.INTERNAL_WEIGHT_KEY,t.mwg.Type.DOUBLE_ARRAY,l),h.setFromKey(n.INTERNAL_NB_PAST_KEY,t.mwg.Type.INT,2),h.setFromKey(n.INTERNAL_STEP_KEY,t.mwg.Type.LONG,s),h.setFromKey(n.INTERNAL_LAST_TIME_KEY,t.mwg.Type.LONG,s)}null!=r&&r(!0)}else null!=r&&r(!1)}},n.updateBuffer=function(e,r,i){var o=e.getFromKey(i);if(null==o)return o=new Float64Array(1),o[0]=r,e.setFromKey(i,t.mwg.Type.DOUBLE_ARRAY,o),o;if(o.length<4*n.MAX_DEGREE){var s=new Float64Array(o.length+1);java.lang.System.arraycopy(o,0,s,0,o.length),s[o.length]=r}else s=new Float64Array(o.length),java.lang.System.arraycopy(o,1,s,0,o.length-1),s[o.length-1]=r;return e.setFromKey(i,t.mwg.Type.DOUBLE_ARRAY,s),s},n.prototype.extrapolate=function(e){var r=this.time(),i=this.unphasedState(),o=i.time(),s=i.getFromKey(n.INTERNAL_WEIGHT_KEY);if(null==s)null!=e&&e(0);else{var a=i.getFromKey(n.INTERNAL_STEP_KEY);null==a||0==a?null!=e&&e(s[0]):(r-=o,i=i.getFromKey(n.INTERNAL_LAST_TIME_KEY),r>i&&(r=i),null!=e&&e(t.mwg.ml.common.matrix.operation.PolynomialFit.extrapolate(r/a,s)))}},n.prototype.maxErr=function(t,e){return t/Math.pow(2,e+1)},n.prototype.tempError=function(e,n,r){for(var i,o=0,s=0;s<n.length;s++)i=Math.abs(r[s]-t.mwg.ml.common.matrix.operation.PolynomialFit.extrapolate(n[s],e)),i>o&&(o=i);return o},n.prototype.toString=function(){var t=new java.lang.StringBuilder;t.append('{"world":'),t.append(this.world()),t.append(',"time":'),t.append(this.time()),t.append(',"id":'),t.append(this.id());var e=this._resolver.resolveState(this);if(null!=e){if(e=e.getFromKey(n.INTERNAL_WEIGHT_KEY),null!=e){t.append('"polynomial":"');for(var r=0;r<e.length;r++)0!=r&&t.append("+("),t.append(e[r]),1==r?t.append("*t"):1<r&&(t.append("*t^"),t.append(r)),0!=r&&t.append(")");t.append('"')}t.append("}")}return t.toString()},n.PRECISION="precision",n.PRECISION_DEF=1,n.VALUE="value",n.NAME="PolynomialNode",n.INTERNAL_WEIGHT_KEY="weight",n.INTERNAL_STEP_KEY="step",n.INTERNAL_TIME_BUFFER="times",n.INTERNAL_VALUES_BUFFER="values",n.INTERNAL_NB_PAST_KEY="nb",n.INTERNAL_LAST_TIME_KEY="lastTime",n.MAX_DEGREE=20,n.NOT_MANAGED_ATT_ERROR="Polynomial node can only handle value attribute, please use a super node to store other data",n.enforcer=(new t.mwg.utility.Enforcer).asPositiveDouble(n.PRECISION),n}(t.mwg.ml.AbstractMLNode),e.PolynomialNode=n}(e.regression||(e.regression={}))}(e.algorithm||(e.algorithm={})),function(e){var n=function(){function e(){}return e.deserializeFromDoubleArray=function(e){return t.mwg.ml.common.DecisionTreeNode.deserializeFromDoubleArrayWithRoot(e,0)},e.deserializeFromDoubleArrayWithRoot=function(n,r){var i=new t.mwg.ml.common.DecisionTreeNode;i.boundary=n[r*e.ELEMENTS_PER_NODE],i.classNum=n[r*e.ELEMENTS_PER_NODE+1];var o=n[r*e.ELEMENTS_PER_NODE+2];return i.left=0<o?t.mwg.ml.common.DecisionTreeNode.deserializeFromDoubleArrayWithRoot(n,o):null,o=n[r*e.ELEMENTS_PER_NODE+3],i.right=0<o?t.mwg.ml.common.DecisionTreeNode.deserializeFromDoubleArrayWithRoot(n,o):null,i.featureNum=n[r*e.ELEMENTS_PER_NODE+4],i},e.prototype.serializeToDoubleArray=function(){for(var t=this.serializeToDoubleObjectArray(),e=new Float64Array(t.size()),n=0;n<e.length;n++)e[n]=t.get(n);return e},e.prototype.serializeToDoubleObjectArray=function(){var t=new java.util.ArrayList,e=new java.util.ArrayList;e.add(this);for(var n=0;0<e.size();){var r=e.get(0);e.remove(0),t.add(r.boundary),t.add(r.classNum),null!=r.left?(n++,t.add(n),e.add(r.left)):t.add(-1),null!=r.right?(n++,t.add(n),e.add(r.right)):t.add(-1),t.add(r.featureNum)}return t},e.ELEMENTS_PER_NODE=5,e}();e.DecisionTreeNode=n,function(t){var e=function(){function t(){}return t.prototype.measure=function(t,e){for(var n=0,r=0,i=0,o=0;o<t.length;o++)n+=t[o]*e[o],r+=t[o]*t[o],i+=e[o]*e[o];return n/=Math.sqrt(r)*Math.sqrt(i),0>n&&(n=0),1-n},t.prototype.compare=function(t,e){return t<e},t.prototype.getMinValue=function(){return 0},t.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE},t}();t.CosineDistance=e,e=function(){function t(){}return t.EUCLIDEAN=0,t.GAUSSIAN=1,t}(),t.DistanceEnum=e,e=function(){function t(){}return t.prototype.measure=function(t,e){for(var n=0,r=0;r<t.length;r++)n+=(t[r]-e[r])*(t[r]-e[r]);return Math.sqrt(n)},t.prototype.compare=function(t,e){return t<e},t.prototype.getMinValue=function(){return 0},t.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE},t}(),t.EuclideanDistance=e,e=function(){function t(t){this.err=t}return t.prototype.measure=function(t,e){for(var n,r=0,i=0;i<t.length;i++)n=(t[i]-e[i])*(t[i]-e[i])/this.err[i],n>r&&(r=n);return Math.sqrt(r)},t.prototype.compare=function(t,e){return t<e},t.prototype.getMinValue=function(){return 0},t.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE},t}(),t.GaussianDistance=e,e=function(){function t(){}return t.prototype.measure=function(t,e){for(var n=0,r=0,i=0,o=0,s=0,a=0;a<t.length;a++)n+=t[a]*e[a],r+=t[a],o+=e[a],i+=t[a]*t[a],s+=e[a]*e[a];return a=t.length,(n-r*o/a)/Math.sqrt((i-r*r/a)*(s-o*o/a))},t.prototype.compare=function(t,e){return Math.abs(t)>Math.abs(e)},t.prototype.getMinValue=function(){return 1},t.prototype.getMaxValue=function(){return 0},t}(),t.PearsonDistance=e}(e.distance||(e.distance={})),function(e){var n=function(){function e(){this.blas=new t.mwg.ml.common.matrix.blassolver.BlasMatrixEngine,this.jama=new t.mwg.ml.common.matrix.jamasolver.JamaMatrixEngine}return e.prototype.multiplyTransposeAlphaBeta=function(t,n,r,i,o,s,a){return r.leadingDimension()<e.MULT_LIMIT&&o.leadingDimension()<e.MULT_LIMIT?this.jama.multiplyTransposeAlphaBeta(t,n,r,i,o,s,a):this.blas.multiplyTransposeAlphaBeta(t,n,r,i,o,s,a)},e.prototype.invert=function(t,n){return t.rows()<e.INVERT_LIMIT?this.jama.invert(t,n):this.blas.invert(t,n)},e.prototype.pinv=function(e,n){var r=new t.mwg.ml.common.matrix.operation.PInvSVD;return r.factor(e,n),r.getPInv()},e.prototype.solveLU=function(t,n,r,i){return t.leadingDimension()<e.SOLVELU_LIMIT&&n.leadingDimension()<e.SOLVELU_LIMIT?this.jama.solveLU(t,n,r,i):this.blas.solveLU(t,n,r,i)},e.prototype.solveQR=function(t,e,n,r){return this.blas.solveQR(t,e,n,r)},e.prototype.decomposeSVD=function(t,n){return t.leadingDimension()<e.SOLVESVD_LIMIT?this.jama.decomposeSVD(t,n):this.blas.decomposeSVD(t,n)},e.MULT_LIMIT=12,e.INVERT_LIMIT=6,e.PINV_LIMIT=5,e.SOLVELU_LIMIT=6,e.SOLVEQR_LIMIT=10,e.SOLVESVD_LIMIT=8,e}();e.HybridMatrixEngine=n,n=function(){function e(t,e,n){this._nbRows=e,this._nbColumns=n,this._data=null!=t?t:new Float64Array(this._nbRows*this._nbColumns)}return e.compare=function(t,e,n){if(null==t||null==e)return!1;for(var r=0;r<t.length;r++)if(Math.abs(t[r]-e[r])>n)return!1;return!0},e.compareArray=function(e,n,r){if(null==e||null==n)return!1;for(var i=0;i<e.length;i++)if(!t.mwg.ml.common.matrix.Matrix.compare(e[i],n[i],r))return!1;return!0},e.prototype.data=function(){return this._data},e.prototype.exportRowMatrix=function(){for(var t=new Float64Array(this._data.length),e=0,n=0;n<this._nbRows;n++)for(var r=0;r<this._nbColumns;r++)t[e]=this.get(n,r),e++;return t},e.prototype.importRowMatrix=function(e,n,r){n=new t.mwg.ml.common.matrix.Matrix(null,n,r);for(var i=r=0;i<this._nbRows;i++)for(var o=0;o<this._nbColumns;o++)n.set(i,o,e[r]),r++;return n},e.prototype.setData=function(t){java.lang.System.arraycopy(t,0,this._data,0,t.length)},e.prototype.rows=function(){return this._nbRows},e.prototype.columns=function(){return this._nbColumns},e.prototype.get=function(t,e){return this._data[t+e*this._nbRows]},e.prototype.set=function(t,e,n){return this._data[t+e*this._nbRows]=n},e.prototype.add=function(t,e,n){return this.set(t,e,this.get(t,e)+n)},e.prototype.setAll=function(t){for(var e=0;e<this._nbColumns*this._nbRows;e++)this._data[e]=t},e.prototype.getAtIndex=function(t){return this._data[t]},e.prototype.setAtIndex=function(t,e){return this._data[t]=e},e.prototype.addAtIndex=function(t,e){return this._data[t]+=e,this._data[t]},e.prototype.clone=function(){var e=new Float64Array(this._data.length);return java.lang.System.arraycopy(this._data,0,e,0,this._data.length),new t.mwg.ml.common.matrix.Matrix(e,this._nbRows,this._nbColumns)},e.defaultEngine=function(){return null==e._defaultEngine&&(e._defaultEngine=new t.mwg.ml.common.matrix.HybridMatrixEngine),e._defaultEngine},e.multiply=function(e,n){return t.mwg.ml.common.matrix.Matrix.defaultEngine().multiplyTransposeAlphaBeta(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE,1,e,t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE,n,0,null)},e.multiplyTranspose=function(e,n,r,i){return t.mwg.ml.common.matrix.Matrix.defaultEngine().multiplyTransposeAlphaBeta(e,1,n,r,i,0,null)},e.multiplyTransposeAlpha=function(e,n,r,i,o){return t.mwg.ml.common.matrix.Matrix.defaultEngine().multiplyTransposeAlphaBeta(e,n,r,i,o,0,null)},e.multiplyTransposeAlphaBeta=function(e,n,r,i,o,s,a){return t.mwg.ml.common.matrix.Matrix.defaultEngine().multiplyTransposeAlphaBeta(e,n,r,i,o,s,a)},e.invert=function(e,n){return t.mwg.ml.common.matrix.Matrix.defaultEngine().invert(e,n)},e.pinv=function(e,n){return t.mwg.ml.common.matrix.Matrix.defaultEngine().pinv(e,n)},e.prototype.leadingDimension=function(){return Math.max(this._nbColumns,this._nbRows)},e.random=function(e,n,r,i){for(var o=new t.mwg.ml.common.matrix.Matrix(null,e,n),s=new java.util.Random,a=0;a<e*n;a++)o.setAtIndex(a,s.nextDouble()*(i-r)+r);return o},e.scale=function(t,e){if(0==t)e.setAll(0);else for(var n=0;n<e.rows()*e.columns();n++)e.setAtIndex(n,t*e.getAtIndex(n))},e.transpose=function(e){var n=new t.mwg.ml.common.matrix.Matrix(null,e.columns(),e.rows());return e.columns()==e.rows()?t.mwg.ml.common.matrix.Matrix.transposeSquare(e,n):375<e.columns()&&375<e.rows()?t.mwg.ml.common.matrix.Matrix.transposeBlock(e,n):t.mwg.ml.common.matrix.Matrix.transposeStandard(e,n),n},e.transposeSquare=function(t,e){for(var n=1,r=t.columns(),i=0;i<t.rows();i++){var o=(i+1)*t.columns()+i,s=i*(t.columns()+1);for(e.setAtIndex(s,t.getAtIndex(s));n<r;n++)e.setAtIndex(n,t.getAtIndex(o)),e.setAtIndex(o,t.getAtIndex(n)),o+=t.columns();n+=i+2,r+=t.columns()}},e.transposeStandard=function(t,e){for(var n=0,r=0;r<e.columns();r++)for(var i=r,o=n+e.rows();n<o;)e.setAtIndex(n++,t.getAtIndex(i)),i+=t.rows()},e.transposeBlock=function(t,e){for(var n=0;n<t.columns();n+=60)for(var r=Math.min(60,t.columns()-n),i=n*t.rows(),o=n,s=0;s<t.rows();s+=60)for(var a=Math.min(60,t.rows()-s),a=i+a;i<a;i++){for(var l=i,h=o,u=h+r;h<u;h++)e.setAtIndex(h,t.getAtIndex(l)),l+=t.rows();o+=e.rows()}},e.prototype.saveToState=function(){var t=new Float64Array(this._data.length+2);return t[0]=this._nbRows,t[1]=this._nbColumns,java.lang.System.arraycopy(this._data,0,t,2,this._data.length),t},e.loadFromState=function(e){var n=new Float64Array(e.length-2);return java.lang.System.arraycopy(e,2,n,0,n.length),new t.mwg.ml.common.matrix.Matrix(n,e[0],e[1])},e.createIdentity=function(e,n){for(var r=new t.mwg.ml.common.matrix.Matrix(null,e,n),i=Math.min(e,n),o=0;o<i;o++)r.set(o,o,1);return r},e.compareMatrix=function(t,e){for(var n=0,r=0;r<t.rows();r++)for(var i=0;i<t.columns();i++)n<Math.abs(t.get(r,i)-e.get(r,i))&&(n=Math.abs(t.get(r,i)-e.get(r,i)));return n},e.testDimensionsAB=function(e,n,r,i){return e.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?n.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?r.columns()==i.rows():r.columns()==i.columns():n.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?r.rows()==i.rows():r.rows()==i.columns()},e.identity=function(e,n){for(var r=new t.mwg.ml.common.matrix.Matrix(null,e,n),i=0;i<Math.max(e,n);i++)r.set(i,i,1);return r},e._defaultEngine=null,e}(),e.Matrix=n,n=function(){function t(){}return t.prototype.equals=function(t){return this==t},t.values=function(){return t._TransposeTypeVALUES},t.NOTRANSPOSE=new t,t.TRANSPOSE=new t,t._TransposeTypeVALUES=[t.NOTRANSPOSE,t.TRANSPOSE],t}(),e.TransposeType=n,function(e){var n=function(){function e(){this._blas=new t.mwg.ml.common.matrix.blassolver.blas.JSBlas}return e.prototype.setBlas=function(t){this._blas=t},e.prototype.getBlas=function(){return this._blas},e.prototype.multiplyTransposeAlphaBeta=function(e,n,r,i,o,s,a){if(t.mwg.ml.common.matrix.Matrix.testDimensionsAB(e,i,r,o)){var l,h=new Int32Array(2);return e.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?(l=r.columns(),i.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?(h[0]=r.rows(),h[1]=o.columns()):(h[0]=r.rows(),h[1]=o.rows())):(l=r.rows(),i.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?(h[0]=r.columns(),h[1]=o.columns()):(h[0]=r.columns(),h[1]=o.rows())),0!=s&&null!=a||(a=new t.mwg.ml.common.matrix.Matrix(null,h[0],h[1])),this._blas.dgemm(e,i,a.rows(),a.columns(),l,n,r.data(),0,r.rows(),o.data(),0,o.rows(),s,a.data(),0,a.rows()),a}throw Error("Dimensions mismatch between A,B and C")},e.prototype.invert=function(e,n){if(e.rows()!=e.columns())return null;if(n){var r=new t.mwg.ml.common.matrix.blassolver.LU(e.rows(),e.columns(),this._blas);return r.invert(e)?e:null}var i=new t.mwg.ml.common.matrix.Matrix(null,e.rows(),e.columns()),o=new t.mwg.ml.common.matrix.Matrix(null,e.rows(),e.columns());
return java.lang.System.arraycopy(e.data(),0,o.data(),0,e.columns()*e.rows()),r=new t.mwg.ml.common.matrix.blassolver.LU(o.rows(),o.columns(),this._blas),r.invert(o)?(i.setData(o.data()),i):null},e.prototype.pinv=function(e,n){return this.solve(e,t.mwg.ml.common.matrix.Matrix.identity(e.rows(),e.rows()))},e.prototype.solveQR=function(e,n,r,i){return r=t.mwg.ml.common.matrix.blassolver.QR.factorize(e,r,this._blas),e=new t.mwg.ml.common.matrix.Matrix(null,e.columns(),n.columns()),i!=t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE&&(n=t.mwg.ml.common.matrix.Matrix.transpose(n)),r.solve(n,e),e},e.prototype.decomposeSVD=function(e,n){var r=new t.mwg.ml.common.matrix.blassolver.SVD(e.rows(),e.columns(),this._blas);return r.factor(e,n),r},e.prototype.solveLU=function(e,n,r,i){if(r)return r=new t.mwg.ml.common.matrix.blassolver.LU(e.rows(),e.columns(),this._blas),r.factor(e,!0),r.isSingular()?null:(r.transSolve(n,i),n);var o=new t.mwg.ml.common.matrix.Matrix(null,e.rows(),e.columns());return java.lang.System.arraycopy(e.data(),0,o.data(),0,e.columns()*e.rows()),r=new t.mwg.ml.common.matrix.blassolver.LU(o.rows(),o.columns(),this._blas),r.factor(o,!0),r.isSingular()?null:(e=new t.mwg.ml.common.matrix.Matrix(null,n.rows(),n.columns()),java.lang.System.arraycopy(n.data(),0,e.data(),0,n.columns()*n.rows()),r.transSolve(e,i),e)},e.prototype.solve=function(e,n){return e.rows()==e.columns()?new t.mwg.ml.common.matrix.blassolver.LU(e.rows(),e.columns(),this._blas).factor(e,!1).solve(n):this.solveQR(e,n,!1,t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)},e}();e.BlasMatrixEngine=n,n=function(){function t(){}return t.prototype.netlib=function(){switch(this){case t.All:return"A";case t.Part:return"S";case t.Overwrite:return"O";default:return"N"}},t.prototype.equals=function(t){return this==t},t.values=function(){return t._JobSVDVALUES},t.All=new t,t.None=new t,t.Overwrite=new t,t.Part=new t,t._JobSVDVALUES=[t.All,t.None,t.Overwrite,t.Part],t}(),e.JobSVD=n,n=function(){function e(e,n,r){this._blas=r,this.LU=new t.mwg.ml.common.matrix.Matrix(null,e,n),this.piv=new Int32Array(Math.min(e,n))}return e.prototype.getLU=function(){return this.LU},e.factorize=function(e,n){return new t.mwg.ml.common.matrix.blassolver.LU(e.rows(),e.columns(),n).factor(e,!1)},e.prototype.factor=function(t,e){if(e){this.singular=!1;var n=new Int32Array(1);if(n[0]=0,this._blas.dgetrf(t.rows(),t.columns(),t.data(),0,t.rows(),this.piv,0,n),0<n[0])this.singular=!0;else if(0>n[0])throw Error();this.LU.setData(t.data())}else{this.singular=!1;var r=t.clone(),n=new Int32Array(1);if(n[0]=0,this._blas.dgetrf(r.rows(),r.columns(),r.data(),0,r.rows(),this.piv,0,n),0<n[0])this.singular=!0;else if(0>n[0])throw Error();this.LU.setData(r.data())}return this},e.prototype.getL=function(){for(var e=this.LU.rows(),n=this.LU.rows()<this.LU.columns()?this.LU.rows():this.LU.columns(),r=new t.mwg.ml.common.matrix.Matrix(null,e,n),i=0;i<n;i++){r.set(i,i,1);for(var o=0;o<i;o++)r.set(i,o,this.LU.get(i,o))}if(e>n)for(i=n;i<e;i++)for(o=0;o<n;o++)r.set(i,o,this.LU.get(i,o));return r},e.prototype.getU=function(){for(var e=this.LU.rows()<this.LU.columns()?this.LU.rows():this.LU.columns(),n=this.LU.columns(),r=new t.mwg.ml.common.matrix.Matrix(null,e,n),i=0;i<e;i++)for(var o=i;o<n;o++)r.set(i,o,this.LU.get(i,o));return r},e.prototype.getPivots=function(){return this.piv},e.prototype.isSingular=function(){return this.singular},e.prototype.solve=function(e){return this.transSolve(e,t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)},e.prototype.transSolve=function(t,e){if(t.rows()!=this.LU.rows())throw Error("B.numRows() != LU.numRows()");var n=new Int32Array(1);if(this._blas.dgetrs(e,this.LU.rows(),t.columns(),this.LU.data(),0,this.LU.rows(),this.piv,0,t.data(),0,t.rows(),n),0>n[0])throw Error();return t},e.prototype.invert=function(t){var e=new Int32Array(1);if(e[0]=0,this._blas.dgetrf(t.rows(),t.columns(),t.data(),0,t.rows(),this.piv,0,e),0<e[0])return this.singular=!0,!1;if(0>e[0])throw Error();for(var n=t.rows()*t.rows(),r=new Float64Array(n),i=0;i<n;i++)r[i]=0;return this._blas.dgetri(t.rows(),t.data(),0,t.rows(),this.piv,0,r,0,n,e),0==e[0]},e}(),e.LU=n,n=function(){function e(e,n,r){if(this._blas=r,n>e)throw Error("n > m");this.m=e,this.n=n,this.k=Math.min(this.m,this.n),this.tau=new Float64Array(this.k),this.R=new t.mwg.ml.common.matrix.Matrix(null,this.n,this.n)}return e.factorize=function(e,n,r){return new t.mwg.ml.common.matrix.blassolver.QR(e.rows(),e.columns(),r).factor(e,n)},e.prototype.factor=function(t,e){var n;n=e?t:t.clone();var r;if(this.work=new Float64Array(1),r=new Int32Array(1),r[0]=0,this._blas.dgeqrf(this.m,this.n,new Float64Array(0),0,this.m,new Float64Array(0),0,this.work,0,-1,r),r=0!=r[0]?this.n:this.work[0],r=Math.max(1,r),this.work=new Float64Array(r),this.workGen=new Float64Array(1),r=new Int32Array(1),r[0]=0,this._blas.dorgqr(this.m,this.n,this.k,new Float64Array(0),0,this.m,new Float64Array(0),0,this.workGen,0,-1,r),r=0!=r[0]?this.n:this.workGen[0],r=Math.max(1,r),this.workGen=new Float64Array(r),r=new Int32Array(1),r[0]=0,this._blas.dgeqrf(this.m,this.n,n.data(),0,this.m,this.tau,0,this.work,0,this.work.length,r),0>r[0])throw Error(""+r[0]);for(var i=0;i<n.columns();i++)for(var o=0;o<=i;o++)this.R.set(o,i,n.get(o,i));if(r[0]=0,this._blas.dorgqr(this.m,this.n,this.k,n.data(),0,this.m,this.tau,0,this.workGen,0,this.workGen.length,r),0>r[0])throw Error();return this.Q=n,this},e.prototype.solve=function(e,n){for(var r,i=e.columns(),o=new t.mwg.ml.common.matrix.Matrix(null,this.m,1),s=0;s<i;s++){for(var a=0;a<this.m;a++)o.setAtIndex(a,e.get(a,s));for(r=t.mwg.ml.common.matrix.Matrix.multiplyTranspose(t.mwg.ml.common.matrix.TransposeType.TRANSPOSE,this.Q,t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE,o),this.solveU(this.R,r.data(),this.n,this.m),a=0;a<this.n;a++)n.set(a,s,r.getAtIndex(a))}},e.prototype.solveU=function(t,e,n,r){for(r=n-1;0<=r;r--){for(var i=e[r],o=r+1;o<n;o++)i-=t.get(r,o)*e[o];e[r]=i/t.get(r,r)}},e.prototype.getR=function(){return this.R},e.prototype.getQ=function(){return this.Q},e}(),e.QR=n,n=function(){function e(e,n,r){this.m=e,this.n=n,this._blas=r,this.vectors=!0,this.S=new Float64Array(Math.min(e,n)),this.vectors?(this.U=new t.mwg.ml.common.matrix.Matrix(null,e,e),this.Vt=new t.mwg.ml.common.matrix.Matrix(null,n,n)):this.U=this.Vt=null,this.job=this.vectors?t.mwg.ml.common.matrix.blassolver.JobSVD.All:t.mwg.ml.common.matrix.blassolver.JobSVD.None,this.iwork=new Int32Array(8*Math.min(e,n)),r=new Float64Array(1);var i=new Int32Array(1);this._blas.dgesdd(this.job.netlib(),e,n,new Float64Array(0),Math.max(1,e),new Float64Array(0),new Float64Array(0),Math.max(1,e),new Float64Array(0),Math.max(1,n),r,-1,this.iwork,i),e=0!=i[0]?this.vectors?3*Math.min(e,n)*Math.min(e,n)+Math.max(Math.max(e,n),4*Math.min(e,n)*Math.min(e,n)+4*Math.min(e,n)):3*Math.min(e,n)*Math.min(e,n)+Math.max(Math.max(e,n),5*Math.min(e,n)*Math.min(e,n)+4*Math.min(e,n)):r[0],e=Math.max(e,1),this.work=new Float64Array(e)}return e.prototype.factor=function(t,e){if(t.rows()!=this.m)throw Error("A.numRows() != m");if(t.columns()!=this.n)throw Error("A.numColumns() != n");var n=new Int32Array(1);if(n[0]=0,e)this._blas.dgesdd(this.job.netlib(),this.m,this.n,t.data(),Math.max(1,this.m),this.S,this.vectors?this.U.data():new Float64Array(0),Math.max(1,this.m),this.vectors?this.Vt.data():new Float64Array(0),Math.max(1,this.n),this.work,this.work.length,this.iwork,n);else{var r=t.data(),i=new Float64Array(r.length);java.lang.System.arraycopy(r,0,i,0,r.length),this._blas.dgesdd(this.job.netlib(),this.m,this.n,i,Math.max(1,this.m),this.S,this.vectors?this.U.data():new Float64Array(0),Math.max(1,this.m),this.vectors?this.Vt.data():new Float64Array(0),Math.max(1,this.n),this.work,this.work.length,this.iwork,n)}if(0<n[0])throw Error("NotConvergedException.Reason.Iterations");if(0>n[0])throw Error();return this},e.prototype.hasSingularVectors=function(){return null!=this.U},e.prototype.getU=function(){return this.U},e.prototype.getVt=function(){return this.Vt},e.prototype.getS=function(){return this.S},e.prototype.getSMatrix=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,this.m,this.n),n=0;n<this.S.length;n++)e.set(n,n,this.S[n]);return e},e}(),e.SVD=n,function(e){var n=function(){function e(){}return e.transTypeToChar=function(n){return n.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?e.TRANSPOSE_TYPE_NOTRANSPOSE:n.equals(t.mwg.ml.common.matrix.TransposeType.TRANSPOSE)?e.TRANSPOSE_TYPE_TRANSPOSE:null},e.TRANSPOSE_TYPE_CONJUCATE="c",e.TRANSPOSE_TYPE_NOTRANSPOSE="n",e.TRANSPOSE_TYPE_TRANSPOSE="t",e}();e.BlasHelper=n}(e.blas||(e.blas={}))}(e.blassolver||(e.blassolver={})),function(e){var n=function(){function e(){}return e.prototype.multiplyTransposeAlphaBeta=function(e,n,r,i,o,s,a){if(t.mwg.ml.common.matrix.Matrix.testDimensionsAB(e,i,r,o)){var l=new Int32Array(3);if(e.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?(i.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?(l[0]=r.rows(),l[1]=o.columns()):(l[0]=r.rows(),l[1]=o.rows()),l[2]=r.columns()):(i.equals(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)?(l[0]=r.columns(),l[1]=o.columns()):(l[0]=r.columns(),l[1]=o.rows()),l[2]=r.rows()),0!=s&&null!=a||(a=new t.mwg.ml.common.matrix.Matrix(null,l[0],l[1])),e==t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE&&i==t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)for(i=0;i<l[0];i++)for(var h=0;h<l[1];h++){for(var u=e=0;u<l[2];u++)e+=n*r.get(i,u)*o.get(u,h);0!=s&&(e+=s*a.get(i,h)),a.set(i,h,e)}else if(e==t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE&&i==t.mwg.ml.common.matrix.TransposeType.TRANSPOSE)for(i=0;i<l[0];i++)for(h=0;h<l[1];h++){for(u=e=0;u<l[2];u++)e+=n*r.get(i,u)*o.get(h,u);0!=s&&(e+=s*a.get(i,h)),a.set(i,h,e)}else if(e==t.mwg.ml.common.matrix.TransposeType.TRANSPOSE&&i==t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)for(i=0;i<l[0];i++)for(h=0;h<l[1];h++){for(u=e=0;u<l[2];u++)e+=n*r.get(u,i)*o.get(u,h);0!=s&&(e+=s*a.get(i,h)),a.set(i,h,e)}else if(e==t.mwg.ml.common.matrix.TransposeType.TRANSPOSE&&i==t.mwg.ml.common.matrix.TransposeType.TRANSPOSE)for(i=0;i<l[0];i++)for(h=0;h<l[1];h++){for(u=e=0;u<l[2];u++)e+=n*r.get(u,i)*o.get(h,u);0!=s&&(e+=s*a.get(i,h)),a.set(i,h,e)}return a}throw Error("Dimensions mismatch between A,B and C")},e.prototype.invert=function(e,n){return t.mwg.ml.common.matrix.jamasolver.JamaMatrixEngine.solve(e,t.mwg.ml.common.matrix.Matrix.identity(e.rows(),e.rows()))},e.prototype.pinv=function(e,n){return t.mwg.ml.common.matrix.jamasolver.JamaMatrixEngine.solve(e,t.mwg.ml.common.matrix.Matrix.identity(e.rows(),e.rows()))},e.prototype.solveLU=function(e,n,r,i){return n=i==t.mwg.ml.common.matrix.TransposeType.TRANSPOSE?t.mwg.ml.common.matrix.Matrix.transpose(n):n,new t.mwg.ml.common.matrix.jamasolver.LU(e).solve(n)},e.prototype.solveQR=function(e,n,r,i){return n=i==t.mwg.ml.common.matrix.TransposeType.TRANSPOSE?t.mwg.ml.common.matrix.Matrix.transpose(n):n,new t.mwg.ml.common.matrix.jamasolver.QR(e).solve(n)},e.prototype.decomposeSVD=function(e,n){return new t.mwg.ml.common.matrix.jamasolver.SVD(e)},e.solve=function(e,n){return e.rows()==e.columns()?new t.mwg.ml.common.matrix.jamasolver.LU(e).solve(n):new t.mwg.ml.common.matrix.jamasolver.QR(e).solve(n)},e}();e.JamaMatrixEngine=n,n=function(){function e(t){this.LU=t.clone(),this.m=t.rows(),this.n=t.columns(),this.piv=new Int32Array(this.m);for(var e=0;e<this.m;e++)this.piv[e]=e;this.pivsign=1,t=new Float64Array(this.m);for(var n=0;n<this.n;n++){for(e=0;e<this.m;e++)t[e]=this.LU.get(e,n);for(e=0;e<this.m;e++){for(var r=Math.min(e,n),i=0,o=0;o<r;o++)i+=this.LU.get(e,o)*t[o];t[e]-=i,this.LU.set(e,n,t[e])}for(r=n,e=n+1;e<this.m;e++)Math.abs(t[e])>Math.abs(t[r])&&(r=e);if(r!=n){for(o=0;o<this.n;o++)e=this.LU.get(r,o),this.LU.set(r,o,this.LU.get(n,o)),this.LU.set(n,o,e);o=this.piv[r],this.piv[r]=this.piv[n],this.piv[n]=o,this.pivsign=-this.pivsign}if(n<this.m&&0!=this.LU.get(n,n))for(e=n+1;e<this.m;e++)this.LU.set(e,n,this.LU.get(e,n)/this.LU.get(n,n))}}return e.prototype.isNonsingular=function(){for(var t=0;t<this.n;t++)if(0==this.LU.get(t,t))return!1;return!0},e.prototype.getL=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,this.m,this.n),n=0;n<this.m;n++)for(var r=0;r<this.n;r++)n>r?e.set(n,r,this.LU.get(n,r)):n==r?e.set(n,r,1):e.set(n,r,0);return e},e.prototype.getU=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,this.n,this.n),n=0;n<this.n;n++)for(var r=0;r<this.n;r++)n<=r?e.set(n,r,this.LU.get(n,r)):e.set(n,r,0);return e},e.prototype.getPivot=function(){for(var t=new Int32Array(this.m),e=0;e<this.m;e++)t[e]=this.piv[e];return t},e.prototype.getDoublePivot=function(){for(var t=new Float64Array(this.m),e=0;e<this.m;e++)t[e]=this.piv[e];return t},e.prototype.det=function(){if(this.m!=this.n)throw Error("Matrix must be square.");for(var t=this.pivsign,e=0;e<this.n;e++)t*=this.LU.get(e,e);return t},e.prototype.solve=function(t){if(t.rows()!=this.m)throw Error("Matrix row dimensions must agree.");if(!this.isNonsingular())throw Error("Matrix is singular.");var e=t.columns();t=this.getMatrix(t,this.piv,0,e-1);for(var n=0;n<this.n;n++)for(var r=n+1;r<this.n;r++)for(var i=0;i<e;i++)t.add(r,i,-t.get(n,i)*this.LU.get(r,n));for(n=this.n-1;0<=n;n--){for(i=0;i<e;i++)t.set(n,i,t.get(n,i)/this.LU.get(n,n));for(r=0;r<n;r++)for(i=0;i<e;i++)t.add(r,i,-t.get(n,i)*this.LU.get(r,n))}return t},e.prototype.getMatrix=function(e,n,r,i){var o=new t.mwg.ml.common.matrix.Matrix(null,n.length,i-r+1);try{for(var s=0;s<n.length;s++)for(var a=r;a<=i;a++)o.set(s,a-r,e.get(n[s],a))}catch(l){if(l instanceof Error)throw Error("Submatrix indices");throw l}return o},e}(),e.LU=n,n=function(){function e(e){for(this.QR=e.clone(),this.m=e.rows(),this.n=e.columns(),this.Rdiag=new Float64Array(this.n),e=0;e<this.n;e++){for(var n=0,r=e;r<this.m;r++)n=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(n,this.QR.get(r,e));if(0!=n){for(0>this.QR.get(e,e)&&(n=-n),r=e;r<this.m;r++)this.QR.set(r,e,this.QR.get(r,e)/n);this.QR.add(e,e,1);for(var i=e+1;i<this.n;i++){for(var o=0,r=e;r<this.m;r++)o+=this.QR.get(r,e)*this.QR.get(r,i);for(o=-o/this.QR.get(e,e),r=e;r<this.m;r++)this.QR.add(r,i,o*this.QR.get(r,e))}}this.Rdiag[e]=-n}}return e.prototype.isFullRank=function(){for(var t=0;t<this.n;t++)if(0==this.Rdiag[t])return!1;return!0},e.prototype.getH=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,this.m,this.n),n=0;n<this.m;n++)for(var r=0;r<this.n;r++)n>=r?e.set(n,r,this.QR.get(n,r)):e.set(n,r,0);return e},e.prototype.getR=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,this.n,this.n),n=0;n<this.n;n++)for(var r=0;r<this.n;r++)n<r?e.set(n,r,this.QR.get(n,r)):n==r?e.set(n,r,this.Rdiag[n]):e.set(n,r,0);return e},e.prototype.getQ=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,this.m,this.n),n=this.n-1;0<=n;n--){for(var r=0;r<this.m;r++)e.set(r,n,0);e.set(n,n,1);for(var i=n;i<this.n;i++)if(0!=this.QR.get(n,n)){for(var o=0,r=n;r<this.m;r++)o+=this.QR.get(r,n)*e.get(r,i);for(o=-o/this.QR.get(n,n),r=n;r<this.m;r++)e.add(r,i,o*this.QR.get(r,n))}}return e},e.prototype.solve=function(e){if(e.rows()!=this.m)throw Error("Matrix row dimensions must agree.");if(!this.isFullRank())throw Error("Matrix is rank deficient.");var n=e.columns();e=e.clone();for(var r=0;r<this.n;r++)for(var i=0;i<n;i++){for(var o=0,s=r;s<this.m;s++)o+=this.QR.get(s,r)*e.get(s,i);for(o=-o/this.QR.get(r,r),s=r;s<this.m;s++)e.add(s,i,o*this.QR.get(s,r))}for(r=this.n-1;0<=r;r--){for(i=0;i<n;i++)e.set(r,i,e.get(r,i)/this.Rdiag[r]);for(s=0;s<r;s++)for(i=0;i<n;i++)e.add(s,i,-e.get(r,i)*this.QR.get(s,r))}return t.mwg.ml.common.matrix.jamasolver.QR.getMatrix(e,0,this.n-1,0,n-1)},e.getMatrix=function(e,n,r,i,o){var s=new t.mwg.ml.common.matrix.Matrix(null,r-n+1,o-i+1);try{for(var a=n;a<=r;a++)for(var l=i;l<=o;l++)s.set(a-n,l-i,e.get(a,l))}catch(h){if(h instanceof Error)throw Error("Submatrix indices");throw h}return s},e}(),e.QR=n,n=function(){function e(e){var n=e.clone();this.m=e.rows(),this.n=e.columns();var r=Math.min(this.m,this.n);this.s=new Float64Array(Math.min(this.m+1,this.n)),this.U=new t.mwg.ml.common.matrix.Matrix(null,this.m,r),this.V=new t.mwg.ml.common.matrix.Matrix(null,this.n,this.n),e=new Float64Array(this.n);for(var i=new Float64Array(this.m),o=Math.min(this.m-1,this.n),s=Math.max(0,Math.min(this.n-2,this.m)),a=0;a<Math.max(o,s);a++){if(a<o){this.s[a]=0;for(var l=a;l<this.m;l++)this.s[a]=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(this.s[a],n.get(l,a));if(0!=this.s[a]){for(0>n.get(a,a)&&(this.s[a]=-this.s[a]),l=a;l<this.m;l++)n.set(l,a,n.get(l,a)/this.s[a]);n.add(a,a,1)}this.s[a]=-this.s[a]}for(var h=a+1;h<this.n;h++){if(a<o&&0!=this.s[a]){for(var u=0,l=a;l<this.m;l++)u+=n.get(l,a)*n.get(l,h);for(u=-u/n.get(a,a),l=a;l<this.m;l++)n.add(l,h,+u*n.get(l,a))}e[h]=n.get(a,h)}if(a<o)for(l=a;l<this.m;l++)this.U.set(l,a,n.get(l,a));if(a<s){for(e[a]=0,l=a+1;l<this.n;l++)e[a]=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(e[a],e[l]);if(0!=e[a]){for(0>e[a+1]&&(e[a]=-e[a]),l=a+1;l<this.n;l++)e[l]/=e[a];e[a+1]+=1}if(e[a]=-e[a],a+1<this.m&&0!=e[a]){for(l=a+1;l<this.m;l++)i[l]=0;for(h=a+1;h<this.n;h++)for(l=a+1;l<this.m;l++)i[l]+=e[h]*n.get(l,h);for(h=a+1;h<this.n;h++)for(u=-e[h]/e[a+1],l=a+1;l<this.m;l++)n.add(l,h,u*i[l])}for(l=a+1;l<this.n;l++)this.V.set(l,a,e[l])}}for(i=Math.min(this.n,this.m+1),o<this.n&&(this.s[o]=n.get(o,o)),this.m<i&&(this.s[i-1]=0),s+1<i&&(e[s]=n.get(s,i-1)),e[i-1]=0,h=o;h<r;h++){for(l=0;l<this.m;l++)this.U.set(l,h,0);this.U.set(h,h,1)}for(a=o-1;0<=a;a--)if(0!=this.s[a]){for(h=a+1;h<r;h++){for(u=0,l=a;l<this.m;l++)u+=this.U.get(l,a)*this.U.get(l,h);for(u=-u/this.U.get(a,a),l=a;l<this.m;l++)this.U.add(l,h,u*this.U.get(l,a))}for(l=a;l<this.m;l++)this.U.set(l,a,-this.U.get(l,a));for(this.U.set(a,a,1+this.U.get(a,a)),l=0;l<a-1;l++)this.U.set(l,a,0)}else{for(l=0;l<this.m;l++)this.U.set(l,a,0);this.U.set(a,a,1)}for(a=this.n-1;0<=a;a--){if(a<s&&0!=e[a])for(h=a+1;h<r;h++){for(u=0,l=a+1;l<this.n;l++)u+=this.V.get(l,a)*this.V.get(l,h);for(u=-u/this.V.get(a+1,a),l=a+1;l<this.n;l++)this.V.add(l,h,u*this.V.get(l,a))}for(l=0;l<this.n;l++)this.V.set(l,a,0);this.V.set(a,a,1)}for(n=i-1,r=Math.pow(2,-52),o=Math.pow(2,-966);0<i;){for(a=i-2;-1<=a&&-1!=a;a--)if(Math.abs(e[a])<=o+r*(Math.abs(this.s[a])+Math.abs(this.s[a+1]))){e[a]=0;break}if(a==i-2)u=4;else{for(l=i-1;l>=a&&l!=a;l--)if(u=(l!=i?Math.abs(e[l]):0)+(l!=a+1?Math.abs(e[l-1]):0),Math.abs(this.s[l])<=o+r*u){this.s[l]=0;break}l==a?u=3:l==i-1?u=1:(u=2,a=l)}switch(a++,u){case 1:for(s=e[i-2],e[i-2]=0,h=i-2;h>=a;h--){var u=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(this.s[h],s),c=this.s[h]/u,p=s/u;for(this.s[h]=u,h!=a&&(s=-p*e[h-1],e[h-1]*=c),l=0;l<this.n;l++)u=c*this.V.get(l,h)+p*this.V.get(l,i-1),this.V.set(l,i-1,-p*this.V.get(l,h)+c*this.V.get(l,i-1)),this.V.set(l,h,u)}break;case 2:for(s=e[a-1],e[a-1]=0,h=a;h<i;h++)for(u=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(this.s[h],s),c=this.s[h]/u,p=s/u,this.s[h]=u,s=-p*e[h],e[h]*=c,l=0;l<this.m;l++)u=c*this.U.get(l,h)+p*this.U.get(l,a-1),this.U.set(l,a-1,-p*this.U.get(l,h)+c*this.U.get(l,a-1)),this.U.set(l,h,u);break;case 3:h=Math.max(Math.max(Math.max(Math.max(Math.abs(this.s[i-1]),Math.abs(this.s[i-2])),Math.abs(e[i-2])),Math.abs(this.s[a])),Math.abs(e[a])),l=this.s[i-1]/h,c=this.s[i-2]/h,s=e[i-2]/h,u=this.s[a]/h,h=e[a]/h,c=((c+l)*(c-l)+s*s)/2,s*=l*s*l,p=0,0==c&&0==s||(p=Math.sqrt(c*c+s),0>c&&(p=-p),p=s/(c+p));for(var s=(u+l)*(u-l)+p,m=u*h,h=a;h<i-1;h++){for(u=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(s,m),c=s/u,p=m/u,h!=a&&(e[h-1]=u),s=c*this.s[h]+p*e[h],e[h]=c*e[h]-p*this.s[h],m=p*this.s[h+1],this.s[h+1]*=c,l=0;l<this.n;l++)u=c*this.V.get(l,h)+p*this.V.get(l,h+1),this.V.set(l,h+1,-p*this.V.get(l,h)+c*this.V.get(l,h+1)),this.V.set(l,h,u);if(u=t.mwg.ml.common.matrix.jamasolver.Utils.hypot(s,m),c=s/u,p=m/u,this.s[h]=u,s=c*e[h]+p*this.s[h+1],this.s[h+1]=-p*e[h]+c*this.s[h+1],m=p*e[h+1],e[h+1]*=c,h<this.m-1)for(l=0;l<this.m;l++)u=c*this.U.get(l,h)+p*this.U.get(l,h+1),this.U.set(l,h+1,-p*this.U.get(l,h)+c*this.U.get(l,h+1)),this.U.set(l,h,u)}e[i-2]=s;break;case 4:if(0>=this.s[a])for(this.s[a]=0>this.s[a]?-this.s[a]:0,l=0;l<=n;l++)this.V.set(l,a,-this.V.get(l,a));for(;a<n&&!(this.s[a]>=this.s[a+1]);){if(u=this.s[a],this.s[a]=this.s[a+1],this.s[a+1]=u,a<this.n-1)for(l=0;l<this.n;l++)u=this.V.get(l,a+1),this.V.set(l,a+1,this.V.get(l,a)),this.V.set(l,a,u);if(a<this.m-1)for(l=0;l<this.m;l++)u=this.U.get(l,a+1),this.U.set(l,a+1,this.U.get(l,a)),this.U.set(l,a,u);a++}i--}}}return e.prototype.factor=function(e,n){return new t.mwg.ml.common.matrix.jamasolver.SVD(e)},e.prototype.getU=function(){return this.U},e.prototype.getVt=function(){return t.mwg.ml.common.matrix.Matrix.transpose(this.getV())},e.prototype.getV=function(){return this.V},e.prototype.getSingularValues=function(){return this.s},e.prototype.getSMatrix=function(){for(var e=new t.mwg.ml.common.matrix.Matrix(null,Math.min(this.m,this.n),this.n),n=0;n<this.s.length;n++)n<this.m&&n<this.n&&e.set(n,n,this.s[n]);return e},e.prototype.getS=function(){return this.s},e.prototype.norm2=function(){return this.s[0]},e.prototype.cond=function(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]},e.prototype.rank=function(){for(var t=Math.max(this.m,this.n)*this.s[0]*Math.pow(2,-52),e=0,n=0;n<this.s.length;n++)this.s[n]>t&&e++;return e},e.serialVersionUID=1,e}(),e.SVD=n,n=function(){function t(){}return t.hypot=function(t,e){var n;return Math.abs(t)>Math.abs(e)?(n=e/t,n=Math.abs(t)*Math.sqrt(1+n*n)):0!=e?(n=t/e,n=Math.abs(e)*Math.sqrt(1+n*n)):n=0,n},t}(),e.Utils=n}(e.jamasolver||(e.jamasolver={})),function(e){var n=function(){function e(){}return e.getCovariance=function(t,e,n){return(e-t*t/n)/(n-1)},e.getDensity=function(e,n,r,i){if(2>r)return 0;var o=e/r;return e=t.mwg.ml.common.matrix.operation.Gaussian1D.getCovariance(e,n,r),1/Math.sqrt(2*Math.PI*e)*Math.exp(-(i-o)*(i-o)/(2*e))},e.getDensityArray=function(e,n,r,i){if(2>r)return null;var o=e/r;e=t.mwg.ml.common.matrix.operation.Gaussian1D.getCovariance(e,n,r),n=1/Math.sqrt(2*Math.PI*e),r=new Float64Array(i.length);for(var s=0;s<i.length;s++)r[s]=n*Math.exp(-(i[s]-o)*(i[s]-o)/(2*e));return r},e}();e.Gaussian1D=n,n=function(){function e(e,n,r){if(this.means=e,null!=n){for(this.covariance=n,this.covDiag=new Float64Array(n.rows()),e=0;e<this.covDiag.length;e++)this.covDiag[e]=n.get(e,e);if(this.pinvsvd=new t.mwg.ml.common.matrix.operation.PInvSVD,this.pinvsvd.factor(this.covariance,!1),this.inv=this.pinvsvd.getPInv(),this.det=this.pinvsvd.getDeterminant(),this.rank=this.pinvsvd.getRank(),!r&&this.rank<n.rows()){for(this.covariance=n.clone(),n=new Float64Array(this.covDiag.length),e=0;e<this.covDiag.length;e++)n[e]=Math.sqrt(this.covDiag[e]);for(e=0;e<this.covDiag.length;e++)for(r=e+1;r<this.covDiag.length;r++){var i=this.covariance.get(e,r)-1e-4*n[e]*n[r];this.covariance.set(e,r,i),this.covariance.set(r,e,i)}this.pinvsvd=new t.mwg.ml.common.matrix.operation.PInvSVD,this.pinvsvd.factor(this.covariance,!1),this.inv=this.pinvsvd.getPInv(),this.det=this.pinvsvd.getDeterminant(),this.rank=this.pinvsvd.getRank()}}}return e.prototype.getMin=function(){return this.min},e.prototype.getMax=function(){return this.max},e.prototype.getAvg=function(){return this.means},e.prototype.getCovDiag=function(){return this.covDiag},e.prototype.setMin=function(t){this.min=t},e.prototype.setMax=function(t){this.max=t},e.getCovariance=function(e,n,r){if(2>r)return null;for(var i=e.length,o=new Float64Array(i),s=0;s<i;s++)o[s]=e[s]/r;e=new Float64Array(i*i);var a;a=r/(r-1);for(var l=0,s=0;s<i;s++)for(var h=s;h<i;h++)e[s*i+h]=(n[l]/r-o[s]*o[h])*a,e[h*i+s]=e[s*i+h],l++;return new t.mwg.ml.common.matrix.Matrix(e,i,i)},e.getDistribution=function(e,n,r,i){if(2>r)return null;for(var o=e.length,s=new Float64Array(o),a=0;a<o;a++)s[a]=e[a]/r;e=new Float64Array(o*o);var l;l=r/(r-1);for(var h=0,a=0;a<o;a++)for(var u=a;u<o;u++)e[a*o+u]=(n[h]/r-s[a]*s[u])*l,e[u*o+a]=e[a*o+u],h++;return n=new t.mwg.ml.common.matrix.Matrix(e,o,o),new t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution(s,n,i)},e.prototype.density=function(t,e){return e?this.getExponentTerm(t):Math.pow(2*Math.PI,-.5*this.rank)*Math.pow(this.det,-.5)*this.getExponentTerm(t)},e.prototype.getExponentTerm=function(e){var n=new Float64Array(e.length);java.lang.System.arraycopy(e,0,n,0,e.length);for(var r=0;r<e.length;r++)n[r]-=this.means[r];return e=new t.mwg.ml.common.matrix.Matrix(n,1,n.length),n=new t.mwg.ml.common.matrix.Matrix(n,n.length,1),e=t.mwg.ml.common.matrix.Matrix.multiply(e,this.inv),n=t.mwg.ml.common.matrix.Matrix.multiply(e,n),Math.exp(-.5*n.get(0,0))},e.prototype.clone=function(e){return e=new t.mwg.ml.common.matrix.operation.MultivariateNormalDistribution(e,null,(!1)),e.pinvsvd=this.pinvsvd,e.inv=this.inv,e.det=this.det,e.rank=this.rank,e.covDiag=this.covDiag,e},e}(),e.MultivariateNormalDistribution=n,n=function(){function e(){}return e.prototype.getRank=function(){return this.rank},e.prototype.getDeterminant=function(){return this.det},e.prototype.factor=function(e,n){this._svd=t.mwg.ml.common.matrix.Matrix.defaultEngine().decomposeSVD(e,n);var r=Array(3);r[0]=this._svd.getU(),r[1]=this._svd.getSMatrix(),r[2]=this._svd.getVt(),r=this._svd.getVt(),this.S=this._svd.getSMatrix().clone();for(var i=0,o=Math.min(this.S.columns(),this.S.rows()),s=0;s<o;s++)this.S.get(s,s)>i&&(i=this.S.get(s,s));var a=Math.pow(2,-46)*Math.max(e.columns(),e.rows())*i;if(this.rank=0,this.det=1,0!=i)for(s=0;s<o;s++)i=this.S.get(s,s),i<a?this.S.set(s,s,0):(this.S.set(s,s,1/i),this.det*=i,this.rank++);return r=t.mwg.ml.common.matrix.Matrix.multiplyTranspose(t.mwg.ml.common.matrix.TransposeType.TRANSPOSE,r,t.mwg.ml.common.matrix.TransposeType.TRANSPOSE,this.S),this.pinv=t.mwg.ml.common.matrix.Matrix.multiplyTranspose(t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE,r,t.mwg.ml.common.matrix.TransposeType.TRANSPOSE,this._svd.getU()),this},e.prototype.getSvd=function(){return this._svd},e.prototype.getInvDeterminant=function(){return this.S},e.prototype.getPInv=function(){return this.pinv},e}(),e.PInvSVD=n,n=function(){function e(t){this.degree=0,this.degree=t}return e.prototype.getCoef=function(){return this.coef.data()},e.prototype.fit=function(e,n){for(var r=new t.mwg.ml.common.matrix.Matrix(n,n.length,1),i=new t.mwg.ml.common.matrix.Matrix(null,r.rows(),this.degree+1),o=0;o<n.length;o++)for(var s=1,a=0;a<this.degree+1;a++)i.set(o,a,s),s*=e[o];this.coef=t.mwg.ml.common.matrix.Matrix.defaultEngine().solveQR(i,r,!0,t.mwg.ml.common.matrix.TransposeType.NOTRANSPOSE)},e.extrapolate=function(t,e){for(var n=0,r=1,i=0;i<e.length;i++)n+=e[i]*r,r*=t;return n},e}(),e.PolynomialFit=n}(e.operation||(e.operation={}))}(e.matrix||(e.matrix={})),function(e){var n=function(){function e(t,e){this.min=new Float64Array(t.length),this.max=new Float64Array(e.length),java.lang.System.arraycopy(t,0,this.min,0,t.length),java.lang.System.arraycopy(e,0,this.max,0,e.length)}return e.prototype.clone=function(){return new t.mwg.ml.common.structure.HRect(this.min,this.max)},e.prototype.closest=function(t){for(var e=new Float64Array(t.length),n=0;n<t.length;++n)e[n]=t[n]<=this.min[n]?this.min[n]:t[n]>=this.max[n]?this.max[n]:t[n];return e},e.infiniteHRect=function(e){for(var n=new Float64Array(e),r=new Float64Array(e),i=0;i<e;++i)n[i]=java.lang.Double.NEGATIVE_INFINITY,r[i]=java.lang.Double.POSITIVE_INFINITY;return new t.mwg.ml.common.structure.HRect(n,r)},e.prototype.intersection=function(e){for(var n=new Float64Array(this.min.length),r=new Float64Array(this.min.length),i=0;i<this.min.length;++i)if(n[i]=Math.max(this.min[i],e.min[i]),r[i]=Math.min(this.max[i],e.max[i]),n[i]>=r[i])return null;return new t.mwg.ml.common.structure.HRect(n,r)},e.prototype.area=function(){for(var t=1,e=0;e<this.min.length;++e)t*=this.max[e]-this.min[e];return t},e.prototype.toString=function(){return this.min+"\n"+this.max+"\n"},e}();e.HRect=n,n=function(e){function n(t,n,r,i){e.call(this,t,n,r,i)}return __extends(n,e),n.initFindNear=function(){var e=t.mwg.task.Actions.newTask();return e.then(function(e){var n=e.resultAsNodes().get(0);if(null!=n){var r=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_KEY),i=e.variable("dim").get(0),o=e.variable("key").get(0),s=e.variable("distance").get(0),a=e.variable("lev").get(0),l=e.variable("hr").get(0),h=e.variable("max_dist_sqd").get(0),u=a%i,s=s.measure(r,o),i=l.clone();l.max[u]=r[u],i.min[u]=r[u],o[u]<r[u]?(r=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_LEFT),u=t.mwg.ml.common.structure.KDTree.INTERNAL_LEFT,o=l,n=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_RIGHT),l=i,i=t.mwg.ml.common.structure.KDTree.INTERNAL_RIGHT):(r=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_RIGHT),o=i,u=t.mwg.ml.common.structure.KDTree.INTERNAL_RIGHT,n=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_LEFT),i=t.mwg.ml.common.structure.KDTree.INTERNAL_LEFT),e.defineVariable("further_hr",l),e.defineVariable("pivot_to_target",s),null!=r&&0!=r.size()?(e.defineVariable("near",u),e.defineVariableForSubTask("hr",o),e.defineVariableForSubTask("max_dist_sqd",h),e.defineVariableForSubTask("lev",a+1)):e.defineVariableForSubTask("near",e.newResult()),null!=n&&0!=n.size()?e.defineVariableForSubTask("far",i):e.defineVariableForSubTask("far",e.newResult())}e.continueTask()}).isolate(t.mwg.task.Actions.ifThen(function(t){return 0<t.variable("near").size()},t.mwg.task.Actions.traverse("{{near}}").isolate(e))).then(function(e){var n,r=e.variable("nnl").get(0),i=e.variable("key").get(0),o=e.variable("distance").get(0),s=e.variable("max_dist_sqd").get(0),a=e.variable("further_hr").get(0),l=e.variable("pivot_to_target").get(0),h=e.variable("lev").get(0),u=e.resultAsNodes().get(0);n=r.isCapacityReached()?r.getMaxPriority():java.lang.Double.MAX_VALUE;var c=Math.min(s,n),p=a.closest(i);o.measure(p,i)<s?(l<n&&(n=l,r.insert(u.get(t.mwg.ml.common.structure.KDTree.INTERNAL_VALUE).get(0),n),c=r.isCapacityReached()?r.getMaxPriority():java.lang.Double.MAX_VALUE),e.defineVariableForSubTask("hr",a),e.defineVariableForSubTask("max_dist_sqd",c),e.defineVariableForSubTask("lev",h+1),e.defineVariable("continueFar",!0)):e.defineVariable("continueFar",!1),e.continueTask()}).isolate(t.mwg.task.Actions.ifThen(function(t){return t.variable("continueFar").get(0)&&0<t.variable("far").size()},t.mwg.task.Actions.traverse("{{far}}").isolate(e))),e},n.prototype.setProperty=function(t,r,i){n.enforcer.check(t,r,i),e.prototype.setProperty.call(this,t,r,i)},n.prototype.getDistance=function(e){var r=e.getFromKeyWithDefault(n.DISTANCE_TYPE,n.DISTANCE_TYPE_DEF);if(r==t.mwg.ml.common.distance.DistanceEnum.EUCLIDEAN)e=new t.mwg.ml.common.distance.EuclideanDistance;else{if(r!=t.mwg.ml.common.distance.DistanceEnum.GAUSSIAN)throw Error("Unknown distance code metric");if(e=e.getFromKey(n.GAUSSIAN_PRECISION),null==e)throw Error("covariance of gaussian distances cannot be null");e=new t.mwg.ml.common.distance.GaussianDistance(e)}return e},n.prototype.insert=function(t,e,r){var i=this.unphasedState(),o=i.getFromKeyWithDefault(n.INTERNAL_DIM,t.length),s=i.getFromKeyWithDefault(n.DISTANCE_THRESHOLD,n.DISTANCE_THRESHOLD_DEF);if(t.length!=o)throw Error("Key size should always be the same");var i=this.getDistance(i),a=n.insert.prepareWith(this.graph(),this,function(t){t.free(),null!=r&&r(!0)}),l=a.newResult();l.add(t),a.setGlobalVariable("key",l),a.setGlobalVariable("value",e),a.setGlobalVariable("root",this),a.setGlobalVariable("distance",i),a.setGlobalVariable("dim",o),a.setGlobalVariable("err",s),a.defineVariable("lev",0),n.insert.executeUsing(a)},n.prototype.nearestWithinDistance=function(e,r){var i=this,o=this.unphasedState().getFromKeyWithDefault(n.DISTANCE_THRESHOLD,n.DISTANCE_THRESHOLD_DEF),s=new t.mwg.ml.common.structure.NearestNeighborList(1);this.nearestN(e,1,function(t){s.getBestDistance()<=o?(t=s.getHighest(),i.graph().lookup(i.world(),i.time(),t,function(t){r(t)})):r(null)})},n.prototype.nearestN=function(e,r,i){var o=this,s=this.unphasedState(),a=s.getFromKeyWithDefault(n.INTERNAL_DIM,e.length);if(e.length!=a)throw Error("Key size should always be the same");var l=t.mwg.ml.common.structure.HRect.infiniteHRect(e.length),h=java.lang.Double.MAX_VALUE,u=new t.mwg.ml.common.structure.NearestNeighborList(r);
r=this.getDistance(s);var s=n.nearestTask.prepareWith(this.graph(),this,function(e){var n=u.getAllNodes();e=t.mwg.task.Actions.setWorld(java.lang.String.valueOf(o.world())).setTime(java.lang.String.valueOf(o.time())).fromVar("res").foreach(t.mwg.task.Actions.lookup("{{result}}"));var r=e.prepareWith(o.graph(),null,function(t){for(var e=Array(t.size()),n=0;n<t.size();n++)e[n]=t.get(n);i(e)}),n=r.wrap(n);r.addToGlobalVariable("res",n),e.executeUsing(r)}),c=s.newResult();c.add(e),s.setGlobalVariable("key",c),s.setGlobalVariable("distance",r),s.setGlobalVariable("dim",a),s.setGlobalVariable("nnl",u),s.defineVariable("lev",0),s.defineVariable("hr",l),s.defineVariable("max_dist_sqd",h),n.nearestTask.executeUsing(s)},n.NAME="KDTree",n.INTERNAL_LEFT="_left",n.INTERNAL_RIGHT="_right",n.INTERNAL_KEY="_key",n.INTERNAL_VALUE="_value",n.NUM_NODES="_num",n.INTERNAL_DIM="_dim",n.DISTANCE_THRESHOLD="_threshold",n.DISTANCE_THRESHOLD_DEF=1e-10,n.DISTANCE_TYPE="disttype",n.DISTANCE_TYPE_DEF=0,n.GAUSSIAN_PRECISION="_precision",n.insert=t.mwg.task.Actions.whileDo(function(e){var n=e.resultAsNodes().get(0),r=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_KEY),i=e.variable("dim").get(0),o=e.variable("key").get(0),s=e.variable("value").get(0),a=e.variable("root").get(0),l=e.variable("distance").get(0),h=e.variable("err").get(0),u=e.variable("lev").get(0);return null==r?(n.setProperty(t.mwg.ml.common.structure.KDTree.INTERNAL_KEY,t.mwg.Type.DOUBLE_ARRAY,o),n.getOrCreateRel(t.mwg.ml.common.structure.KDTree.INTERNAL_VALUE).clear().add(s.id()),n.setProperty(t.mwg.ml.common.structure.KDTree.NUM_NODES,t.mwg.Type.INT,1),!1):l.measure(o,r)<h?(n.getOrCreateRel(t.mwg.ml.common.structure.KDTree.INTERNAL_VALUE).clear().add(s.id()),!1):(o[u]>r[u]?(l=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_RIGHT),r=t.mwg.ml.common.structure.KDTree.INTERNAL_RIGHT):(l=n.get(t.mwg.ml.common.structure.KDTree.INTERNAL_LEFT),r=t.mwg.ml.common.structure.KDTree.INTERNAL_LEFT),null==l||0==l.size()?(e=e.graph().newTypedNode(n.world(),n.time(),t.mwg.ml.common.structure.KDTree.NAME),e.setProperty(t.mwg.ml.common.structure.KDTree.INTERNAL_KEY,t.mwg.Type.DOUBLE_ARRAY,o),e.getOrCreateRel(t.mwg.ml.common.structure.KDTree.INTERNAL_VALUE).clear().add(s.id()),n.getOrCreateRel(r).clear().add(e.id()),a.setProperty(t.mwg.ml.common.structure.KDTree.NUM_NODES,t.mwg.Type.INT,a.get(t.mwg.ml.common.structure.KDTree.NUM_NODES)+1),e.free(),!1):(e.setGlobalVariable("next",r),e.setGlobalVariable("lev",(u+1)%i),!0))},t.mwg.task.Actions.traverse("{{next}}")),n.nearestTask=n.initFindNear(),n.enforcer=(new t.mwg.utility.Enforcer).asPositiveDouble(n.DISTANCE_THRESHOLD),n}(t.mwg.plugin.AbstractNode),e.KDTree=n,n=function(){function t(t){this.maxPriority=java.lang.Double.MAX_VALUE,this.count=0,this.capacity=t,this.data=new Float64Array(t+1),this.value=new Float64Array(t+1),this.value[0]=this.maxPriority}return t.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value[1]},t.prototype.insert=function(t,e){return this.count<this.capacity?(this.add(t,e),!0):!(e>this.getMaxPriority())&&(this.remove(),this.add(t,e),!0)},t.prototype.getAllNodes=function(){for(var t=Math.min(this.capacity,this.count),e=new Float64Array(t),n=0;n<t;++n)e[t-n-1]=this.remove();return e},t.prototype.isCapacityReached=function(){return this.count>=this.capacity},t.prototype.getHighest=function(){return this.data[1]},t.prototype.getBestDistance=function(){return this.value[1]},t.prototype.isEmpty=function(){return 0==this.count},t.prototype.getSize=function(){return this.count},t.prototype.add=function(t,e){this.count++>=this.capacity&&this.expandCapacity(),this.value[this.count]=e,this.data[this.count]=t,this.bubbleUp(this.count)},t.prototype.remove=function(){if(0==this.count)return 0;var t=this.data[1];return this.data[1]=this.data[this.count],this.value[1]=this.value[this.count],this.data[this.count]=0,this.value[this.count]=0,this.count--,this.bubbleDown(1),t},t.prototype.bubbleDown=function(t){for(var e,n=this.data[t],r=this.value[t];2*t<=this.count&&(e=2*t,e!=this.count&&this.value[e]<this.value[e+1]&&e++,r<this.value[e]);t=e)this.value[t]=this.value[e],this.data[t]=this.data[e];this.value[t]=r,this.data[t]=n},t.prototype.bubbleUp=function(t){for(var e=this.data[t],n=this.value[t];this.value[t/2]<n;)this.value[t]=this.value[t/2],this.data[t]=this.data[t/2],t/=2;this.value[t]=n,this.data[t]=e},t.prototype.expandCapacity=function(){this.capacity=2*this.count;var t=new Float64Array(this.capacity+1),e=new Float64Array(this.capacity+1);java.lang.System.arraycopy(this.data,0,t,0,this.data.length),java.lang.System.arraycopy(this.value,0,e,0,this.data.length),this.data=t,this.value=e},t}(),e.NearestNeighborList=n}(e.structure||(e.structure={}))}(e.common||(e.common={}))}(e.ml||(e.ml={}))}(t.mwg||(t.mwg={}))}(org||(org={}));var WebSocketHelper;!function(t){var e=function(){function t(t,e){void 0===e&&(e=[]),this.debug=!1,this.reconnectInterval=1e3,this.timeoutInterval=2e3,this.timedOut=this.forcedClose=!1,this.protocols=[],this.onopen=function(t){},this.onclose=function(t){},this.onconnecting=function(){},this.onmessage=function(t){},this.onerror=function(t){},this.url=t,this.protocols=e,this.readyState=WebSocket.CONNECTING}return t.prototype.connect=function(t){var e=this;this.ws=new WebSocket(this.url,this.protocols),this.ws.binaryType="arraybuffer",this.onconnecting(),this.log("ReconnectingWebSocket","attempt-connect",this.url);var n=this.ws,r=setTimeout(function(){e.log("ReconnectingWebSocket","connection-timeout",e.url),e.timedOut=!0,n.close(),e.timedOut=!1},this.timeoutInterval);this.ws.onopen=function(n){clearTimeout(r),e.log("ReconnectingWebSocket","onopen",e.url),e.readyState=WebSocket.OPEN,t=!1,e.onopen(n)},this.ws.onclose=function(n){clearTimeout(r),e.ws=null,e.forcedClose?(e.readyState=WebSocket.CLOSED,e.onclose(n)):(e.readyState=WebSocket.CONNECTING,e.onconnecting(),t||e.timedOut||(e.log("ReconnectingWebSocket","onclose",e.url),e.onclose(n)),setTimeout(function(){e.connect(!0)},e.reconnectInterval))},this.ws.onmessage=function(t){e.log("ReconnectingWebSocket","onmessage",e.url,t.data),e.onmessage(t)},this.ws.onerror=function(t){e.log("ReconnectingWebSocket","onerror",e.url,t),e.onerror(t)}},t.prototype.send=function(t){if(this.ws)return this.log("ReconnectingWebSocket","send",this.url,t),this.ws.send(t);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},t.prototype.close=function(){return!!this.ws&&(this.forcedClose=!0,this.ws.close(),!0)},t.prototype.refresh=function(){return!!this.ws&&(this.ws.close(),!0)},t.prototype.log=function(){for(var e=[],n=0;n<arguments.length;n++)e[n-0]=arguments[n];(this.debug||t.debugAll)&&console.debug.apply(console,e)},t.debugAll=!1,t}();t.ReconnectingWebSocket=e}(WebSocketHelper||(WebSocketHelper={}));var org;!function(t){!function(e){!function(e){var n=function(){function e(t){this.graph=this.ws=null,this.REQ_GET=this.generator=0,this.REQ_PUT=1,this.REQ_LOCK=2,this.REQ_UNLOCK=3,this.REQ_REMOVE=4,this.REQ_UPDATE=5,this.RESP_GET=6,this.RESP_PUT=7,this.RESP_REMOVE=8,this.RESP_LOCK=9,this.RESP_UNLOCK=10,this.url=t,this.callbacks=new java.util.HashMap}return e.prototype.connect=function(t,e){if(this.graph=t,null==this.ws){var n=this;this.ws=new WebSocketHelper.ReconnectingWebSocket(this.url),this.ws.onopen=function(t){e(!0)},this.ws.onmessage=function(t){n.process_rpc_resp(new Int8Array(t.data))},this.ws.connect(!1)}else e(!0)},e.prototype.disconnect=function(t){null!=this.ws&&(this.ws.close(),this.ws=null,t(!0))},e.prototype.get=function(t,e){this.send_rpc_req(this.REQ_GET,t,e)},e.prototype.put=function(t,e){this.send_rpc_req(this.REQ_PUT,t,e)},e.prototype.remove=function(t,e){this.send_rpc_req(this.REQ_REMOVE,t,e)},e.prototype.lock=function(t){this.send_rpc_req(this.REQ_LOCK,null,t)},e.prototype.unlock=function(t,e){this.send_rpc_req(this.REQ_UNLOCK,t,e)},e.prototype.process_rpc_resp=function(e){var n=this.graph.newBuffer();if(n.writeAll(e),e=n.iterator(),n=e.next(),null!=n&&0!=n.length()&&(n=n.read(0),n!=this.REQ_UPDATE)){var r=e.next();if(null!=r&&(r=t.mwg.utility.Base64.decodeToIntWithBounds(r,0,r.length()),r=this.callbacks.get(r),null!=r))if(n==this.RESP_GET||n==this.RESP_LOCK){for(var n=this.graph.newBuffer(),i=!0;e.hasNext();)i?i=!1:n.write(t.mwg.Constants.BUFFER_SEP),n.writeAll(e.next().data());r(n)}else r(!0)}},e.prototype.send_rpc_req=function(e,n,r){if(null==this.ws)throw Error("Not connected!");var i=this.graph.newBuffer();i.write(e),i.write(t.mwg.Constants.BUFFER_SEP),e=this.generator,this.generator+=1,this.callbacks.put(e,r),t.mwg.utility.Base64.encodeIntToBuffer(e,i),null!=n&&(i.write(t.mwg.Constants.BUFFER_SEP),i.writeAll(n.data())),n=i.data(),i.free(),this.ws.send(n)},e}();e.WSClient=n}(e.plugin||(e.plugin={}))}(t.mwg||(t.mwg={}))}(org||(org={}));
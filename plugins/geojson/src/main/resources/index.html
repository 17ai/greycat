<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.css"/>
    <script src="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.js"></script>

    <script src="flatpickr.min.js"></script>
    <link rel="stylesheet" type="text/css" href="flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="flatpickr.material_blue.min.css">

    <script src="mwg.js"></script>
    <script src="mwg.ml.js"></script>
    <script src="mwg.ws.js"></script>
</head>
<body>

<div id="mapid" style="display: block;height: 1000px; width: calc(100% - 200px);"></div>

<div style="display: block; margin: 5px; height: 100%; width: 200px; background-color: lavender; position: fixed; top: 0; right: 0;">
    <select onchange="updateContract(this.value)" style="width: 100%">
    </select>
    <input class=flatpickr data-date-format="d-m-Y" data-inline=true data-enable-time=true data-time_24hr=true style="width: 100%">
    <div id="infoPanel" style="position: absolute; bottom: 0; right: 0; width: calc(100% - 5px); height: 200px; border: 1px solid lightgray">
        <h3>&nbsp;&nbsp;INFORMATION </h3>
        <table>
            <tr>
                <td><b>Bike stands:</b></td>
                <td id="all_stands"></td>
            </tr>
            <tr>
                <td><b>Free stands:</b></td>
                <td id="free_stands"></td>
            </tr>
            <tr>
                <td><b>Available bikes:</b></td>
                <td id="available_bikes"></td>
            </tr>
        </table>

    </div>
</div>

<script>


    var graph = new org.mwg.GraphBuilder().withStorage(new org.mwg.plugin.WSClient("ws://localhost:8050")).withPlugin(new org.mwg.ml.MLPlugin()).build();
    graph.connect(function () {

        updateContract("Luxembourg");

        var optionLists = {};
        var fillOptionList = org.mwg.task.Actions.setTime((new Date()).getTime())
                        .fromIndexAll("stations")
                        .get("contract_name")
                        .foreach(org.mwg.task.Actions.then(function (context) {
                            optionLists[context.result().get(0)] = context.result().get(0);
                            context.continueTask();
                        }))
                        .then(function (context) {
                            var selector = document.querySelector("select")
                            for (var e in optionLists) {
                                var opt = document.createElement("option");
                                opt.textContent = e;
                                selector.appendChild(opt);
                            }
                        })
                ;
        fillOptionList.execute(graph, null);


    });

    document.querySelector(".flatpickr").flatpickr();


    var mymap = L.map('mapid').setView([49.632386, 6.168544], 13);
    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v9/tiles/256/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 18,
        id: 'test',
        accessToken: 'pk.eyJ1IjoiZ25haW4iLCJhIjoiY2lzbG96eWZwMDA3NzJucGtwMTd5bXh2MiJ9.tJUI9PFDrl7eENeVW9kaWw'
    }).addTo(mymap);

    var markers;
    function updateContract(contract_name) {
        if (markers != undefined) {
            mymap.removeLayer(markers);
        }
        markers = new L.FeatureGroup();
        var displayStationsTask = org.mwg.task.Actions
                .setTime((new Date()).getTime())
                .fromIndexAll("stations").selectWith("contract_name", contract_name).foreach(
                        org.mwg.task.Actions.isolate(org.mwg.task.Actions.traverse("position").asVar("pos"))
                                .then(function (context) {
                                    var marker = L.marker([context.variable("pos").get(0).get("lat"), context.variable("pos").get(0).get("lng")])
                                            .addTo(mymap)
                                            .bindPopup(context.result().get(0).get("name"));
                                    marker["node"] = context.result().get(0).id();
                                    marker.on('click', function (e) {
                                        graph.lookup(0, (new Date()).getTime(), e.target.node, function (node) {
                                            document.querySelector("#all_stands").textContent = node.get("bike_stands");
                                            document.querySelector("#free_stands").textContent = node.get("available_bike_stands");
                                            document.querySelector("#available_bikes").textContent = node.get("available_bikes");
                                        });

                                    });
                                    markers.addLayer(marker);
                                    context.continueTask();
                                })
                ).then(function (context) {
                    mymap.addLayer(markers);
                    context.continueTask();
                });
        displayStationsTask.execute(graph, null);
    }


    mymap.on('click', function (e) {
        updateNearest(e);
    });

    function updateNearest(e) {
        var askKDTree = org.mwg.task.Actions
                .setTime((new Date()).getTime())
                .fromIndexAll("positionsTree").then(function (context) {
                    var kdTree = context.result().get(0);
                    kdTree.nearestN([e.latlng.lat, e.latlng.lng], 10, function (nodes) {
                        for (var n in nodes) {
                            console.log(nodes[n].get("name"));
                        }
                        context.continueTask();
                    });
                });
        askKDTree.execute(graph, null);
    }

</script>
</body>
</html>



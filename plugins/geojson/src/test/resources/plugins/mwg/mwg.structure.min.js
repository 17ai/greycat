var __extends=this&&this.__extends||function(c,t){function u(){this.constructor=c}for(var w in t)t.hasOwnProperty(w)&&(c[w]=t[w]);c.prototype=null===t?Object.create(t):(u.prototype=t.prototype,new u)},org;
(function(c){(function(t){(function(u){var t=function(){function q(){}q.nTreeInsertTo=function(f){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeInsertTo.NAME,f)};q.nTreeNearestN=function(f){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeNearestN.NAME,f)};q.nTreeNearestWithinRadius=function(f){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeNearestWithinRadius.NAME,f)};q.nTreeNearestNWithinRadius=function(f){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeNearestNWithinRadius.NAME,
f)};return q}();u.StructureActions=t;t=function(q){function f(){q.call(this);this.declareNodeType(c.mwg.structure.tree.KDTree.NAME,function(b,a,e,d){return new c.mwg.structure.tree.KDTree(b,a,e,d)});this.declareNodeType(c.mwg.structure.tree.NDTree.NAME,function(b,a,e,d){return new c.mwg.structure.tree.NDTree(b,a,e,d)});this.declareTaskAction(c.mwg.structure.action.NTreeInsertTo.NAME,function(b){if(1!=b.length)throw Error("Bad param number!");return new c.mwg.structure.action.NTreeInsertTo(b[0])});
this.declareTaskAction(c.mwg.structure.action.TraverseById.NAME,function(b){if(1!=b.length)throw Error("Bad param number!");return new c.mwg.structure.action.TraverseById(b[0])});this.declareTaskAction(c.mwg.structure.action.NTreeNearestN.NAME,function(b){if(2>b.length)throw Error("Bad param number!");for(var a=java.lang.Integer.parseInt(b[b.length-1]),e=new Float64Array(b.length-1),d=0;d<b.length-1;d++)e[d]=parseFloat(b[d]);return new c.mwg.structure.action.NTreeNearestN(e,a)});this.declareTaskAction(c.mwg.structure.action.NTreeNearestWithinRadius.NAME,
function(b){if(2>b.length)throw Error("Bad param number!");for(var a=parseFloat(b[b.length-1]),e=new Float64Array(b.length-1),d=0;d<b.length-1;d++)e[d]=parseFloat(b[d]);return new c.mwg.structure.action.NTreeNearestWithinRadius(e,a)});this.declareTaskAction(c.mwg.structure.action.NTreeNearestNWithinRadius.NAME,function(b){if(3>b.length)throw Error("Bad param number!");for(var a=parseFloat(b[b.length-1]),e=java.lang.Integer.parseInt(b[b.length-2]),d=new Float64Array(b.length-2),m=0;m<b.length-2;m++)d[m]=
parseFloat(b[m]);return new c.mwg.structure.action.NTreeNearestNWithinRadius(d,e,a)})}__extends(f,q);return f}(c.mwg.plugin.AbstractPlugin);u.StructurePlugin=t;(function(q){var f=function(b){function a(a){b.call(this);this._variableName=a}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),m=a.variable(a.template(this._variableName));if(null!=d&&null!=m){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),g=d.next();null!=g;){if(g instanceof c.mwg.plugin.AbstractNode)for(var h=m.iterator(),
k=h.next();null!=k;)k instanceof c.mwg.structure.tree.KDTree?k.insert(g,function(a){b.count()}):b.count(),k=h.next();else b.count();g=d.next()}b.then(function(){a.continueTask()})}else a.continueTask()};a.prototype.toString=function(){return"nTreeInsertTo('"+this._variableName+"')"};a.NAME="nTreeInsertTo";return a}(c.mwg.plugin.AbstractTaskAction);q.NTreeInsertTo=f;f=function(b){function a(a,d){b.call(this);this._key=a;this._n=d}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),m=a.newResult();
if(null!=d){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),g=d.next();null!=g;)g instanceof c.mwg.structure.tree.KDTree?g.nearestN(this._key,this._n,function(a){for(var d=0;d<a.length;d++)m.add(a[d]);b.count()}):b.count(),g=d.next();b.then(function(){a.continueWith(m)})}else a.continueWith(m)};a.prototype.toString=function(){return"nTreeNearestN('')"};a.NAME="nTreeNearestN";return a}(c.mwg.plugin.AbstractTaskAction);q.NTreeNearestN=f;f=function(b){function a(a,d,m){b.call(this);this._key=
a;this._n=d;this._radius=m}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),m=a.newResult();if(null!=d){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),g=d.next();null!=g;)g instanceof c.mwg.structure.tree.KDTree?g.nearestNWithinRadius(this._key,this._n,this._radius,function(a){for(var d=0;d<a.length;d++)m.add(a[d]);b.count()}):b.count(),g=d.next();b.then(function(){a.continueWith(m)})}else a.continueWith(m)};a.prototype.toString=function(){return"nTreeNearestNWithinRadius('')"};
a.NAME="nTreeNearestNWithinRadius";return a}(c.mwg.plugin.AbstractTaskAction);q.NTreeNearestNWithinRadius=f;f=function(b){function a(a,d){b.call(this);this._key=a;this._radius=d}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),m=a.newResult();if(null!=d){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),g=d.next();null!=g;)g instanceof c.mwg.structure.tree.KDTree?g.nearestWithinRadius(this._key,this._radius,function(a){for(var d=0;d<a.length;d++)m.add(a[d]);b.count()}):b.count(),
g=d.next();b.then(function(){a.continueWith(m)})}else a.continueWith(m)};a.prototype.toString=function(){return"nTreeNearestWithinRadius('')"};a.NAME="nTreeNearestWithinRadius";return a}(c.mwg.plugin.AbstractTaskAction);q.NTreeNearestWithinRadius=f;f=function(b){function a(a){b.call(this);this._name=a}__extends(a,b);a.prototype.eval=function(a){var d=a.wrap(null),m=java.lang.Long.parseLong(a.template(this._name)),b=a.result();if(null!=b){for(var g=b.size(),h=a.graph().newCounter(g),k=function(a){var e=
b.get(a);e instanceof c.mwg.plugin.AbstractNode?e.relByIndex(m,function(a){if(null!=a)for(var m=0;m<a.length;m++)d.add(a[m]);e.free();h.count()}):(d.add(e),h.count())},n=0;n<g;n++)k(n);h.then(function(){b.clear();a.continueWith(d)})}else a.continueTask()};a.prototype.toString=function(){return"traverseById('"+this._name+"')"};a.NAME="traverseById";return a}(c.mwg.plugin.AbstractTaskAction);q.TraverseById=f})(u.action||(u.action={}));(function(q){var f=function(){function b(){}b.instance=function(){null==
b.static_instance&&(b.static_instance=new c.mwg.structure.distance.CosineDistance);return b.static_instance};b.prototype.measure=function(a,e){for(var d=0,m=0,c=0,b=0;b<a.length;b++)d+=a[b]*e[b],m+=a[b]*a[b],c+=e[b]*e[b];d/=Math.sqrt(m)*Math.sqrt(c);0>d&&(d=0);return 1-d};b.prototype.compare=function(a,e){return a<e};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};b.static_instance=null;return b}();q.CosineDistance=f;f=function(){function b(){}
b.EUCLIDEAN=0;b.GEODISTANCE=1;b.COSINE=2;return b}();q.Distances=f;f=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new c.mwg.structure.distance.EuclideanDistance);return b.static_instance};b.prototype.measure=function(a,e){for(var d=0,m=0;m<a.length;m++)d+=(a[m]-e[m])*(a[m]-e[m]);return Math.sqrt(d)};b.prototype.compare=function(a,e){return a<e};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};
b.static_instance=null;return b}();q.EuclideanDistance=f;f=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new c.mwg.structure.distance.GeoDistance);return b.static_instance};b.prototype.measure=function(a,e){var d=c.mwg.structure.distance.GeoDistance.toRadians(e[0]-a[0]),m=c.mwg.structure.distance.GeoDistance.toRadians(e[1]-a[1]),d=Math.sin(d/2)*Math.sin(d/2)+Math.cos(c.mwg.structure.distance.GeoDistance.toRadians(a[0]))*Math.cos(c.mwg.structure.distance.GeoDistance.toRadians(e[0]))*
Math.sin(m/2)*Math.sin(m/2);return 12742E3*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))};b.toRadians=function(a){return a*Math.PI/180};b.prototype.compare=function(a,e){return a<e};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};b.static_instance=null;return b}();q.GeoDistance=f;f=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new c.mwg.structure.distance.PearsonDistance);return b.static_instance};
b.prototype.measure=function(a,e){for(var d=0,m=0,b=0,c=0,h=0,k=0;k<a.length;k++)d+=a[k]*e[k],m+=a[k],c+=e[k],b+=a[k]*a[k],h+=e[k]*e[k];k=a.length;return(d-m*c/k)/Math.sqrt((b-m*m/k)*(h-c*c/k))};b.prototype.compare=function(a,e){return Math.abs(a)>Math.abs(e)};b.prototype.getMinValue=function(){return 1};b.prototype.getMaxValue=function(){return 0};b.static_instance=null;return b}();q.PearsonDistance=f})(u.distance||(u.distance={}));(function(q){var f=function(b){function a(a,d,m,c){b.call(this,a,
d,m,c)}__extends(a,b);a.initFindNear=function(){var a=c.mwg.task.Actions.newTask();a.then(function(a){var e=a.resultAsNodes().get(0);if(null!=e){var b=e.get(c.mwg.structure.tree.KDTree.KEY),g=a.variable("dim").get(0),h=a.variable("key").get(0),k=a.variable("distance").get(0),n=a.variable("lev").get(0),l=a.variable("hr").get(0),f=a.variable("max_dist_sqd").get(0),p=n%g,k=k.measure(b,h),g=l.clone();l.max[p]=b[p];g.min[p]=b[p];h[p]<b[p]?(b=e.get(c.mwg.structure.tree.KDTree.LEFT),p=c.mwg.structure.tree.KDTree.LEFT,
h=l,e=e.get(c.mwg.structure.tree.KDTree.RIGHT),l=g,g=c.mwg.structure.tree.KDTree.RIGHT):(b=e.get(c.mwg.structure.tree.KDTree.RIGHT),h=g,p=c.mwg.structure.tree.KDTree.RIGHT,e=e.get(c.mwg.structure.tree.KDTree.LEFT),g=c.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",l);a.defineVariable("pivot_to_target",k);null!=b&&0!=b.size()?(a.defineVariable("near",p),a.defineVariableForSubTask("hr",h),a.defineVariableForSubTask("max_dist_sqd",f),a.defineVariableForSubTask("lev",n+1)):a.defineVariableForSubTask("near",
a.newResult());null!=e&&0!=e.size()?a.defineVariableForSubTask("far",g):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},c.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var e=a.variable("nnl").get(0),b=a.variable("key").get(0),g=a.variable("distance").get(0),h=a.variable("max_dist_sqd").get(0),k=a.variable("further_hr").get(0),n=a.variable("pivot_to_target").get(0),l=a.variable("lev").get(0),
f=a.resultAsNodes().get(0),p;p=e.isCapacityReached()?e.getMaxPriority():java.lang.Double.MAX_VALUE;var v=Math.min(h,p),q=k.closest(b);g.measure(q,b)<h?(n<p&&(p=n,e.insert(f.get(c.mwg.structure.tree.KDTree.VALUE).get(0),p),f.get(c.mwg.structure.tree.KDTree.KEY),v=e.isCapacityReached()?e.getMaxPriority():java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",k),a.defineVariableForSubTask("max_dist_sqd",v),a.defineVariableForSubTask("lev",l+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",
!1);a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},c.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.initFindRadius=function(){var a=c.mwg.task.Actions.newTask();a.then(function(a){var e=a.resultAsNodes().get(0);if(null!=e){var b=e.get(c.mwg.structure.tree.KDTree.KEY),g=a.variable("dim").get(0),h=a.variable("key").get(0),k=a.variable("distance").get(0),n=a.variable("lev").get(0),l=a.variable("hr").get(0),
f=a.variable("max_dist_sqd").get(0),p=n%g,k=k.measure(b,h),g=l.clone();l.max[p]=b[p];g.min[p]=b[p];h[p]<b[p]?(b=e.get(c.mwg.structure.tree.KDTree.LEFT),p=c.mwg.structure.tree.KDTree.LEFT,h=l,e=e.get(c.mwg.structure.tree.KDTree.RIGHT),l=g,g=c.mwg.structure.tree.KDTree.RIGHT):(b=e.get(c.mwg.structure.tree.KDTree.RIGHT),h=g,p=c.mwg.structure.tree.KDTree.RIGHT,e=e.get(c.mwg.structure.tree.KDTree.LEFT),g=c.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",l);a.defineVariable("pivot_to_target",
k);null!=b&&0!=b.size()?(a.defineVariable("near",p),a.defineVariableForSubTask("hr",h),a.defineVariableForSubTask("max_dist_sqd",f),a.defineVariableForSubTask("lev",n+1)):a.defineVariableForSubTask("near",a.newResult());null!=e&&0!=e.size()?a.defineVariableForSubTask("far",g):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},c.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var e=
a.variable("nnl").get(0),b=a.variable("key").get(0),g=a.variable("distance").get(0),h=a.variable("radius").get(0),k=a.variable("max_dist_sqd").get(0),n=a.variable("further_hr").get(0),l=a.variable("pivot_to_target").get(0),f=a.variable("lev").get(0),p=a.resultAsNodes().get(0),v=java.lang.Double.MAX_VALUE,q=Math.min(k,v),x=n.closest(b);g.measure(x,b)<k?(l<v&&(v=l,v<=h&&e.insert(p.get(c.mwg.structure.tree.KDTree.VALUE).get(0),v),q=java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",n),a.defineVariableForSubTask("max_dist_sqd",
q),a.defineVariableForSubTask("lev",f+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",!1);a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},c.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.prototype.setProperty=function(e,d,m){a.enforcer.check(e,d,m);b.prototype.setProperty.call(this,e,d,m)};a.prototype.insert=function(a,d){var b=this;this.extractFeatures(a,function(c){b.insertWith(c,
a,d)})};a.prototype.insertWith=function(e,d,b){var c=this.unphasedState(),g=c.getFromKeyWithDefault(a.DIMENSIONS,e.length),h=c.getFromKeyWithDefault(a.DISTANCE_THRESHOLD,a.DISTANCE_THRESHOLD_DEF);if(e.length!=g)throw Error("Key size should always be the same");if(null==d)throw Error("To index node should not be null");var c=this.getDistance(c),k=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=b&&b(!0)}),n=k.newResult();n.add(e);k.setGlobalVariable("key",n);k.setGlobalVariable("value",
d);k.setGlobalVariable("root",this);k.setGlobalVariable("distance",c);k.setGlobalVariable("dim",g);k.setGlobalVariable("err",h);k.defineVariable("lev",0);a.insert.executeUsing(k)};a.prototype.size=function(){return this.graph().resolver().resolveState(this).getFromKeyWithDefault(a.SIZE,0)};a.prototype.setDistance=function(e){this.set(a.DISTANCE,e)};a.prototype.setFrom=function(e){this.set(a.FROM,e)};a.prototype.nearestNWithinRadius=function(e,d,b,r){var g=this,h=this.unphasedState(),k=h.getFromKeyWithDefault(a.DIMENSIONS,
e.length);if(e.length!=k)throw Error("Key size should always be the same");var n=c.mwg.structure.util.HRect.infiniteHRect(e.length),l=java.lang.Double.MAX_VALUE,f=new c.mwg.structure.util.NearestNeighborList(d);d=this.getDistance(h);var h=a.nearestTask.prepareWith(this.graph(),this,function(a){var e=f.getAllNodesWithin(b);a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(g.world())).setTime(java.lang.String.valueOf(g.time())).fromVar("res").foreach(c.mwg.task.Actions.lookup("{{result}}"));var d=
a.prepareWith(g.graph(),null,function(a){for(var e=Array(a.size()),d=0;d<a.size();d++)e[d]=a.get(d);r(e)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),p=h.newResult();p.add(e);h.setGlobalVariable("key",p);h.setGlobalVariable("distance",d);h.setGlobalVariable("dim",k);h.setGlobalVariable("nnl",f);h.defineVariable("lev",0);h.defineVariable("hr",n);h.defineVariable("max_dist_sqd",l);a.nearestTask.executeUsing(h)};a.prototype.nearestWithinRadius=function(e,d,b){var r=this,g=this.unphasedState(),
h=g.getFromKeyWithDefault(a.DIMENSIONS,e.length);if(e.length!=h)throw Error("Key size should always be the same");var k=c.mwg.structure.util.HRect.infiniteHRect(e.length),n=java.lang.Double.MAX_VALUE,l=new c.mwg.structure.util.NearestNeighborArrayList,g=this.getDistance(g),f=a.nearestRadiusTask.prepareWith(this.graph(),this,function(a){var e=l.getAllNodes();a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(r.world())).setTime(java.lang.String.valueOf(r.time())).fromVar("res").foreach(c.mwg.task.Actions.lookup("{{result}}"));
var d=a.prepareWith(r.graph(),null,function(a){for(var e=Array(a.size()),d=0;d<a.size();d++)e[d]=a.get(d);b(e)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),p=f.newResult();p.add(e);f.setGlobalVariable("key",p);f.setGlobalVariable("distance",g);f.setGlobalVariable("dim",h);f.setGlobalVariable("nnl",l);f.setGlobalVariable("radius",d);f.defineVariable("lev",0);f.defineVariable("hr",k);f.defineVariable("max_dist_sqd",n);a.nearestRadiusTask.executeUsing(f)};a.prototype.nearestN=function(e,
d,b){var r=this,g=this.unphasedState(),h=g.getFromKeyWithDefault(a.DIMENSIONS,e.length);if(e.length!=h)throw Error("Key size should always be the same");var k=c.mwg.structure.util.HRect.infiniteHRect(e.length),n=java.lang.Double.MAX_VALUE,l=new c.mwg.structure.util.NearestNeighborList(d);d=this.getDistance(g);var g=a.nearestTask.prepareWith(this.graph(),this,function(a){var e=l.getAllNodes();a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(r.world())).setTime(java.lang.String.valueOf(r.time())).fromVar("res").foreach(c.mwg.task.Actions.lookup("{{result}}"));
var d=a.prepareWith(r.graph(),null,function(a){for(var e=Array(a.size()),d=0;d<a.size();d++)e[d]=a.get(d);b(e)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),f=g.newResult();f.add(e);g.setGlobalVariable("key",f);g.setGlobalVariable("distance",d);g.setGlobalVariable("dim",h);g.setGlobalVariable("nnl",l);g.defineVariable("lev",0);g.defineVariable("hr",k);g.defineVariable("max_dist_sqd",n);a.nearestTask.executeUsing(g)};a.prototype.getDistance=function(e){e=e.getFromKeyWithDefault(a.DISTANCE,
a.DISTANCE_TYPE_DEF);if(e==c.mwg.structure.distance.Distances.EUCLIDEAN)e=c.mwg.structure.distance.EuclideanDistance.instance();else if(e==c.mwg.structure.distance.Distances.GEODISTANCE)e=c.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return e};a.prototype.extractFeatures=function(e,d){var m=this,r=b.prototype.get.call(this,a.FROM);if(null!=r){for(var r=r.split(","),g=Array(r.length),h=0;h<r.length;h++){var k=c.mwg.task.Actions.setWorld(""+this.world());
k.setTime(this.time()+"");k.parse(r[h].trim());g[h]=k}for(var n=new Float64Array(g.length),l=this.graph().newCounter(g.length),k=function(a){var d=c.mwg.task.Actions.newTask().emptyResult();d.add(e);(function(a){g[a].executeWith(m.graph(),d,function(e){null==e?n[a]=c.mwg.Constants.NULL_LONG:(n[a]=parseFloat(e.get(0).toString()),e.free());l.count()})})(a)},h=0;h<r.length;h++)k(h);l.then(function(){d(n)})}else d(null)};a.NAME="KDTree";a.FROM="from";a.LEFT="left";a.RIGHT="right";a.KEY="key";a.VALUE=
"value";a.SIZE="size";a.DIMENSIONS="dimensions";a.DISTANCE="distance";a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.insert=c.mwg.task.Actions.whileDo(function(a){var d=a.resultAsNodes().get(0),b=d.get(c.mwg.structure.tree.KDTree.KEY),r=a.variable("dim").get(0),g=a.variable("key").get(0),h=a.variable("value").get(0),k=a.variable("root").get(0),n=a.variable("distance").get(0),l=a.variable("err").get(0),f=a.variable("lev").get(0);if(null==b)return d.setProperty(c.mwg.structure.tree.KDTree.DIMENSIONS,
c.mwg.Type.INT,r),d.setProperty(c.mwg.structure.tree.KDTree.KEY,c.mwg.Type.DOUBLE_ARRAY,g),d.getOrCreateRel(c.mwg.structure.tree.KDTree.VALUE).clear().add(h.id()),d.setProperty(c.mwg.structure.tree.KDTree.SIZE,c.mwg.Type.INT,1),!1;if(n.measure(g,b)<l)return d.getOrCreateRel(c.mwg.structure.tree.KDTree.VALUE).clear().add(h.id()),!1;g[f]>b[f]?(n=d.get(c.mwg.structure.tree.KDTree.RIGHT),b=c.mwg.structure.tree.KDTree.RIGHT):(n=d.get(c.mwg.structure.tree.KDTree.LEFT),b=c.mwg.structure.tree.KDTree.LEFT);
if(null==n||0==n.size())return a=a.graph().newTypedNode(d.world(),d.time(),c.mwg.structure.tree.KDTree.NAME),a.setProperty(c.mwg.structure.tree.KDTree.KEY,c.mwg.Type.DOUBLE_ARRAY,g),a.getOrCreateRel(c.mwg.structure.tree.KDTree.VALUE).clear().add(h.id()),d.getOrCreateRel(b).clear().add(a.id()),k.setProperty(c.mwg.structure.tree.KDTree.SIZE,c.mwg.Type.INT,k.get(c.mwg.structure.tree.KDTree.SIZE)+1),a.free(),!1;a.setGlobalVariable("next",b);a.setGlobalVariable("lev",(f+1)%r);return!0},c.mwg.task.Actions.traverse("{{next}}"));
a.nearestTask=a.initFindNear();a.nearestRadiusTask=a.initFindRadius();a.enforcer=(new c.mwg.utility.Enforcer).asPositiveDouble(a.DISTANCE_THRESHOLD);return a}(c.mwg.plugin.AbstractNode);q.KDTree=f;f=function(b){function a(a,d,c,r){b.call(this,a,d,c,r)}__extends(a,b);a.prototype.setUpdateStat=function(e){this.unphasedState().set(a._STAT,c.mwg.Type.BOOL,e)};a.updateGaussian=function(e,d){var b=0,r=e.get(a._TOTAL);null!=r&&(b=r);if(0==b)e.set(a._TOTAL,c.mwg.Type.INT,1),e.set(a._SUM,c.mwg.Type.DOUBLE_ARRAY,
d);else{var r=d.length,g,h;if(1==b){g=e.get(a._SUM);h=new Float64Array(r*(r+1)/2);for(var k=0,f=0;f<r;f++)for(var l=f;l<r;l++)h[k]=g[f]*g[l],k++}else g=e.get(a._SUM),h=e.get(a._SUMSQ);for(f=0;f<r;f++)g[f]+=d[f];for(f=k=0;f<r;f++)for(l=f;l<r;l++)h[k]+=d[f]*d[l],k++;b++;e.set(a._TOTAL,c.mwg.Type.INT,b);e.set(a._SUM,c.mwg.Type.DOUBLE_ARRAY,g);e.set(a._SUMSQ,c.mwg.Type.DOUBLE_ARRAY,h)}};a.prototype.getTotal=function(){var e=b.prototype.getByIndex.call(this,a._TOTAL);return null==e?0:e};a.prototype.getAvg=
function(){var e=this.getTotal();if(0==e)return null;if(1==e)return b.prototype.getByIndex.call(this,a._SUM);for(var d=b.prototype.getByIndex.call(this,a._SUM),c=0;c<d.length;c++)d[c]/=e;return d};a.prototype.getCovarianceArray=function(e,d){if(null==e){var c=new Float64Array(d.length);java.lang.System.arraycopy(d,0,c,0,d.length);return c}null==d&&(d=new Float64Array(e.length));var c=e.length,f=this.getTotal();if(0==f)return null;if(1<f){var g=new Float64Array(c),h=b.prototype.getByIndex.call(this,
a._SUMSQ),k;k=f/(f-1);for(var n=0,l=0;l<c;l++)g[l]=(h[n]/f-e[l]*e[l])*k,g[l]<d[l]&&(g[l]=d[l]),n+=c-l;return g}c=new Float64Array(d.length);java.lang.System.arraycopy(d,0,c,0,d.length);return c};a.getRelationId=function(a,d){for(var b=Long.UZERO,f=0;f<a.length;f++)0!=f&&(b=b.shiftLeft(1)),d[f]>a[f]&&(b=b.add(Long.ONE));return b.add(Long.fromNumber(c.mwg.structure.tree.NDTree._RELCONST,!0)).toNumber()};a.binaryFromLong=function(e,d){for(var b=e-a._RELCONST,c=b>>1,g=[],f=0;f<d;f++)g[d-f-1]=1==b-(c<<
1),b=c,c=b>>1;return g};a.prototype.setProperty=function(e,d,m){e===a.BOUNDMIN?(e=this.unphasedState(),e.set(a._BOUNDMIN,c.mwg.Type.DOUBLE_ARRAY,m)):e===a.BOUNDMAX?(e=this.unphasedState(),e.set(a._BOUNDMAX,c.mwg.Type.DOUBLE_ARRAY,m)):e===a.PRECISION?(e=this.unphasedState(),e.set(a._PRECISION,c.mwg.Type.DOUBLE_ARRAY,m)):b.prototype.setProperty.call(this,e,d,m)};a.prototype.insert=function(e,d,b){var f=this.unphasedState(),g=f.get(a._PRECISION);null==f.get(a._DIM)&&f.set(a._DIM,c.mwg.Type.INT,e.length);
var h=f.getWithDefault(a._DIM,e.length);if(e.length!=h)throw Error("Key size should always be the same");var h=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=b&&b(!0)}),k=h.newResult();k.add(e);h.setGlobalVariable("key",k);null!=d&&h.setGlobalVariable("value",d);e=f.getWithDefault(a._STAT,a.STAT_DEF);h.setGlobalVariable("updatestat",e);h.setGlobalVariable("root",this);e=h.newResult();e.add(g);h.setGlobalVariable("precision",e);a.insert.executeUsing(h)};a.prototype.nearestN=function(e,
d,b){var f=this,g=this.unphasedState().get(a._DIM);if(null==g)b(null);else{if(e.length!=g)throw Error("Key size should always be the same");var h=new c.mwg.structure.util.NearestNeighborList(d);d=c.mwg.structure.distance.EuclideanDistance.instance();var k=a.nearestTask.prepareWith(this.graph(),this,function(a){var e=h.getAllNodes();a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(f.world())).setTime(java.lang.String.valueOf(f.time())).fromVar("res").foreach(c.mwg.task.Actions.lookup("{{result}}"));
var d=a.prepareWith(f.graph(),null,function(a){a=Array(a.size());b(a)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),n=k.newResult();n.add(e);k.setGlobalVariable("key",n);k.setGlobalVariable("distance",d);k.setGlobalVariable("dim",g);k.defineVariable("lev",0);a.nearestTask.executeUsing(k)}};a.convertToDistance=function(a,d,b,f,g,h,k){for(var n=new Float64Array(b.length),l,q=c.mwg.structure.tree.NDTree.binaryFromLong(a,b.length),p=0;p<n.length;p++)q[p]?(a=g[p]-Math.max(g[p]-b[p],
h[p]),l=g[p]):(a=f[p],l=Math.max(b[p]-f[p],h[p])+f[p]),n[p]=(a+l)/2;return k.measure(n,d)};a.prototype.getNumNodes=function(){return null!=this.getByIndex(a._NUMNODES)?this.getByIndex(a._NUMNODES):1};a.NAME="NDTree";a._STAT=0;a._TOTAL=1;a._SUM=2;a._SUMSQ=3;a._BOUNDMIN=6;a._BOUNDMAX=7;a._VALUES=8;a._PRECISION=9;a._NUMNODES=10;a._DIM=11;a.STAT_DEF=!1;a.BOUNDMIN="boundmin";a.BOUNDMAX="boundmax";a.PRECISION="precision";a._RELCONST=16;a.insert=c.mwg.task.Actions.whileDo(function(a){for(var b=a.variable("root").get(0),
m=a.resultAsNodes().get(0),f=m.graph().resolver().resolveState(m),g=a.variable("updatestat").get(0),h=f.get(c.mwg.structure.tree.NDTree._BOUNDMAX),k=f.get(c.mwg.structure.tree.NDTree._BOUNDMIN),n=new Float64Array(h.length),l=0;l<n.length;l++)n[l]=(h[l]+k[l])/2;var q=a.variable("key").get(0),p=a.variable("precision").get(0),v=q.length;g&&c.mwg.structure.tree.NDTree.updateGaussian(f,q);g=!1;for(l=0;l<v;l++)if(h[l]-k[l]>p[l]){g=!0;break}if(g){var t=c.mwg.structure.tree.NDTree.getRelationId(n,q);if(null==
f.get(t)){for(var u=new Float64Array(v),v=new Float64Array(v),l=0;l<n.length;l++)q[l]<=n[l]?(u[l]=k[l],v[l]=Math.max(n[l]-k[l],p[l])+k[l]):(u[l]=h[l]-Math.max(h[l]-n[l],p[l]),v[l]=h[l]);m=m.graph().newTypedNode(m.world(),m.time(),c.mwg.structure.tree.NDTree.NAME);h=m.graph().resolver().resolveState(m);h.set(c.mwg.structure.tree.NDTree._BOUNDMIN,c.mwg.Type.DOUBLE_ARRAY,u);h.set(c.mwg.structure.tree.NDTree._BOUNDMAX,c.mwg.Type.DOUBLE_ARRAY,v);f.getOrCreate(t,c.mwg.Type.RELATION).add(m.id());m.free();
null!=b.getByIndex(c.mwg.structure.tree.NDTree._NUMNODES)?(f=b.getByIndex(c.mwg.structure.tree.NDTree._NUMNODES),f++,b.setPropertyByIndex(c.mwg.structure.tree.NDTree._NUMNODES,c.mwg.Type.INT,f)):b.setPropertyByIndex(c.mwg.structure.tree.NDTree._NUMNODES,c.mwg.Type.INT,2)}a.setVariable("next",t)}else a=a.variable("value").get(0),f.getOrCreate(c.mwg.structure.tree.NDTree._VALUES,c.mwg.Type.RELATION).add(a.id());return g},c.mwg.task.Actions.action(c.mwg.structure.action.TraverseById.NAME,"{{next}}"));
a.nearestTask=c.mwg.task.Actions.then(function(a){for(var b=a.result().get(0),f=b.graph().resolver().resolveState(b),b=f.get(c.mwg.structure.tree.NDTree._BOUNDMAX),q=f.get(c.mwg.structure.tree.NDTree._BOUNDMIN),f=new Float64Array(b.length),g=0;g<f.length;g++)f[g]=(b[g]+q[g])/2;b=a.variable("key").get(0);b=a.variable("distance").get(0).measure(b,f);a.setVariable("parentdistance",b);a.continueTask()}).asVar("parent").print("{{result}}").propertiesWithTypes(c.mwg.Type.RELATION).foreach(c.mwg.task.Actions.ifThen(function(a){return!0},
c.mwg.task.Actions.print("{{result}}")));return a}(c.mwg.plugin.AbstractNode);q.NDTree=f})(u.tree||(u.tree={}));(function(q){var f=function(){function b(a,b){this.min=new Float64Array(a.length);this.max=new Float64Array(b.length);java.lang.System.arraycopy(a,0,this.min,0,a.length);java.lang.System.arraycopy(b,0,this.max,0,b.length)}b.prototype.clone=function(){return new c.mwg.structure.util.HRect(this.min,this.max)};b.prototype.closest=function(a){for(var b=new Float64Array(a.length),d=0;d<a.length;++d)b[d]=
a[d]<=this.min[d]?this.min[d]:a[d]>=this.max[d]?this.max[d]:a[d];return b};b.infiniteHRect=function(a){for(var b=new Float64Array(a),d=new Float64Array(a),f=0;f<a;++f)b[f]=java.lang.Double.NEGATIVE_INFINITY,d[f]=java.lang.Double.POSITIVE_INFINITY;return new c.mwg.structure.util.HRect(b,d)};b.prototype.intersection=function(a){for(var b=new Float64Array(this.min.length),d=new Float64Array(this.min.length),f=0;f<this.min.length;++f)if(b[f]=Math.max(this.min[f],a.min[f]),d[f]=Math.min(this.max[f],a.max[f]),
b[f]>=d[f])return null;return new c.mwg.structure.util.HRect(b,d)};b.prototype.area=function(){for(var a=1,b=0;b<this.min.length;++b)a*=this.max[b]-this.min[b];return a};b.prototype.toString=function(){return this.min+"\n"+this.max+"\n"};return b}();q.HRect=f;f=function(){return function(){}}();q.NDResult=f;f=function(){function b(){this.maxPriority=java.lang.Double.MAX_VALUE;this.count=0;this.data=new java.util.ArrayList;this.value=new java.util.ArrayList;this.value.add(this.maxPriority);this.data.add(-1)}
b.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value.get(1)};b.prototype.insert=function(a,b){this.count++;this.value.add(b);this.data.add(a);this.bubbleUp(this.count);return!0};b.prototype.getAllNodes=function(){for(var a=this.count,b=new Float64Array(this.count),d=0;d<a;++d)b[a-d-1]=this.remove();return b};b.prototype.getHighest=function(){return this.data.get(1)};b.prototype.getBestDistance=function(){return this.value.get(1)};b.prototype.isEmpty=
function(){return 0==this.count};b.prototype.getSize=function(){return this.count};b.prototype.remove=function(){if(0==this.count)return 0;var a=this.data.get(1);this.data.set(1,this.data.get(this.count));this.value.set(1,this.value.get(this.count));this.data.set(this.count,0);this.value.set(this.count,0);this.count--;this.bubbleDown(1);return a};b.prototype.bubbleDown=function(a){for(var b=this.data.get(a),d=this.value.get(a),c;2*a<=this.count;a=c)if(c=2*a,c!=this.count&&this.value.get(c)<this.value.get(c+
1)&&c++,d<this.value.get(c))this.value.set(a,this.value.get(c)),this.data.set(a,this.data.get(c));else break;this.value.set(a,d);this.data.set(a,b)};b.prototype.bubbleUp=function(a){for(var b=this.data.get(a),d=this.value.get(a),c=Math.floor(a/2);this.value.get(c)<d;)this.value.set(a,this.value.get(c)),this.data.set(a,this.data.get(c)),a=Math.floor(a/2),c=Math.floor(a/2);this.value.set(a,d);this.data.set(a,b)};return b}();q.NearestNeighborArrayList=f;f=function(){function b(a){this.maxPriority=java.lang.Double.MAX_VALUE;
this.count=0;this.capacity=a;this.data=new Float64Array(a+1);this.value=new Float64Array(a+1);this.value[0]=this.maxPriority}b.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value[1]};b.prototype.insert=function(a,b){if(this.count<this.capacity)return this.add(a,b),!0;if(b>this.getMaxPriority())return!1;this.remove();this.add(a,b);return!0};b.prototype.print=function(){console.log(" ");console.log("keys: ");for(var a=0;a<this.data.length;a++)console.log(this.data[a]);
console.log(" ");console.log("dist: ");for(a=0;a<this.value.length;a++)console.log(this.value[a]);console.log(" ")};b.prototype.getAllNodes=function(){for(var a=Math.min(this.capacity,this.count),b=new Float64Array(a),d=0;d<a;++d)b[a-d-1]=this.remove();return b};b.prototype.isCapacityReached=function(){return this.count>=this.capacity};b.prototype.getHighest=function(){return this.data[1]};b.prototype.getWorstDistance=function(){return this.value[1]};b.prototype.isEmpty=function(){return 0==this.count};
b.prototype.getSize=function(){return this.count};b.prototype.add=function(a,b){this.count++>=this.capacity&&this.expandCapacity();this.value[this.count]=b;this.data[this.count]=a;this.bubbleUp(this.count)};b.prototype.remove=function(){if(0==this.count)return 0;var a=this.data[1];this.data[1]=this.data[this.count];this.value[1]=this.value[this.count];this.data[this.count]=0;this.value[this.count]=0;this.count--;this.bubbleDown(1);return a};b.prototype.bubbleDown=function(a){for(var b=this.data[a],
d=this.value[a],c;2*a<=this.count;a=c)if(c=2*a,c!=this.count&&this.value[c]<this.value[c+1]&&c++,d<this.value[c])this.value[a]=this.value[c],this.data[a]=this.data[c];else break;this.value[a]=d;this.data[a]=b};b.prototype.bubbleUp=function(a){for(var b=this.data[a],d=this.value[a],c=Math.floor(a/2);this.value[c]<d;)this.value[a]=this.value[c],this.data[a]=this.data[c],a=Math.floor(a/2),c=Math.floor(a/2);this.value[a]=d;this.data[a]=b};b.prototype.expandCapacity=function(){this.capacity=2*this.count;
var a=new Float64Array(this.capacity+1),b=new Float64Array(this.capacity+1);java.lang.System.arraycopy(this.data,0,a,0,this.data.length);java.lang.System.arraycopy(this.value,0,b,0,this.data.length);this.data=a;this.value=b};b.prototype.getAllNodesWithin=function(a){for(var b=Math.min(this.capacity,this.count),c=new Float64Array(b),f=0,q=0;q<b;++q)this.getMaxPriority()<=a?(c[b-f-1]=this.remove(),f++):this.remove();a=new Float64Array(f);java.lang.System.arraycopy(c,b-f,a,0,f);return a};return b}();
q.NearestNeighborList=f})(u.util||(u.util={}))})(t.structure||(t.structure={}))})(c.mwg||(c.mwg={}))})(org||(org={}));

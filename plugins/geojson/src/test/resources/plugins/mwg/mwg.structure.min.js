var __extends=this&&this.__extends||function(c,u){function v(){this.constructor=c}for(var w in u)u.hasOwnProperty(w)&&(c[w]=u[w]);c.prototype=null===u?Object.create(u):(v.prototype=u.prototype,new v)},org;
(function(c){(function(u){(function(v){var u=function(){function r(){}r.nTreeInsertTo=function(n){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeInsertTo.NAME,n)};r.nTreeNearestN=function(n){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeNearestN.NAME,n)};r.nTreeNearestWithinRadius=function(n){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeNearestWithinRadius.NAME,n)};r.nTreeNearestNWithinRadius=function(n){return c.mwg.task.Actions.newTask().action(c.mwg.structure.action.NTreeNearestNWithinRadius.NAME,
n)};return r}();v.StructureActions=u;u=function(r){function n(){r.call(this);this.declareNodeType(c.mwg.structure.tree.KDTree.NAME,function(b,a,e,d){return new c.mwg.structure.tree.KDTree(b,a,e,d)});this.declareNodeType(c.mwg.structure.tree.NDTree.NAME,function(b,a,e,d){return new c.mwg.structure.tree.NDTree(b,a,e,d)});this.declareTaskAction(c.mwg.structure.action.NTreeInsertTo.NAME,function(b){if(1!=b.length)throw Error("Bad param number!");return new c.mwg.structure.action.NTreeInsertTo(b[0])});
this.declareTaskAction(c.mwg.structure.action.TraverseById.NAME,function(b){if(1!=b.length)throw Error("Bad param number!");return new c.mwg.structure.action.TraverseById(b[0])});this.declareTaskAction(c.mwg.structure.action.NTreeNearestN.NAME,function(b){if(2>b.length)throw Error("Bad param number!");for(var a=java.lang.Integer.parseInt(b[b.length-1]),e=new Float64Array(b.length-1),d=0;d<b.length-1;d++)e[d]=parseFloat(b[d]);return new c.mwg.structure.action.NTreeNearestN(e,a)});this.declareTaskAction(c.mwg.structure.action.NTreeNearestWithinRadius.NAME,
function(b){if(2>b.length)throw Error("Bad param number!");for(var a=parseFloat(b[b.length-1]),e=new Float64Array(b.length-1),d=0;d<b.length-1;d++)e[d]=parseFloat(b[d]);return new c.mwg.structure.action.NTreeNearestWithinRadius(e,a)});this.declareTaskAction(c.mwg.structure.action.NTreeNearestNWithinRadius.NAME,function(b){if(3>b.length)throw Error("Bad param number!");for(var a=parseFloat(b[b.length-1]),e=java.lang.Integer.parseInt(b[b.length-2]),d=new Float64Array(b.length-2),l=0;l<b.length-2;l++)d[l]=
parseFloat(b[l]);return new c.mwg.structure.action.NTreeNearestNWithinRadius(d,e,a)})}__extends(n,r);return n}(c.mwg.plugin.AbstractPlugin);v.StructurePlugin=u;(function(r){var n=function(b){function a(a){b.call(this);this._variableName=a}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),l=a.variable(a.template(this._variableName));if(null!=d&&null!=l){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),f=d.next();null!=f;){if(f instanceof c.mwg.plugin.AbstractNode)for(var g=l.iterator(),
h=g.next();null!=h;)h instanceof c.mwg.structure.tree.KDTree?h.insert(f,function(a){b.count()}):b.count(),h=g.next();else b.count();f=d.next()}b.then(function(){a.continueTask()})}else a.continueTask()};a.prototype.toString=function(){return"nTreeInsertTo('"+this._variableName+"')"};a.NAME="nTreeInsertTo";return a}(c.mwg.plugin.AbstractTaskAction);r.NTreeInsertTo=n;n=function(b){function a(a,d){b.call(this);this._key=a;this._n=d}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),l=a.newResult();
if(null!=d){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),f=d.next();null!=f;)f instanceof c.mwg.structure.tree.KDTree?f.nearestN(this._key,this._n,function(a){for(var d=0;d<a.length;d++)l.add(a[d]);b.count()}):b.count(),f=d.next();b.then(function(){a.continueWith(l)})}else a.continueWith(l)};a.prototype.toString=function(){return"nTreeNearestN('')"};a.NAME="nTreeNearestN";return a}(c.mwg.plugin.AbstractTaskAction);r.NTreeNearestN=n;n=function(b){function a(a,d,l){b.call(this);this._key=
a;this._n=d;this._radius=l}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),l=a.newResult();if(null!=d){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),f=d.next();null!=f;)f instanceof c.mwg.structure.tree.KDTree?f.nearestNWithinRadius(this._key,this._n,this._radius,function(a){for(var d=0;d<a.length;d++)l.add(a[d]);b.count()}):b.count(),f=d.next();b.then(function(){a.continueWith(l)})}else a.continueWith(l)};a.prototype.toString=function(){return"nTreeNearestNWithinRadius('')"};
a.NAME="nTreeNearestNWithinRadius";return a}(c.mwg.plugin.AbstractTaskAction);r.NTreeNearestNWithinRadius=n;n=function(b){function a(a,d){b.call(this);this._key=a;this._radius=d}__extends(a,b);a.prototype.eval=function(a){var d=a.result(),l=a.newResult();if(null!=d){for(var b=a.graph().newCounter(d.size()),d=d.iterator(),f=d.next();null!=f;)f instanceof c.mwg.structure.tree.KDTree?f.nearestWithinRadius(this._key,this._radius,function(a){for(var d=0;d<a.length;d++)l.add(a[d]);b.count()}):b.count(),
f=d.next();b.then(function(){a.continueWith(l)})}else a.continueWith(l)};a.prototype.toString=function(){return"nTreeNearestWithinRadius('')"};a.NAME="nTreeNearestWithinRadius";return a}(c.mwg.plugin.AbstractTaskAction);r.NTreeNearestWithinRadius=n;n=function(b){function a(a){b.call(this);this._name=a}__extends(a,b);a.prototype.eval=function(a){var d=a.wrap(null),l=java.lang.Long.parseLong(a.template(this._name)),b=a.result();if(null!=b){for(var f=b.size(),g=a.graph().newCounter(f),h=function(a){var e=
b.get(a);e instanceof c.mwg.plugin.AbstractNode?e.relByIndex(l,function(a){if(null!=a)for(var l=0;l<a.length;l++)d.add(a[l]);e.free();g.count()}):(d.add(e),g.count())},p=0;p<f;p++)h(p);g.then(function(){b.clear();a.continueWith(d)})}else a.continueTask()};a.prototype.toString=function(){return"traverseById('"+this._name+"')"};a.NAME="traverseById";return a}(c.mwg.plugin.AbstractTaskAction);r.TraverseById=n})(v.action||(v.action={}));(function(r){var n=function(){function b(){}b.instance=function(){null==
b.static_instance&&(b.static_instance=new c.mwg.structure.distance.CosineDistance);return b.static_instance};b.prototype.measure=function(a,e){for(var d=0,l=0,c=0,b=0;b<a.length;b++)d+=a[b]*e[b],l+=a[b]*a[b],c+=e[b]*e[b];d/=Math.sqrt(l)*Math.sqrt(c);0>d&&(d=0);return 1-d};b.prototype.compare=function(a,e){return a<e};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};b.static_instance=null;return b}();r.CosineDistance=n;n=function(){function b(){}
b.EUCLIDEAN=0;b.GEODISTANCE=1;b.COSINE=2;return b}();r.Distances=n;n=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new c.mwg.structure.distance.EuclideanDistance);return b.static_instance};b.prototype.measure=function(a,e){for(var d=0,l=0;l<a.length;l++)d+=(a[l]-e[l])*(a[l]-e[l]);return Math.sqrt(d)};b.prototype.compare=function(a,e){return a<e};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};
b.static_instance=null;return b}();r.EuclideanDistance=n;n=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new c.mwg.structure.distance.GeoDistance);return b.static_instance};b.prototype.measure=function(a,e){var d=c.mwg.structure.distance.GeoDistance.toRadians(e[0]-a[0]),l=c.mwg.structure.distance.GeoDistance.toRadians(e[1]-a[1]),d=Math.sin(d/2)*Math.sin(d/2)+Math.cos(c.mwg.structure.distance.GeoDistance.toRadians(a[0]))*Math.cos(c.mwg.structure.distance.GeoDistance.toRadians(e[0]))*
Math.sin(l/2)*Math.sin(l/2);return 12742E3*Math.atan2(Math.sqrt(d),Math.sqrt(1-d))};b.toRadians=function(a){return a*Math.PI/180};b.prototype.compare=function(a,e){return a<e};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};b.static_instance=null;return b}();r.GeoDistance=n;n=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new c.mwg.structure.distance.PearsonDistance);return b.static_instance};
b.prototype.measure=function(a,e){for(var d=0,l=0,b=0,c=0,g=0,h=0;h<a.length;h++)d+=a[h]*e[h],l+=a[h],c+=e[h],b+=a[h]*a[h],g+=e[h]*e[h];h=a.length;return(d-l*c/h)/Math.sqrt((b-l*l/h)*(g-c*c/h))};b.prototype.compare=function(a,e){return Math.abs(a)>Math.abs(e)};b.prototype.getMinValue=function(){return 1};b.prototype.getMaxValue=function(){return 0};b.static_instance=null;return b}();r.PearsonDistance=n})(v.distance||(v.distance={}));(function(r){var n=function(b){function a(a,d,l,c){b.call(this,a,
d,l,c)}__extends(a,b);a.initFindNear=function(){var a=c.mwg.task.Actions.newTask();a.then(function(a){var e=a.resultAsNodes().get(0);if(null!=e){var b=e.get(c.mwg.structure.tree.KDTree.KEY),f=a.variable("dim").get(0),g=a.variable("key").get(0),h=a.variable("distance").get(0),p=a.variable("lev").get(0),k=a.variable("hr").get(0),t=a.variable("max_dist_sqd").get(0),q=p%f,h=h.measure(b,g),f=k.clone();k.max[q]=b[q];f.min[q]=b[q];g[q]<b[q]?(b=e.get(c.mwg.structure.tree.KDTree.LEFT),q=c.mwg.structure.tree.KDTree.LEFT,
g=k,e=e.get(c.mwg.structure.tree.KDTree.RIGHT),k=f,f=c.mwg.structure.tree.KDTree.RIGHT):(b=e.get(c.mwg.structure.tree.KDTree.RIGHT),g=f,q=c.mwg.structure.tree.KDTree.RIGHT,e=e.get(c.mwg.structure.tree.KDTree.LEFT),f=c.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",k);a.defineVariable("pivot_to_target",h);null!=b&&0!=b.size()?(a.defineVariable("near",q),a.defineVariableForSubTask("hr",g),a.defineVariableForSubTask("max_dist_sqd",t),a.defineVariableForSubTask("lev",p+1)):a.defineVariableForSubTask("near",
a.newResult());null!=e&&0!=e.size()?a.defineVariableForSubTask("far",f):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},c.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var e=a.variable("nnl").get(0),b=a.variable("key").get(0),f=a.variable("distance").get(0),g=a.variable("max_dist_sqd").get(0),h=a.variable("further_hr").get(0),p=a.variable("pivot_to_target").get(0),k=a.variable("lev").get(0),
t=a.resultAsNodes().get(0),q;q=e.isCapacityReached()?e.getMaxPriority():java.lang.Double.MAX_VALUE;var n=Math.min(g,q),r=h.closest(b);f.measure(r,b)<g?(p<q&&(q=p,e.insert(t.get(c.mwg.structure.tree.KDTree.VALUE).get(0),q),t.get(c.mwg.structure.tree.KDTree.KEY),n=e.isCapacityReached()?e.getMaxPriority():java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",h),a.defineVariableForSubTask("max_dist_sqd",n),a.defineVariableForSubTask("lev",k+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",
!1);a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},c.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.initFindRadius=function(){var a=c.mwg.task.Actions.newTask();a.then(function(a){var e=a.resultAsNodes().get(0);if(null!=e){var b=e.get(c.mwg.structure.tree.KDTree.KEY),f=a.variable("dim").get(0),g=a.variable("key").get(0),h=a.variable("distance").get(0),p=a.variable("lev").get(0),k=a.variable("hr").get(0),
t=a.variable("max_dist_sqd").get(0),q=p%f,h=h.measure(b,g),f=k.clone();k.max[q]=b[q];f.min[q]=b[q];g[q]<b[q]?(b=e.get(c.mwg.structure.tree.KDTree.LEFT),q=c.mwg.structure.tree.KDTree.LEFT,g=k,e=e.get(c.mwg.structure.tree.KDTree.RIGHT),k=f,f=c.mwg.structure.tree.KDTree.RIGHT):(b=e.get(c.mwg.structure.tree.KDTree.RIGHT),g=f,q=c.mwg.structure.tree.KDTree.RIGHT,e=e.get(c.mwg.structure.tree.KDTree.LEFT),f=c.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",k);a.defineVariable("pivot_to_target",
h);null!=b&&0!=b.size()?(a.defineVariable("near",q),a.defineVariableForSubTask("hr",g),a.defineVariableForSubTask("max_dist_sqd",t),a.defineVariableForSubTask("lev",p+1)):a.defineVariableForSubTask("near",a.newResult());null!=e&&0!=e.size()?a.defineVariableForSubTask("far",f):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},c.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var e=
a.variable("nnl").get(0),b=a.variable("key").get(0),f=a.variable("distance").get(0),g=a.variable("radius").get(0),h=a.variable("max_dist_sqd").get(0),p=a.variable("further_hr").get(0),k=a.variable("pivot_to_target").get(0),t=a.variable("lev").get(0),q=a.resultAsNodes().get(0),n=java.lang.Double.MAX_VALUE,r=Math.min(h,n),x=p.closest(b);f.measure(x,b)<h?(k<n&&(n=k,n<=g&&e.insert(q.get(c.mwg.structure.tree.KDTree.VALUE).get(0),n),r=java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",p),a.defineVariableForSubTask("max_dist_sqd",
r),a.defineVariableForSubTask("lev",t+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",!1);a.continueTask()}).isolate(c.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},c.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.prototype.setProperty=function(e,d,l){a.enforcer.check(e,d,l);b.prototype.setProperty.call(this,e,d,l)};a.prototype.insert=function(a,d){var b=this;this.extractFeatures(a,function(c){b.insertWith(c,
a,d)})};a.prototype.insertWith=function(e,d,b){var c=this.unphasedState(),f=c.getFromKeyWithDefault(a.DIMENSIONS,e.length),g=c.getFromKeyWithDefault(a.DISTANCE_THRESHOLD,a.DISTANCE_THRESHOLD_DEF);if(e.length!=f)throw Error("Key size should always be the same");if(null==d)throw Error("To index node should not be null");var c=this.getDistance(c),h=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=b&&b(!0)}),p=h.newResult();p.add(e);h.setGlobalVariable("key",p);h.setGlobalVariable("value",
d);h.setGlobalVariable("root",this);h.setGlobalVariable("distance",c);h.setGlobalVariable("dim",f);h.setGlobalVariable("err",g);h.defineVariable("lev",0);a.insert.executeUsing(h)};a.prototype.size=function(){return this.graph().resolver().resolveState(this).getFromKeyWithDefault(a.SIZE,0)};a.prototype.setDistance=function(e){this.set(a.DISTANCE,e)};a.prototype.setFrom=function(e){this.set(a.FROM,e)};a.prototype.nearestNWithinRadius=function(e,d,b,m){var f=this,g=this.unphasedState(),h=g.getFromKeyWithDefault(a.DIMENSIONS,
e.length);if(e.length!=h)throw Error("Key size should always be the same");var p=c.mwg.structure.util.HRect.infiniteHRect(e.length),k=java.lang.Double.MAX_VALUE,t=new c.mwg.structure.util.NearestNeighborList(d);d=this.getDistance(g);var g=a.nearestTask.prepareWith(this.graph(),this,function(a){var e=t.getAllNodesWithin(b);a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(f.world())).setTime(java.lang.String.valueOf(f.time())).fromVar("res").flatmap(c.mwg.task.Actions.lookup("{{result}}"));var d=
a.prepareWith(f.graph(),null,function(a){for(var e=Array(a.size()),d=0;d<a.size();d++)e[d]=a.get(d);m(e)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),q=g.newResult();q.add(e);g.setGlobalVariable("key",q);g.setGlobalVariable("distance",d);g.setGlobalVariable("dim",h);g.setGlobalVariable("nnl",t);g.defineVariable("lev",0);g.defineVariable("hr",p);g.defineVariable("max_dist_sqd",k);a.nearestTask.executeUsing(g)};a.prototype.nearestWithinRadius=function(e,d,b){var m=this,f=this.unphasedState(),
g=f.getFromKeyWithDefault(a.DIMENSIONS,e.length);if(e.length!=g)throw Error("Key size should always be the same");var h=c.mwg.structure.util.HRect.infiniteHRect(e.length),p=java.lang.Double.MAX_VALUE,k=new c.mwg.structure.util.NearestNeighborArrayList,f=this.getDistance(f),t=a.nearestRadiusTask.prepareWith(this.graph(),this,function(a){var e=k.getAllNodes();a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(m.world())).setTime(java.lang.String.valueOf(m.time())).fromVar("res").flatmap(c.mwg.task.Actions.lookup("{{result}}"));
var d=a.prepareWith(m.graph(),null,function(a){for(var e=Array(a.size()),d=0;d<a.size();d++)e[d]=a.get(d);b(e)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),q=t.newResult();q.add(e);t.setGlobalVariable("key",q);t.setGlobalVariable("distance",f);t.setGlobalVariable("dim",g);t.setGlobalVariable("nnl",k);t.setGlobalVariable("radius",d);t.defineVariable("lev",0);t.defineVariable("hr",h);t.defineVariable("max_dist_sqd",p);a.nearestRadiusTask.executeUsing(t)};a.prototype.nearestN=function(e,
d,b){var m=this,f=this.unphasedState(),g=f.getFromKeyWithDefault(a.DIMENSIONS,e.length);if(e.length!=g)throw Error("Key size should always be the same");var h=c.mwg.structure.util.HRect.infiniteHRect(e.length),p=java.lang.Double.MAX_VALUE,k=new c.mwg.structure.util.NearestNeighborList(d);d=this.getDistance(f);var f=a.nearestTask.prepareWith(this.graph(),this,function(a){var e=k.getAllNodes();a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(m.world())).setTime(java.lang.String.valueOf(m.time())).fromVar("res").flatmap(c.mwg.task.Actions.lookup("{{result}}"));
var d=a.prepareWith(m.graph(),null,function(a){for(var e=Array(a.size()),d=0;d<a.size();d++)e[d]=a.get(d);b(e)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),t=f.newResult();t.add(e);f.setGlobalVariable("key",t);f.setGlobalVariable("distance",d);f.setGlobalVariable("dim",g);f.setGlobalVariable("nnl",k);f.defineVariable("lev",0);f.defineVariable("hr",h);f.defineVariable("max_dist_sqd",p);a.nearestTask.executeUsing(f)};a.prototype.getDistance=function(e){e=e.getFromKeyWithDefault(a.DISTANCE,
a.DISTANCE_TYPE_DEF);if(e==c.mwg.structure.distance.Distances.EUCLIDEAN)e=c.mwg.structure.distance.EuclideanDistance.instance();else if(e==c.mwg.structure.distance.Distances.GEODISTANCE)e=c.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return e};a.prototype.extractFeatures=function(e,d){var l=this,m=b.prototype.get.call(this,a.FROM);if(null!=m){for(var m=m.split(","),f=Array(m.length),g=0;g<m.length;g++){var h=c.mwg.task.Actions.setWorld(""+this.world());
h.setTime(this.time()+"");h.parse(m[g].trim());f[g]=h}for(var p=new Float64Array(f.length),k=this.graph().newCounter(f.length),h=function(a){var d=c.mwg.task.Actions.newTask().emptyResult();d.add(e);(function(a){f[a].executeWith(l.graph(),d,function(e){null==e?p[a]=c.mwg.Constants.NULL_LONG:(p[a]=parseFloat(e.get(0).toString()),e.free());k.count()})})(a)},g=0;g<m.length;g++)h(g);k.then(function(){d(p)})}else d(null)};a.NAME="KDTree";a.FROM="from";a.LEFT="left";a.RIGHT="right";a.KEY="key";a.VALUE=
"value";a.SIZE="size";a.DIMENSIONS="dimensions";a.DISTANCE="distance";a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.insert=c.mwg.task.Actions.whileDo(function(a){var d=a.resultAsNodes().get(0),b=d.get(c.mwg.structure.tree.KDTree.KEY),m=a.variable("dim").get(0),f=a.variable("key").get(0),g=a.variable("value").get(0),h=a.variable("root").get(0),p=a.variable("distance").get(0),k=a.variable("err").get(0),t=a.variable("lev").get(0);if(null==b)return d.setProperty(c.mwg.structure.tree.KDTree.DIMENSIONS,
c.mwg.Type.INT,m),d.setProperty(c.mwg.structure.tree.KDTree.KEY,c.mwg.Type.DOUBLE_ARRAY,f),d.getOrCreateRel(c.mwg.structure.tree.KDTree.VALUE).clear().add(g.id()),d.setProperty(c.mwg.structure.tree.KDTree.SIZE,c.mwg.Type.INT,1),!1;if(p.measure(f,b)<k)return d.getOrCreateRel(c.mwg.structure.tree.KDTree.VALUE).clear().add(g.id()),!1;f[t]>b[t]?(p=d.get(c.mwg.structure.tree.KDTree.RIGHT),b=c.mwg.structure.tree.KDTree.RIGHT):(p=d.get(c.mwg.structure.tree.KDTree.LEFT),b=c.mwg.structure.tree.KDTree.LEFT);
if(null==p||0==p.size())return a=a.graph().newTypedNode(d.world(),d.time(),c.mwg.structure.tree.KDTree.NAME),a.setProperty(c.mwg.structure.tree.KDTree.KEY,c.mwg.Type.DOUBLE_ARRAY,f),a.getOrCreateRel(c.mwg.structure.tree.KDTree.VALUE).clear().add(g.id()),d.getOrCreateRel(b).clear().add(a.id()),h.setProperty(c.mwg.structure.tree.KDTree.SIZE,c.mwg.Type.INT,h.get(c.mwg.structure.tree.KDTree.SIZE)+1),a.free(),!1;a.setGlobalVariable("next",b);a.setGlobalVariable("lev",(t+1)%m);return!0},c.mwg.task.Actions.traverse("{{next}}"));
a.nearestTask=a.initFindNear();a.nearestRadiusTask=a.initFindRadius();a.enforcer=(new c.mwg.utility.Enforcer).asPositiveDouble(a.DISTANCE_THRESHOLD);return a}(c.mwg.plugin.AbstractNode);r.KDTree=n;n=function(b){function a(a,d,c,m){b.call(this,a,d,c,m)}__extends(a,b);a.prototype.setUpdateStat=function(e){this.unphasedState().set(a._STAT,c.mwg.Type.BOOL,e)};a.updateGaussian=function(e,d){var b=0,m=e.get(a._TOTAL);null!=m&&(b=m);if(0==b)e.set(a._TOTAL,c.mwg.Type.INT,1),e.set(a._SUM,c.mwg.Type.DOUBLE_ARRAY,
d);else{var m=d.length,f,g;if(1==b){f=e.get(a._SUM);g=new Float64Array(m*(m+1)/2);for(var h=0,p=0;p<m;p++)for(var k=p;k<m;k++)g[h]=f[p]*f[k],h++}else f=e.get(a._SUM),g=e.get(a._SUMSQ);for(p=0;p<m;p++)f[p]+=d[p];for(p=h=0;p<m;p++)for(k=p;k<m;k++)g[h]+=d[p]*d[k],h++;b++;e.set(a._TOTAL,c.mwg.Type.INT,b);e.set(a._SUM,c.mwg.Type.DOUBLE_ARRAY,f);e.set(a._SUMSQ,c.mwg.Type.DOUBLE_ARRAY,g)}};a.prototype.getTotal=function(){var e=b.prototype.getByIndex.call(this,a._TOTAL);return null==e?0:e};a.prototype.getAvg=
function(){var e=this.getTotal();if(0==e)return null;if(1==e)return b.prototype.getByIndex.call(this,a._SUM);for(var d=b.prototype.getByIndex.call(this,a._SUM),c=0;c<d.length;c++)d[c]/=e;return d};a.prototype.getCovarianceArray=function(e,d){if(null==e){var c=new Float64Array(d.length);java.lang.System.arraycopy(d,0,c,0,d.length);return c}null==d&&(d=new Float64Array(e.length));var c=e.length,m=this.getTotal();if(0==m)return null;if(1<m){var f=new Float64Array(c),g=b.prototype.getByIndex.call(this,
a._SUMSQ),h;h=m/(m-1);for(var p=0,k=0;k<c;k++)f[k]=(g[p]/m-e[k]*e[k])*h,f[k]<d[k]&&(f[k]=d[k]),p+=c-k;return f}c=new Float64Array(d.length);java.lang.System.arraycopy(d,0,c,0,d.length);return c};a.getRelationId=function(a,d){for(var b=Long.UZERO,m=0;m<a.length;m++)0!=m&&(b=b.shiftLeft(1)),d[m]>a[m]&&(b=b.add(Long.ONE));return b.add(Long.fromNumber(c.mwg.structure.tree.NDTree._RELCONST,!0)).toNumber()};a.binaryFromLong=function(e,d){for(var b=e-a._RELCONST,c=b>>1,f=[],g=0;g<d;g++)f[d-g-1]=1==b-(c<<
1),b=c,c=b>>1;return f};a.prototype.setProperty=function(e,d,l){e===a.BOUNDMIN?(e=this.unphasedState(),e.set(a._BOUNDMIN,c.mwg.Type.DOUBLE_ARRAY,l)):e===a.BOUNDMAX?(e=this.unphasedState(),e.set(a._BOUNDMAX,c.mwg.Type.DOUBLE_ARRAY,l)):e===a.PRECISION?(e=this.unphasedState(),e.set(a._PRECISION,c.mwg.Type.DOUBLE_ARRAY,l)):b.prototype.setProperty.call(this,e,d,l)};a.prototype.insert=function(e,d,b){var m=this.unphasedState(),f=m.get(a._PRECISION);null==m.get(a._DIM)&&m.set(a._DIM,c.mwg.Type.INT,e.length);
var g=m.getWithDefault(a._DIM,e.length);if(e.length!=g)throw Error("Key size should always be the same");var g=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=b&&b(!0)}),h=g.newResult();h.add(e);g.setGlobalVariable("key",h);null!=d&&g.setGlobalVariable("value",d);e=m.getWithDefault(a._STAT,a.STAT_DEF);g.setGlobalVariable("updatestat",e);g.setGlobalVariable("root",this);e=g.newResult();e.add(f);g.setGlobalVariable("precision",e);a.insert.executeUsing(g)};a.prototype.nearestN=function(e,
d,b){var m=this,f=this.unphasedState().get(a._DIM);if(null==f)b(null);else{if(e.length!=f)throw Error("Key size should always be the same");var g=new c.mwg.structure.util.NearestNeighborList(d);d=c.mwg.structure.distance.EuclideanDistance.instance();var h=a.nearestTask.prepareWith(this.graph(),this,function(a){var e=g.getAllNodes();a=c.mwg.task.Actions.setWorld(java.lang.String.valueOf(m.world())).setTime(java.lang.String.valueOf(m.time())).fromVar("res").flatmap(c.mwg.task.Actions.lookup("{{result}}"));
var d=a.prepareWith(m.graph(),null,function(a){a=Array(a.size());b(a)}),e=d.wrap(e);d.addToGlobalVariable("res",e);a.executeUsing(d)}),p=h.newResult();p.add(e);h.setGlobalVariable("key",p);h.setGlobalVariable("distance",d);h.setGlobalVariable("dim",f);h.defineVariable("lev",0);a.nearestTask.executeUsing(h)}};a.convertToDistance=function(a,d,b,m,f,g,h){for(var p=new Float64Array(b.length),k,n=c.mwg.structure.tree.NDTree.binaryFromLong(a,b.length),q=0;q<p.length;q++)n[q]?(a=f[q]-Math.max(f[q]-b[q],
g[q]),k=f[q]):(a=m[q],k=Math.max(b[q]-m[q],g[q])+m[q]),p[q]=(a+k)/2;return h.measure(p,d)};a.initNearestTask=function(){var a=c.mwg.task.Actions.newTask();a.then(function(a){var e=a.result().get(0),b=e.graph().resolver().resolveState(e),e=b.get(c.mwg.structure.tree.NDTree._VALUES);if(null!=e){for(var f=a.variable("dim").get(0),g=new Float64Array(f),b=b.get(c.mwg.structure.tree.NDTree._KEYS),h=a.variable("key").get(0),p=a.variable("distance").get(0),k=a.variable("nnl").get(0),n=0;n<e.size();n++){for(var q=
0;q<f;q++)g[q]=b[n*f+q];k.insert(e.get(n),p.measure(g,h))}a.continueWith(null)}else b.get(c.mwg.structure.tree.NDTree._BOUNDMAX),b.get(c.mwg.structure.tree.NDTree._BOUNDMIN),a.variable("key").get(0),a.variable("distance").get(0)});return a};a.prototype.getNumNodes=function(){return null!=this.getByIndex(a._NUMNODES)?this.getByIndex(a._NUMNODES):1};a.NAME="NDTree";a._STAT=0;a._TOTAL=1;a._SUM=2;a._SUMSQ=3;a._BOUNDMIN=6;a._BOUNDMAX=7;a._VALUES=8;a._VALUES_STR="8";a._KEYS=9;a._KEYS_STR="9";a._PRECISION=
10;a._NUMNODES=11;a._DIM=12;a.STAT_DEF=!1;a.BOUNDMIN="boundmin";a.BOUNDMAX="boundmax";a.PRECISION="precision";a._RELCONST=16;a.insert=c.mwg.task.Actions.whileDo(function(a){for(var b=a.variable("root").get(0),l=a.resultAsNodes().get(0),m=l.graph().resolver().resolveState(l),f=a.variable("updatestat").get(0),g=m.get(c.mwg.structure.tree.NDTree._BOUNDMAX),h=m.get(c.mwg.structure.tree.NDTree._BOUNDMIN),p=new Float64Array(g.length),k=0;k<p.length;k++)p[k]=(g[k]+h[k])/2;var n=a.variable("key").get(0),
q=a.variable("precision").get(0),r=n.length;f&&c.mwg.structure.tree.NDTree.updateGaussian(m,n);f=!1;for(k=0;k<r;k++)if(g[k]-h[k]>q[k]){f=!0;break}if(f){var u=c.mwg.structure.tree.NDTree.getRelationId(p,n);if(null==m.get(u)){for(var v=new Float64Array(r),r=new Float64Array(r),k=0;k<p.length;k++)n[k]<=p[k]?(v[k]=h[k],r[k]=Math.max(p[k]-h[k],q[k])+h[k]):(v[k]=g[k]-Math.max(g[k]-p[k],q[k]),r[k]=g[k]);n=l.graph().newTypedNode(l.world(),l.time(),c.mwg.structure.tree.NDTree.NAME);l=n.graph().resolver().resolveState(n);
l.set(c.mwg.structure.tree.NDTree._BOUNDMIN,c.mwg.Type.DOUBLE_ARRAY,v);l.set(c.mwg.structure.tree.NDTree._BOUNDMAX,c.mwg.Type.DOUBLE_ARRAY,r);m.getOrCreate(u,c.mwg.Type.RELATION).add(n.id());n.free();null!=b.getByIndex(c.mwg.structure.tree.NDTree._NUMNODES)?(m=b.getByIndex(c.mwg.structure.tree.NDTree._NUMNODES),m++,b.setPropertyByIndex(c.mwg.structure.tree.NDTree._NUMNODES,c.mwg.Type.INT,m)):b.setPropertyByIndex(c.mwg.structure.tree.NDTree._NUMNODES,c.mwg.Type.INT,2)}a.setVariable("next",u)}else a=
a.variable("value").get(0),m.getOrCreate(c.mwg.structure.tree.NDTree._VALUES,c.mwg.Type.RELATION).add(a.id()),a=m.get(c.mwg.structure.tree.NDTree._KEYS),null!=a?(b=new Float64Array(a.length+r),java.lang.System.arraycopy(a,0,b,0,a.length),java.lang.System.arraycopy(n,0,b,a.length,r),m.set(c.mwg.structure.tree.NDTree._KEYS,c.mwg.Type.DOUBLE_ARRAY,b)):m.set(c.mwg.structure.tree.NDTree._KEYS,c.mwg.Type.DOUBLE_ARRAY,n);return f},c.mwg.task.Actions.action(c.mwg.structure.action.TraverseById.NAME,"{{next}}"));
a.nearestTask=a.initNearestTask();return a}(c.mwg.plugin.AbstractNode);r.NDTree=n})(v.tree||(v.tree={}));(function(r){var n=function(){function b(a,b){this.min=new Float64Array(a.length);this.max=new Float64Array(b.length);java.lang.System.arraycopy(a,0,this.min,0,a.length);java.lang.System.arraycopy(b,0,this.max,0,b.length)}b.prototype.clone=function(){return new c.mwg.structure.util.HRect(this.min,this.max)};b.prototype.closest=function(a){for(var b=new Float64Array(a.length),d=0;d<a.length;++d)b[d]=
a[d]<=this.min[d]?this.min[d]:a[d]>=this.max[d]?this.max[d]:a[d];return b};b.infiniteHRect=function(a){for(var b=new Float64Array(a),d=new Float64Array(a),l=0;l<a;++l)b[l]=java.lang.Double.NEGATIVE_INFINITY,d[l]=java.lang.Double.POSITIVE_INFINITY;return new c.mwg.structure.util.HRect(b,d)};b.prototype.intersection=function(a){for(var b=new Float64Array(this.min.length),d=new Float64Array(this.min.length),l=0;l<this.min.length;++l)if(b[l]=Math.max(this.min[l],a.min[l]),d[l]=Math.min(this.max[l],a.max[l]),
b[l]>=d[l])return null;return new c.mwg.structure.util.HRect(b,d)};b.prototype.area=function(){for(var a=1,b=0;b<this.min.length;++b)a*=this.max[b]-this.min[b];return a};b.prototype.toString=function(){return this.min+"\n"+this.max+"\n"};return b}();r.HRect=n;n=function(){return function(){}}();r.NDResult=n;n=function(){function b(){this.maxPriority=java.lang.Double.MAX_VALUE;this.count=0;this.data=new java.util.ArrayList;this.value=new java.util.ArrayList;this.value.add(this.maxPriority);this.data.add(-1)}
b.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value.get(1)};b.prototype.insert=function(a,b){this.count++;this.value.add(b);this.data.add(a);this.bubbleUp(this.count);return!0};b.prototype.getAllNodes=function(){for(var a=this.count,b=new Float64Array(this.count),d=0;d<a;++d)b[a-d-1]=this.remove();return b};b.prototype.getHighest=function(){return this.data.get(1)};b.prototype.getBestDistance=function(){return this.value.get(1)};b.prototype.isEmpty=
function(){return 0==this.count};b.prototype.getSize=function(){return this.count};b.prototype.remove=function(){if(0==this.count)return 0;var a=this.data.get(1);this.data.set(1,this.data.get(this.count));this.value.set(1,this.value.get(this.count));this.data.set(this.count,0);this.value.set(this.count,0);this.count--;this.bubbleDown(1);return a};b.prototype.bubbleDown=function(a){for(var b=this.data.get(a),d=this.value.get(a),c;2*a<=this.count;a=c)if(c=2*a,c!=this.count&&this.value.get(c)<this.value.get(c+
1)&&c++,d<this.value.get(c))this.value.set(a,this.value.get(c)),this.data.set(a,this.data.get(c));else break;this.value.set(a,d);this.data.set(a,b)};b.prototype.bubbleUp=function(a){for(var b=this.data.get(a),d=this.value.get(a),c=Math.floor(a/2);this.value.get(c)<d;)this.value.set(a,this.value.get(c)),this.data.set(a,this.data.get(c)),a=Math.floor(a/2),c=Math.floor(a/2);this.value.set(a,d);this.data.set(a,b)};return b}();r.NearestNeighborArrayList=n;n=function(){function b(a){this.maxPriority=java.lang.Double.MAX_VALUE;
this.count=0;this.capacity=a;this.data=new Float64Array(a+1);this.value=new Float64Array(a+1);this.value[0]=this.maxPriority}b.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value[1]};b.prototype.removeNode=function(a){for(var b=-1,d=1;d<this.capacity+1;d++)if(this.data[d]==a){b=d;break}if(-1==b)return!1;if(1==b)this.remove();else{if(b==this.capacity+1)this.data[b]=0,this.value[b]=0;else for(d=b;d<this.capacity;d++)this.data[d]=this.data[d+1],this.value[d]=
this.value[d+1];this.count--}return!0};b.prototype.insert=function(a,b){if(this.count<this.capacity)return this.add(a,b),!0;if(b>this.getMaxPriority())return!1;this.remove();this.add(a,b);return!0};b.prototype.print=function(){console.log(" ");console.log("keys: ");for(var a=0;a<this.data.length;a++)console.log(this.data[a]);console.log(" ");console.log("dist: ");for(a=0;a<this.value.length;a++)console.log(this.value[a]);console.log(" ")};b.prototype.getAllNodes=function(){for(var a=Math.min(this.capacity,
this.count),b=new Float64Array(a),d=0;d<a;++d)b[a-d-1]=this.remove();return b};b.prototype.isCapacityReached=function(){return this.count>=this.capacity};b.prototype.getHighest=function(){return this.data[1]};b.prototype.getWorstDistance=function(){return this.value[1]};b.prototype.isEmpty=function(){return 0==this.count};b.prototype.getSize=function(){return this.count};b.prototype.add=function(a,b){this.count++>=this.capacity&&this.expandCapacity();this.value[this.count]=b;this.data[this.count]=
a;this.bubbleUp(this.count)};b.prototype.remove=function(){if(0==this.count)return 0;var a=this.data[1];this.data[1]=this.data[this.count];this.value[1]=this.value[this.count];this.data[this.count]=0;this.value[this.count]=0;this.count--;this.bubbleDown(1);return a};b.prototype.bubbleDown=function(a){for(var b=this.data[a],d=this.value[a],c;2*a<=this.count;a=c)if(c=2*a,c!=this.count&&this.value[c]<this.value[c+1]&&c++,d<this.value[c])this.value[a]=this.value[c],this.data[a]=this.data[c];else break;
this.value[a]=d;this.data[a]=b};b.prototype.bubbleUp=function(a){for(var b=this.data[a],d=this.value[a],c=Math.floor(a/2);this.value[c]<d;)this.value[a]=this.value[c],this.data[a]=this.data[c],a=Math.floor(a/2),c=Math.floor(a/2);this.value[a]=d;this.data[a]=b};b.prototype.expandCapacity=function(){this.capacity=2*this.count;var a=new Float64Array(this.capacity+1),b=new Float64Array(this.capacity+1);java.lang.System.arraycopy(this.data,0,a,0,this.data.length);java.lang.System.arraycopy(this.value,
0,b,0,this.data.length);this.data=a;this.value=b};b.prototype.getAllNodesWithin=function(a){for(var b=Math.min(this.capacity,this.count),d=new Float64Array(b),c=0,m=0;m<b;++m)this.getMaxPriority()<=a?(d[b-c-1]=this.remove(),c++):this.remove();a=new Float64Array(c);java.lang.System.arraycopy(d,b-c,a,0,c);return a};return b}();r.NearestNeighborList=n})(v.util||(v.util={}))})(u.structure||(u.structure={}))})(c.mwg||(c.mwg={}))})(org||(org={}));

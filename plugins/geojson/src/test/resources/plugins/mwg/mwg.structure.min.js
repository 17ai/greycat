var __extends=this&&this.__extends||function(e,u){function v(){this.constructor=e}for(var w in u)u.hasOwnProperty(w)&&(e[w]=u[w]);e.prototype=null===u?Object.create(u):(v.prototype=u.prototype,new v)},org;
(function(e){(function(u){(function(v){var u=function(){function q(){}q.nTreeInsertTo=function(l){return e.mwg.task.Actions.newTask().action(e.mwg.structure.action.NTreeInsertTo.NAME,l)};q.nTreeNearestN=function(l){return e.mwg.task.Actions.newTask().action(e.mwg.structure.action.NTreeNearestN.NAME,l)};q.nTreeNearestWithinRadius=function(l){return e.mwg.task.Actions.newTask().action(e.mwg.structure.action.NTreeNearestWithinRadius.NAME,l)};q.nTreeNearestNWithinRadius=function(l){return e.mwg.task.Actions.newTask().action(e.mwg.structure.action.NTreeNearestNWithinRadius.NAME,
l)};return q}();v.StructureActions=u;u=function(q){function l(){q.call(this);this.declareNodeType(e.mwg.structure.tree.KDTree.NAME,function(b,a,d,c){return new e.mwg.structure.tree.KDTree(b,a,d,c)});this.declareNodeType(e.mwg.structure.tree.NDTree.NAME,function(b,a,d,c){return new e.mwg.structure.tree.NDTree(b,a,d,c)});this.declareTaskAction(e.mwg.structure.action.NTreeInsertTo.NAME,function(b){if(1!=b.length)throw Error("Bad param number!");return new e.mwg.structure.action.NTreeInsertTo(b[0])});
this.declareTaskAction(e.mwg.structure.action.TraverseById.NAME,function(b){if(1!=b.length)throw Error("Bad param number!");return new e.mwg.structure.action.TraverseById(b[0])});this.declareTaskAction(e.mwg.structure.action.NTreeNearestN.NAME,function(b){if(2>b.length)throw Error("Bad param number!");for(var a=java.lang.Integer.parseInt(b[b.length-1]),d=new Float64Array(b.length-1),c=0;c<b.length-1;c++)d[c]=parseFloat(b[c]);return new e.mwg.structure.action.NTreeNearestN(d,a)});this.declareTaskAction(e.mwg.structure.action.NTreeNearestWithinRadius.NAME,
function(b){if(2>b.length)throw Error("Bad param number!");for(var a=parseFloat(b[b.length-1]),d=new Float64Array(b.length-1),c=0;c<b.length-1;c++)d[c]=parseFloat(b[c]);return new e.mwg.structure.action.NTreeNearestWithinRadius(d,a)});this.declareTaskAction(e.mwg.structure.action.NTreeNearestNWithinRadius.NAME,function(b){if(3>b.length)throw Error("Bad param number!");for(var a=parseFloat(b[b.length-1]),d=java.lang.Integer.parseInt(b[b.length-2]),c=new Float64Array(b.length-2),p=0;p<b.length-2;p++)c[p]=
parseFloat(b[p]);return new e.mwg.structure.action.NTreeNearestNWithinRadius(c,d,a)})}__extends(l,q);return l}(e.mwg.plugin.AbstractPlugin);v.StructurePlugin=u;(function(q){var l=function(b){function a(a){b.call(this);this._variableName=a}__extends(a,b);a.prototype.eval=function(a){var c=a.result(),p=a.variable(a.template(this._variableName));if(null!=c&&null!=p){for(var b=a.graph().newCounter(c.size()),c=c.iterator(),f=c.next();null!=f;){if(f instanceof e.mwg.plugin.AbstractNode)for(var g=p.iterator(),
h=g.next();null!=h;)h instanceof e.mwg.structure.tree.KDTree?h.insert(f,function(a){b.count()}):b.count(),h=g.next();else b.count();f=c.next()}b.then(function(){a.continueTask()})}else a.continueTask()};a.prototype.toString=function(){return"nTreeInsertTo('"+this._variableName+"')"};a.NAME="nTreeInsertTo";return a}(e.mwg.plugin.AbstractTaskAction);q.NTreeInsertTo=l;l=function(b){function a(a,c){b.call(this);this._key=a;this._n=c}__extends(a,b);a.prototype.eval=function(a){var c=a.result(),p=a.newResult();
if(null!=c){for(var b=a.graph().newCounter(c.size()),c=c.iterator(),f=c.next();null!=f;)f instanceof e.mwg.structure.tree.KDTree?f.nearestN(this._key,this._n,function(a){for(var c=0;c<a.length;c++)p.add(a[c]);b.count()}):b.count(),f=c.next();b.then(function(){a.continueWith(p)})}else a.continueWith(p)};a.prototype.toString=function(){return"nTreeNearestN('')"};a.NAME="nTreeNearestN";return a}(e.mwg.plugin.AbstractTaskAction);q.NTreeNearestN=l;l=function(b){function a(a,c,p){b.call(this);this._key=
a;this._n=c;this._radius=p}__extends(a,b);a.prototype.eval=function(a){var c=a.result(),p=a.newResult();if(null!=c){for(var b=a.graph().newCounter(c.size()),c=c.iterator(),f=c.next();null!=f;)f instanceof e.mwg.structure.tree.KDTree?f.nearestNWithinRadius(this._key,this._n,this._radius,function(a){for(var c=0;c<a.length;c++)p.add(a[c]);b.count()}):b.count(),f=c.next();b.then(function(){a.continueWith(p)})}else a.continueWith(p)};a.prototype.toString=function(){return"nTreeNearestNWithinRadius('')"};
a.NAME="nTreeNearestNWithinRadius";return a}(e.mwg.plugin.AbstractTaskAction);q.NTreeNearestNWithinRadius=l;l=function(b){function a(a,c){b.call(this);this._key=a;this._radius=c}__extends(a,b);a.prototype.eval=function(a){var c=a.result(),p=a.newResult();if(null!=c){for(var b=a.graph().newCounter(c.size()),c=c.iterator(),f=c.next();null!=f;)f instanceof e.mwg.structure.tree.KDTree?f.nearestWithinRadius(this._key,this._radius,function(a){for(var c=0;c<a.length;c++)p.add(a[c]);b.count()}):b.count(),
f=c.next();b.then(function(){a.continueWith(p)})}else a.continueWith(p)};a.prototype.toString=function(){return"nTreeNearestWithinRadius('')"};a.NAME="nTreeNearestWithinRadius";return a}(e.mwg.plugin.AbstractTaskAction);q.NTreeNearestWithinRadius=l;l=function(b){function a(a){b.call(this);this._name=a}__extends(a,b);a.prototype.eval=function(a){var c=a.wrap(null),p=java.lang.Long.parseLong(a.template(this._name)),b=a.result();if(null!=b){for(var f=b.size(),g=a.graph().newCounter(f),h=function(a){var d=
b.get(a);d instanceof e.mwg.plugin.AbstractNode?d.relByIndex(p,function(a){if(null!=a)for(var p=0;p<a.length;p++)c.add(a[p]);d.free();g.count()}):(c.add(d),g.count())},n=0;n<f;n++)h(n);g.then(function(){b.clear();a.continueWith(c)})}else a.continueTask()};a.prototype.toString=function(){return"traverseById('"+this._name+"')"};a.NAME="traverseById";return a}(e.mwg.plugin.AbstractTaskAction);q.TraverseById=l})(v.action||(v.action={}));(function(q){var l=function(){function b(){}b.instance=function(){null==
b.static_instance&&(b.static_instance=new e.mwg.structure.distance.CosineDistance);return b.static_instance};b.prototype.measure=function(a,d){for(var c=0,p=0,e=0,b=0;b<a.length;b++)c+=a[b]*d[b],p+=a[b]*a[b],e+=d[b]*d[b];c/=Math.sqrt(p)*Math.sqrt(e);0>c&&(c=0);return 1-c};b.prototype.compare=function(a,d){return a<d};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};b.static_instance=null;return b}();q.CosineDistance=l;l=function(){function e(){}
e.EUCLIDEAN=0;e.GEODISTANCE=1;e.COSINE=2;return e}();q.Distances=l;l=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new e.mwg.structure.distance.EuclideanDistance);return b.static_instance};b.prototype.measure=function(a,d){for(var c=0,p=0;p<a.length;p++)c+=(a[p]-d[p])*(a[p]-d[p]);return Math.sqrt(c)};b.prototype.compare=function(a,d){return a<d};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};
b.static_instance=null;return b}();q.EuclideanDistance=l;l=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new e.mwg.structure.distance.GeoDistance);return b.static_instance};b.prototype.measure=function(a,d){var c=e.mwg.structure.distance.GeoDistance.toRadians(d[0]-a[0]),p=e.mwg.structure.distance.GeoDistance.toRadians(d[1]-a[1]),c=Math.sin(c/2)*Math.sin(c/2)+Math.cos(e.mwg.structure.distance.GeoDistance.toRadians(a[0]))*Math.cos(e.mwg.structure.distance.GeoDistance.toRadians(d[0]))*
Math.sin(p/2)*Math.sin(p/2);return 12742E3*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))};b.toRadians=function(a){return a*Math.PI/180};b.prototype.compare=function(a,d){return a<d};b.prototype.getMinValue=function(){return 0};b.prototype.getMaxValue=function(){return java.lang.Double.MAX_VALUE};b.static_instance=null;return b}();q.GeoDistance=l;l=function(){function b(){}b.instance=function(){null==b.static_instance&&(b.static_instance=new e.mwg.structure.distance.PearsonDistance);return b.static_instance};
b.prototype.measure=function(a,d){for(var c=0,p=0,e=0,b=0,g=0,h=0;h<a.length;h++)c+=a[h]*d[h],p+=a[h],b+=d[h],e+=a[h]*a[h],g+=d[h]*d[h];h=a.length;return(c-p*b/h)/Math.sqrt((e-p*p/h)*(g-b*b/h))};b.prototype.compare=function(a,d){return Math.abs(a)>Math.abs(d)};b.prototype.getMinValue=function(){return 1};b.prototype.getMaxValue=function(){return 0};b.static_instance=null;return b}();q.PearsonDistance=l})(v.distance||(v.distance={}));(function(q){var l=function(b){function a(a,c,p,e){b.call(this,a,
c,p,e)}__extends(a,b);a.initFindNear=function(){var a=e.mwg.task.Actions.newTask();a.then(function(a){var d=a.resultAsNodes().get(0);if(null!=d){var b=d.get(e.mwg.structure.tree.KDTree.KEY),f=a.variable("dim").get(0),g=a.variable("key").get(0),h=a.variable("distance").get(0),n=a.variable("lev").get(0),k=a.variable("hr").get(0),t=a.variable("max_dist_sqd").get(0),r=n%f,h=h.measure(b,g),f=k.clone();k.max[r]=b[r];f.min[r]=b[r];g[r]<b[r]?(b=d.get(e.mwg.structure.tree.KDTree.LEFT),r=e.mwg.structure.tree.KDTree.LEFT,
g=k,d=d.get(e.mwg.structure.tree.KDTree.RIGHT),k=f,f=e.mwg.structure.tree.KDTree.RIGHT):(b=d.get(e.mwg.structure.tree.KDTree.RIGHT),g=f,r=e.mwg.structure.tree.KDTree.RIGHT,d=d.get(e.mwg.structure.tree.KDTree.LEFT),f=e.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",k);a.defineVariable("pivot_to_target",h);null!=b&&0!=b.size()?(a.defineVariable("near",r),a.defineVariableForSubTask("hr",g),a.defineVariableForSubTask("max_dist_sqd",t),a.defineVariableForSubTask("lev",n+1)):a.defineVariableForSubTask("near",
a.newResult());null!=d&&0!=d.size()?a.defineVariableForSubTask("far",f):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(e.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},e.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var d=a.variable("nnl").get(0),b=a.variable("key").get(0),f=a.variable("distance").get(0),g=a.variable("max_dist_sqd").get(0),h=a.variable("further_hr").get(0),n=a.variable("pivot_to_target").get(0),k=a.variable("lev").get(0),
t=a.resultAsNodes().get(0),r;r=d.isCapacityReached()?d.getMaxPriority():java.lang.Double.MAX_VALUE;var B=Math.min(g,r),l=h.closest(b);f.measure(l,b)<g?(n<r&&(r=n,d.insert(t.get(e.mwg.structure.tree.KDTree.VALUE).get(0),r),t.get(e.mwg.structure.tree.KDTree.KEY),B=d.isCapacityReached()?d.getMaxPriority():java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",h),a.defineVariableForSubTask("max_dist_sqd",B),a.defineVariableForSubTask("lev",k+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",
!1);a.continueTask()}).isolate(e.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},e.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.initFindRadius=function(){var a=e.mwg.task.Actions.newTask();a.then(function(a){var d=a.resultAsNodes().get(0);if(null!=d){var b=d.get(e.mwg.structure.tree.KDTree.KEY),f=a.variable("dim").get(0),g=a.variable("key").get(0),h=a.variable("distance").get(0),n=a.variable("lev").get(0),k=a.variable("hr").get(0),
t=a.variable("max_dist_sqd").get(0),r=n%f,h=h.measure(b,g),f=k.clone();k.max[r]=b[r];f.min[r]=b[r];g[r]<b[r]?(b=d.get(e.mwg.structure.tree.KDTree.LEFT),r=e.mwg.structure.tree.KDTree.LEFT,g=k,d=d.get(e.mwg.structure.tree.KDTree.RIGHT),k=f,f=e.mwg.structure.tree.KDTree.RIGHT):(b=d.get(e.mwg.structure.tree.KDTree.RIGHT),g=f,r=e.mwg.structure.tree.KDTree.RIGHT,d=d.get(e.mwg.structure.tree.KDTree.LEFT),f=e.mwg.structure.tree.KDTree.LEFT);a.defineVariable("further_hr",k);a.defineVariable("pivot_to_target",
h);null!=b&&0!=b.size()?(a.defineVariable("near",r),a.defineVariableForSubTask("hr",g),a.defineVariableForSubTask("max_dist_sqd",t),a.defineVariableForSubTask("lev",n+1)):a.defineVariableForSubTask("near",a.newResult());null!=d&&0!=d.size()?a.defineVariableForSubTask("far",f):a.defineVariableForSubTask("far",a.newResult())}a.continueTask()}).isolate(e.mwg.task.Actions.ifThen(function(a){return 0<a.variable("near").size()},e.mwg.task.Actions.traverse("{{near}}").isolate(a))).then(function(a){var d=
a.variable("nnl").get(0),b=a.variable("key").get(0),f=a.variable("distance").get(0),g=a.variable("radius").get(0),h=a.variable("max_dist_sqd").get(0),n=a.variable("further_hr").get(0),k=a.variable("pivot_to_target").get(0),t=a.variable("lev").get(0),r=a.resultAsNodes().get(0),l=java.lang.Double.MAX_VALUE,C=Math.min(h,l),q=n.closest(b);f.measure(q,b)<h?(k<l&&(l=k,l<=g&&d.insert(r.get(e.mwg.structure.tree.KDTree.VALUE).get(0),l),C=java.lang.Double.MAX_VALUE),a.defineVariableForSubTask("hr",n),a.defineVariableForSubTask("max_dist_sqd",
C),a.defineVariableForSubTask("lev",t+1),a.defineVariable("continueFar",!0)):a.defineVariable("continueFar",!1);a.continueTask()}).isolate(e.mwg.task.Actions.ifThen(function(a){return a.variable("continueFar").get(0)&&0<a.variable("far").size()},e.mwg.task.Actions.traverse("{{far}}").isolate(a)));return a};a.prototype.setProperty=function(d,c,e){a.enforcer.check(d,c,e);b.prototype.setProperty.call(this,d,c,e)};a.prototype.insert=function(a,c){var b=this;this.extractFeatures(a,function(e){b.insertWith(e,
a,c)})};a.prototype.insertWith=function(d,c,b){var e=this.unphasedState(),f=e.getFromKeyWithDefault(a.DIMENSIONS,d.length),g=e.getFromKeyWithDefault(a.DISTANCE_THRESHOLD,a.DISTANCE_THRESHOLD_DEF);if(d.length!=f)throw Error("Key size should always be the same");if(null==c)throw Error("To index node should not be null");var e=this.getDistance(e),h=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=b&&b(!0)}),n=h.newResult();n.add(d);h.setGlobalVariable("key",n);h.setGlobalVariable("value",
c);h.setGlobalVariable("root",this);h.setGlobalVariable("distance",e);h.setGlobalVariable("dim",f);h.setGlobalVariable("err",g);h.defineVariable("lev",0);a.insert.executeUsing(h)};a.prototype.size=function(){return this.graph().resolver().resolveState(this).getFromKeyWithDefault(a.SIZE,0)};a.prototype.setDistance=function(d){this.set(a.DISTANCE,d)};a.prototype.setFrom=function(d){this.set(a.FROM,d)};a.prototype.nearestNWithinRadius=function(d,c,b,m){var f=this,g=this.unphasedState(),h=g.getFromKeyWithDefault(a.DIMENSIONS,
d.length);if(d.length!=h)throw Error("Key size should always be the same");var n=e.mwg.structure.util.HRect.infiniteHRect(d.length),k=java.lang.Double.MAX_VALUE,t=new e.mwg.structure.util.NearestNeighborList(c);c=this.getDistance(g);var g=a.nearestTask.prepareWith(this.graph(),this,function(a){var d=t.getAllNodesWithin(b);a=e.mwg.task.Actions.setWorld(java.lang.String.valueOf(f.world())).setTime(java.lang.String.valueOf(f.time())).fromVar("res").flatmap(e.mwg.task.Actions.lookup("{{result}}"));var c=
a.prepareWith(f.graph(),null,function(a){for(var d=Array(a.size()),c=0;c<a.size();c++)d[c]=a.get(c);m(d)}),d=c.wrap(d);c.addToGlobalVariable("res",d);a.executeUsing(c)}),r=g.newResult();r.add(d);g.setGlobalVariable("key",r);g.setGlobalVariable("distance",c);g.setGlobalVariable("dim",h);g.setGlobalVariable("nnl",t);g.defineVariable("lev",0);g.defineVariable("hr",n);g.defineVariable("max_dist_sqd",k);a.nearestTask.executeUsing(g)};a.prototype.nearestWithinRadius=function(d,c,b){var m=this,f=this.unphasedState(),
g=f.getFromKeyWithDefault(a.DIMENSIONS,d.length);if(d.length!=g)throw Error("Key size should always be the same");var h=e.mwg.structure.util.HRect.infiniteHRect(d.length),n=java.lang.Double.MAX_VALUE,k=new e.mwg.structure.util.NearestNeighborArrayList,f=this.getDistance(f),t=a.nearestRadiusTask.prepareWith(this.graph(),this,function(a){var d=k.distroyAndGetAllNodes();a=e.mwg.task.Actions.setWorld(java.lang.String.valueOf(m.world())).setTime(java.lang.String.valueOf(m.time())).fromVar("res").flatmap(e.mwg.task.Actions.lookup("{{result}}"));
var c=a.prepareWith(m.graph(),null,function(a){for(var d=Array(a.size()),c=0;c<a.size();c++)d[c]=a.get(c);b(d)}),d=c.wrap(d);c.addToGlobalVariable("res",d);a.executeUsing(c)}),r=t.newResult();r.add(d);t.setGlobalVariable("key",r);t.setGlobalVariable("distance",f);t.setGlobalVariable("dim",g);t.setGlobalVariable("nnl",k);t.setGlobalVariable("radius",c);t.defineVariable("lev",0);t.defineVariable("hr",h);t.defineVariable("max_dist_sqd",n);a.nearestRadiusTask.executeUsing(t)};a.prototype.nearestN=function(d,
c,b){var m=this,f=this.unphasedState(),g=f.getFromKeyWithDefault(a.DIMENSIONS,d.length);if(d.length!=g)throw Error("Key size should always be the same");var h=e.mwg.structure.util.HRect.infiniteHRect(d.length),n=java.lang.Double.MAX_VALUE,k=new e.mwg.structure.util.NearestNeighborList(c);c=this.getDistance(f);var f=a.nearestTask.prepareWith(this.graph(),this,function(a){var d=k.getAllNodes();a=e.mwg.task.Actions.setWorld(java.lang.String.valueOf(m.world())).setTime(java.lang.String.valueOf(m.time())).fromVar("res").flatmap(e.mwg.task.Actions.lookup("{{result}}"));
var c=a.prepareWith(m.graph(),null,function(a){for(var d=Array(a.size()),c=0;c<a.size();c++)d[c]=a.get(c);b(d)}),d=c.wrap(d);c.addToGlobalVariable("res",d);a.executeUsing(c)}),t=f.newResult();t.add(d);f.setGlobalVariable("key",t);f.setGlobalVariable("distance",c);f.setGlobalVariable("dim",g);f.setGlobalVariable("nnl",k);f.defineVariable("lev",0);f.defineVariable("hr",h);f.defineVariable("max_dist_sqd",n);a.nearestTask.executeUsing(f)};a.prototype.getDistance=function(d){d=d.getFromKeyWithDefault(a.DISTANCE,
a.DISTANCE_TYPE_DEF);if(d==e.mwg.structure.distance.Distances.EUCLIDEAN)d=e.mwg.structure.distance.EuclideanDistance.instance();else if(d==e.mwg.structure.distance.Distances.GEODISTANCE)d=e.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return d};a.prototype.extractFeatures=function(d,c){var p=this,m=b.prototype.get.call(this,a.FROM);if(null!=m){for(var m=m.split(","),f=Array(m.length),g=0;g<m.length;g++){var h=e.mwg.task.Actions.setWorld(""+this.world());
h.setTime(this.time()+"");h.parse(m[g].trim());f[g]=h}for(var n=new Float64Array(f.length),k=this.graph().newCounter(f.length),h=function(a){var c=e.mwg.task.Actions.newTask().emptyResult();c.add(d);(function(a){f[a].executeWith(p.graph(),c,function(d){null==d?n[a]=e.mwg.Constants.NULL_LONG:(n[a]=parseFloat(d.get(0).toString()),d.free());k.count()})})(a)},g=0;g<m.length;g++)h(g);k.then(function(){c(n)})}else c(null)};a.NAME="KDTree";a.FROM="from";a.LEFT="left";a.RIGHT="right";a.KEY="key";a.VALUE=
"value";a.SIZE="size";a.DIMENSIONS="dimensions";a.DISTANCE="distance";a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.insert=e.mwg.task.Actions.whileDo(function(a){var c=a.resultAsNodes().get(0),b=c.get(e.mwg.structure.tree.KDTree.KEY),m=a.variable("dim").get(0),f=a.variable("key").get(0),g=a.variable("value").get(0),h=a.variable("root").get(0),n=a.variable("distance").get(0),k=a.variable("err").get(0),l=a.variable("lev").get(0);if(null==b)return c.setProperty(e.mwg.structure.tree.KDTree.DIMENSIONS,
e.mwg.Type.INT,m),c.setProperty(e.mwg.structure.tree.KDTree.KEY,e.mwg.Type.DOUBLE_ARRAY,f),c.getOrCreateRel(e.mwg.structure.tree.KDTree.VALUE).clear().add(g.id()),c.setProperty(e.mwg.structure.tree.KDTree.SIZE,e.mwg.Type.INT,1),!1;if(n.measure(f,b)<k)return c.getOrCreateRel(e.mwg.structure.tree.KDTree.VALUE).clear().add(g.id()),!1;f[l]>b[l]?(n=c.get(e.mwg.structure.tree.KDTree.RIGHT),b=e.mwg.structure.tree.KDTree.RIGHT):(n=c.get(e.mwg.structure.tree.KDTree.LEFT),b=e.mwg.structure.tree.KDTree.LEFT);
if(null==n||0==n.size())return a=a.graph().newTypedNode(c.world(),c.time(),e.mwg.structure.tree.KDTree.NAME),a.setProperty(e.mwg.structure.tree.KDTree.KEY,e.mwg.Type.DOUBLE_ARRAY,f),a.getOrCreateRel(e.mwg.structure.tree.KDTree.VALUE).clear().add(g.id()),c.getOrCreateRel(b).clear().add(a.id()),h.setProperty(e.mwg.structure.tree.KDTree.SIZE,e.mwg.Type.INT,h.get(e.mwg.structure.tree.KDTree.SIZE)+1),a.free(),!1;a.setGlobalVariable("next",b);a.setGlobalVariable("lev",(l+1)%m);return!0},e.mwg.task.Actions.traverse("{{next}}"));
a.nearestTask=a.initFindNear();a.nearestRadiusTask=a.initFindRadius();a.enforcer=(new e.mwg.utility.Enforcer).asPositiveDouble(a.DISTANCE_THRESHOLD);return a}(e.mwg.plugin.AbstractNode);q.KDTree=l;l=function(b){function a(a,c,e,m){b.call(this,a,c,e,m)}__extends(a,b);a.prototype.setUpdateStat=function(d){this.unphasedState().set(a._STAT,e.mwg.Type.BOOL,d)};a.updateGaussian=function(d,c){var b=0,m=d.get(a._TOTAL);null!=m&&(b=m);if(0==b)d.set(a._TOTAL,e.mwg.Type.INT,1),d.set(a._SUM,e.mwg.Type.DOUBLE_ARRAY,
c);else{var m=c.length,f,g;if(1==b){f=d.get(a._SUM);g=new Float64Array(m*(m+1)/2);for(var h=0,n=0;n<m;n++)for(var k=n;k<m;k++)g[h]=f[n]*f[k],h++}else f=d.get(a._SUM),g=d.get(a._SUMSQ);for(n=0;n<m;n++)f[n]+=c[n];for(n=h=0;n<m;n++)for(k=n;k<m;k++)g[h]+=c[n]*c[k],h++;b++;d.set(a._TOTAL,e.mwg.Type.INT,b);d.set(a._SUM,e.mwg.Type.DOUBLE_ARRAY,f);d.set(a._SUMSQ,e.mwg.Type.DOUBLE_ARRAY,g)}};a.prototype.getTotal=function(){var d=b.prototype.getByIndex.call(this,a._TOTAL);return null==d?0:d};a.prototype.getAvg=
function(){var d=this.getTotal();if(0==d)return null;if(1==d)return b.prototype.getByIndex.call(this,a._SUM);for(var c=b.prototype.getByIndex.call(this,a._SUM),e=0;e<c.length;e++)c[e]/=d;return c};a.prototype.getCovarianceArray=function(d,c){if(null==d){var e=new Float64Array(c.length);java.lang.System.arraycopy(c,0,e,0,c.length);return e}null==c&&(c=new Float64Array(d.length));var e=d.length,m=this.getTotal();if(0==m)return null;if(1<m){var f=new Float64Array(e),g=b.prototype.getByIndex.call(this,
a._SUMSQ),h;h=m/(m-1);for(var n=0,k=0;k<e;k++)f[k]=(g[n]/m-d[k]*d[k])*h,f[k]<c[k]&&(f[k]=c[k]),n+=e-k;return f}e=new Float64Array(c.length);java.lang.System.arraycopy(c,0,e,0,c.length);return e};a.getRelationId=function(a,c){for(var b=Long.UZERO,m=0;m<a.length;m++)0!=m&&(b=b.shiftLeft(1)),c[m]>a[m]&&(b=b.add(Long.ONE));return b.add(Long.fromNumber(e.mwg.structure.tree.NDTree._RELCONST,!0)).toNumber()};a.binaryFromLong=function(d,c){for(var b=d-a._RELCONST,e=b>>1,f=[],g=0;g<c;g++)f[c-g-1]=1==b-(e<<
1),b=e,e=b>>1;return f};a.prototype.setProperty=function(d,c,p){d===a.BOUNDMIN?(d=this.unphasedState(),d.set(a._BOUNDMIN,e.mwg.Type.DOUBLE_ARRAY,p)):d===a.BOUNDMAX?(d=this.unphasedState(),d.set(a._BOUNDMAX,e.mwg.Type.DOUBLE_ARRAY,p)):d===a.PRECISION?(d=this.unphasedState(),d.set(a._PRECISION,e.mwg.Type.DOUBLE_ARRAY,p)):b.prototype.setProperty.call(this,d,c,p)};a.prototype.getDistance=function(d){d=d.getWithDefault(a._DISTANCE,a.DISTANCE_TYPE_DEF);if(d==e.mwg.structure.distance.Distances.EUCLIDEAN)d=
e.mwg.structure.distance.EuclideanDistance.instance();else if(d==e.mwg.structure.distance.Distances.GEODISTANCE)d=e.mwg.structure.distance.GeoDistance.instance();else throw Error("Unknown distance code metric");return d};a.prototype.setDistance=function(d){this.setPropertyByIndex(a._DISTANCE,e.mwg.Type.INT,d)};a.prototype.insert=function(d,c,b){var m=this.unphasedState(),f=m.get(a._PRECISION);null==m.get(a._DIM)&&m.set(a._DIM,e.mwg.Type.INT,d.length);var g=m.getWithDefault(a._DIM,d.length);if(d.length!=
g)throw Error("Key size should always be the same");var g=a.insert.prepareWith(this.graph(),this,function(a){a.free();null!=b&&b(!0)}),h=g.newResult();h.add(d);g.setGlobalVariable("key",h);null!=c&&g.setGlobalVariable("value",c);d=m.getWithDefault(a._STAT,a.STAT_DEF);g.setGlobalVariable("updatestat",d);g.setGlobalVariable("root",this);d=g.newResult();d.add(f);g.setGlobalVariable("precision",d);a.insert.executeUsing(g)};a.prototype.nearestN=function(d,c,b){var m=this,f=this.unphasedState(),g=f.get(a._DIM);
if(null==g)b(null);else{if(d.length!=g)throw Error("Key size should always be the same");var h=new e.mwg.structure.util.NearestNeighborList(c),n=this.getDistance(f);c=a.nearestTask.prepareWith(this.graph(),this,function(a){var d=h.getAllNodes();a=e.mwg.task.Actions.setWorld(java.lang.String.valueOf(m.world())).setTime(java.lang.String.valueOf(m.time())).fromVar("res").flatmap(e.mwg.task.Actions.lookup("{{result}}"));var c=a.prepareWith(m.graph(),null,function(a){for(var d=Array(a.size()),c=0;c<a.size();c++)d[c]=
a.get(c);b(d)}),d=c.wrap(d);c.addToGlobalVariable("res",d);a.executeUsing(c)});var k=c.newResult();k.add(d);c.setGlobalVariable("key",k);c.setGlobalVariable("distance",n);c.setGlobalVariable("dim",g);c.defineVariable("lev",0);d=f.get(a._PRECISION);f=c.newResult();f.add(d);c.setGlobalVariable("precision",f);c.setGlobalVariable("nnl",h);a.nearestTask.executeUsing(c)}};a.getclosestDistance=function(a,c,b,e){for(var f=new Float64Array(a.length),g=0;g<a.length;g++)f[g]=a[g]>=b[g]?b[g]:a[g]<=c[g]?c[g]:
a[g];return e.measure(f,a)};a.initNearestTask=function(){var a=e.mwg.task.Actions.newTask();a.defineVar("parent").then(function(a){var d=a.result().get(0),b=d.graph().resolver().resolveState(d),d=a.variable("nnl").get(0),f=b.get(e.mwg.structure.tree.NDTree._VALUES);if(null!=f){for(var g=a.variable("dim").get(0),h=new Float64Array(g),b=b.get(e.mwg.structure.tree.NDTree._KEYS),n=a.variable("key").get(0),k=a.variable("distance").get(0),l=0;l<f.size();l++){for(var r=0;r<g;r++)h[r]=b[l*g+r];d.insert(f.get(l),
k.measure(h,n))}a.continueWith(null)}else{var q=b.get(e.mwg.structure.tree.NDTree._BOUNDMAX),u=b.get(e.mwg.structure.tree.NDTree._BOUNDMIN),v=a.variable("key").get(0),w=a.variable("distance").get(0),f=d.getWorstDistance();if(!d.isCapacityReached()||e.mwg.structure.tree.NDTree.getclosestDistance(v,u,q,w)<=f){var D=a.variable("precision").get(0),x=u.length,y=new Float64Array(x),z=new Float64Array(x),A=new e.mwg.structure.util.NearestNeighborArrayList;b.each(function(a,d,c){if(a>=e.mwg.structure.tree.NDTree._RELCONST){d=
e.mwg.structure.tree.NDTree.binaryFromLong(a,x);for(c=0;c<x;c++)d[c]?(y[c]=q[c]-Math.max((q[c]-u[c])/2,D[c]),z[c]=q[c]):(y[c]=u[c],z[c]=Math.max((q[c]-u[c])/2,D[c])+u[c]);A.insert(a,e.mwg.structure.tree.NDTree.getclosestDistance(v,y,z,w))}});A.sort();d=A.getNodes();a.continueWith(a.wrap(d))}else a.continueWith(null)}}).foreach(e.mwg.task.Actions.defineVar("relid").fromVar("parent").action(e.mwg.structure.action.TraverseById.NAME,"{{relid}}").subTask(a));return a};a.prototype.getNumNodes=function(){return null!=
this.getByIndex(a._NUMNODES)?this.getByIndex(a._NUMNODES):1};a.NAME="NDTree";a._STAT=0;a._TOTAL=1;a._SUM=2;a._SUMSQ=3;a._BOUNDMIN=6;a._BOUNDMAX=7;a._VALUES=8;a._VALUES_STR="8";a._KEYS=9;a._KEYS_STR="9";a._PRECISION=10;a._NUMNODES=11;a._DIM=12;a._DISTANCE=13;a._DISTANCETHRESHOLD=14;a.DISTANCE_THRESHOLD="threshold";a.DISTANCE_THRESHOLD_DEF=1E-10;a.DISTANCE_TYPE_DEF=0;a.STAT_DEF=!1;a.BOUNDMIN="boundmin";a.BOUNDMAX="boundmax";a.PRECISION="precision";a._RELCONST=16;a.insert=e.mwg.task.Actions.whileDo(function(a){for(var c=
a.variable("root").get(0),b=a.resultAsNodes().get(0),m=b.graph().resolver().resolveState(b),f=a.variable("updatestat").get(0),g=m.get(e.mwg.structure.tree.NDTree._BOUNDMAX),h=m.get(e.mwg.structure.tree.NDTree._BOUNDMIN),n=new Float64Array(g.length),k=0;k<n.length;k++)n[k]=(g[k]+h[k])/2;var l=a.variable("key").get(0),r=a.variable("precision").get(0),q=l.length;f&&e.mwg.structure.tree.NDTree.updateGaussian(m,l);f=!1;for(k=0;k<q;k++)if(g[k]-h[k]>r[k]){f=!0;break}if(f){var u=e.mwg.structure.tree.NDTree.getRelationId(n,
l);if(null==m.get(u)){for(var v=new Float64Array(q),q=new Float64Array(q),k=0;k<n.length;k++)l[k]<=n[k]?(v[k]=h[k],q[k]=Math.max(n[k]-h[k],r[k])+h[k]):(v[k]=g[k]-Math.max(g[k]-n[k],r[k]),q[k]=g[k]);l=b.graph().newTypedNode(b.world(),b.time(),e.mwg.structure.tree.NDTree.NAME);b=l.graph().resolver().resolveState(l);b.set(e.mwg.structure.tree.NDTree._BOUNDMIN,e.mwg.Type.DOUBLE_ARRAY,v);b.set(e.mwg.structure.tree.NDTree._BOUNDMAX,e.mwg.Type.DOUBLE_ARRAY,q);m.getOrCreate(u,e.mwg.Type.RELATION).add(l.id());
l.free();null!=c.getByIndex(e.mwg.structure.tree.NDTree._NUMNODES)?(m=c.getByIndex(e.mwg.structure.tree.NDTree._NUMNODES),m++,c.setPropertyByIndex(e.mwg.structure.tree.NDTree._NUMNODES,e.mwg.Type.INT,m)):c.setPropertyByIndex(e.mwg.structure.tree.NDTree._NUMNODES,e.mwg.Type.INT,2)}a.setVariable("next",u)}else a=a.variable("value").get(0),m.getOrCreate(e.mwg.structure.tree.NDTree._VALUES,e.mwg.Type.RELATION).add(a.id()),a=m.get(e.mwg.structure.tree.NDTree._KEYS),null!=a?(c=new Float64Array(a.length+
q),java.lang.System.arraycopy(a,0,c,0,a.length),java.lang.System.arraycopy(l,0,c,a.length,q),m.set(e.mwg.structure.tree.NDTree._KEYS,e.mwg.Type.DOUBLE_ARRAY,c)):m.set(e.mwg.structure.tree.NDTree._KEYS,e.mwg.Type.DOUBLE_ARRAY,l);return f},e.mwg.task.Actions.action(e.mwg.structure.action.TraverseById.NAME,"{{next}}"));a.nearestTask=a.initNearestTask();return a}(e.mwg.plugin.AbstractNode);q.NDTree=l})(v.tree||(v.tree={}));(function(q){var l=function(){function b(a,d){this.min=new Float64Array(a.length);
this.max=new Float64Array(d.length);java.lang.System.arraycopy(a,0,this.min,0,a.length);java.lang.System.arraycopy(d,0,this.max,0,d.length)}b.prototype.clone=function(){return new e.mwg.structure.util.HRect(this.min,this.max)};b.prototype.closest=function(a){for(var d=new Float64Array(a.length),c=0;c<a.length;++c)d[c]=a[c]<=this.min[c]?this.min[c]:a[c]>=this.max[c]?this.max[c]:a[c];return d};b.infiniteHRect=function(a){for(var d=new Float64Array(a),c=new Float64Array(a),b=0;b<a;++b)d[b]=java.lang.Double.NEGATIVE_INFINITY,
c[b]=java.lang.Double.POSITIVE_INFINITY;return new e.mwg.structure.util.HRect(d,c)};b.prototype.intersection=function(a){for(var d=new Float64Array(this.min.length),c=new Float64Array(this.min.length),b=0;b<this.min.length;++b)if(d[b]=Math.max(this.min[b],a.min[b]),c[b]=Math.min(this.max[b],a.max[b]),d[b]>=c[b])return null;return new e.mwg.structure.util.HRect(d,c)};b.prototype.area=function(){for(var a=1,d=0;d<this.min.length;++d)a*=this.max[d]-this.min[d];return a};b.prototype.toString=function(){return this.min+
"\n"+this.max+"\n"};return b}();q.HRect=l;l=function(){return function(){}}();q.NDResult=l;l=function(){function b(){this.maxPriority=java.lang.Double.MAX_VALUE;this.count=0;this.data=new java.util.ArrayList;this.value=new java.util.ArrayList;this.value.add(this.maxPriority);this.data.add(-1)}b.prototype.getMaxPriority=function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value.get(1)};b.prototype.insert=function(a,d){this.count++;this.value.add(d);this.data.add(a);this.bubbleUp(this.count);
return!0};b.prototype.distroyAndGetAllNodes=function(){for(var a=this.count,d=new Float64Array(this.count),c=0;c<a;++c)d[a-c-1]=this.remove();return d};b.prototype.sort=function(){for(var a=2;a<this.count;a++)for(var d=a+1;d<this.count;d++)if(this.value.get(a)<this.value.get(d)){var c=this.value.get(a);this.value.set(a,this.value.get(d));this.value.set(d,c);c=this.data.get(a);this.data.set(a,this.data.get(d));this.data.set(d,c)}};b.prototype.getNodes=function(){for(var a=new Float64Array(this.count),
d=0;d<this.count;d++)a[d]=this.data.get(this.count-d);return a};b.prototype.getDistances=function(){for(var a=new Float64Array(this.count),d=0;d<this.count;d++)a[d]=this.value.get(this.count-d);return a};b.prototype.getHighest=function(){return this.data.get(1)};b.prototype.getBestDistance=function(){return this.value.get(1)};b.prototype.isEmpty=function(){return 0==this.count};b.prototype.getSize=function(){return this.count};b.prototype.remove=function(){if(0==this.count)return 0;var a=this.data.get(1);
this.data.set(1,this.data.get(this.count));this.value.set(1,this.value.get(this.count));this.data.set(this.count,0);this.value.set(this.count,0);this.count--;this.bubbleDown(1);return a};b.prototype.bubbleDown=function(a){for(var d=this.data.get(a),c=this.value.get(a),b;2*a<=this.count;a=b)if(b=2*a,b!=this.count&&this.value.get(b)<this.value.get(b+1)&&b++,c<this.value.get(b))this.value.set(a,this.value.get(b)),this.data.set(a,this.data.get(b));else break;this.value.set(a,c);this.data.set(a,d)};b.prototype.bubbleUp=
function(a){for(var b=this.data.get(a),c=this.value.get(a),e=Math.floor(a/2);this.value.get(e)<c;)this.value.set(a,this.value.get(e)),this.data.set(a,this.data.get(e)),a=Math.floor(a/2),e=Math.floor(a/2);this.value.set(a,c);this.data.set(a,b)};return b}();q.NearestNeighborArrayList=l;l=function(){function b(a){this.maxPriority=java.lang.Double.MAX_VALUE;this.count=0;this.capacity=a;this.data=new Float64Array(a+1);this.value=new Float64Array(a+1);this.value[0]=this.maxPriority}b.prototype.getMaxPriority=
function(){return 0==this.count?java.lang.Double.POSITIVE_INFINITY:this.value[1]};b.prototype.removeNode=function(a){for(var b=-1,c=1;c<this.capacity+1;c++)if(this.data[c]==a){b=c;break}if(-1==b)return!1;if(1==b)this.remove();else{if(b==this.capacity+1)this.data[b]=0,this.value[b]=0;else for(c=b;c<this.capacity;c++)this.data[c]=this.data[c+1],this.value[c]=this.value[c+1];this.count--}return!0};b.prototype.insert=function(a,b){if(this.count<this.capacity)return this.add(a,b),!0;if(b>this.getMaxPriority())return!1;
this.remove();this.add(a,b);return!0};b.prototype.print=function(){console.log(" ");console.log("keys: ");for(var a=0;a<this.data.length;a++)console.log(this.data[a]);console.log(" ");console.log("dist: ");for(a=0;a<this.value.length;a++)console.log(this.value[a]);console.log(" ")};b.prototype.getAllNodes=function(){for(var a=Math.min(this.capacity,this.count),b=new Float64Array(a),c=0;c<a;++c)b[a-c-1]=this.remove();return b};b.prototype.isCapacityReached=function(){return this.count>=this.capacity};
b.prototype.getHighest=function(){return this.data[1]};b.prototype.getWorstDistance=function(){return this.value[1]};b.prototype.isEmpty=function(){return 0==this.count};b.prototype.getSize=function(){return this.count};b.prototype.add=function(a,b){this.count++>=this.capacity&&this.expandCapacity();this.value[this.count]=b;this.data[this.count]=a;this.bubbleUp(this.count)};b.prototype.remove=function(){if(0==this.count)return 0;var a=this.data[1];this.data[1]=this.data[this.count];this.value[1]=
this.value[this.count];this.data[this.count]=0;this.value[this.count]=0;this.count--;this.bubbleDown(1);return a};b.prototype.bubbleDown=function(a){for(var b=this.data[a],c=this.value[a],e;2*a<=this.count;a=e)if(e=2*a,e!=this.count&&this.value[e]<this.value[e+1]&&e++,c<this.value[e])this.value[a]=this.value[e],this.data[a]=this.data[e];else break;this.value[a]=c;this.data[a]=b};b.prototype.bubbleUp=function(a){for(var b=this.data[a],c=this.value[a],e=Math.floor(a/2);this.value[e]<c;)this.value[a]=
this.value[e],this.data[a]=this.data[e],a=Math.floor(a/2),e=Math.floor(a/2);this.value[a]=c;this.data[a]=b};b.prototype.expandCapacity=function(){this.capacity=2*this.count;var a=new Float64Array(this.capacity+1),b=new Float64Array(this.capacity+1);java.lang.System.arraycopy(this.data,0,a,0,this.data.length);java.lang.System.arraycopy(this.value,0,b,0,this.data.length);this.data=a;this.value=b};b.prototype.getAllNodesWithin=function(a){for(var b=Math.min(this.capacity,this.count),c=new Float64Array(b),
e=0,l=0;l<b;++l)this.getMaxPriority()<=a?(c[b-e-1]=this.remove(),e++):this.remove();a=new Float64Array(e);java.lang.System.arraycopy(c,b-e,a,0,e);return a};return b}();q.NearestNeighborList=l})(v.util||(v.util={}))})(u.structure||(u.structure={}))})(e.mwg||(e.mwg={}))})(org||(org={}));
